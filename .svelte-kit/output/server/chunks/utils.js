let idCounter=0;function generateId(p="a11y"){return`${p}-${++idCounter}`}function announceToScreenReader(p,e="polite"){const t=document.createElement("div");t.setAttribute("aria-live",e),t.setAttribute("aria-atomic","true"),t.className="sr-only",t.textContent=p,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},1e3)}class AccessibilityPreferences{preferences=new Map;listeners=new Map;constructor(){this.loadPreferences(),this.setupMediaQueryListeners()}loadPreferences(){try{const e=localStorage.getItem("accessibility-preferences");if(e){const t=JSON.parse(e);Object.entries(t).forEach(([r,n])=>{this.preferences.set(r,n)})}}catch(e){console.warn("Failed to load accessibility preferences:",e)}}savePreferences(){try{const e=Object.fromEntries(this.preferences);localStorage.setItem("accessibility-preferences",JSON.stringify(e))}catch(e){console.warn("Failed to save accessibility preferences:",e)}}setupMediaQueryListeners(){const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=window.matchMedia("(prefers-contrast: high)"),r=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",n=>{this.set("reducedMotion",n.matches)}),t.addEventListener("change",n=>{this.set("highContrast",n.matches)}),r.addEventListener("change",n=>{this.set("darkMode",n.matches)}),this.set("reducedMotion",e.matches),this.set("highContrast",t.matches),this.set("darkMode",r.matches)}get(e,t){return this.preferences.get(e)??t}set(e,t){this.preferences.set(e,t),this.savePreferences(),this.notifyListeners(e,t)}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),t(this.get(e)),()=>{this.listeners.get(e)?.delete(t)}}notifyListeners(e,t){this.listeners.get(e)?.forEach(r=>r(t))}}const accessibilityPreferences=new AccessibilityPreferences;class SearchEngine{searchIndex={content:new Map,tags:new Map,links:new Map};stopWords=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","will","with","the","this","but","they","have","had","what","said","each","which","she","do","how","their","if","up","out","many","then","them","these","so","some","her","would","make","like","into","him","time","two","more","go","no","way","could","my","than","first","been","call","who","oil","sit","now","find","down","day","did","get","come","made","may","part"]);tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!this.stopWords.has(t)).map(t=>t.trim()).filter(t=>t.length>0)}extractContentText(e){return e.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(r=>r.question).join(" ")||"";case"flashcard":return`${t.content?.front||""} ${t.content?.back||""}`;default:return""}}).join(" ")}indexModule(e){const t=[e.title,e.description,this.extractContentText(e.blocks)].join(" "),r=this.tokenize(t);this.searchIndex.content.set(e.id,r);for(const s of e.metadata.tags)this.searchIndex.tags.has(s)||this.searchIndex.tags.set(s,[]),this.searchIndex.tags.get(s).push(e.id);const n=[...e.relationships.prerequisites,...e.relationships.dependents,...e.relationships.related];this.searchIndex.links.set(e.id,n)}indexNode(e){const t=[e.title].join(" "),r=this.tokenize(t);this.searchIndex.content.set(e.id,r);for(const n of e.metadata.tags)this.searchIndex.tags.has(n)||this.searchIndex.tags.set(n,[]),this.searchIndex.tags.get(n).push(e.id)}removeFromIndex(e){this.searchIndex.content.delete(e),this.searchIndex.links.delete(e);for(const[t,r]of this.searchIndex.tags.entries()){const n=r.indexOf(e);n>-1&&(r.splice(n,1),r.length===0&&this.searchIndex.tags.delete(t))}}calculateRelevance(e,t,r,n,s){let i=0,o=!1;for(const a of t){const m=r.filter(d=>a.length>=3&&d.length>a.length&&d.includes(a)).length;m>0&&(i+=m*5,o=!0),r.includes(a)&&(i+=20,o=!0)}const l=n?.title||s?.title||"",c=this.tokenize(l);for(const a of t)c.includes(a)?(i+=50,o=!0):a.length>=3&&c.some(m=>m.length>a.length&&m.includes(a))&&(i+=25,o=!0);const u=n?.metadata.tags||s?.metadata.tags||[];for(const a of u){const m=this.tokenize(a);for(const d of t)m.includes(d)?(i+=30,o=!0):d.length>=3&&m.some(h=>h.length>d.length&&h.includes(d))&&(i+=15,o=!0)}return o&&n&&(i+=Math.log(n.analytics.views+1)*2,i+=Math.log(n.analytics.completions+1)*3,i+=n.analytics.averageScore*.5),i}applyFilters(e,t,r,n){return e.filter(s=>{const i=r.get(s.id),o=n.get(s.id);if(t.contentTypes&&t.contentTypes.length>0&&!t.contentTypes.includes(s.type))return!1;if(t.tags&&t.tags.length>0){const l=i?.metadata.tags||o?.metadata.tags||[];if(!t.tags.some(c=>l.includes(c)))return!1}if(t.difficulty&&t.difficulty.length>0){const l=i?.metadata.difficulty||o?.metadata.difficulty;if(l&&!t.difficulty.includes(l))return!1}if(t.dateRange&&i){const l=i.metadata.created;if(l<t.dateRange.start||l>t.dateRange.end)return!1}return!(t.author&&i&&i.metadata.author!==t.author||t.minRelevance&&s.relevance<t.minRelevance)})}generateSnippet(e,t,r=150){const n=t.split(/[.!?]+/).filter(o=>o.trim().length>0);let s="",i=0;for(const o of n){const l=this.tokenize(o),c=e.filter(u=>l.some(a=>a.includes(u))).length;c>i&&(i=c,s=o.trim())}return s.length>r&&(s=s.substring(0,r-3)+"..."),s||t.substring(0,r-3)+"..."}search(e,t,r,n={},s=50){if(!e.trim())return[];const i=this.tokenize(e),o=[];for(const[c,u]of this.searchIndex.content.entries()){const a=t.get(c),m=r.get(c);if(!a&&!m)continue;const d=this.calculateRelevance(c,i,u,a,m);if(d>10){const h=a?.title||m?.title||"",g=a?`${a.description} ${this.extractContentText(a.blocks)}`:h,f=this.generateSnippet(i,g),y=a?.metadata.tags||m?.metadata.tags||[],v=a?"module":m?.type||"unknown";o.push({id:c,title:h,snippet:f,relevance:d,type:v,tags:y})}}return o.sort((c,u)=>u.relevance-c.relevance),this.applyFilters(o,n,t,r).slice(0,s)}searchByTags(e,t,r){const n=[],s=new Set;for(const i of e){const o=this.searchIndex.tags.get(i)||[];for(const l of o){if(s.has(l))continue;s.add(l);const c=t.get(l),u=r.get(l);if(c||u){const a=c?.title||u?.title||"",m=c?`${c.description} ${this.extractContentText(c.blocks)}`:a,d=this.generateSnippet([i],m),h=c?.metadata.tags||u?.metadata.tags||[],g=c?"module":u?.type||"unknown";n.push({id:l,title:a,snippet:d,relevance:100,type:g,tags:h})}}}return n.sort((i,o)=>o.relevance-i.relevance)}getRelatedContent(e,t,r,n=10){const s=[],i=t.get(e),o=r.get(e);if(!i&&!o)return s;const l=this.searchIndex.links.get(e)||[];for(const u of l){const a=t.get(u),m=r.get(u);if(a||m){const d=a?.title||m?.title||"",h=a?`${a.description} ${this.extractContentText(a.blocks)}`:d,g=this.generateSnippet([],h),f=a?.metadata.tags||m?.metadata.tags||[],y=a?"module":m?.type||"unknown";s.push({id:u,title:d,snippet:g,relevance:90,type:y,tags:f})}}const c=i?.metadata.tags||o?.metadata.tags||[];for(const u of c){const a=this.searchIndex.tags.get(u)||[];for(const m of a){if(m===e||s.some(g=>g.id===m))continue;const d=t.get(m),h=r.get(m);if(d||h){const g=d?.title||h?.title||"",f=d?`${d.description} ${this.extractContentText(d.blocks)}`:g,y=this.generateSnippet([],f),v=d?.metadata.tags||h?.metadata.tags||[],w=d?"module":h?.type||"unknown";s.push({id:m,title:g,snippet:y,relevance:70,type:w,tags:v})}}}return s.sort((u,a)=>a.relevance-u.relevance).slice(0,n)}getSuggestions(e,t=5){if(e.length<2)return[];const r=new Set,n=e.toLowerCase();for(const s of this.searchIndex.content.values()){for(const i of s)if(i.startsWith(n)&&i.length>n.length&&(r.add(i),r.size>=t))break;if(r.size>=t)break}for(const s of this.searchIndex.tags.keys())if(s.toLowerCase().includes(n)&&(r.add(s),r.size>=t))break;return Array.from(r).slice(0,t)}clearIndex(){this.searchIndex.content.clear(),this.searchIndex.tags.clear(),this.searchIndex.links.clear()}getIndexStats(){return{totalContent:this.searchIndex.content.size,totalTags:this.searchIndex.tags.size,totalLinks:this.searchIndex.links.size,averageTokensPerContent:this.searchIndex.content.size>0?Array.from(this.searchIndex.content.values()).reduce((e,t)=>e+t.length,0)/this.searchIndex.content.size:0}}}const searchEngine=new SearchEngine;class CodeExecutionService{static instance;executionEnvironments=new Map;constructor(){this.initializeEnvironments()}static getInstance(){return CodeExecutionService.instance||(CodeExecutionService.instance=new CodeExecutionService),CodeExecutionService.instance}initializeEnvironments(){this.executionEnvironments.set("javascript",{language:"javascript",timeout:5e3,memoryLimit:50*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("python",{language:"python",timeout:1e4,memoryLimit:100*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("html",{language:"html",timeout:3e3,memoryLimit:25*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1})}async executeCode(p,e,t){const r=performance.now(),n=this.executionEnvironments.get(e);if(!n)return{success:!1,error:`Execution not supported for language: ${e}`,executionTime:0,timestamp:new Date};const s={...n,...t};try{let i;switch(e){case"javascript":i=await this.executeJavaScript(p,s);break;case"python":i=await this.executePython(p,s);break;case"html":i=await this.executeHTML(p,s);break;default:i={success:!1,error:`Execution not implemented for language: ${e}`,executionTime:0,timestamp:new Date}}return i.executionTime=performance.now()-r,i}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown execution error",executionTime:performance.now()-r,timestamp:new Date}}}async executeJavaScript(p,e){return new Promise(t=>{const r=setTimeout(()=>{t({success:!1,error:"Execution timeout exceeded",executionTime:e.timeout,timestamp:new Date})},e.timeout);try{const n=console,s=[],o={console:{log:(...u)=>s.push(u.map(a=>String(a)).join(" ")),error:(...u)=>s.push("ERROR: "+u.map(a=>String(a)).join(" ")),warn:(...u)=>s.push("WARN: "+u.map(a=>String(a)).join(" ")),info:(...u)=>s.push("INFO: "+u.map(a=>String(a)).join(" "))},Math,Date,JSON,Array,Object,String,Number,Boolean,RegExp,setTimeout:(u,a)=>(a>1e3&&(a=1e3),setTimeout(u,a)),clearTimeout},c=new Function(...Object.keys(o),`
					"use strict";
					try {
						${p}
					} catch (error) {
						console.error(error.message);
						throw error;
					}
					`)(...Object.values(o));clearTimeout(r),t({success:!0,output:s.length>0?s.join(`
`):c!==void 0?String(c):"",executionTime:0,timestamp:new Date})}catch(n){clearTimeout(r),t({success:!1,error:n instanceof Error?n.message:"JavaScript execution error",executionTime:0,timestamp:new Date})}})}async executePython(code,environment){return new Promise(resolve=>{setTimeout(()=>{if(code.includes("print(")){const print_matches=code.match(/print\((.*?)\)/g),output=print_matches?.map(match=>{const content=match.replace(/print\((.*?)\)/,"$1");try{return eval(content.replace(/'/g,'"'))}catch{return content.replace(/['"]/g,"")}}).join(`
`)||"";resolve({success:!0,output,executionTime:0,timestamp:new Date})}else resolve({success:!0,output:"Python code executed (simulation)",executionTime:0,timestamp:new Date})},100)})}async executeHTML(p,e){try{const t=document.createElement("iframe");return t.style.display="none",t.setAttribute("sandbox","allow-scripts"),document.body.appendChild(t),new Promise(r=>{const n=setTimeout(()=>{document.body.removeChild(t),r({success:!1,error:"HTML execution timeout",executionTime:e.timeout,timestamp:new Date})},e.timeout);t.onload=()=>{try{t.contentDocument&&(t.contentDocument.open(),t.contentDocument.write(p),t.contentDocument.close()),clearTimeout(n),setTimeout(()=>{document.body.removeChild(t),r({success:!0,output:"HTML rendered successfully",executionTime:0,timestamp:new Date})},500)}catch(s){clearTimeout(n),document.body.removeChild(t),r({success:!1,error:s instanceof Error?s.message:"HTML execution error",executionTime:0,timestamp:new Date})}},t.src="about:blank"})}catch(t){return{success:!1,error:t instanceof Error?t.message:"HTML execution setup error",executionTime:0,timestamp:new Date}}}isLanguageExecutable(p){return this.executionEnvironments.get(p)!==void 0}getSupportedLanguages(){return Array.from(this.executionEnvironments.keys())}}CodeExecutionService.getInstance();class CodeVersioningService{static instance;constructor(){}static getInstance(){return CodeVersioningService.instance||(CodeVersioningService.instance=new CodeVersioningService),CodeVersioningService.instance}createVersion(e,t,r,n){const s={id:crypto.randomUUID(),code:e.code,timestamp:new Date,description:r||`Version ${e.version}`,author:n||"Anonymous"};return{...e,code:t,version:e.version+1,history:[...e.history,s]}}restoreToVersion(e,t){const r=e.history.find(s=>s.id===t);if(!r)return null;const n={id:crypto.randomUUID(),code:e.code,timestamp:new Date,description:`Backup before restore to version ${r.description}`,author:"System"};return{...e,code:r.code,version:e.version+1,history:[...e.history,n]}}getVersionHistory(e){const t=[...e.history],r={id:"current",code:e.code,timestamp:new Date,description:`Current version (${e.version})`,author:"Current"},n=[...t,r];return n.map((s,i)=>{if(i===0)return s;const o=n[i-1],l=this.calculateDiffStats(o.code,s.code);return{...s,diffStats:l}})}calculateDiffStats(e,t){const r=e.split(`
`),n=t.split(`
`);let s=0,i=0,o=0;const l=Math.max(r.length,n.length);for(let c=0;c<l;c++){const u=r[c],a=n[c];u===void 0?s++:a===void 0?i++:u!==a&&o++}return{added:s,removed:i,modified:o}}generateDiff(e,t){const r=e.split(`
`),n=t.split(`
`),s=[],i=Math.max(r.length,n.length);for(let o=0;o<i;o++){const l=r[o],c=n[o];l===void 0?s.push({type:"added",content:c,lineNumber:o+1}):c===void 0?s.push({type:"removed",content:l,lineNumber:o+1}):l!==c?(s.push({type:"removed",content:l,lineNumber:o+1}),s.push({type:"added",content:c,lineNumber:o+1})):s.push({type:"unchanged",content:l,lineNumber:o+1})}return s}cleanupVersions(e,t=10){if(e.history.length<=t)return e;const r=[...e.history].sort((n,s)=>s.timestamp.getTime()-n.timestamp.getTime());return{...e,history:r.slice(0,t)}}exportVersionHistory(e){const t={currentVersion:{code:e.code,version:e.version,language:e.language,title:e.title,description:e.description},history:e.history,exportedAt:new Date().toISOString()};return JSON.stringify(t,null,2)}importVersionHistory(e){try{const t=JSON.parse(e);if(!t.currentVersion||!Array.isArray(t.history))throw new Error("Invalid version history format");return{code:t.currentVersion.code,language:t.currentVersion.language,title:t.currentVersion.title,description:t.currentVersion.description,version:t.currentVersion.version,history:t.history.map(r=>({...r,timestamp:new Date(r.timestamp)})),executable:!0}}catch{return null}}}const codeVersioningService=CodeVersioningService.getInstance(),physicsSimulations=[{id:"pendulum",name:"Simple Pendulum",domain:"physics",description:"Simulate the motion of a simple pendulum with adjustable parameters",parameters:[{name:"length",type:"number",min:.5,max:5,step:.1,default:2,description:"Length of the pendulum (m)"},{name:"gravity",type:"number",min:1,max:20,step:.1,default:9.81,description:"Gravitational acceleration (m/s²)"},{name:"damping",type:"number",min:0,max:1,step:.01,default:.05,description:"Damping coefficient"},{name:"initialAngle",type:"number",min:-90,max:90,step:1,default:30,description:"Initial angle (degrees)"}],initialState:{angle:30*Math.PI/180,angularVelocity:0,time:0},stepFunction:`
            const dt = 0.016; // 60 FPS
            const g = parameters.gravity;
            const L = parameters.length;
            const b = parameters.damping;
            
            const angularAcceleration = -(g / L) * Math.sin(state.angle) - b * state.angularVelocity;
            
            return {
                angle: state.angle + state.angularVelocity * dt,
                angularVelocity: state.angularVelocity + angularAcceleration * dt,
                time: state.time + dt
            };
        `,visualization:{type:"canvas",width:400,height:400,interactive:!0,config:{showTrail:!0,showForces:!1}}},{id:"spring-mass",name:"Spring-Mass System",domain:"physics",description:"Simulate a mass attached to a spring with damping",parameters:[{name:"mass",type:"number",min:.1,max:10,step:.1,default:1,description:"Mass (kg)"},{name:"springConstant",type:"number",min:1,max:100,step:1,default:20,description:"Spring constant (N/m)"},{name:"damping",type:"number",min:0,max:10,step:.1,default:1,description:"Damping coefficient"},{name:"initialPosition",type:"number",min:-2,max:2,step:.1,default:1,description:"Initial displacement (m)"}],initialState:{position:1,velocity:0,time:0},stepFunction:`
            const dt = 0.016;
            const m = parameters.mass;
            const k = parameters.springConstant;
            const c = parameters.damping;
            
            const force = -k * state.position - c * state.velocity;
            const acceleration = force / m;
            
            return {
                position: state.position + state.velocity * dt,
                velocity: state.velocity + acceleration * dt,
                time: state.time + dt
            };
        `,visualization:{type:"canvas",width:400,height:300,interactive:!0,config:{showGraph:!0,showForces:!0}}}],chemistrySimulations=[{id:"reaction-kinetics",name:"Chemical Reaction Kinetics",domain:"chemistry",description:"Simulate the kinetics of a simple A → B reaction",parameters:[{name:"rateConstant",type:"number",min:.001,max:1,step:.001,default:.1,description:"Rate constant (s⁻¹)"},{name:"initialConcentrationA",type:"number",min:.1,max:10,step:.1,default:2,description:"Initial concentration of A (mol/L)"},{name:"temperature",type:"number",min:273,max:373,step:1,default:298,description:"Temperature (K)"}],initialState:{concentrationA:2,concentrationB:0,time:0},stepFunction:`
            const dt = 0.1;
            const k = parameters.rateConstant;
            const rate = k * state.concentrationA;
            
            return {
                concentrationA: Math.max(0, state.concentrationA - rate * dt),
                concentrationB: state.concentrationB + rate * dt,
                time: state.time + dt
            };
        `,visualization:{type:"chart",width:500,height:300,interactive:!0,config:{chartType:"line",showBoth:!0}}},{id:"gas-laws",name:"Ideal Gas Law",domain:"chemistry",description:"Explore the relationship between pressure, volume, and temperature",parameters:[{name:"volume",type:"number",min:1,max:50,step:.5,default:22.4,description:"Volume (L)"},{name:"temperature",type:"number",min:200,max:500,step:5,default:273,description:"Temperature (K)"},{name:"moles",type:"number",min:.1,max:10,step:.1,default:1,description:"Amount of gas (mol)"}],initialState:{pressure:1,volume:22.4,temperature:273,moles:1},stepFunction:`
            const R = 0.08314; // Gas constant (L·bar/mol·K)
            const pressure = (parameters.moles * R * parameters.temperature) / parameters.volume;
            
            return {
                pressure: pressure,
                volume: parameters.volume,
                temperature: parameters.temperature,
                moles: parameters.moles
            };
        `,visualization:{type:"canvas",width:400,height:400,interactive:!0,config:{show3D:!1,showMolecules:!0}}}],engineeringSimulations=[{id:"pid-controller",name:"PID Controller",domain:"engineering",description:"Simulate a PID controller response to a step input",parameters:[{name:"kp",type:"number",min:0,max:10,step:.1,default:1,description:"Proportional gain (Kp)"},{name:"ki",type:"number",min:0,max:5,step:.1,default:.5,description:"Integral gain (Ki)"},{name:"kd",type:"number",min:0,max:2,step:.01,default:.1,description:"Derivative gain (Kd)"},{name:"setpoint",type:"number",min:0,max:10,step:.1,default:5,description:"Setpoint value"}],initialState:{output:0,error:0,integral:0,previousError:0,time:0},stepFunction:`
            const dt = 0.05;
            const setpoint = parameters.setpoint;
            const error = setpoint - state.output;
            const integral = state.integral + error * dt;
            const derivative = (error - state.previousError) / dt;
            
            const controlSignal = parameters.kp * error + parameters.ki * integral + parameters.kd * derivative;
            const newOutput = state.output + controlSignal * dt;
            
            return {
                output: newOutput,
                error: error,
                integral: integral,
                previousError: error,
                time: state.time + dt
            };
        `,visualization:{type:"chart",width:500,height:300,interactive:!0,config:{chartType:"line",showSetpoint:!0,showError:!0}}},{id:"beam-deflection",name:"Beam Deflection",domain:"engineering",description:"Calculate deflection of a simply supported beam under load",parameters:[{name:"load",type:"number",min:100,max:1e4,step:100,default:1e3,description:"Applied load (N)"},{name:"length",type:"number",min:1,max:10,step:.1,default:4,description:"Beam length (m)"},{name:"elasticModulus",type:"number",min:1e5,max:3e5,step:1e4,default:2e5,description:"Elastic modulus (MPa)"},{name:"momentOfInertia",type:"number",min:1e-4,max:.01,step:1e-4,default:.001,description:"Moment of inertia (m⁴)"}],initialState:{maxDeflection:0,stress:0,safetyFactor:0},stepFunction:`
            const P = parameters.load;
            const L = parameters.length;
            const E = parameters.elasticModulus * 1e6; // Convert MPa to Pa
            const I = parameters.momentOfInertia;
            
            // Maximum deflection at center for simply supported beam with center load
            const maxDeflection = (P * Math.pow(L, 3)) / (48 * E * I);
            
            // Maximum stress
            const maxStress = (P * L) / (4 * Math.sqrt(I)) / 1e6; // Convert to MPa
            
            // Safety factor (assuming yield strength of 250 MPa)
            const yieldStrength = 250;
            const safetyFactor = yieldStrength / maxStress;
            
            return {
                maxDeflection: maxDeflection * 1000, // Convert to mm
                stress: maxStress,
                safetyFactor: safetyFactor
            };
        `,visualization:{type:"canvas",width:500,height:300,interactive:!0,config:{showDeformation:!0,showStress:!0}}}],systemDiagramTemplates=[{id:"control-system",name:"Control System Block Diagram",domain:"engineering",description:"Interactive control system with feedback loop",elements:[{id:"input",type:"circle",position:{x:50,y:150},size:{width:60,height:60},label:"Input",description:"System input signal",style:{fill:"#e3f2fd",stroke:"#1976d2",strokeWidth:2},interactive:!0,clickable:!0},{id:"controller",type:"rectangle",position:{x:150,y:125},size:{width:100,height:50},label:"Controller",description:"PID Controller",style:{fill:"#f3e5f5",stroke:"#7b1fa2",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"plant",type:"rectangle",position:{x:300,y:125},size:{width:100,height:50},label:"Plant",description:"System to be controlled",style:{fill:"#e8f5e8",stroke:"#388e3c",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"output",type:"circle",position:{x:450,y:150},size:{width:60,height:60},label:"Output",description:"System output signal",style:{fill:"#fff3e0",stroke:"#f57c00",strokeWidth:2},interactive:!0,clickable:!0},{id:"sensor",type:"rectangle",position:{x:300,y:225},size:{width:100,height:40},label:"Sensor",description:"Feedback sensor",style:{fill:"#fce4ec",stroke:"#c2185b",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0}],connections:[{id:"input-controller",from:"input",to:"controller",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"controller-plant",from:"controller",to:"plant",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"plant-output",from:"plant",to:"output",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"output-sensor",from:"output",to:"sensor",type:"line",arrow:!1,style:{stroke:"#666666",strokeWidth:2}},{id:"sensor-controller",from:"sensor",to:"controller",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2,strokeDasharray:"5,5"}}],parameters:[{name:"gain",type:"number",min:.1,max:10,step:.1,default:1,description:"Controller gain"},{name:"delay",type:"number",min:0,max:2,step:.1,default:.5,description:"System delay (s)"}],initialState:{input:{opacity:1,scale:1},controller:{opacity:1,scale:1},plant:{opacity:1,scale:1},output:{opacity:1,scale:1},sensor:{opacity:1,scale:1}},updateFunction:`
            const gain = parameters.gain;
            const delay = parameters.delay;
            
            // Highlight active components based on parameters
            const controllerScale = 1.0 + (gain - 1.0) * 0.1;
            const plantOpacity = Math.max(0.3, 1.0 - delay * 0.3);
            
            return {
                ...state,
                controller: { ...state.controller, scale: controllerScale },
                plant: { ...state.plant, opacity: plantOpacity }
            };
        `},{id:"chemical-process",name:"Chemical Process Flow",domain:"chemistry",description:"Interactive chemical process diagram",elements:[{id:"reactor",type:"circle",position:{x:200,y:100},size:{width:80,height:80},label:"Reactor",description:"Chemical reactor vessel",style:{fill:"#e8f5e8",stroke:"#388e3c",strokeWidth:3},interactive:!0,clickable:!0},{id:"heater",type:"rectangle",position:{x:150,y:200},size:{width:60,height:40},label:"Heater",description:"Process heater",style:{fill:"#ffebee",stroke:"#d32f2f",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"separator",type:"rectangle",position:{x:350,y:125},size:{width:80,height:60},label:"Separator",description:"Product separator",style:{fill:"#e3f2fd",stroke:"#1976d2",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0}],connections:[{id:"reactor-separator",from:"reactor",to:"separator",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:3}},{id:"heater-reactor",from:"heater",to:"reactor",type:"arrow",arrow:!0,style:{stroke:"#d32f2f",strokeWidth:2}}],parameters:[{name:"temperature",type:"number",min:20,max:200,step:5,default:80,description:"Reactor temperature (°C)"},{name:"pressure",type:"number",min:1,max:10,step:.5,default:2,description:"System pressure (bar)"}],initialState:{reactor:{opacity:1,scale:1},heater:{opacity:1,scale:1},separator:{opacity:1,scale:1}},updateFunction:`
            const temp = parameters.temperature;
            const pressure = parameters.pressure;
            
            // Visual feedback based on parameters
            const heaterIntensity = Math.min(1.0, temp / 100);
            const reactorScale = 1.0 + (pressure - 1.0) * 0.05;
            
            return {
                reactor: { opacity: 1.0, scale: reactorScale },
                heater: { opacity: 0.5 + heaterIntensity * 0.5, scale: 1.0 },
                separator: { opacity: 1.0, scale: 1.0 }
            };
        `}];function getSimulationTemplate(p){return[...physicsSimulations,...chemistrySimulations,...engineeringSimulations].find(t=>t.id===p)}function getDiagramTemplate(p){return systemDiagramTemplates.find(e=>e.id===p)}function createSimulationFromTemplate(p,e){const t=getSimulationTemplate(p);return t?{id:e,type:"simulation",content:{simulationType:t.name,parameters:t.parameters,initialState:t.initialState,stepFunction:t.stepFunction,visualization:t.visualization,sourceReference:{originalUrl:"",originalContent:`Template: ${t.name}`,transformationReasoning:`Created from ${t.domain} simulation template`,extractionMethod:"template",confidence:1}},metadata:{created:new Date,modified:new Date,version:1}}:null}function createDiagramFromTemplate(p,e){const t=getDiagramTemplate(p);return t?{id:e,type:"system-diagram",content:{diagramType:t.name,description:t.description,elements:t.elements,connections:t.connections,parameters:t.parameters,initialState:t.initialState,updateFunction:t.updateFunction,layout:{width:600,height:400,padding:20,grid:!1},sourceReference:{originalUrl:"",originalContent:`Template: ${t.name}`,transformationReasoning:`Created from ${t.domain} diagram template`,extractionMethod:"template",confidence:1}},metadata:{created:new Date,modified:new Date,version:1}}:null}const is_development=typeof process<"u"&&process.env?.NODE_ENV!=="production";function createLogger(p){const e=`[${p}]`;return{debug:(...t)=>{is_development&&console.debug(e,...t)},info:(...t)=>{console.info(e,...t)},warn:(...t)=>{console.warn(e,...t)},error:(...t)=>{console.error(e,...t)}}}class ErrorHandler{static instance;logger=createLogger("error-handler");toastQueue=[];errorListeners=[];constructor(){}static getInstance(){return ErrorHandler.instance||(ErrorHandler.instance=new ErrorHandler),ErrorHandler.instance}async handleAsync(e,t,r={}){const{showToast:n=!0,logError:s=!0,retryable:i=!1,maxRetries:o=3,retryDelay:l=1e3,onError:c,onRetry:u}=r;let a,m=0;for(;m<=(i?o:0);)try{return{success:!0,data:await e(),retryCount:m}}catch(d){if(a=d instanceof Error?d:new Error(String(d)),s&&this.logger.error(`Operation failed: ${t.operation}`,{error:a,context:t,attempt:m+1}),c&&c(a,t),this.notifyErrorListeners(a,t),i&&m<o&&this.isRetryableError(a)){m++,u&&u(m,a),await this.delay(l*m);continue}break}return n&&this.showErrorToast(a,t),{success:!1,error:a,retryCount:m}}handleSync(e,t,r={}){const{showToast:n=!0,logError:s=!0,fallbackValue:i,onError:o}=r;try{return{success:!0,data:e()}}catch(l){const c=l instanceof Error?l:new Error(String(l));return s&&this.logger.error(`Sync operation failed: ${t.operation}`,{error:c,context:t}),o&&o(c,t),this.notifyErrorListeners(c,t),n&&this.showErrorToast(c,t),{success:!1,error:c,data:i}}}createAsyncWrapper(e,t,r={}){return async(...n)=>(await this.handleAsync(()=>e(...n),t,r)).data}createSyncWrapper(e,t,r={}){return(...n)=>this.handleSync(()=>e(...n),t,r).data}addErrorListener(e){this.errorListeners.push(e)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}getUserFriendlyMessage(e,t){if(this.isNetworkError(e))return"Unable to connect to the server. Please check your internet connection and try again.";if(this.isValidationError(e))return e.message||"Please check your input and try again.";if(this.isPermissionError(e))return"You do not have permission to perform this action.";if(this.isTimeoutError(e))return"The operation took too long to complete. Please try again.";if(this.isStorageError(e))return"Unable to save data. Please check your storage space and try again.";switch(t.operation){case"save":case"create":return"Failed to save. Please try again.";case"load":case"fetch":return"Failed to load data. Please refresh and try again.";case"delete":return"Failed to delete. Please try again.";case"update":return"Failed to update. Please try again.";default:return"An unexpected error occurred. Please try again."}}isRetryableError(e){return this.isNetworkError(e)||this.isTimeoutError(e)||e.message.toLowerCase().includes("rate limit")||e.message.toLowerCase().includes("server error")||e.message.includes("503")||e.message.includes("502")||e.message.toLowerCase().includes("network error")}isNetworkError(e){return e.message.includes("fetch")||e.message.includes("network")||e.message.includes("connection")||e.message.includes("offline")||e.name==="NetworkError"}isValidationError(e){return e.message.includes("validation")||e.message.includes("invalid")||e.message.includes("required")||e.name==="ValidationError"}isPermissionError(e){return e.message.includes("permission")||e.message.includes("unauthorized")||e.message.includes("forbidden")||e.message.includes("401")||e.message.includes("403")}isTimeoutError(e){return e.message.includes("timeout")||e.message.includes("aborted")||e.name==="TimeoutError"||e.name==="AbortError"}isStorageError(e){return e.message.includes("storage")||e.message.includes("quota")||e.message.includes("IndexedDB")||e.name==="QuotaExceededError"}showErrorToast(e,t){const r=this.getUserFriendlyMessage(e,t),n={id:`error_${Date.now()}`,type:"error",title:"Error",message:r,duration:5e3,actions:this.getErrorActions(e,t)};this.toastQueue.push(n),typeof window<"u"&&window.dispatchEvent(new CustomEvent("show-toast",{detail:n}))}getErrorActions(e,t){const r=[];return this.isRetryableError(e)&&r.push({label:"Retry",action:()=>{typeof window<"u"&&window.dispatchEvent(new CustomEvent("error-retry",{detail:{error:e,context:t}}))}}),this.isNetworkError(e)&&r.push({label:"Refresh",action:()=>window.location.reload()}),r}notifyErrorListeners(e,t){this.errorListeners.forEach(r=>{try{r(e,t)}catch(n){this.logger.error("Error listener failed:",n)}})}delay(e){return new Promise(t=>setTimeout(t,e))}getToastQueue(){return[...this.toastQueue]}clearToastQueue(){this.toastQueue.length=0}}const errorHandler=ErrorHandler.getInstance();errorHandler.handleAsync.bind(errorHandler);errorHandler.handleSync.bind(errorHandler);errorHandler.createAsyncWrapper.bind(errorHandler);errorHandler.createSyncWrapper.bind(errorHandler);class PerformanceMonitor{entries=[];observers=[];startTime=Date.now();constructor(){this.initializeObservers()}initializeObservers(){if(!(typeof window>"u")&&"PerformanceObserver"in window){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.entryType==="navigation"&&this.recordNavigationMetrics(n)})});e.observe({entryTypes:["navigation"]}),this.observers.push(e)}catch(e){console.warn("Navigation timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.entryType==="paint"&&this.recordPaintMetrics(n)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Paint timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{const r=t.getEntries(),n=r[r.length-1];n&&this.recordLCPMetrics(n)});e.observe({entryTypes:["largest-contentful-paint"]}),this.observers.push(e)}catch(e){console.warn("LCP observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{this.recordLayoutShiftMetrics(n)})});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Layout shift observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{this.recordFirstInputDelay(n)})});e.observe({entryTypes:["first-input"]}),this.observers.push(e)}catch(e){console.warn("First input delay observer not supported:",e)}}}recordNavigationMetrics(e){const t={pageLoad:{domContentLoaded:e.domContentLoadedEventEnd-e.navigationStart,loadComplete:e.loadEventEnd-e.navigationStart}};this.updateCurrentMetrics(t)}recordPaintMetrics(e){const t={};e.name==="first-contentful-paint"&&(t.pageLoad={...this.getCurrentMetrics()?.pageLoad,firstContentfulPaint:e.startTime}),this.updateCurrentMetrics(t)}recordLCPMetrics(e){const t={pageLoad:{...this.getCurrentMetrics()?.pageLoad,largestContentfulPaint:e.startTime}};this.updateCurrentMetrics(t)}recordLayoutShiftMetrics(e){if(!e.hadRecentInput){const t=this.getCurrentMetrics(),r=t?.userExperience?.cumulativeLayoutShift||0,n={userExperience:{...t?.userExperience,cumulativeLayoutShift:r+e.value}};this.updateCurrentMetrics(n)}}recordFirstInputDelay(e){const t={userExperience:{...this.getCurrentMetrics()?.userExperience,firstInputDelay:e.processingStart-e.startTime}};this.updateCurrentMetrics(t)}measureRenderTime(e,t){const r=performance.now();t();const s=performance.now()-r;return console.debug(`Component ${e} render time: ${s.toFixed(2)}ms`),s}async measureAsyncOperation(e,t){const r=performance.now(),n=await t(),i=performance.now()-r;return console.debug(`Operation ${e} completed in: ${i.toFixed(2)}ms`),{result:n,duration:i}}getMemoryUsage(){if(typeof window<"u"&&"memory"in performance)return performance.memory.usedJSHeapSize}getConnectionInfo(){if(typeof navigator<"u"&&"connection"in navigator){const e=navigator.connection;return e.effectiveType||e.type}}recordEntry(e,t){const r=this.getCurrentMetrics(),n=this.getMemoryUsage(),s=this.getConnectionInfo(),i={timestamp:Date.now(),page:e,metrics:{pageLoad:r?.pageLoad||{domContentLoaded:0,loadComplete:0},bundle:r?.bundle||{totalSize:0,chunkCount:0,loadTime:0},runtime:{memoryUsage:n,renderTime:r?.runtime?.renderTime||0,interactionTime:r?.runtime?.interactionTime||0},userExperience:r?.userExperience||{},...t},userAgent:navigator.userAgent,connectionType:s};this.entries.push(i),this.logPerformanceEntry(i)}getCurrentMetrics(){return this.entries[this.entries.length-1]?.metrics}updateCurrentMetrics(e){this.entries.length===0&&this.recordEntry(window.location.pathname);const t=this.entries[this.entries.length-1];t.metrics={...t.metrics,...e,pageLoad:{...t.metrics.pageLoad,...e.pageLoad},runtime:{...t.metrics.runtime,...e.runtime},userExperience:{...t.metrics.userExperience,...e.userExperience}}}logPerformanceEntry(e){console.group(`Performance Metrics - ${e.page}`),console.log("Timestamp:",new Date(e.timestamp).toISOString()),console.log("Page Load:",e.metrics.pageLoad),console.log("Runtime:",e.metrics.runtime),console.log("User Experience:",e.metrics.userExperience),e.connectionType&&console.log("Connection:",e.connectionType),console.groupEnd()}getEntries(){return[...this.entries]}getSummary(){if(this.entries.length===0)return{totalEntries:0,averageLoadTime:0,averageRenderTime:0,averageMemoryUsage:0};const e=this.entries.reduce((n,s)=>n+s.metrics.pageLoad.loadComplete,0),t=this.entries.reduce((n,s)=>n+s.metrics.runtime.renderTime,0),r=this.entries.reduce((n,s)=>n+(s.metrics.runtime.memoryUsage||0),0);return{totalEntries:this.entries.length,averageLoadTime:e/this.entries.length,averageRenderTime:t/this.entries.length,averageMemoryUsage:r/this.entries.length}}clearEntries(){this.entries=[]}cleanup(){this.observers.forEach(e=>{e.disconnect()}),this.observers=[]}}new PerformanceMonitor;export{accessibilityPreferences as a,createLogger as b,chemistrySimulations as c,searchEngine as d,engineeringSimulations as e,announceToScreenReader as f,generateId as g,codeVersioningService as h,createSimulationFromTemplate as i,createDiagramFromTemplate as j,physicsSimulations as p,systemDiagramTemplates as s};
