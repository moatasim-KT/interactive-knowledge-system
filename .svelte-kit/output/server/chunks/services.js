import{s as p,a as m,b as w}from"./components-knowledge.js";import"clsx";import{c as O,s as B}from"./utils.js";import{openDB as Q}from"idb";class j{graphCache=new Map;dependencyCache=new Map;analyticsCache=null;lastCacheUpdate=new Date(0);cacheTimeout=5*60*1e3;async createLink(e,t,n,s=1,i,a=!1,r=!1){r||await this.validateLinkCreation(e,t,n);const o={id:`${e}-${t}-${n}-${Date.now()}`,sourceId:e,targetId:t,type:n,strength:Math.max(0,Math.min(1,s)),metadata:{created:new Date,createdBy:"current-user",description:i,automatic:a}};if(await p.add("links",o,`Created ${n} link`),this.isBidirectionalType(n)){const c=await this.createReverseLink(o);await p.add("links",c,`Created reverse ${n} link`)}return(n==="prerequisite"||n==="dependent")&&await this.updateDependencyChains(e,t,n),this.invalidateCache(),o}async createLinksBatch(e){const t=[];for(const n of e)if(n.operation==="create"){for(const s of n.links)if(s.sourceId&&s.targetId&&s.type)try{const i=await this.createLink(s.sourceId,s.targetId,s.type,s.strength,s.metadata?.description,s.metadata?.automatic||!1,!0);t.push(i)}catch(i){console.warn(`Failed to create link in batch: ${i}`)}}return await this.validateBatchForCircularDependencies(t),t}async updateLink(e,t){const n=await p.get("links",e);if(!n)return null;const s={...n,...t,metadata:{...n.metadata,...t.metadata}};if(await p.update("links",e,s,"Updated link"),this.isBidirectionalType(n.type)){const i=this.getReverseId(n),a=await p.get("links",i);a&&t.strength!==void 0&&await p.update("links",i,{...a,strength:t.strength},"Updated reverse link")}return this.invalidateCache(),s}async deleteLink(e){const t=await p.get("links",e);if(!t)return!1;if(this.isBidirectionalType(t.type)){const n=this.getReverseId(t);await p.delete("links",n,"Deleted reverse link")}return await p.delete("links",e,"Deleted link"),(t.type==="prerequisite"||t.type==="dependent")&&await this.recalculateDependencyChains(),this.invalidateCache(),!0}async findLinks(e={}){return(await p.getAll("links")).filter(n=>{if(e.sourceIds&&!e.sourceIds.includes(n.sourceId)||e.targetIds&&!e.targetIds.includes(n.targetId)||e.types&&!e.types.includes(n.type))return!1;if(e.strengthRange){const[s,i]=e.strengthRange;if(n.strength<s||n.strength>i)return!1}return!(e.automatic!==void 0&&n.metadata.automatic!==e.automatic||e.createdAfter&&n.metadata.created<e.createdAfter||e.createdBefore&&n.metadata.created>e.createdBefore)})}async getLinksForContent(e){const t=await p.getAll("links"),n=t.filter(a=>a.targetId===e),s=t.filter(a=>a.sourceId===e),i=[...n,...s];return{incoming:n,outgoing:s,all:i}}async buildContentGraph(e){const t=e.map(r=>r.id).sort().join("-");if(this.graphCache.has(t)&&!this.isCacheExpired())return this.graphCache.get(t);const n=new Map,s=new Map;for(const r of e){const o=await this.getLinksForContent(r.id);n.set(r.id,{id:r.id,title:r.title,type:this.inferNodeType(r),tags:r.metadata.tags,difficulty:r.metadata.difficulty,incomingLinks:o.incoming.map(c=>c.id),outgoingLinks:o.outgoing.map(c=>c.id)})}const i=await this.findLinks({sourceIds:e.map(r=>r.id),targetIds:e.map(r=>r.id)});for(const r of i)s.set(r.id,r);const a={nodes:n,edges:s};return this.graphCache.set(t,a),this.lastCacheUpdate=new Date,a}async analyzeDependencyChain(e){if(this.dependencyCache.has(e)&&!this.isCacheExpired())return this.dependencyCache.get(e);const t=new Set,n=await this.getPrerequisiteChain(e,t);t.clear();const s=await this.getDependentChain(e,t),i=await this.calculateDepth(e),a=await this.checkAccessibility(e),r={nodeId:e,prerequisites:Array.from(n),dependents:Array.from(s),depth:i,canAccess:a};return this.dependencyCache.set(e,r),r}async detectCircularDependencies(){const e=await this.findLinks({types:["prerequisite","dependent"]}),t=new Map;for(const r of e)r.type==="prerequisite"&&(t.has(r.targetId)||t.set(r.targetId,[]),t.get(r.targetId).push(r.sourceId));const n=[],s=new Set,i=new Set,a=(r,o)=>{if(i.has(r)){const l=o.indexOf(r);l!==-1&&n.push([...o.slice(l),r]);return}if(s.has(r))return;s.add(r),i.add(r),o.push(r);const c=t.get(r)||[];for(const l of c)a(l,[...o]);i.delete(r)};for(const r of t.keys())s.has(r)||a(r,[]);return n}async generateAutomaticLinks(e,t=.7,n=5){const s=[];for(let i=0;i<e.length;i++){const a=e[i],r=[];for(let o=i+1;o<e.length;o++){const c=e[o];if((await this.findLinks({sourceIds:[a.id],targetIds:[c.id]})).length>0)continue;const d=await this.calculateModuleSimilarity(a,c);if(d.score>=t){const h=this.suggestRelationshipType(a,c,d);r.push({module:c,score:d.score,type:h})}}r.sort((o,c)=>c.score-o.score).slice(0,n).forEach(o=>{s.push({id:`auto-${a.id}-${o.module.id}-${o.type}`,sourceId:a.id,targetId:o.module.id,type:o.type,strength:o.score,metadata:{created:new Date,createdBy:"system",description:`Automatically suggested based on ${Math.round(o.score*100)}% similarity`,automatic:!0}})})}return s}async getAnalytics(){if(this.analyticsCache&&!this.isCacheExpired())return this.analyticsCache;const e=await p.getAll("links"),t=e.length,n={prerequisite:0,dependent:0,related:0,similar:0,sequence:0,reference:0,example:0,practice:0};let s=0,i=0,a=0;const r=new Map;for(const u of e)n[u.type]++,s+=u.strength,u.metadata.automatic?i++:a++,r.set(u.sourceId,(r.get(u.sourceId)||0)+1),r.set(u.targetId,(r.get(u.targetId)||0)+1);const o=t>0?s/t:0,c=Array.from(r.entries()).map(([u,y])=>({id:u,connectionCount:y})).sort((u,y)=>y.connectionCount-u.connectionCount).slice(0,10),l=e.sort((u,y)=>u.strength-y.strength),d=l.slice(0,5),h=l.slice(-5).reverse();return this.analyticsCache={totalLinks:t,linksByType:n,averageStrength:o,automaticVsManual:{automatic:i,manual:a},mostConnectedNodes:c,weakestLinks:d,strongestLinks:h},this.analyticsCache}async validateLinkCreation(e,t,n){if(e===t)throw new Error("Cannot create self-referential link");if((await this.findLinks({sourceIds:[e],targetIds:[t],types:[n]})).length>0)throw new Error("Link already exists");if(n==="prerequisite"&&await this.wouldCreateCircularDependency(e,t))throw new Error("Creating this prerequisite link would create a circular dependency")}async wouldCreateCircularDependency(e,t){const n=new Set;return await this.hasPath(t,e,n,["prerequisite"])}async hasPath(e,t,n,s){if(e===t)return!0;if(n.has(e))return!1;n.add(e);const i=await this.findLinks({sourceIds:[e],types:s});for(const a of i)if(await this.hasPath(a.targetId,t,n,s))return!0;return!1}async createReverseLink(e){return{...e,id:this.getReverseId(e),sourceId:e.targetId,targetId:e.sourceId,type:this.getReverseType(e.type)}}getReverseId(e){return`${e.targetId}-${e.sourceId}-${e.type}-reverse`}getReverseType(e){switch(e){case"prerequisite":return"dependent";case"dependent":return"prerequisite";case"related":return"related";case"similar":return"similar";default:return e}}isBidirectionalType(e){return["related","similar","prerequisite"].includes(e)}inferNodeType(e){const t=e.blocks.length,n=e.blocks.some(s=>s.type==="quiz");return t>10||n?"module":t>3?"lesson":"concept"}async calculateModuleSimilarity(e,t){let n=0,s=0;const i=e.metadata.tags.filter(l=>t.metadata.tags.includes(l)),a=i.length/Math.max(e.metadata.tags.length,t.metadata.tags.length,1);n+=a*.4,s+=.4;const r=Math.abs(e.metadata.difficulty-t.metadata.difficulty),o=Math.max(0,1-r/10);n+=o*.3,s+=.3;const c=this.calculateContentTypeSimilarity(e,t);return n+=c*.3,s+=.3,{contentId:t.id,score:s>0?n/s:0,reasons:[{type:"tags",score:a,details:`Common tags: ${i.join(", ")}`},{type:"difficulty",score:o,details:`Difficulty difference: ${r}`},{type:"content",score:c,details:"Content type similarity"}]}}calculateContentTypeSimilarity(e,t){const n=new Set(e.blocks.map(r=>r.type)),s=new Set(t.blocks.map(r=>r.type)),i=new Set([...n].filter(r=>s.has(r))),a=new Set([...n,...s]);return a.size>0?i.size/a.size:0}suggestRelationshipType(e,t,n){const s=t.metadata.difficulty-e.metadata.difficulty;return s>=2?"prerequisite":Math.abs(s)<=1&&n.score>=.8?"related":this.calculateContentTypeSimilarity(e,t)>=.6?"similar":"related"}async getPrerequisiteChain(e,t){if(t.has(e))return new Set;t.add(e);const n=new Set,s=await this.findLinks({targetIds:[e],types:["prerequisite"]});for(const i of s)n.add(i.sourceId),(await this.getPrerequisiteChain(i.sourceId,t)).forEach(r=>n.add(r));return n}async getDependentChain(e,t){if(t.has(e))return new Set;t.add(e);const n=new Set,s=await this.findLinks({sourceIds:[e],types:["prerequisite"]});for(const i of s)n.add(i.targetId),(await this.getDependentChain(i.targetId,t)).forEach(r=>n.add(r));return n}async calculateDepth(e){const t=await this.findLinks({targetIds:[e],types:["prerequisite"]});if(t.length===0)return 0;let n=0;for(const s of t){const i=await this.calculateDepth(s.sourceId);n=Math.max(n,i)}return n+1}async checkAccessibility(e){return!0}async updateDependencyChains(e,t,n){this.dependencyCache.delete(e),this.dependencyCache.delete(t)}async recalculateDependencyChains(){this.dependencyCache.clear()}async validateBatchForCircularDependencies(e){const t=e.filter(s=>s.type==="prerequisite");if(t.length===0)return;const n=new Map;t.forEach(s=>{n.has(s.targetId)||n.set(s.targetId,new Set),n.get(s.targetId).add(s.sourceId)});for(const[s,i]of n.entries())if(this.hasCycleInBatch(s,i,n,new Set))throw new Error(`Batch operation would create circular dependency involving ${s}`)}hasCycleInBatch(e,t,n,s){if(s.has(e))return!0;s.add(e);for(const i of t){const a=n.get(i);if(a&&this.hasCycleInBatch(i,a,n,new Set(s)))return!0}return!1}isCacheExpired(){return Date.now()-this.lastCacheUpdate.getTime()>this.cacheTimeout}invalidateCache(){this.graphCache.clear(),this.dependencyCache.clear(),this.analyticsCache=null}clearCaches(){this.invalidateCache()}}const U=new j;class A{static instance;networkStatus={isOnline:typeof navigator<"u"?navigator.onLine:!0};listeners=new Set;connectionMonitor=null;constructor(){this.initializeNetworkMonitoring()}static getInstance(){return A.instance||(A.instance=new A),A.instance}initializeNetworkMonitoring(){if(!(typeof window>"u")){if(window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),"connection"in navigator){const e=navigator.connection;e&&(this.updateConnectionInfo(e),e.addEventListener("change",()=>{this.updateConnectionInfo(e)}))}this.startPeriodicCheck()}}handleOnline(){this.networkStatus.isOnline=!0,m.setOnlineStatus(!0),this.notifyListeners()}handleOffline(){this.networkStatus.isOnline=!1,m.setOnlineStatus(!1),this.notifyListeners()}updateConnectionInfo(e){this.networkStatus={...this.networkStatus,connectionType:e.type||"unknown",effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt},this.notifyListeners()}startPeriodicCheck(){this.connectionMonitor=window.setInterval(async()=>{const e=this.networkStatus.isOnline,t=await this.checkConnectivity();e!==t&&(this.networkStatus.isOnline=t,m.setOnlineStatus(t),this.notifyListeners())},3e4)}async checkConnectivity(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("/favicon.ico",{method:"HEAD",cache:"no-cache",signal:e.signal});return clearTimeout(t),n.ok}catch{return!1}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.networkStatus)}catch{}})}getNetworkStatus(){return{...this.networkStatus}}isOnline(){return this.networkStatus.isOnline}isSlowConnection(){const{effectiveType:e,downlink:t}=this.networkStatus;return e==="slow-2g"||e==="2g"||t!==void 0&&t<1}addListener(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}destroy(){typeof window>"u"||(window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.connectionMonitor&&(clearInterval(this.connectionMonitor),this.connectionMonitor=null),this.listeners.clear())}}const v=A.getInstance();class D{static instance;queue=new Map;processing=!1;QUEUE_STORE="offline_queue";constructor(){this.loadQueue()}static getInstance(){return D.instance||(D.instance=new D),D.instance}async enqueue(e,t="medium",n=[]){const s={operation:e,priority:t,dependencies:n};this.queue.set(e.id,s),await this.persistQueue()}async dequeue(e){this.queue.delete(e),await this.persistQueue()}getNextOperations(e=10){const t=[],n=new Set,s=Array.from(this.queue.values()).sort((i,a)=>{const r={high:3,medium:2,low:1},o=r[a.priority]-r[i.priority];return o!==0?o:i.operation.timestamp.getTime()-a.operation.timestamp.getTime()});for(const i of s){if(t.length>=e)break;i.dependencies.every(r=>n.has(r)||!this.queue.has(r))&&(t.push(i.operation),n.add(i.operation.id))}return t}getAllOperations(){return Array.from(this.queue.values()).map(e=>e.operation)}size(){return this.queue.size}isEmpty(){return this.queue.size===0}async clear(){this.queue.clear(),await this.persistQueue()}getOperationsByEntity(e){return Array.from(this.queue.values()).filter(t=>t.operation.entity===e).map(t=>t.operation)}getOperationsByEntityId(e){return Array.from(this.queue.values()).filter(t=>t.operation.entityId===e).map(t=>t.operation)}async incrementRetryCount(e){const t=this.queue.get(e);return t?(t.operation.retryCount++,t.operation.retryCount>=t.operation.maxRetries?(await this.dequeue(e),!1):(await this.persistQueue(),!0)):!1}async optimizeQueue(){const e=new Map;for(const t of this.queue.values()){const n=`${t.operation.entity}:${t.operation.entityId}`;e.has(n)||e.set(n,[]),e.get(n).push(t)}for(const[t,n]of e){if(n.length<=1)continue;n.sort((a,r)=>r.operation.timestamp.getTime()-a.operation.timestamp.getTime());const s=new Set,i=new Set;for(const a of n){const r=a.operation.type;if(r==="delete"){i.clear(),i.add(a.operation.id);break}else{if(r==="create"&&s.has("update"))continue;(r==="update"&&!s.has(r)||r==="create"&&!s.has("update"))&&i.add(a.operation.id)}s.add(r)}for(const a of n)i.has(a.operation.id)||this.queue.delete(a.operation.id)}await this.persistQueue()}async loadQueue(){try{await p.init();const e=await p.get("offline_queue","queue");e&&Array.isArray(e.items)&&(this.queue=new Map(e.items.map(t=>[t.operation.id,{...t,operation:{...t.operation,timestamp:new Date(t.operation.timestamp)}}])))}catch(e){console.error("Failed to load offline queue:",e),this.queue=new Map}}async persistQueue(){try{await p.init();const t={id:"queue",items:Array.from(this.queue.values()),lastUpdated:new Date};await p.put("offline_queue",t)}catch(e){console.error("Failed to persist offline queue:",e)}}}const S=D.getInstance();class W{strategies=new Map;constructor(){this.registerDefaultStrategies()}registerStrategy(e,t){this.strategies.set(e,t)}async resolveConflict(e){const t=this.strategies.get(e.conflictType);if(!t)throw new Error(`No resolution strategy found for conflict type: ${e.conflictType}`);const n=await t.resolve(e);return e.resolved=!0,n}detectConflicts(e,t){const n=[];return t?(this.hasVersionConflict(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"version",timestamp:new Date,resolved:!1}),this.hasConcurrentEdit(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"concurrent_edit",timestamp:new Date,resolved:!1}),n):((e.type==="update"||e.type==="delete")&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:null,conflictType:"deleted_remotely",timestamp:new Date,resolved:!1}),n)}hasVersionConflict(e,t){return e.metadata?.version!==void 0&&t.metadata?.version!==void 0&&e.metadata.version!==t.metadata.version}hasConcurrentEdit(e,t){const n=new Date(e.metadata?.modified||0),s=new Date(t.metadata?.modified||0);return Math.abs(n.getTime()-s.getTime())<5*60*1e3}registerDefaultStrategies(){this.registerStrategy("version",new K),this.registerStrategy("concurrent_edit",new V),this.registerStrategy("deleted_remotely",new X),this.registerStrategy("deleted_locally",new G)}}class K{async resolve(e){const t=new Date(e.localData.metadata?.modified||0),n=new Date(e.remoteData.metadata?.modified||0);return t>n?e.localData:e.remoteData}}class V{async resolve(e){const{localData:t,remoteData:n}=e;if(this.isContentModule(t))return this.mergeContentModule(t,n);if(this.isUserProgress(t))return this.mergeUserProgress(t,n);if(this.isUserSettings(t))return this.mergeUserSettings(t,n);const s=new Date(t.metadata?.modified||0),i=new Date(n.metadata?.modified||0);return s>i?t:n}isContentModule(e){return e&&typeof e.title=="string"&&Array.isArray(e.blocks)}isUserProgress(e){return e&&typeof e.moduleId=="string"&&typeof e.userId=="string"}isUserSettings(e){return e&&typeof e.userId=="string"&&e.preferences}mergeContentModule(e,t){const n=Math.max(...(e.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),s=Math.max(...(t.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),i=n>s?e:t,a={views:(e.analytics?.views??0)+(t.analytics?.views??0),completions:(e.analytics?.completions??0)+(t.analytics?.completions??0),averageScore:((e.analytics?.averageScore??0)+(t.analytics?.averageScore??0))/2||0,averageTime:((e.analytics?.averageTime??0)+(t.analytics?.averageTime??0))/2||0},r=Array.from(new Set([...e.metadata?.tags??[],...t.metadata?.tags??[]]));return{...i,metadata:{...i.metadata,tags:r,modified:new Date,version:Math.max(e.metadata?.version??0,t.metadata?.version??0)+1},analytics:{...i.analytics,...a}}}mergeUserProgress(e,t){return{...e,score:Math.max(e.score??0,t.score??0),timeSpent:(e.timeSpent??0)+(t.timeSpent??0),lastAccessed:new Date(Math.max(e.lastAccessed.getTime(),t.lastAccessed.getTime())),attempts:e.attempts+t.attempts,notes:e.notes&&t.notes?`${e.notes}
---
${t.notes}`:e.notes||t.notes,status:this.getMostAdvancedStatus(e.status,t.status)}}mergeUserSettings(e,t){return{...e,preferences:{...t.preferences,...e.preferences}}}getMostAdvancedStatus(e,t){const n={"not-started":0,"in-progress":1,completed:2},s=n[e]||0,i=n[t]||0,a=Math.max(s,i);return Object.keys(n)[a]}}class X{async resolve(e){return console.warn("User prompt strategy not implemented, using local data"),e.localData}}class G{async resolve(e){return e.remoteData}}const H=new W;class E{static instance;updates=new Map;rollbackCallbacks=new Map;constructor(){}static getInstance(){return E.instance||(E.instance=new E),E.instance}applyOptimisticUpdate(e){const t=crypto.randomUUID(),n=this.captureCurrentState(e.entity,e.entityId);this.applyUpdateToState(e);const s={id:t,operationId:e.id,entity:e.entity,entityId:e.entityId,previousState:n,newState:e.data,timestamp:new Date,applied:!0};return this.updates.set(t,s),this.rollbackCallbacks.set(t,()=>{this.rollbackUpdate(t)}),t}confirmUpdate(e){this.updates.get(e)&&(this.updates.delete(e),this.rollbackCallbacks.delete(e))}rollbackUpdate(e){const t=this.updates.get(e);!t||!t.applied||(this.restoreState(t.entity,t.entityId,t.previousState),t.applied=!1,m.addNotification({type:"warning",message:`Update to ${t.entity} failed and was rolled back`}))}rollbackOperation(e){for(const[t,n]of this.updates)n.operationId===e&&this.rollbackUpdate(t)}getPendingUpdates(){return Array.from(this.updates.values()).filter(e=>e.applied)}clearAll(){this.updates.clear(),this.rollbackCallbacks.clear()}captureCurrentState(e,t){switch(e){case"content":return w.content.nodes.get(t);case"progress":return w.progress.userProgress.get(t);case"settings":return w.user.settings;default:return null}}applyUpdateToState(e){switch(e.entity){case"content":this.applyContentUpdate(e);break;case"progress":this.applyProgressUpdate(e);break;case"settings":this.applySettingsUpdate(e);break;case"relationships":this.applyRelationshipUpdate(e);break}}applyContentUpdate(e){switch(e.type){case"create":m.addKnowledgeNode(e.data);break;case"update":m.updateKnowledgeNode(e.entityId,e.data);break;case"delete":m.removeKnowledgeNode(e.entityId);break}}applyProgressUpdate(e){switch(e.type){case"create":case"update":m.updateUserProgress(e.entityId,e.data);break;case"delete":w.progress.userProgress.delete(e.entityId);break}}applySettingsUpdate(e){e.type==="update"&&(w.user.settings={...w.user.settings,...e.data})}applyRelationshipUpdate(e){console.log("Relationship update applied optimistically:",e)}restoreState(e,t,n){if(n)switch(e){case"content":n?m.updateKnowledgeNode(t,n):m.removeKnowledgeNode(t);break;case"progress":n?m.updateUserProgress(t,n):w.progress.userProgress.delete(t);break;case"settings":w.user.settings=n;break}}}const L=E.getInstance();class R{static instance;config=null;syncInterval=null;isSyncing=!1;lastSyncAttempt=null;constructor(){this.setupNetworkListener()}static getInstance(){return R.instance||(R.instance=new R),R.instance}initialize(e){this.config=e,this.startPeriodicSync()}startPeriodicSync(){!this.config||this.syncInterval||typeof window>"u"||(this.syncInterval=window.setInterval(()=>{v.isOnline()&&!this.isSyncing&&this.sync()},this.config.syncInterval))}stopPeriodicSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async sync(){if(!this.config||this.isSyncing||!v.isOnline())return{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:"Sync not available",retryable:!1,timestamp:new Date}]};this.isSyncing=!0,m.setSyncStatus(!0),this.lastSyncAttempt=new Date;try{const e=S.getNextOperations(this.config.batchSize);if(e.length===0)return await this.pullRemoteChanges(),{success:!0,operationsProcessed:0,conflicts:[],errors:[]};const t=await this.processSyncBatch(e);for(const n of e)t.errors.some(i=>i.operationId===n.id)||(await S.dequeue(n.id),L.confirmUpdate(n.id));return t}catch(e){return console.error("Sync failed:",e),{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:e instanceof Error?e.message:"Unknown sync error",retryable:!0,timestamp:new Date}]}}finally{this.isSyncing=!1,m.setSyncStatus(!1)}}async processSyncBatch(e){const t={success:!0,operationsProcessed:0,conflicts:[],errors:[]};for(const n of e)try{const s=await this.processSyncOperation(n);if(t.operationsProcessed++,t.conflicts.push(...s.conflicts),s.conflicts.length>0)for(const i of s.conflicts)try{const a=await H.resolveConflict(i);await this.applyResolvedData(n,a)}catch(a){t.errors.push({operationId:n.id,error:`Conflict resolution failed: ${a}`,retryable:!1,timestamp:new Date})}}catch(s){t.success=!1,t.errors.push({operationId:n.id,error:s instanceof Error?s.message:"Unknown operation error",retryable:this.isRetryableError(s),timestamp:new Date}),await S.incrementRetryCount(n.id)||L.rollbackOperation(n.id)}return t}async processSyncOperation(e){const t=this.getEndpointForOperation(e),n=this.getHttpMethodForOperation(e);let s=null;(e.type==="update"||e.type==="delete")&&(s=await this.fetchRemoteData(e.entity,e.entityId));const i=H.detectConflicts(e,s);if(i.length>0)return{conflicts:i};const a=await this.makeRequest(t,{method:n,headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:n!=="DELETE"?JSON.stringify(e.data):void 0});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return{conflicts:[]}}async pullRemoteChanges(){if(!this.config)return;const e=w.sync.lastSync?.toISOString()||new Date(0).toISOString(),t=`${this.config.endpoint}/changes?since=${e}&userId=${this.config.userId}`;try{const n=await this.makeRequest(t,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});if(n.ok){const s=await n.json();await this.applyRemoteChanges(s)}}catch(n){console.error("Failed to pull remote changes:",n)}}async applyRemoteChanges(e){for(const t of e)try{switch(t.entity){case"content":t.type==="delete"?m.removeKnowledgeNode(t.entityId):m.updateKnowledgeNode(t.entityId,t.data);break;case"progress":t.type==="delete"?w.progress.userProgress.delete(t.entityId):m.updateUserProgress(t.entityId,t.data);break;case"settings":t.type!=="delete"&&(w.user.settings={...w.user.settings,...t.data});break}}catch(n){console.error("Failed to apply remote change:",n)}}async applyResolvedData(e,t){switch(e.entity){case"content":m.updateKnowledgeNode(e.entityId,t);break;case"progress":m.updateUserProgress(e.entityId,t);break;case"settings":w.user.settings={...w.user.settings,...t};break}const n=this.getEndpointForOperation(e);await this.makeRequest(n,{method:"PUT",headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:JSON.stringify({...e,data:t,resolved:!0})})}async fetchRemoteData(e,t){if(!this.config)return null;const n=`${this.config.endpoint}/${e}/${t}?userId=${this.config.userId}`;try{const s=await this.makeRequest(n,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});return s.ok?await s.json():null}catch{return null}}async makeRequest(e,t,n=3){for(let s=0;s<n;s++)try{return await fetch(e,{...t,signal:AbortSignal.timeout(1e4)})}catch(i){if(s===n-1)throw i;const a=Math.min(1e3*Math.pow(2,s),1e4);await new Promise(r=>setTimeout(r,a))}throw new Error("Max retries exceeded")}getEndpointForOperation(e){if(!this.config)throw new Error("Sync not configured");return e.type==="create"?`${this.config.endpoint}/${e.entity}?userId=${this.config.userId}`:`${this.config.endpoint}/${e.entity}/${e.entityId}?userId=${this.config.userId}`}getHttpMethodForOperation(e){switch(e.type){case"create":return"POST";case"update":return"PUT";case"delete":return"DELETE";default:return"PUT"}}isRetryableError(e){return e instanceof TypeError||e.name==="AbortError"||e&&typeof e.status=="number"&&e.status>=500&&e.status<600}setupNetworkListener(){v.addListener(e=>{e.isOnline&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),1e3)})}async queueOperation(e,t,n,s,i="medium"){const a={id:crypto.randomUUID(),type:e,entity:t,entityId:t==="settings"?"default-user":n,data:s,timestamp:new Date,retryCount:0,maxRetries:3};return L.applyOptimisticUpdate(a),await S.enqueue(a,i),m.addPendingChange(a.id),v.isOnline()&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),100),a.id}getSyncStatus(){return{isOnline:v.isOnline(),isSyncing:this.isSyncing,lastSync:w.sync.lastSync,pendingOperations:S.size(),lastSyncAttempt:this.lastSyncAttempt}}}const k=R.getInstance();class M{static instance;initialized=!1;constructor(){}static getInstance(){return M.instance||(M.instance=new M),M.instance}async initialize(e){this.initialized||(v.getNetworkStatus(),this.setupNetworkEffects(),e&&k.initialize(e),await S.optimizeQueue(),this.initialized=!0,m.addNotification({type:"info",message:"Sync service initialized"}))}async createContent(e){return await k.queueOperation("create","content",e.id,e,"high")}async updateContent(e,t){return await k.queueOperation("update","content",e,t,"medium")}async deleteContent(e){return await k.queueOperation("delete","content",e,null,"high")}async updateProgress(e,t){return await k.queueOperation("update","progress",e,t,"medium")}async updateSettings(e){return await k.queueOperation("update","settings",w.user.id,e,"low")}async syncNow(){if(!v.isOnline()){m.addNotification({type:"warning",message:"Cannot sync while offline"});return}try{const e=await k.sync();e.success?m.addNotification({type:"success",message:`Synced ${e.operationsProcessed} operations`}):m.addNotification({type:"error",message:`Sync failed: ${e.errors.length} errors`}),e.conflicts.length>0&&m.addNotification({type:"warning",message:`${e.conflicts.length} conflicts resolved automatically`})}catch(e){m.addNotification({type:"error",message:"Sync failed: "+(e instanceof Error?e.message:"Unknown error")})}}getSyncStatus(){const e=k.getSyncStatus(),t=v.getNetworkStatus(),n=L.getPendingUpdates();return{...e,networkStatus:t,pendingOptimisticUpdates:n.length,queueSize:S.size(),canSync:t.isOnline&&!e.isSyncing}}async clearOfflineData(){await S.clear(),L.clearAll(),m.addNotification({type:"info",message:"Offline data cleared"})}getOfflineStats(){const e=S.getAllOperations(),t={total:e.length,byType:{},byEntity:{},oldestOperation:null,newestOperation:null};for(const n of e)t.byType[n.type]=(t.byType[n.type]||0)+1,t.byEntity[n.entity]=(t.byEntity[n.entity]||0)+1,(!t.oldestOperation||n.timestamp<t.oldestOperation)&&(t.oldestOperation=n.timestamp),(!t.newestOperation||n.timestamp>t.newestOperation)&&(t.newestOperation=n.timestamp);return t}setupNetworkEffects(){v.addListener(e=>{if(m.setOnlineStatus(e.isOnline),e.isOnline){const t=S.size();t>0&&m.addNotification({type:"info",message:`Back online! ${t} operations queued for sync`})}else m.addNotification({type:"warning",message:"You are now offline. Changes will be synced when connection is restored."})}),setInterval(async()=>{S.size()>10&&await S.optimizeQueue()},5*60*1e3)}destroy(){k.stopPeriodicSync(),v.destroy(),L.clearAll(),this.initialized=!1}}const he=M.getInstance();class Y{db=null;dbName="web-content-sourcing";version=1;async initialize(){this.db=await Q(this.dbName,this.version,{upgrade(e){const t=e.createObjectStore("sources",{keyPath:"id"});t.createIndex("by-domain","domain"),t.createIndex("by-category","metadata.category"),t.createIndex("by-status","status");const n=e.createObjectStore("content",{keyPath:"id"});n.createIndex("by-url","url"),n.createIndex("by-domain","metadata.domain");const s=e.createObjectStore("jobs",{keyPath:"id"});s.createIndex("by-status","status"),s.createIndex("by-created","createdAt");const i=e.createObjectStore("templates",{keyPath:"id"});i.createIndex("by-type","type"),i.createIndex("by-category","category"),e.createObjectStore("settings",{keyPath:"key"})}})}ensureDB(){if(!this.db)throw new Error("Database not initialized. Call initialize() first.");return this.db}async addSource(e){await this.ensureDB().add("sources",e)}async updateSource(e){await this.ensureDB().put("sources",e)}async getSource(e){return await this.ensureDB().get("sources",e)}async getAllSources(){return await this.ensureDB().getAll("sources")}async getSourcesByDomain(e){return await this.ensureDB().getAllFromIndex("sources","by-domain",e)}async getSourcesByCategory(e){return await this.ensureDB().getAllFromIndex("sources","by-category",e)}async getSourcesByStatus(e){return await this.ensureDB().getAllFromIndex("sources","by-status",e)}async deleteSource(e){await this.ensureDB().delete("sources",e)}async addContent(e){await this.ensureDB().add("content",e)}async updateContent(e){await this.ensureDB().put("content",e)}async getContent(e){return await this.ensureDB().get("content",e)}async getContentByUrl(e){return await this.ensureDB().getFromIndex("content","by-url",e)}async getAllContent(){return await this.ensureDB().getAll("content")}async deleteContent(e){await this.ensureDB().delete("content",e)}async addJob(e){await this.ensureDB().add("jobs",e)}async updateJob(e){await this.ensureDB().put("jobs",e)}async getJob(e){return await this.ensureDB().get("jobs",e)}async getJobsByStatus(e){return await this.ensureDB().getAllFromIndex("jobs","by-status",e)}async getAllJobs(){return await this.ensureDB().getAll("jobs")}async deleteJob(e){await this.ensureDB().delete("jobs",e)}async addTemplate(e){await this.ensureDB().add("templates",e)}async updateTemplate(e){await this.ensureDB().put("templates",e)}async getTemplate(e){return await this.ensureDB().get("templates",e)}async getTemplatesByType(e){return await this.ensureDB().getAllFromIndex("templates","by-type",e)}async getAllTemplates(){return await this.ensureDB().getAll("templates")}async deleteTemplate(e){await this.ensureDB().delete("templates",e)}async setSetting(e,t){await this.ensureDB().put("settings",{key:e,value:t})}async getSetting(e){return(await this.ensureDB().get("settings",e))?.value}async deleteSetting(e){await this.ensureDB().delete("settings",e)}async clear(){const t=this.ensureDB().transaction(["sources","content","jobs","templates","settings"],"readwrite");await Promise.all([t.objectStore("sources").clear(),t.objectStore("content").clear(),t.objectStore("jobs").clear(),t.objectStore("templates").clear(),t.objectStore("settings").clear()]),await t.done}async getStats(){const e=this.ensureDB(),[t,n,s,i]=await Promise.all([e.count("sources"),e.count("content"),e.count("jobs"),e.count("templates")]);return{sources:t,content:n,jobs:s,templates:i}}}const g=new Y;let _;const Z=typeof window>"u";Z?_=(await import("./svelte-actions-bridge.js")).svelteActions:_=(await import("./webContentState.svelte.js")).webContentActions;const C=O("web-content-error-handler");class ${static instance;errorHistory=[];maxHistorySize=100;static getInstance(){return $.instance||($.instance=new $),$.instance}handleError(e,t,n){const s=this.categorizeError(e,t,n);return C.error(`${n} failed in ${t}:`,{code:s.code,message:s.message,details:s.details}),this.addToHistory(s),this.showUserNotification(s),s.recoverable&&this.attemptRecovery(s,t,n),s}categorizeError(e,t,n){const i={details:{context:t,operation:n,originalError:e},timestamp:new Date};if(e instanceof TypeError&&e.message.includes("fetch"))return{...i,code:"NETWORK_ERROR",message:"Network connection failed",recoverable:!0,retryable:!0,userMessage:"Unable to connect to the website. Please check your internet connection and try again."};if(e.name==="AbortError"||e.message.includes("timeout"))return{...i,code:"TIMEOUT_ERROR",message:"Request timed out",recoverable:!0,retryable:!0,userMessage:"The request took too long to complete. The website might be slow or unavailable."};if(e.status){const a=e.status;if(a===404)return{...i,code:"NOT_FOUND",message:"Content not found",recoverable:!1,retryable:!1,userMessage:"The requested page could not be found. Please check the URL and try again."};if(a===403)return{...i,code:"ACCESS_DENIED",message:"Access denied",recoverable:!1,retryable:!1,userMessage:"Access to this content is restricted. You may need special permissions to view it."};if(a===429)return{...i,code:"RATE_LIMITED",message:"Rate limit exceeded",recoverable:!0,retryable:!0,userMessage:"Too many requests have been made. Please wait a moment before trying again."};if(a>=500)return{...i,code:"SERVER_ERROR",message:"Server error",recoverable:!0,retryable:!0,userMessage:"The website is experiencing technical difficulties. Please try again later."}}return t.includes("extraction")||t.includes("parsing")?{...i,code:"EXTRACTION_ERROR",message:"Failed to extract content",recoverable:!0,retryable:!1,userMessage:"Unable to extract readable content from this page. The page format may not be supported."}:t.includes("storage")||e.name==="QuotaExceededError"?{...i,code:"STORAGE_ERROR",message:"Storage operation failed",recoverable:!0,retryable:!1,userMessage:"Unable to save content. Your storage may be full or unavailable."}:t.includes("transformation")||t.includes("analysis")?{...i,code:"TRANSFORMATION_ERROR",message:"Content transformation failed",recoverable:!0,retryable:!0,userMessage:"Unable to transform this content into interactive format. The content structure may not be suitable."}:e.message?.includes("Invalid URL")||t.includes("validation")?{...i,code:"INVALID_URL",message:"Invalid URL provided",recoverable:!1,retryable:!1,userMessage:"The provided URL is not valid. Please check the URL format and try again."}:{...i,code:"UNKNOWN_ERROR",message:e.message||"An unknown error occurred",recoverable:!1,retryable:!1,userMessage:"An unexpected error occurred. Please try again or contact support if the problem persists."}}addToHistory(e){this.errorHistory.unshift(e),this.errorHistory.length>this.maxHistorySize&&(this.errorHistory=this.errorHistory.slice(0,this.maxHistorySize))}showUserNotification(e){const t=this.getNotificationType(e.code);_.addNotification({type:t,message:e.userMessage})}getNotificationType(e){switch(e){case"RATE_LIMITED":case"TIMEOUT_ERROR":return"warning";case"NOT_FOUND":case"ACCESS_DENIED":case"INVALID_URL":return"error";case"EXTRACTION_ERROR":case"TRANSFORMATION_ERROR":return"warning";default:return"error"}}attemptRecovery(e,t,n){switch(C.info(`Attempting recovery for ${e.code} in ${t}`),e.code){case"NETWORK_ERROR":case"TIMEOUT_ERROR":this.scheduleRetry(e,t,n);break;case"RATE_LIMITED":this.scheduleDelayedRetry(e,t,n,6e4);break;case"STORAGE_ERROR":this.attemptStorageCleanup();break;case"EXTRACTION_ERROR":this.tryAlternativeExtraction(e,t);break;default:C.info(`No recovery strategy available for ${e.code}`)}}scheduleRetry(e,t,n){const s=this.getRetryCount(e.code),i=Math.min(1e3*Math.pow(2,s),3e4);C.info(`Scheduling retry ${s+1} for ${e.code} in ${i}ms`),setTimeout(()=>{_.addNotification({type:"info",message:`Retrying ${n}... (attempt ${s+1})`})},i)}scheduleDelayedRetry(e,t,n,s){C.info(`Scheduling delayed retry for ${e.code} in ${s}ms`),setTimeout(()=>{_.addNotification({type:"info",message:`Rate limit should be cleared. You can try ${n} again.`})},s)}attemptStorageCleanup(){try{C.info("Attempting storage cleanup..."),_.addNotification({type:"info",message:"Attempting to free up storage space..."}),C.info("Storage cleanup completed")}catch(e){C.error("Storage cleanup failed:",e)}}tryAlternativeExtraction(e,t){C.info("Trying alternative extraction methods..."),_.addNotification({type:"info",message:"Trying alternative content extraction methods..."})}getRetryCount(e){return this.errorHistory.filter(t=>t.code===e).length}getErrorStats(){const e={};let t=0,n=0;for(const s of this.errorHistory)e[s.code]=(e[s.code]||0)+1,s.recoverable&&t++,s.retryable&&n++;return{total:this.errorHistory.length,byCode:e,recent:this.errorHistory.slice(0,10),recoverable:t,retryable:n}}clearHistory(){this.errorHistory=[],C.info("Error history cleared")}shouldRetry(e,t=3){return this.errorHistory.filter(s=>s.code===e).filter(s=>Date.now()-s.timestamp.getTime()<3e5).length<t}getErrorGuidance(e){switch(e){case"NETWORK_ERROR":return{message:"Network connection failed",suggestions:["Check your internet connection","Try again in a few moments","Verify the website is accessible"],canRetry:!0};case"NOT_FOUND":return{message:"Content not found",suggestions:["Verify the URL is correct","Check if the page has moved","Try accessing the page directly in your browser"],canRetry:!1};case"ACCESS_DENIED":return{message:"Access denied",suggestions:["The content may require login","Check if you have permission to access this content","Try accessing the page directly in your browser"],canRetry:!1};case"EXTRACTION_ERROR":return{message:"Content extraction failed",suggestions:["The page format may not be supported","Try a different URL from the same site","Check if the page loads correctly in your browser"],canRetry:!0};default:return{message:"An error occurred",suggestions:["Try again in a few moments","Check your internet connection","Contact support if the problem persists"],canRetry:!0}}}}const ee=$.getInstance();class te{logger=O("web-content-fetcher");defaultOptions={timeout:3e4,userAgent:"Mozilla/5.0 (compatible; WebContentFetcher/2.0; +https://example.com/bot)",followRedirects:!0,maxRedirects:5,extractAssets:!0,cleanContent:!0,preserveInteractivity:!1,useHeadlessBrowser:!1,retryAttempts:3,retryDelay:1e3,acceptedContentTypes:["text/html","application/xhtml+xml","application/xml","text/xml","application/json","application/rss+xml","application/atom+xml"],extractionMethod:"auto"};retryConfig={maxAttempts:3,baseDelay:1e3,maxDelay:3e4,backoffMultiplier:2,retryableErrors:["NETWORK_ERROR","TIMEOUT_ERROR","SERVER_ERROR","RATE_LIMITED"]};contentTypeHandlers=[];constructor(){this.initializeContentTypeHandlers()}initializeContentTypeHandlers(){this.contentTypeHandlers.push({canHandle:e=>e.includes("text/html")||e.includes("application/xhtml+xml"),extract:this.extractHtmlContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("application/json"),extract:this.extractJsonContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("application/xml")||e.includes("text/xml")||e.includes("application/rss+xml")||e.includes("application/atom+xml"),extract:this.extractXmlContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("text/plain"),extract:this.extractPlainTextContent.bind(this)})}async fetch(e,t={}){const n={...this.defaultOptions,...t},s=Date.now();try{this.logger.info(`Fetching content from: ${e}`);const i=new URL(e);return await this.fetchWithRetry(e,n,s)}catch(i){const a=Date.now()-s,r=ee.handleError(i,"fetch","URL content fetching");return{id:`error_${Date.now()}`,url:e,title:"Failed to fetch content",content:{html:"",text:"",images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(e),contentType:"error",language:"en",readingTime:0,wordCount:0,keywords:[],description:r.userMessage,attribution:e,tags:["error",r.code.toLowerCase()],category:"error"},extraction:{method:"error",confidence:0,qualityScore:0,issues:[r.message],processingTime:a},fetchedAt:new Date().toISOString(),success:!1}}}async fetchWithRetry(e,t,n){let s=null;const i=t.retryAttempts||this.retryConfig.maxAttempts;for(let a=1;a<=i;a++)try{this.logger.info(`Fetch attempt ${a}/${i} for: ${e}`);const r=await this.performSingleFetch(e,t),o=Date.now()-n;return r.extraction.processingTime=o,this.logger.info(`Content fetched successfully in ${o}ms on attempt ${a}`),r}catch(r){if(s=r instanceof Error?r:new Error(String(r)),this.shouldRetryError(s)&&a<i){const c=this.calculateRetryDelay(a);this.logger.warn(`Attempt ${a} failed, retrying in ${c}ms:`,s.message),await this.sleep(c)}else throw this.logger.error(`All ${a} attempts failed for ${e}:`,s),s}throw s||new Error("All retry attempts failed")}async performSingleFetch(e,t){const n=new AbortController,s=setTimeout(()=>n.abort(),t.timeout);try{if(t.useHeadlessBrowser||await this.shouldUseHeadlessBrowser(e))return await this.fetchWithHeadlessBrowser(e,t);const a=await fetch(e,{signal:n.signal,headers:this.buildHeaders(t),redirect:t.followRedirects?"follow":"manual"});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const r=a.headers.get("content-type")||"text/html",o=await a.text(),c=a.url,l=this.contentTypeHandlers.find(d=>d.canHandle(r));return l?await l.extract(o,c,t):await this.extractHtmlContent(o,c,t)}finally{clearTimeout(s)}}buildHeaders(e){const t=e.acceptedContentTypes?.join(",")||"text/html,application/xhtml+xml,application/xml;q=0.9,application/json;q=0.8,*/*;q=0.7";return{"User-Agent":e.userAgent,Accept:t,"Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",DNT:"1","Upgrade-Insecure-Requests":"1"}}shouldRetryError(e){const t=e.message.toLowerCase();return e.name.toLowerCase()==="aborterror"||t.includes("timeout")||t.includes("network")||t.includes("fetch")||t.includes("503")||t.includes("502")||t.includes("500")||t.includes("429")||t.includes("connection")}calculateRetryDelay(e){const t=this.retryConfig.baseDelay,n=this.retryConfig.backoffMultiplier,s=this.retryConfig.maxDelay,i=Math.random()*.1*t,a=Math.min(t*Math.pow(n,e-1)+i,s);return Math.floor(a)}sleep(e){return new Promise(t=>setTimeout(t,e))}async shouldUseHeadlessBrowser(e){const t=this.safeParseDomain(e).toLowerCase();return["twitter.com","x.com","facebook.com","instagram.com","linkedin.com","reddit.com","youtube.com","tiktok.com","discord.com","slack.com","notion.so","airtable.com"].some(s=>t.includes(s))}async fetchWithHeadlessBrowser(e,t){this.logger.info(`Headless browser requested for ${e}, falling back to regular fetch`);const n={...t,timeout:(t.timeout||3e4)*2};return await this.performSingleFetch(e,n)}async extractHtmlContent(e,t,n){const i=new DOMParser().parseFromString(e,"text/html"),a=this.extractMetadata(i,t,t),r=await this.extractMainContentAdvanced(i,n),o=this.extractImages(i,t),c=this.extractCodeBlocks(i),l=this.extractTables(i),d=this.detectCharts(i);return{id:`content_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,url:t,finalUrl:t,title:a.description||"Untitled",content:{html:r.html,text:r.text,images:o,codeBlocks:c,tables:l,charts:d,blocks:[]},metadata:a,extraction:{method:n.extractionMethod||"auto",confidence:this.calculateExtractionConfidence(i,r),qualityScore:this.calculateQualityScore(r,a),issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractJsonContent(e,t,n){try{const s=JSON.parse(e),i=`json_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,a=this.extractTextFromJson(s),r=this.extractTitleFromJson(s)||"JSON Content";return{id:i,url:t,finalUrl:t,title:r,content:{html:`<pre><code class="language-json">${JSON.stringify(s,null,2)}</code></pre>`,text:a,images:[],codeBlocks:[{id:"json_data",code:JSON.stringify(s,null,2),language:"json",interactive:!1,executable:!1}],tables:this.extractTablesFromJson(s),charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"json",language:"en",readingTime:Math.ceil(a.split(" ").length/200),wordCount:a.split(" ").length,keywords:this.extractKeywordsFromJson(s),description:r,attribution:t,tags:["json","data"],category:"data"},extraction:{method:"json",confidence:.9,qualityScore:.8,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}catch(s){throw new Error(`Failed to parse JSON content: ${s instanceof Error?s.message:String(s)}`)}}async extractXmlContent(e,t,n){try{const s=new DOMParser;let i;try{if(i=s.parseFromString(e,"application/xml"),i.querySelector("parsererror")||i.documentElement.nodeName==="parsererror"||!i.documentElement)throw new Error("XML parsing failed")}catch{if(i=s.parseFromString(e,"text/html"),!i.documentElement)throw new Error("Invalid XML content")}const a=`xml_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;if(i.querySelector("rss, feed"))return await this.extractRssFeedContent(i,t,n);const o=i.documentElement.textContent||"",c=this.extractTitleFromXml(i)||"XML Content";return{id:a,url:t,finalUrl:t,title:c,content:{html:`<pre><code class="language-xml">${this.escapeHtml(e)}</code></pre>`,text:o,images:[],codeBlocks:[{id:"xml_data",code:e,language:"xml",interactive:!1,executable:!1}],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"xml",language:"en",readingTime:Math.ceil(o.split(" ").length/200),wordCount:o.split(" ").length,keywords:[],description:c,attribution:t,tags:["xml","data"],category:"data"},extraction:{method:"xml",confidence:.8,qualityScore:.7,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}catch(s){throw new Error(`Failed to parse XML content: ${s instanceof Error?s.message:String(s)}`)}}async extractRssFeedContent(e,t,n){const s=`rss_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,i=e.querySelector("title")?.textContent||"RSS Feed",a=e.querySelector("description")?.textContent||"",r=Array.from(e.querySelectorAll("item, entry")).map((l,d)=>{const h=l.querySelector("title")?.textContent||`Item ${d+1}`,u=l.querySelector("description, summary")?.textContent||"",y=l.querySelector("link")?.textContent||l.querySelector("link")?.getAttribute("href")||"",b=l.querySelector("pubDate, published")?.textContent||"";return{title:h,description:u,link:y,date:b}}),o=`
            <h1>${this.escapeHtml(i)}</h1>
            <p>${this.escapeHtml(a)}</p>
            <div class="rss-items">
                ${r.map(l=>`
                    <article class="rss-item">
                        <h2><a href="${this.escapeHtml(l.link)}">${this.escapeHtml(l.title)}</a></h2>
                        <p>${this.escapeHtml(l.description)}</p>
                        ${l.date?`<time>${this.escapeHtml(l.date)}</time>`:""}
                    </article>
                `).join("")}
            </div>
        `,c=`${i}
${a}

${r.map(l=>`${l.title}
${l.description}
${l.link}`).join(`

`)}`;return{id:s,url:t,finalUrl:t,title:i,content:{html:o,text:c,images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"rss",language:"en",readingTime:Math.ceil(c.split(" ").length/200),wordCount:c.split(" ").length,keywords:[],description:a,attribution:t,tags:["rss","feed","news"],category:"news"},extraction:{method:"rss",confidence:.9,qualityScore:.8,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractPlainTextContent(e,t,n){const s=`text_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,a=e.split(`
`)[0]?.trim()||"Plain Text Content";return{id:s,url:t,finalUrl:t,title:a,content:{html:`<pre>${this.escapeHtml(e)}</pre>`,text:e,images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"text",language:"en",readingTime:Math.ceil(e.split(" ").length/200),wordCount:e.split(" ").length,keywords:[],description:a,attribution:t,tags:["text"],category:"document"},extraction:{method:"text",confidence:.7,qualityScore:.6,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractMainContentAdvanced(e,t){switch(t.extractionMethod||"auto"){case"readability":return this.extractWithReadabilityAlgorithm(e,t);case"semantic":return this.extractWithSemanticAnalysis(e,t);case"heuristic":return this.extractMainContent(e,t);case"auto":default:try{return this.extractWithSemanticAnalysis(e,t)}catch{try{return this.extractWithReadabilityAlgorithm(e,t)}catch{return this.extractMainContent(e,t)}}}}extractWithReadabilityAlgorithm(e,t){const n=[];e.querySelectorAll("div, article, section, main, p").forEach(a=>{let r=0;const c=(a.textContent||"").length;c>25&&(r+=1),c>100&&(r+=1),c>500&&(r+=2);const l=a.querySelectorAll("p");r+=l.length;const d=a.querySelectorAll("a"),h=Array.from(d).reduce((z,I)=>z+(I.textContent?.length||0),0);(c>0?h/c:0)>.3&&(r-=2);const y=a.className.toLowerCase(),b=a.id.toLowerCase();(y.includes("content")||y.includes("article")||y.includes("main"))&&(r+=2),(y.includes("sidebar")||y.includes("nav")||y.includes("ad"))&&(r-=2),(b.includes("content")||b.includes("article")||b.includes("main"))&&(r+=2),(b.includes("sidebar")||b.includes("nav")||b.includes("ad"))&&(r-=2),n.push({element:a,score:r})}),n.sort((a,r)=>r.score-a.score);const i=n[0];if(i&&i.score>0){const a=i.element.cloneNode(!0);return t.cleanContent&&this.cleanContent(a),{html:a.innerHTML,text:a.textContent||""}}return this.extractMainContent(e,t)}extractWithSemanticAnalysis(e,t){const n=["main",'[role="main"]',"article",'[role="article"]',".content","#content",".post-content",".entry-content",".article-content",".main-content"];for(const s of n){const i=e.querySelector(s);if(i){const a=i.cloneNode(!0);t.cleanContent&&this.cleanContent(a);const r=a.textContent||"";if(r.length>100)return{html:a.innerHTML,text:r}}}return this.extractWithReadabilityAlgorithm(e,t)}extractTextFromJson(e){return typeof e=="string"?e:typeof e=="number"||typeof e=="boolean"?String(e):Array.isArray(e)?e.map(t=>this.extractTextFromJson(t)).join(" "):typeof e=="object"&&e!==null?Object.values(e).map(t=>this.extractTextFromJson(t)).join(" "):""}extractTitleFromJson(e){if(typeof e=="object"&&e!==null){const t=["title","name","label","heading","subject"];for(const n of t)if(e[n]&&typeof e[n]=="string")return e[n]}return null}extractKeywordsFromJson(e){const t=[];if(typeof e=="object"&&e!==null){const n=["keywords","tags","categories","labels"];for(const s of n)e[s]&&(Array.isArray(e[s])?t.push(...e[s].filter(i=>typeof i=="string")):typeof e[s]=="string"&&t.push(...e[s].split(",").map(i=>i.trim())))}return[...new Set(t)]}extractTablesFromJson(e){const t=[];if(typeof e=="object"&&e!==null){for(const[n,s]of Object.entries(e))if(Array.isArray(s)&&s.length>0){const i=s[0];if(typeof i=="object"&&i!==null){const a=Object.keys(i),r=s.map(o=>a.map(c=>String(o[c]||"")));t.push({id:`json_table_${t.length}`,headers:a,rows:r})}}}if(Array.isArray(e)&&e.length>0){const n=e[0];if(typeof n=="object"&&n!==null){const s=Object.keys(n),i=e.map(a=>s.map(r=>String(a[r]||"")));t.push({id:`json_table_${t.length}`,headers:s,rows:i})}}return t}extractTitleFromXml(e){const t=["title","name","label","heading"];for(const n of t){const s=e.querySelector(n);if(s?.textContent)return s.textContent.trim()}return null}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}extractMetadata(e,t,n){const s=new URL(n).hostname,i=e.querySelector("title")?.textContent?.trim()||e.querySelector('meta[property="og:title"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:title"]')?.getAttribute("content")||e.querySelector("h1")?.textContent?.trim()||"Untitled",a=e.querySelector('meta[name="description"]')?.getAttribute("content")||e.querySelector('meta[property="og:description"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:description"]')?.getAttribute("content")||"",r=e.querySelector('meta[name="author"]')?.getAttribute("content")||e.querySelector('meta[property="article:author"]')?.getAttribute("content")||e.querySelector('[rel="author"]')?.textContent?.trim(),o=this.extractDate(e,['meta[property="article:published_time"]','meta[name="date"]','meta[name="publish-date"]',"time[datetime]"]),c=this.extractDate(e,['meta[property="article:modified_time"]','meta[name="last-modified"]','meta[http-equiv="last-modified"]']),l=e.documentElement.lang||e.querySelector('meta[http-equiv="content-language"]')?.getAttribute("content")||"en",h=(e.querySelector('meta[name="keywords"]')?.getAttribute("content")||"").split(",").map(I=>I.trim()).filter(I=>I.length>0),u=this.determineContentType(e,i,a),b=(e.body?.textContent||"").split(/\s+/).filter(I=>I.length>0).length,z=Math.ceil(b/200);return{description:i,author:r,publishDate:o,lastModified:c,domain:s,contentType:u,language:l,readingTime:z,wordCount:b,keywords:h,attribution:t,tags:[],category:this.categorizeContent(u,s,i,a)}}extractMainContent(e,t){let n=e.querySelector("main")||e.querySelector("article")||e.querySelector('[role="main"]')||e.querySelector(".content")||e.querySelector("#content")||e.querySelector(".post-content")||e.querySelector(".entry-content");if(n||(n=e.body),!n)return{html:"",text:""};const s=n.cloneNode(!0);t.cleanContent&&this.cleanContent(s);const i=s.innerHTML,a=s.textContent||"";return{html:i,text:a}}cleanContent(e){["script","style","noscript",".advertisement",".ads",".ad",".social-share",".share-buttons",".comments",".comment-section",".sidebar",".navigation",".nav",".header",".footer",".popup",".modal",".overlay"].forEach(n=>{e.querySelectorAll(n).forEach(s=>s.remove())}),e.querySelectorAll("*").forEach(n=>{["onclick","onload","onerror","data-track","data-analytics"].forEach(i=>{n.hasAttribute(i)&&n.removeAttribute(i)})})}extractImages(e,t){const n=[];return e.querySelectorAll("img").forEach((i,a)=>{const r=i.getAttribute("src");if(r)try{const o=new URL(r,t).href;n.push({id:`img_${a}`,src:o,alt:i.getAttribute("alt")||"",caption:i.getAttribute("title")||"",width:i.naturalWidth||void 0,height:i.naturalHeight||void 0})}catch{}}),n}extractCodeBlocks(e){const t=[];return e.querySelectorAll("pre code, code, .highlight, .code-block").forEach((s,i)=>{const a=s.textContent||"";if(a.trim().length>10){const r=this.detectCodeLanguage(s,a);t.push({id:`code_${i}`,code:a.trim(),language:r,filename:s.getAttribute("data-filename")||void 0,interactive:!1,executable:!1})}}),t}extractTables(e){const t=[];return e.querySelectorAll("table").forEach((s,i)=>{const a=[],r=[];s.querySelectorAll("thead th, tr:first-child th").forEach(l=>{a.push(l.textContent?.trim()||"")}),s.querySelectorAll("tbody tr, tr").forEach(l=>{const d=l.querySelectorAll("td, th");if(d.length>0){const h=[];d.forEach(u=>{h.push(u.textContent?.trim()||"")}),r.push(h)}}),r.length>0&&t.push({id:`table_${i}`,headers:a.length>0?a:void 0,rows:r})}),t}detectCharts(e){const t=[];return['canvas[id*="chart"]',".chart",".graph",".visualization","[data-chart]","[data-graph]","svg.chart","svg.graph"].forEach(s=>{e.querySelectorAll(s).forEach((i,a)=>{t.push({id:`chart_${t.length}`,type:this.detectChartType(i),selector:s,detected:!0,data:null})})}),t}detectChartType(e){const t=e.className.toLowerCase(),n=e.id.toLowerCase();return t.includes("line")||n.includes("line")?"line":t.includes("bar")||n.includes("bar")?"bar":t.includes("pie")||n.includes("pie")?"pie":t.includes("scatter")||n.includes("scatter")?"scatter":t.includes("area")||n.includes("area")?"area":"unknown"}detectCodeLanguage(e,t){const n=e.className.toLowerCase(),s={javascript:/\b(javascript|js)\b/,typescript:/\b(typescript|ts)\b/,python:/\b(python|py)\b/,java:/\bjava\b/,cpp:/\b(cpp|c\+\+)\b/,csharp:/\b(csharp|c#)\b/,html:/\bhtml\b/,css:/\bcss\b/,sql:/\bsql\b/,json:/\bjson\b/,xml:/\bxml\b/,bash:/\b(bash|shell|sh)\b/};for(const[i,a]of Object.entries(s))if(a.test(n))return i;return t.includes("function")&&t.includes("{")?"javascript":t.includes("def ")&&t.includes(":")?"python":t.includes("public class")||t.includes("import java")?"java":t.includes("<html")||t.includes("<!DOCTYPE")?"html":t.includes("SELECT")&&t.includes("FROM")?"sql":t.startsWith("{")&&t.endsWith("}")?"json":"text"}extractDate(e,t){for(const n of t){const s=e.querySelector(n);if(s){const i=s.getAttribute("content")||s.getAttribute("datetime")||s.textContent;if(i){const a=new Date(i);if(!isNaN(a.getTime()))return a}}}}determineContentType(e,t,n){const s=(t+" "+n).toLowerCase();return s.includes("tutorial")||s.includes("how to")||s.includes("guide")?"tutorial":s.includes("news")||s.includes("breaking")?"news":s.includes("blog")||s.includes("post")?"blog":s.includes("research")||s.includes("paper")||s.includes("study")?"research":s.includes("documentation")||s.includes("docs")||s.includes("api")?"documentation":e.querySelector("article")||e.querySelector('[itemtype*="Article"]')?"article":"webpage"}categorizeContent(e,t,n,s){const i=(n+" "+s+" "+t).toLowerCase();return i.includes("tech")||i.includes("programming")||i.includes("code")?"technology":i.includes("science")||i.includes("research")?"science":i.includes("business")||i.includes("finance")||i.includes("market")?"business":i.includes("health")||i.includes("medical")?"health":i.includes("education")||i.includes("learning")?"education":"general"}calculateExtractionConfidence(e,t){let n=.5;return e.querySelector('main, article, [role="main"]')&&(n+=.2),t.text.length>500&&(n+=.1),t.text.length>2e3&&(n+=.1),e.querySelector("h1, h2, h3")&&(n+=.1),Math.min(n,1)}calculateQualityScore(e,t){let n=.5;e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),t.description&&t.description.length>10&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.author&&(n+=.05),t.publishDate&&(n+=.05),t.keywords.length>0&&(n+=.05);const s=e.html.toLowerCase();return(s.includes("<h1")||s.includes("<h2"))&&(n+=.05),s.includes("<p>")&&(n+=.05),(s.includes("<ul>")||s.includes("<ol>"))&&(n+=.05),Math.min(n,1)}safeParseDomain(e){try{return new URL(e).hostname}catch{return"unknown"}}addContentTypeHandler(e){this.contentTypeHandlers.push(e)}removeContentTypeHandler(e){const t=this.contentTypeHandlers.indexOf(e);t>-1&&this.contentTypeHandlers.splice(t,1)}getSupportedContentTypes(){return this.defaultOptions.acceptedContentTypes||[]}async checkIfNeedsJavaScript(e){return this.shouldUseHeadlessBrowser(e)}isRetryableError(e){const t=e.message.toLowerCase();return e.name==="AbortError"||t.includes("timeout")||t.includes("network")||t.includes("fetch")||t.includes("503")||t.includes("502")||t.includes("500")}}const J=new te;class ne{config={similarityThreshold:.3,tagMatchWeight:.4,contentMatchWeight:.3,titleMatchWeight:.3,enableAutomaticPrerequisites:!0,enableAutomaticRelated:!0,maxAutoRelationships:5};updateConfig(e){this.config={...this.config,...e}}async integrateContent(e,t){const n=Date.now();try{await this.createKnowledgeNode(e,t);const s=await this.detectRelationships(t);return this.addToSearchIndex(t),await this.updateRecommendations(t),await this.generateLearningPathSuggestions(t),await this.recordIntegrationMetrics(n),s}catch(s){throw new Error(`Integration failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async createKnowledgeNode(e,t){const n=await this.findAppropriateParent(t),s=Math.min(5,Math.max(1,t.metadata.difficulty));return{id:t.id,title:t.title,type:"module",parent:n,metadata:{difficulty:s,estimatedTime:t.metadata.estimatedTime,prerequisites:t.relationships.prerequisites,tags:[...t.metadata.tags,"imported",`source:${e.domain}`,`type:${e.metadata.category}`]},progress:{completed:!1,lastAccessed:new Date}}}async findAppropriateParent(e){}async detectRelationships(e){const t=await p.getAll("modules"),n=[],s=[];for(const r of t){if(r.id===e.id)continue;const o=this.calculateContentSimilarity(e,r);if(o.score>=this.config.similarityThreshold){const c=this.determineRelationshipType(e,r,o);n.push({targetContentId:r.id,relationshipType:c,confidence:o.score,reasoning:o.reasons.join(", "),automatic:!0}),s.push(`Found ${c} relationship with "${r.title}" (confidence: ${(o.score*100).toFixed(1)}%)`)}}n.sort((r,o)=>o.confidence-r.confidence);const i=n.slice(0,this.config.maxAutoRelationships);(this.config.enableAutomaticRelated||this.config.enableAutomaticPrerequisites)&&await this.createAutomaticRelationships(e.id,i);const a=i.length>0?i.reduce((r,o)=>r+o.confidence,0)/i.length:0;return{sourceContentId:e.id,suggestedRelationships:i,confidence:a,reasoning:s}}calculateContentSimilarity(e,t){let n=0;const s=[],i=e.metadata.tags.filter(b=>t.metadata.tags.includes(b)),a=i.length/Math.max(e.metadata.tags.length,t.metadata.tags.length);n+=a*this.config.tagMatchWeight,i.length>0&&s.push(`Common tags: ${i.join(", ")}`);const r=e.title.toLowerCase().split(/\s+/),o=t.title.toLowerCase().split(/\s+/),c=r.filter(b=>o.includes(b)),l=c.length/Math.max(r.length,o.length);n+=l*this.config.titleMatchWeight,c.length>0&&s.push(`Common title words: ${c.join(", ")}`);const d=this.extractContentText(e),h=this.extractContentText(t),u=this.calculateTextSimilarity(d,h);return n+=u*this.config.contentMatchWeight,u>.1&&s.push(`Content similarity: ${(u*100).toFixed(1)}%`),Math.abs(e.metadata.difficulty-t.metadata.difficulty)<=1&&(n+=.1,s.push("Similar difficulty levels")),{score:Math.min(1,n),reasons:s}}extractContentText(e){return e.blocks.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(n=>n.question).join(" ")||"";default:return""}}).join(" ").toLowerCase()}calculateTextSimilarity(e,t){const n=new Set(e.split(/\s+/).filter(r=>r.length>3)),s=new Set(t.split(/\s+/).filter(r=>r.length>3)),i=new Set(Array.from(n).filter(r=>s.has(r))),a=new Set(Array.from(n).concat(Array.from(s)));return a.size>0?i.size/a.size:0}determineRelationshipType(e,t,n){return t.metadata.difficulty<e.metadata.difficulty&&n.reasons.some(r=>r.includes("basic")||r.includes("intro")||r.includes("fundamental"))?"prerequisite":n.reasons.some(a=>a.includes("part")||a.includes("chapter")||a.includes("lesson"))?"sequence":n.reasons.some(a=>a.includes("example")||a.includes("demo")||a.includes("tutorial"))?"example":"related"}async createAutomaticRelationships(e,t){for(const n of t)try{(n.relationshipType==="related"&&this.config.enableAutomaticRelated||n.relationshipType==="prerequisite"&&this.config.enableAutomaticPrerequisites||n.relationshipType==="sequence"||n.relationshipType==="example")&&await U.createLink(e,n.targetContentId,n.relationshipType,n.confidence,n.reasoning,!0)}catch{}}addToSearchIndex(e){B.indexModule(e)}async updateRecommendations(e){const t=B.getRelatedContent(e.id,new Map([[e.id,e]]),new Map);await p.add("content_recommendations",{contentId:e.id,relatedContent:t.map(n=>n.id),lastUpdated:new Date},"Updated recommendations for imported content")}async generateLearningPathSuggestions(e){const t=[],n=await p.getAll("paths"),s=await p.getAll("modules");for(const a of n){const r=s.filter(c=>a.modules.includes(c.id)),o=await this.calculatePathSimilarity(e,r);o.score>.4&&t.push({pathId:a.id,name:`Enhanced ${a.name}`,description:`${a.description} - Enhanced with imported content from ${e.metadata.tags.join(", ")}`,suggestedModules:[...a.modules,e.id],estimatedDuration:a.estimatedDuration+e.metadata.estimatedTime,difficulty:Math.max(a.difficulty,e.metadata.difficulty),confidence:o.score,reasoning:o.reasons})}const i=await U.getLinksForContent(e.id);if(i.length>0){const a=i.map(r=>r.sourceId===e.id?r.targetId:r.sourceId);t.push({pathId:`generated-${e.id}`,name:`Learning Path: ${e.title}`,description:"Auto-generated learning path based on imported content and related materials",suggestedModules:[e.id,...a.slice(0,3)],estimatedDuration:e.metadata.estimatedTime*2,difficulty:e.metadata.difficulty,confidence:.7,reasoning:["Based on automatic relationship detection","Includes related existing content"]})}return t.sort((a,r)=>r.confidence-a.confidence)}async calculatePathSimilarity(e,t){let n=0;const s=[],i=new Set(t.flatMap(h=>h.metadata.tags)),a=e.metadata.tags.filter(h=>i.has(h)),r=a.length/Math.max(e.metadata.tags.length,i.size);n+=r*.5,a.length>0&&s.push(`Common tags with path: ${a.join(", ")}`);const o=t.map(h=>h.metadata.difficulty).sort((h,u)=>h-u);e.metadata.difficulty>=o[0]&&e.metadata.difficulty<=o[o.length-1]&&(n+=.3,s.push("Difficulty fits path progression"));const d=(await U.getLinksForContent(e.id)).filter(h=>t.some(u=>u.id===h.targetId||u.id===h.sourceId));return d.length>0&&(n+=.2,s.push(`Has relationships with ${d.length} path modules`)),{score:Math.min(1,n),reasons:s}}async recordIntegrationMetrics(e){const t=Date.now()-e;try{const n=await p.get("integration_metrics","current")||{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0},s={...n,totalImportedContent:n.totalImportedContent+1,averageIntegrationTime:(n.averageIntegrationTime+t)/2};await p.put("integration_metrics",s,"Updated integration metrics")}catch{}}async getIntegrationMetrics(){try{return await p.get("integration_metrics","current")}catch{return{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0}}}async createManualRelationship(e,t,n,s){const i=await U.createLink(e,t,n,1,s,!1);try{const a=await this.getIntegrationMetrics();a.manualRelationshipsCreated+=1,await p.put("integration_metrics",a,"Updated manual relationship count")}catch{}return i}async getContentRecommendations(e,t,n=10){const s=[],a=(await p.getAll("modules")).filter(r=>r.metadata.tags.includes("imported")&&!t.has(r.id));for(const r of a){const o=await U.getLinksForContent(r.id);if(o.filter(d=>d.type==="prerequisite"&&d.targetId===r.id).map(d=>d.sourceId).every(d=>t.has(d))){const d=[];let h=.5;const u=o.filter(y=>t.has(y.sourceId)||t.has(y.targetId));h+=u.length*.1,u.length>0&&d.push({type:"prerequisite-completed",weight:.3,description:`Related to ${u.length} completed modules`}),s.push({contentId:r.id,score:Math.min(1,h),reasons:d,type:"related-topic"})}}return s.sort((r,o)=>o.score-r.score).slice(0,n)}}const N=new ne;class se{logger=O("source-manager");initialized=!1;async initialize(){this.initialized||(await g.initialize(),this.initialized=!0,this.logger.info("Source Manager initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async addSource(e){await this.ensureInitialized();const{url:t,title:n,category:s="web-content",tags:i=[],metadata:a={}}=e;this.logger.info("Adding new content source",{url:t,category:s,tags:i});try{const o=new URL(t).hostname,c=await this.findDuplicateSource(t);if(c)return this.logger.warn("Duplicate source detected",{url:t,existingSourceId:c.id}),{sourceId:c.id,source:c,isDuplicate:!0,duplicateOf:c.id};const l=`source_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,d=new Date,h={id:l,url:t,title:n||`Content from ${o}`,domain:o,importDate:d,lastChecked:d,status:"active",metadata:{author:a.author,publishDate:a.publishDate?new Date(a.publishDate):void 0,lastModified:a.lastModified?new Date(a.lastModified):void 0,domain:o,contentType:a.contentType||"article",language:a.language||"en",readingTime:a.readingTime||0,wordCount:a.wordCount||0,keywords:a.keywords||[],description:a.description||"",license:a.license,attribution:t,tags:i,category:s,contentHash:a.contentHash},usage:{timesReferenced:0,lastAccessed:d,generatedModules:[]}};return await g.addSource(h),this.logger.info("Content source added successfully",{sourceId:l,url:t,domain:o,category:s}),{sourceId:l,source:h,isDuplicate:!1}}catch(r){throw this.logger.error("Failed to add content source:",r),new Error(`Failed to add source: ${r instanceof Error?r.message:"Unknown error"}`)}}async listSources(e){await this.ensureInitialized(),this.logger.info("Listing content sources",{filters:e});try{let t;e?.domain?t=await g.getSourcesByDomain(e.domain):e?.category?t=await g.getSourcesByCategory(e.category):e?.status?t=await g.getSourcesByStatus(e.status):t=await g.getAllSources();const n=(await g.getAllSources()).length;e?.tags&&e.tags.length>0&&(t=t.filter(i=>e.tags.some(a=>i.metadata.tags.includes(a))));const s=t.length;if(e?.offset||e?.limit){const i=e.offset||0,a=e.limit||50;t=t.slice(i,i+a)}return t.sort((i,a)=>a.lastChecked.getTime()-i.lastChecked.getTime()),this.logger.info("Sources listed successfully",{total:n,filtered:s,returned:t.length}),{sources:t,total:n,filtered:s}}catch(t){throw this.logger.error("Failed to list sources:",t),new Error(`Failed to list sources: ${t instanceof Error?t.message:"Unknown error"}`)}}async updateSource(e,t){await this.ensureInitialized(),this.logger.info("Updating content source",{sourceId:e,updates:t});try{const n=await g.getSource(e);if(!n)throw new Error(`Source not found: ${e}`);const s={...n};let i=!1;t&&(t.title&&t.title!==n.title&&(n.title=t.title,i=!0),t.category&&t.category!==n.metadata.category&&(n.metadata.category=t.category,i=!0),t.tags&&JSON.stringify(t.tags)!==JSON.stringify(n.metadata.tags)&&(n.metadata.tags=t.tags,i=!0),t.status&&t.status!==n.status&&(n.status=t.status,i=!0)),n.lastChecked=new Date;try{const r=await J.fetch(n.url);if(r.success){const o=this.generateContentHash(r.content.text);n.metadata.contentHash&&n.metadata.contentHash!==o?(n.status="updated",n.metadata.contentHash=o,i=!0):n.metadata.contentHash||(n.metadata.contentHash=o,i=!0)}}catch(r){this.logger.warn("Failed to check for content updates:",r),n.status="error",i=!0}i&&await g.updateSource(n);const a={sourceId:e,success:!0,hasChanges:i,changes:i?{title:t?.title!==s.title,content:n.metadata.contentHash!==s.metadata.contentHash,metadata:t?.category!==s.metadata.category||JSON.stringify(t?.tags)!==JSON.stringify(s.metadata.tags)}:void 0,updatedAt:new Date};return this.logger.info("Source updated successfully",{sourceId:e,hasChanges:i}),a}catch(n){return this.logger.error("Failed to update source:",n),{sourceId:e,success:!1,hasChanges:!1,error:n instanceof Error?n.message:"Unknown error",updatedAt:new Date}}}async removeSource(e){await this.ensureInitialized(),this.logger.info("Removing content source",{sourceId:e});try{const t=await g.getSource(e);if(!t)return{sourceId:e,removed:!1};await g.deleteSource(e);const n=await g.getContentByUrl(t.url);return n&&await g.deleteContent(n.id),this.logger.info("Source removed successfully",{sourceId:e}),{sourceId:e,removed:!0,source:t}}catch(t){return this.logger.error("Failed to remove source:",t),{sourceId:e,removed:!1}}}async validateSources(e){await this.ensureInitialized();const t=e?(await Promise.all(e.map(n=>g.getSource(n)))).filter(Boolean):await g.getAllSources();this.logger.info("Validating content sources",{sourceCount:t.length,specific:!!e});try{const n=[];for(const i of t){if(!i)continue;const a=[],r=[];try{new URL(i.url)}catch{a.push("Invalid URL format"),r.push("Update URL to valid format")}(Date.now()-i.lastChecked.getTime())/(1e3*60*60*24)>30&&(a.push("Source not checked in over 30 days"),r.push("Update source to refresh content")),i.metadata.description||(a.push("Missing description"),r.push("Add description for better categorization")),i.metadata.keywords.length===0&&(a.push("No keywords defined"),r.push("Add keywords for better searchability"));try{const c=await fetch(i.url,{method:"HEAD"});c.ok||(a.push(`URL returns ${c.status} status`),r.push("Check if URL is still accessible"))}catch{a.push("URL is not accessible"),r.push("Verify URL is correct and accessible")}n.push({sourceId:i.id,valid:a.length===0,issues:a,suggestions:r})}const s={total:n.length,valid:n.filter(i=>i.valid).length,invalid:n.filter(i=>!i.valid).length};return this.logger.info("Source validation completed",s),{validationResults:n,summary:s}}catch(n){throw this.logger.error("Source validation failed:",n),new Error(`Source validation failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async performHealthCheck(e){await this.ensureInitialized(),this.logger.info("Performing source health check",{filters:e});try{let t=await g.getAllSources();if(e&&(e.domain&&(t=t.filter(i=>i.domain===e.domain)),e.category&&(t=t.filter(i=>i.metadata.category===e.category)),e.lastCheckedBefore)){const i=new Date(e.lastCheckedBefore);t=t.filter(a=>a.lastChecked<i)}const n=[];for(const i of t){const a=Date.now();let r;const o=[],c=[];try{const l=new AbortController,d=setTimeout(()=>l.abort(),1e4),h=await fetch(i.url,{method:"HEAD",signal:l.signal});clearTimeout(d);const u=Date.now()-a;h.ok?u>5e3?(r="warning",o.push("Slow response time"),c.push("Monitor performance","Consider caching")):r="healthy":(r="error",o.push(`HTTP ${h.status}: ${h.statusText}`),c.push("Check URL validity","Verify content is still available")),n.push({sourceId:i.id,url:i.url,status:r,lastChecked:new Date,responseTime:u,issues:o,suggestions:c})}catch{const d=Date.now()-a;r="error",o.push("Connection failed"),c.push("Check URL validity","Verify network connectivity"),n.push({sourceId:i.id,url:i.url,status:r,lastChecked:new Date,responseTime:d,issues:o,suggestions:c})}r==="error"&&(i.status="error",await g.updateSource(i))}const s={total:n.length,healthy:n.filter(i=>i.status==="healthy").length,warning:n.filter(i=>i.status==="warning").length,error:n.filter(i=>i.status==="error").length};return this.logger.info("Health check completed",s),{healthChecks:n,summary:s}}catch(t){throw this.logger.error("Health check failed:",t),new Error(`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async detectDuplicates(){await this.ensureInitialized(),this.logger.info("Detecting duplicate sources");try{const e=await g.getAllSources(),t=[],n=new Set;for(const i of e){if(n.has(i.id))continue;const a=e.filter(r=>r.id!==i.id&&!n.has(r.id)&&this.calculateSimilarity(i,r)>.8);if(a.length>0){const r={sourceId:i.id,duplicates:a.map(o=>({id:o.id,similarity:this.calculateSimilarity(i,o),reason:this.getDuplicateReason(i,o)})),suggestions:[{action:"merge",confidence:.8,reasoning:"High similarity detected, consider merging sources"}]};t.push(r),n.add(i.id),a.forEach(o=>n.add(o.id))}}const s={totalSources:e.length,duplicateGroups:t.length,duplicateSources:t.reduce((i,a)=>i+a.duplicates.length+1,0)};return this.logger.info("Duplicate detection completed",s),{duplicates:t,summary:s}}catch(e){throw this.logger.error("Duplicate detection failed:",e),new Error(`Duplicate detection failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getSourceStatistics(){await this.ensureInitialized();const e=await g.getAllSources(),t=new Date,n=new Date(t.getTime()-24*60*60*1e3),s=new Date(t.getTime()-7*24*60*60*1e3),i={total:e.length,byDomain:{},byCategory:{},byStatus:{},recentlyAdded:e.filter(a=>a.importDate>s).length,recentlyUpdated:e.filter(a=>a.lastChecked>n).length};return e.forEach(a=>{i.byDomain[a.domain]=(i.byDomain[a.domain]||0)+1}),e.forEach(a=>{i.byCategory[a.metadata.category]=(i.byCategory[a.metadata.category]||0)+1}),e.forEach(a=>{i.byStatus[a.status]=(i.byStatus[a.status]||0)+1}),i}async integrateWithKnowledgeSystem(e,t){await this.ensureInitialized(),this.logger.info("Integrating content with knowledge system",{sourceId:e.id,moduleId:t.id});try{const n=await N.integrateContent(e,t);return e.usage.timesReferenced+=1,e.usage.lastAccessed=new Date,e.usage.generatedModules.push(t.id),await g.updateSource(e),this.logger.info("Knowledge system integration completed",{sourceId:e.id,relationshipsDetected:n.suggestedRelationships.length,confidence:n.confidence}),{success:!0,relationshipsCreated:n.suggestedRelationships.length,searchIndexed:!0,learningPathSuggestions:0,error:void 0}}catch(n){return this.logger.error("Knowledge system integration failed:",n),{success:!1,relationshipsCreated:0,searchIndexed:!1,learningPathSuggestions:0,error:n instanceof Error?n.message:"Unknown error"}}}async getSource(e){return await this.ensureInitialized(),await g.getSource(e)}async getAllSources(){return await this.ensureInitialized(),await g.getAllSources()}async deleteSource(e){await this.ensureInitialized(),await g.deleteSource(e)}async getContentRecommendations(e,t,n=10){await this.ensureInitialized();try{const s=await N.getContentRecommendations(e,t,n),i=await g.getAllSources(),a=[];for(const r of s){const o=i.find(c=>c.usage.generatedModules.includes(r.contentId));o&&a.push({contentId:r.contentId,title:o.title,sourceUrl:o.url,score:r.score,reasons:r.reasons.map(c=>c.description||"Related content")})}return a}catch(s){return this.logger.error("Failed to get content recommendations:",s),[]}}async findDuplicateSource(e){return await g.getContentByUrl(e)&&(await g.getAllSources()).find(s=>s.url===e)||null}calculateSimilarity(e,t){let n=0;return e.url===t.url?n+=.5:e.domain===t.domain&&(n+=.2),e.title===t.title?n+=.3:(e.title.toLowerCase().includes(t.title.toLowerCase())||t.title.toLowerCase().includes(e.title.toLowerCase()))&&(n+=.15),e.metadata.contentHash&&t.metadata.contentHash&&e.metadata.contentHash===t.metadata.contentHash&&(n+=.2),Math.min(n,1)}getDuplicateReason(e,t){return e.url===t.url?"Identical URL":e.title===t.title?"Identical title":e.metadata.contentHash===t.metadata.contentHash?"Identical content":e.domain===t.domain?"Same domain with similar content":"Similar content detected"}generateContentHash(e){let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return t.toString(36)}}const x=new se;class q{static instance;config;constructor(){this.config={similarityThreshold:.8,methods:["url","title","content","metadata"],weights:{url:.4,title:.3,content:.2,metadata:.1},ignoreParameters:!0,caseSensitive:!1}}static getInstance(){return q.instance||(q.instance=new q),q.instance}updateConfig(e){this.config={...this.config,...e}}async detectDuplicatesForSource(e){const t=await x.getSource(e);if(!t)throw new Error(`Source ${e} not found`);const s=(await x.getAllSources()).filter(r=>r.id!==e),i=[];for(const r of s){const o=this.calculateSimilarity(t,r);if(o>=this.config.similarityThreshold){const c=this.generateSimilarityReason(t,r,o);i.push({id:r.id,similarity:o,reason:c})}}i.sort((r,o)=>o.similarity-r.similarity);const a=this.generateMergeSuggestions(t,i);return{sourceId:e,duplicates:i,suggestions:a}}async detectAllDuplicates(){const e=await x.getAllSources(),t=[],n=new Set;for(const s of e){const i=await this.detectDuplicatesForSource(s.id),a=i.duplicates.filter(r=>{const o=[s.id,r.id].sort().join("-");return n.has(o)?!1:(n.add(o),!0)});a.length>0&&t.push({...i,duplicates:a})}return t}calculateSimilarity(e,t){let n=0,s=0;for(const i of this.config.methods){const a=this.config.weights[i],r=this.calculateMethodSimilarity(e,t,i);n+=r*a,s+=a}return s>0?n/s:0}calculateMethodSimilarity(e,t,n){switch(n){case"url":return this.calculateUrlSimilarity(e.url,t.url);case"title":return this.calculateTextSimilarity(e.title,t.title);case"content":return this.calculateContentSimilarity(e,t);case"metadata":return this.calculateMetadataSimilarity(e.metadata,t.metadata);case"combined":return this.calculateUrlSimilarity(e.url,t.url)*.4+this.calculateTextSimilarity(e.title,t.title)*.6;default:return 0}}calculateUrlSimilarity(e,t){try{const n=new URL(e),s=new URL(t);if(e===t)return 1;if(n.hostname===s.hostname&&n.pathname===s.pathname){if(this.config.ignoreParameters)return 1;const i=new Set(n.searchParams.keys()),a=new Set(s.searchParams.keys()),r=new Set(Array.from(i).filter(c=>a.has(c))),o=new Set([...Array.from(i),...Array.from(a)]);return o.size>0?r.size/o.size:1}return n.hostname===s.hostname?.7:n.pathname===s.pathname&&n.pathname!=="/"?.5:0}catch{return this.calculateTextSimilarity(e,t)}}calculateTextSimilarity(e,t){if(!e||!t)return 0;const n=l=>this.config.caseSensitive?l:l.toLowerCase(),s=n(e),i=n(t);if(s===i)return 1;const a=new Set(s.split(/\s+/).filter(l=>l.length>0)),r=new Set(i.split(/\s+/).filter(l=>l.length>0)),o=new Set(Array.from(a).filter(l=>r.has(l))),c=new Set([...Array.from(a),...Array.from(r)]);return c.size>0?o.size/c.size:0}calculateContentSimilarity(e,t){const n=[this.calculateNumericSimilarity(e.metadata?.wordCount??0,t.metadata?.wordCount??0),this.calculateNumericSimilarity(e.metadata?.readingTime??0,t.metadata?.readingTime??0),this.calculateArraySimilarity(e.metadata?.keywords??[],t.metadata?.keywords??[])];return n.reduce((s,i)=>s+i,0)/n.length}calculateMetadataSimilarity(e,t){const n=[];return e?.author&&t?.author&&n.push(this.calculateTextSimilarity(e.author,t.author)),e?.category&&t?.category&&n.push(e.category===t.category?1:0),n.push(this.calculateArraySimilarity(e?.tags||[],t?.tags||[])),e?.language&&t?.language&&n.push(e.language===t.language?1:0),n.length>0?n.reduce((s,i)=>s+i,0)/n.length:0}calculateNumericSimilarity(e,t){return e===t?1:e===0||t===0?0:Math.min(e,t)/Math.max(e,t)}calculateArraySimilarity(e,t){if(e.length===0&&t.length===0)return 1;if(e.length===0||t.length===0)return 0;const n=new Set(e.map(r=>this.config.caseSensitive?r:r.toLowerCase())),s=new Set(t.map(r=>this.config.caseSensitive?r:r.toLowerCase())),i=new Set(Array.from(n).filter(r=>s.has(r))),a=new Set([...Array.from(n),...Array.from(s)]);return a.size>0?i.size/a.size:0}generateSimilarityReason(e,t,n){const s=[],i=this.calculateUrlSimilarity(e.url,t.url);i>.8?s.push("Very similar URLs"):i>.5&&s.push("Similar domains or paths");const a=this.calculateTextSimilarity(e.title,t.title);return a>.8?s.push("Nearly identical titles"):a>.5&&s.push("Similar titles"),e.metadata?.author&&t.metadata?.author&&e.metadata.author===t.metadata.author&&s.push("Same author"),e.metadata?.category&&t.metadata?.category&&e.metadata.category===t.metadata.category&&s.push("Same category"),s.length>0?s.join(", "):`${Math.round(n*100)}% similarity`}generateMergeSuggestions(e,t){return t.map(n=>n.similarity>.95?{action:"merge",confidence:.9,reasoning:"Very high similarity suggests these are the same content"}:n.similarity>.85?{action:"merge",confidence:.7,reasoning:"High similarity suggests likely duplicates"}:n.similarity>.7?{action:"keep_both",confidence:.6,reasoning:"Moderate similarity - may be related but distinct content"}:{action:"keep_both",confidence:.8,reasoning:"Low similarity - likely different content"})}async mergeSources(e,t,n={preferNewer:!0,preserveUsageStats:!0,combineMetadata:!0,keepBothIfUncertain:!1}){const s=await x.getSource(e);if(!s)throw new Error(`Primary source ${e} not found`);const a=(await Promise.all(t.map(o=>x.getSource(o)))).filter(o=>o!==void 0),r=[];if(n.preserveUsageStats){for(const o of a)if(s.usage&&o.usage){s.usage.timesReferenced+=o.usage.timesReferenced;const c=o.usage.generatedModules.filter(l=>!s.usage.generatedModules.includes(l));s.usage.generatedModules.push(...c),o.usage.lastAccessed>s.usage.lastAccessed&&(s.usage.lastAccessed=o.usage.lastAccessed)}}if(n.combineMetadata){for(const o of a)if(s.metadata&&o.metadata){const c=o.metadata.tags.filter(d=>!s.metadata.tags.includes(d));s.metadata.tags.push(...c);const l=o.metadata.keywords.filter(d=>!s.metadata.keywords.includes(d));s.metadata.keywords.push(...l),o.metadata.author&&s.metadata.author&&o.metadata.author!==s.metadata.author&&r.push(`Author conflict: ${s.metadata.author} vs ${o.metadata.author}`)}}await x.updateSource(s.id,s);for(const o of t)await x.deleteSource(o);return{success:!0,mergedSourceId:e,removedSourceIds:t,conflicts:r,preservedData:{usage:n.preserveUsageStats,metadata:n.combineMetadata,relationships:!0}}}}const ie=q.getInstance();class ae{logger=O("interactive-analyzer");initialized=!1;async initialize(){this.initialized||(await g.initialize(),this.initialized=!0,this.logger.info("Interactive Analyzer initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async analyzeContent(e){await this.ensureInitialized(),this.logger.info("Analyzing content for interactivity",{contentId:e});try{const t=await g.getContent(e);if(!t)throw new Error(`Content not found: ${e}`);const n={interactiveElements:[],javascriptFrameworks:[],dependencies:[],dataRequirements:{},preservationFeasibility:{},opportunities:[]};return n.interactiveElements=this.detectInteractiveElements(t.content.html),n.javascriptFrameworks=this.detectJavaScriptFrameworks(t.content.html),n.dependencies=this.analyzeDependencies(t.content.html),n.preservationFeasibility=this.assessPreservationFeasibility(n.interactiveElements),n.opportunities=this.generateInteractiveOpportunities(t),this.logger.info("Content analysis completed",{contentId:e,interactiveElements:n.interactiveElements.length,frameworks:n.javascriptFrameworks.length,opportunities:n.opportunities.length}),n}catch(t){throw this.logger.error("Failed to analyze content:",t),new Error(`Content analysis failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async transform(e,t){await this.ensureInitialized();const{type:n,domain:s,parameters:i={}}=t;this.logger.info("Transforming content to interactive",{contentId:e,transformationType:n,domain:s});try{const a=await g.getContent(e);if(!a)throw new Error(`Content not found: ${e}`);const r={transformedContent:null,interactiveBlocks:[],preservationResults:{},metadata:{transformationType:n,domain:s,parameters:i,transformedAt:new Date().toISOString()}},o=await this.analyzeContent(e);switch(n){case"auto":r.interactiveBlocks=this.autoTransform(a,o);break;case"visualization":r.interactiveBlocks=this.createVisualizationBlocks(a,s);break;case"simulation":r.interactiveBlocks=this.createSimulationBlocks(a,s);break;case"chart":r.interactiveBlocks=this.createInteractiveCharts(a);break;case"quiz":r.interactiveBlocks=this.generateQuizBlocks(a);break;default:throw new Error(`Unknown transformation type: ${n}`)}return r.transformedContent={...a,blocks:[...a.content.blocks||[],...r.interactiveBlocks],metadata:{...a.metadata,transformed:!0,transformationType:n,transformedAt:new Date().toISOString()}},this.logger.info("Content transformation completed",{contentId:e,blocksCreated:r.interactiveBlocks.length}),r}catch(a){throw this.logger.error("Failed to transform content:",a),new Error(`Content transformation failed: ${a instanceof Error?a.message:"Unknown error"}`)}}async generateVisualization(e,t){await this.ensureInitialized();const{type:n,config:s={}}=t;this.logger.info("Generating visualization",{contentId:e,visualizationType:n});try{const i=await g.getContent(e);if(!i)throw new Error(`Content not found: ${e}`);const a={id:`viz_${Date.now()}`,type:n,contentId:e,data:null,config:null,interactionHandlers:[]};switch(n){case"chart":a.data=this.extractChartData(i),a.config=this.createChartConfig(s),a.interactionHandlers=this.createChartInteractions();break;case"network":a.data=this.extractNetworkData(i),a.config=this.createNetworkConfig(s),a.interactionHandlers=this.createNetworkInteractions();break;case"timeline":a.data=this.extractTimelineData(i),a.config=this.createTimelineConfig(s),a.interactionHandlers=this.createTimelineInteractions();break;case"neural-network":a.data=this.extractNeuralNetworkData(i),a.config=this.createNeuralNetworkConfig(s),a.interactionHandlers=this.createNeuralNetworkInteractions();break;default:throw new Error(`Unknown visualization type: ${n}`)}return{visualization:a,config:a.config,interactionHandlers:a.interactionHandlers}}catch(i){throw this.logger.error("Failed to generate visualization:",i),new Error(`Visualization generation failed: ${i instanceof Error?i.message:"Unknown error"}`)}}detectInteractiveElements(e){const t=[],n=[{selector:"button",type:"button"},{selector:"input",type:"input"},{selector:"select",type:"select"},{selector:"textarea",type:"textarea"},{selector:"form",type:"form"},{selector:"canvas",type:"canvas"},{selector:"svg",type:"svg"},{selector:"[onclick]",type:"clickable"},{selector:"[data-*]",type:"data-element"}],i=new DOMParser().parseFromString(e,"text/html");return n.forEach(({selector:a,type:r})=>{i.querySelectorAll(a).forEach((c,l)=>{t.push({id:`element_${t.length}`,type:r,selector:a,html:c.outerHTML.substring(0,200),detected:"static_analysis",confidence:.8})})}),t}detectJavaScriptFrameworks(e){return[]}analyzeDependencies(e){return[]}assessPreservationFeasibility(e){return{feasible:!0,confidence:.8}}generateInteractiveOpportunities(e){const t=[];e.content.codeBlocks.forEach((s,i)=>{this.isInteractiveCodeCandidate(s)&&t.push({id:`code_${i}`,type:"interactive-code",title:`Interactive Code: ${s.language}`,description:`Make this ${s.language} code block interactive`,confidence:.8,reasoning:`Code block contains ${s.language} code that could be made executable`,sourceElement:`code_block_${i}`,parameters:{language:{type:"text",value:s.language},executable:{type:"boolean",value:!0}}})}),e.content.tables.forEach((s,i)=>{s.rows.length>5&&t.push({id:`table_${i}`,type:"interactive-table",title:"Interactive Data Table",description:"Add filtering and sorting to this data table",confidence:.7,reasoning:`Table has ${s.rows.length} rows and could benefit from interactive features`,sourceElement:`table_${i}`,parameters:{sortable:{type:"boolean",value:!0},filterable:{type:"boolean",value:!0}}})}),e.content.charts.forEach((s,i)=>{t.push({id:`chart_${i}`,type:"interactive-chart",title:`Interactive ${s.type} Chart`,description:`Make this ${s.type} chart interactive with hover and zoom`,confidence:.9,reasoning:"Chart detected and can be enhanced with interactivity",sourceElement:`chart_${i}`,parameters:{chartType:{type:"text",value:s.type},interactive:{type:"boolean",value:!0}}})});const n=e.content.text.toLowerCase();return(n.includes("algorithm")||n.includes("process")||n.includes("step"))&&t.push({id:"simulation_content",type:"simulation",title:"Process Simulation",description:"Create an interactive simulation of the described process",confidence:.6,reasoning:"Content describes processes or algorithms that could be simulated",sourceElement:"main_content",parameters:{simulationType:{type:"text",value:"process"},interactive:{type:"boolean",value:!0}}}),t}isInteractiveCodeCandidate(e){return["javascript","python","html","css","sql"].includes(e.language.toLowerCase())&&e.code.length>50}autoTransform(e,t){return[]}createVisualizationBlocks(e,t){return[]}createSimulationBlocks(e,t){return[]}createInteractiveCharts(e){return[]}generateQuizBlocks(e){return[]}extractChartData(e){return null}createChartConfig(e){return{title:"Chart",description:"Interactive chart",parameters:[],layout:{width:800,height:600,margin:{top:20,right:20,bottom:20,left:20},responsive:!0},styling:{theme:"light",colors:["#1f77b4"],fonts:{family:"Arial",size:12}},animations:{enabled:!0,duration:300,easing:"ease",transitions:[]}}}createChartInteractions(){return[]}extractNetworkData(e){return null}createNetworkConfig(e){return this.createChartConfig(e)}createNetworkInteractions(){return[]}extractTimelineData(e){return null}createTimelineConfig(e){return this.createChartConfig(e)}createTimelineInteractions(){return[]}extractNeuralNetworkData(e){return null}createNeuralNetworkConfig(e){return this.createChartConfig(e)}createNeuralNetworkInteractions(){return[]}}const F=new ae;class P{static instance;config;activeJobs=new Map;jobQueue=[];completedJobs=new Map;isProcessing=!1;logger=O("processing-pipeline");progressReportingTimer;eventListeners=new Map;constructor(){this.config={maxConcurrentJobs:3,retryAttempts:3,retryDelay:1e3,retryBackoffMultiplier:2,maxRetryDelay:3e4,timeoutMs:3e5,enableDuplicateDetection:!0,enableQualityAssessment:!0,enableInteractiveTransformation:!0,enableParallelProcessing:!0,progressReportingInterval:5e3,enableDetailedLogging:!0},this.startProgressReporting()}static getInstance(){return P.instance||(P.instance=new P),P.instance}updateConfig(e){this.config={...this.config,...e},this.logger.info("Pipeline configuration updated",e),e.progressReportingInterval!==void 0&&(this.stopProgressReporting(),this.startProgressReporting())}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const n=this.eventListeners.get(e);if(n){const s=n.indexOf(t);s>-1&&n.splice(s,1)}}emitEvent(e,t){const n=this.eventListeners.get(e);n&&n.forEach(s=>{try{s(t)}catch(i){this.logger.error("Error in event listener:",i)}})}createSingleProcessingJob(e,t="normal",n={}){const s=this.generateJobId(),i=this.createProcessingStages("single"),a={id:s,type:"single",status:"pending",progress:{currentStage:0,totalStages:i.length,stageProgress:0,overallProgress:0},stages:i,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrl:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(a),this.sortJobQueue(),this.logger.info("Single processing job created",{jobId:s,url:e,priority:t}),this.emitEvent("job-created",{job:this.sanitizeJobForEvent(a)}),this.isProcessing||this.processJobQueue(),s}createBatchProcessingJob(e,t="normal",n={}){const s=this.generateJobId();if(this.config.enableParallelProcessing&&n.enableParallel!==!1){const i=e.map(a=>this.createSingleProcessingJob(a,t,{...n,tags:[...n.tags||[],"batch"],batchId:s}));return this.logger.info("Batch processing job created (parallel)",{batchId:s,urlCount:e.length,jobIds:i}),this.emitEvent("batch-created",{batchId:s,urlCount:e.length,jobIds:i,parallel:!0}),s}else{const i=this.createProcessingStages("batch"),a={id:s,type:"batch",status:"pending",progress:{currentStage:0,totalStages:i.length,stageProgress:0,overallProgress:0},stages:i,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrls:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(a),this.sortJobQueue(),this.logger.info("Batch processing job created (sequential)",{batchId:s,urlCount:e.length}),this.emitEvent("batch-created",{batchId:s,urlCount:e.length,parallel:!1}),this.isProcessing||this.processJobQueue(),s}}getJobStatus(e){return this.activeJobs.get(e)||this.jobQueue.find(t=>t.id===e)||this.completedJobs.get(e)}cancelJob(e){const t=this.getJobStatus(e);if(!t)return!1;if(t.status==="pending"){const n=this.jobQueue.findIndex(s=>s.id===e);n>=0&&this.jobQueue.splice(n,1)}return t.status="cancelled",t.completedAt=new Date,!0}getActiveJobs(){return Array.from(this.activeJobs.values())}getJobQueue(){return[...this.jobQueue]}getCompletedJobs(){return Array.from(this.completedJobs.values())}getBatchStatus(e){const t=[...this.jobQueue,...this.activeJobs.values(),...this.completedJobs.values()].filter(r=>r.metadata.batchId===e);if(t.length===0)return null;const n=t.filter(r=>r.status==="completed").length,s=t.filter(r=>r.status==="failed").length,i=t.filter(r=>r.status==="processing").length;let a;return n===t.length?a="completed":s===t.length?a="failed":i>0||n>0?a="processing":a="pending",{batchId:e,totalJobs:t.length,completedJobs:n,failedJobs:s,overallProgress:n/t.length*100,status:a}}getStatistics(){const e=Array.from(this.completedJobs.values()),t=e.filter(i=>i.status==="completed"),n=e.filter(i=>i.startedAt&&i.completedAt).map(i=>i.completedAt.getTime()-i.startedAt.getTime()),s=n.length>0?n.reduce((i,a)=>i+a,0)/n.length:0;return{activeJobs:this.activeJobs.size,queuedJobs:this.jobQueue.length,completedJobs:e.length,totalProcessed:e.length,averageProcessingTime:s,successRate:e.length>0?t.length/e.length*100:0}}async processJobQueue(){if(!this.isProcessing){this.isProcessing=!0;try{for(;this.jobQueue.length>0&&this.activeJobs.size<this.config.maxConcurrentJobs;){const e=this.jobQueue.shift();!e||e.status==="cancelled"||(await new Promise(t=>setTimeout(t,0)),this.activeJobs.set(e.id,e),this.processJob(e).catch(t=>{e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date}).finally(()=>{this.activeJobs.delete(e.id),this.jobQueue.length>0&&setTimeout(()=>void this.processJobQueue(),100)}))}}finally{this.activeJobs.size===0&&this.jobQueue.length===0&&(this.isProcessing=!1)}}}async processJob(e){e.status="processing",e.startedAt=new Date,this.logger.info("Starting job processing",{jobId:e.id,type:e.type}),this.emitEvent("job-started",{job:this.sanitizeJobForEvent(e)});try{for(let t=0;t<e.stages.length;t++){if(this.activeJobs.get(e.id)?.status==="cancelled"){this.logger.info("Job cancelled during processing",{jobId:e.id});return}const n=e.stages[t];e.progress.currentStage=t,e.progress.stageProgress=0,e.stageTimings.set(n.name,{startTime:Date.now()}),this.logger.debug("Processing stage",{jobId:e.id,stage:n.name}),this.emitEvent("stage-started",{jobId:e.id,stage:n.name,stageIndex:t});let s,i=0;for(;i<=this.config.retryAttempts;)try{s=await this.processStageWithTimeout(e,n);break}catch(r){if(i++,i>this.config.retryAttempts)throw r;const o=this.calculateRetryDelay(i);this.logger.warn("Stage failed, retrying",{jobId:e.id,stage:n.name,attempt:i,delay:o,error:r instanceof Error?r.message:"Unknown error"}),this.emitEvent("stage-retry",{jobId:e.id,stage:n.name,attempt:i,delay:o}),await this.delay(o)}const a=e.stageTimings.get(n.name);if(a.endTime=Date.now(),a.duration=a.endTime-a.startTime,e.results.push(s),!s.success)throw new Error(`Stage ${n.name} failed: ${s.metadata.issues.join(", ")}`);e.progress.stageProgress=100,e.progress.overallProgress=(t+1)/e.stages.length*100,e.progressHistory.push({timestamp:new Date,stage:n.name,progress:e.progress.overallProgress}),this.updateTimeEstimate(e),this.logger.debug("Stage completed",{jobId:e.id,stage:n.name,duration:a.duration}),this.emitEvent("stage-completed",{jobId:e.id,stage:n.name,duration:a.duration,progress:e.progress.overallProgress})}e.status="completed",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.info("Job completed successfully",{jobId:e.id,duration:e.completedAt.getTime()-e.startedAt.getTime()}),this.emitEvent("job-completed",{job:this.sanitizeJobForEvent(e)})}catch(t){throw e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.error("Job failed",{jobId:e.id,error:e.error,retryCount:e.retryCount}),this.emitEvent("job-failed",{job:this.sanitizeJobForEvent(e),error:e.error}),t}}async processStage(e,t){const n=Date.now(),s=[];try{let i={};switch(t.name){case"fetch":i=await this.processFetchStage(e,t);break;case"extract":i=await this.processExtractStage(e,t);break;case"store":i=await this.processStoreStage(e,t);break;case"duplicate_check":this.config.enableDuplicateDetection&&(i=await this.processDuplicateCheckStage(e,t));break;case"quality_assessment":this.config.enableQualityAssessment&&(i=await this.processQualityAssessmentStage(e,t));break;case"interactive_transformation":this.config.enableInteractiveTransformation&&(i=await this.processInteractiveTransformationStage(e,t));break;default:s.push(`Unknown stage: ${t.name}`)}const a=this.calculateStageConfidence(t.name,i);return{stage:t.name,success:s.length===0,data:i,metadata:{processingTime:Date.now()-n,confidence:a,issues:s}}}catch(i){return s.push(i instanceof Error?i.message:"Unknown error"),{stage:t.name,success:!1,data:null,metadata:{processingTime:Date.now()-n,confidence:0,issues:s}}}}async processFetchStage(e,t){const n=e.metadata.sourceUrl||e.metadata.sourceUrls?.[0];if(!n)throw new Error("No URL provided for fetch stage");this.logger.debug("Fetching content",{jobId:e.id,url:n});try{const s=await J.fetch(n,{timeout:this.config.timeoutMs,cleanContent:!0,preserveInteractivity:!0});if(!s.success)throw new Error(`Failed to fetch content: ${s.extraction.issues.join(", ")}`);return{webContent:s,url:n,fetchedAt:new Date,success:!0,confidence:s.extraction.confidence}}catch(s){throw this.logger.error("Fetch stage failed",{jobId:e.id,url:n,error:s}),s}}async processExtractStage(e,t){const n=e.results.find(i=>i.stage==="fetch");if(!n?.data?.webContent)throw new Error("No web content available for extraction");const s=n.data.webContent;this.logger.debug("Analyzing content for interactivity",{jobId:e.id,contentId:s.id});try{const i=await x.addSource({url:s.url,title:s.title,metadata:s.metadata}),a=await F.analyzeContent(s.id);return{contentId:i.sourceId,analysis:a,extractionMethod:s.extraction.method,confidence:s.extraction.confidence,interactiveOpportunities:a.opportunities.length}}catch(i){throw this.logger.error("Extract stage failed",{jobId:e.id,error:i}),i}}async processStoreStage(e,t){const n=e.results.find(i=>i.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for storage");const s=n.data.contentId;this.logger.debug("Storing content permanently",{jobId:e.id,contentId:s});try{const i=await g.getSource(s);if(!i)throw new Error("Content not found in source manager");return await x.updateSource(s,{status:"updated"}),{sourceId:s,stored:!0,url:i.url,title:i.title}}catch(i){throw this.logger.error("Store stage failed",{jobId:e.id,error:i}),i}}async processDuplicateCheckStage(e,t){const n=e.results.find(i=>i.stage==="store");if(!n?.data?.sourceId)return{duplicatesFound:!1};const s=await ie.detectDuplicatesForSource(n.data.sourceId);return{duplicatesFound:s.duplicates.length>0,duplicateCount:s.duplicates.length,suggestions:s.suggestions}}async processQualityAssessmentStage(e,t){const n=e.results.find(a=>a.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for quality assessment");const s=n.data.contentId,i=n.data.analysis;this.logger.debug("Assessing content quality",{jobId:e.id,contentId:s});try{const a=await g.getSource(s);if(!a)throw new Error("Source not found for quality assessment");const r=this.assessContentQuality(a,i);return{contentId:s,qualityScore:r.overallScore,readabilityScore:r.readabilityScore,interactivityPotential:r.interactivityScore,accessibilityScore:r.accessibilityScore,suggestions:this.generateQualityImprovements(r),metrics:r}}catch(a){throw this.logger.error("Quality assessment stage failed",{jobId:e.id,error:a}),a}}async processInteractiveTransformationStage(e,t){const n=e.results.find(a=>a.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for transformation");const s=n.data.contentId,i=n.data.analysis;this.logger.debug("Transforming content to interactive",{jobId:e.id,contentId:s,opportunities:i.opportunities.length});try{const a=await F.transform(s,{type:"auto",domain:this.detectDomain(i),parameters:t.config});return{contentId:s,transformationsApplied:a.interactiveBlocks.length,interactiveElementsCreated:a.interactiveBlocks.map(r=>r.type),confidence:this.calculateTransformationConfidence(a),transformedContent:a.transformedContent}}catch(a){throw this.logger.error("Interactive transformation stage failed",{jobId:e.id,error:a}),a}}createProcessingStages(e){const t=[{name:"fetch",processor:"WebContentFetcher",config:{},dependencies:[],outputs:["webContent"]},{name:"extract",processor:"ContentExtractor",config:{},dependencies:["fetch"],outputs:["extractedContent"]},{name:"store",processor:"SourceManager",config:{},dependencies:["extract"],outputs:["sourceId"]}];return this.config.enableDuplicateDetection&&t.push({name:"duplicate_check",processor:"DuplicateDetector",config:{},dependencies:["store"],outputs:["duplicateReport"]}),this.config.enableQualityAssessment&&t.push({name:"quality_assessment",processor:"QualityAssessor",config:{},dependencies:["store"],outputs:["qualityReport"]}),this.config.enableInteractiveTransformation&&t.push({name:"interactive_transformation",processor:"InteractiveTransformer",config:{},dependencies:["quality_assessment"],outputs:["interactiveContent"]}),t}sortJobQueue(){const e={high:3,normal:2,low:1};this.jobQueue.sort((t,n)=>{const s=e[t.metadata.priority],i=e[n.metadata.priority];return s!==i?i-s:t.createdAt.getTime()-n.createdAt.getTime()})}generateJobId(){return`job_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async processStageWithTimeout(e,t){return new Promise((n,s)=>{const i=setTimeout(()=>{s(new Error(`Stage ${t.name} timed out after ${this.config.timeoutMs}ms`))},this.config.timeoutMs);this.processStage(e,t).then(a=>{clearTimeout(i),n(a)}).catch(a=>{clearTimeout(i),s(a)})})}calculateRetryDelay(e){const t=this.config.retryDelay*Math.pow(this.config.retryBackoffMultiplier,e-1);return Math.min(t,this.config.maxRetryDelay)}delay(e){return new Promise(t=>setTimeout(t,e))}updateTimeEstimate(e){if(e.progressHistory.length<2)return;const t=e.progressHistory.slice(-3),n=t.reduce((i,a,r)=>{if(r===0)return i;const o=t[r-1],c=a.timestamp.getTime()-o.timestamp.getTime(),l=a.progress-o.progress;return i+(l>0?c/l:0)},0)/(t.length-1),s=100-e.progress.overallProgress;if(e.progress.estimatedTimeRemaining=s*n,e.startedAt){const i=Date.now()-e.startedAt.getTime();e.progress.throughput=e.progress.overallProgress/i*1e3}}sanitizeJobForEvent(e){return{id:e.id,type:e.type,status:e.status,progress:e.progress,retryCount:e.retryCount,createdAt:e.createdAt,startedAt:e.startedAt,completedAt:e.completedAt,metadata:{priority:e.metadata.priority,tags:e.metadata.tags,batchId:e.metadata.batchId}}}startProgressReporting(){this.progressReportingTimer&&clearInterval(this.progressReportingTimer),this.progressReportingTimer=setInterval(()=>{if(this.activeJobs.size>0){const e=Array.from(this.activeJobs.values()),t=this.getStatistics();this.emitEvent("progress-report",{activeJobs:e.map(n=>this.sanitizeJobForEvent(n)),statistics:t,timestamp:new Date}),this.config.enableDetailedLogging&&this.logger.debug("Progress report",{statistics:t,activeJobCount:e.length})}},this.config.progressReportingInterval)}stopProgressReporting(){this.progressReportingTimer&&(clearInterval(this.progressReportingTimer),this.progressReportingTimer=void 0)}cleanupCompletedJobs(e=24*60*60*1e3){const t=Date.now()-e,n=[];this.completedJobs.forEach((s,i)=>{s.completedAt&&s.completedAt.getTime()<t&&n.push(i)}),n.forEach(s=>this.completedJobs.delete(s)),n.length>0&&this.logger.info("Cleaned up completed jobs",{removedCount:n.length})}detectDomain(e){return e.javascriptFrameworks.some(t=>t.name.includes("React"))?"web-development":e.interactiveElements.some(t=>t.type==="canvas")?"data-visualization":"general"}calculateTransformationConfidence(e){const t=e.interactiveBlocks.length;return t===0?.1:t>=3?.9:.5+t*.2}calculateStageConfidence(e,t){switch(e){case"fetch":return t.confidence||.8;case"extract":return t.confidence||.7;case"store":return t.stored?.9:.1;case"duplicate_check":return .8;case"quality_assessment":return t.qualityScore||.6;case"interactive_transformation":return t.confidence||.7;default:return .5}}assessContentQuality(e,t){const n=e.content,s=e.metadata,i=this.calculateReadabilityScore(n.text),a=t.opportunities.length>0?Math.min(t.opportunities.length*.2,1):.1,r=this.calculateAccessibilityScore(n.html),o=this.calculateEngagementScore(n,s),c=(i+a+r+o)/4;return{readabilityScore:i,interactivityScore:a,accessibilityScore:r,engagementScore:o,overallScore:c}}calculateReadabilityScore(e){const t=e.split(/\s+/).length,n=e.split(/[.!?]+/).length,s=t/n;return s<15?.9:s<20?.7:s<25?.5:.3}calculateAccessibilityScore(e){let t=.5;const n=e.match(/<img[^>]*>/g)||[],s=e.match(/<img[^>]*alt\s*=\s*["'][^"']*["'][^>]*>/g)||[];return n.length>0&&(t+=s.length/n.length*.2),(e.includes("<h1")||e.includes("<h2"))&&(t+=.1),(e.includes("<nav")||e.includes("<main"))&&(t+=.1),e.includes("aria-")&&(t+=.1),Math.min(t,1)}calculateEngagementScore(e,t){let n=.3;return e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),e.images.length>0&&(n+=.1),e.codeBlocks.length>0&&(n+=.1),e.tables.length>0&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.keywords.length>0&&(n+=.1),Math.min(n,1)}generateQualityImprovements(e){const t=[];return e.readabilityScore<.6&&t.push("Consider breaking up long sentences for better readability"),e.interactivityScore<.4&&t.push("Add interactive elements like charts, quizzes, or simulations"),e.accessibilityScore<.7&&t.push("Improve accessibility by adding alt text to images and using semantic HTML"),e.engagementScore<.5&&t.push("Add more visual elements and structured content to increase engagement"),t}}const T=P.getInstance(),ge={startProcessing:async(f,e)=>({success:!0,id:T.createSingleProcessingJob(f[0]??"")}),startBatchProcessing:async(f,e)=>({id:T.createBatchProcessingJob(f)}),onProgressUpdate:f=>{const e=t=>f(t);return T.addEventListener("progress-report",e),()=>T.removeEventListener("progress-report",e)},onJobComplete:f=>{const e=({job:t})=>f(t);return T.addEventListener("job-completed",e),()=>T.removeEventListener("job-completed",e)},onJobError:f=>{const e=({job:t,error:n})=>f(t.id,new Error(n));return T.addEventListener("job-failed",e),()=>T.removeEventListener("job-failed",e)}},re={enableOcr:!0,ocrLanguage:"eng",extractImages:!0,detectCodeBlocks:!0,generateToc:!0,minSectionLength:100,maxSectionDepth:6};class oe{config;constructor(e={}){this.config={...re,...e}}async processPdf(e){try{const t=await e.arrayBuffer(),n=new Uint8Array(t);let s="",i="direct",a=.9;try{s=await this.extractPdfText(n),s.trim().length<100&&this.config.enableOcr&&(s=await this.performOcr(n),i="ocr",a=.7)}catch{if(this.config.enableOcr)s=await this.performOcr(n),i="ocr-fallback",a=.6;else throw new Error("PDF text extraction failed and OCR is disabled")}const r=[];if(this.config.extractImages){const d=await this.extractPdfImages(n);r.push(...d)}const o={originalFormat:"pdf",title:e.name.replace(".pdf",""),created:new Date,modified:new Date,wordCount:this.countWords(s),tags:[],extractionMethod:i,confidence:a},c=await this.buildDocumentStructure(s),l=await this.createContentBlocks(s,c);return{id:this.generateId(),title:o.title,content:l,metadata:o,structure:c,assets:r}}catch(t){throw new Error(`PDF processing failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async processMarkdown(e,t){try{const n=await this.parseMarkdownStructure(e),{content:s,frontmatter:i}=this.extractFrontmatter(e),a=await this.createMarkdownContentBlocks(s,n),r=await this.extractMarkdownAssets(s),o={originalFormat:"markdown",title:i?.title||t?.replace(".md","")||"Untitled",author:i?.author,created:i?.date?new Date(i.date):new Date,modified:new Date,language:i?.language||"en",wordCount:this.countWords(s),tags:i?.tags||[],extractionMethod:"markdown-parser",confidence:.95};return{id:this.generateId(),title:o.title,content:a,metadata:o,structure:n,assets:r}}catch(n){throw new Error(`Markdown processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processWebContent(e,t){try{const n=this.extractMainContent(e),s=await this.buildHtmlStructure(n),i=await this.createHtmlContentBlocks(n,s),a=await this.extractHtmlAssets(n,t),r={originalFormat:"html",title:this.extractHtmlTitle(e)||"Web Content",created:new Date,modified:new Date,wordCount:this.countWords(this.stripHtml(n)),tags:this.extractHtmlTags(e),extractionMethod:"html-parser",confidence:.8};return{id:this.generateId(),title:r.title,content:i,metadata:r,structure:s,assets:a}}catch(n){throw new Error(`Web content processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processDocument(e,t){if(e instanceof File){const n=t||this.detectFileType(e);switch(n){case"pdf":return this.processPdf(e);case"markdown":const s=await e.text();return this.processMarkdown(s,e.name);default:throw new Error(`Unsupported file type: ${n}`)}}else switch(t||this.detectContentType(e)){case"markdown":return this.processMarkdown(e);case"html":return this.processWebContent(e);default:return this.processPlainText(e)}}async extractPdfText(e){throw new Error("PDF text extraction not implemented - requires pdf-parse library")}async performOcr(e){throw new Error("OCR not implemented - requires Tesseract.js library")}async extractPdfImages(e){return[]}async buildDocumentStructure(e){const t=this.detectSections(e),n=this.generateTableOfContents(t),s={maxDepth:this.getMaxDepth(t),sectionCount:this.countAllSections(t),hasImages:e.includes("![")||e.includes("<img"),hasCodeBlocks:e.includes("```")||e.includes("<code"),hasTables:e.includes("|")||e.includes("<table")};return{sections:t,toc:n,metadata:s}}detectSections(e){const t=[],n=e.split(`
`);let s=null,i=0;for(let a=0;a<n.length;a++){const o=n[a].trim().match(/^(#{1,6})\s+(.+)$/);if(o){const c=o[1].length,l=o[2];s&&(s.endPosition=a),s={id:`section-${++i}`,title:l,level:c,content:[],subsections:[],startPosition:a,endPosition:a},t.push(s)}}return s&&(s.endPosition=n.length),this.buildSectionHierarchy(t)}buildSectionHierarchy(e){const t=[],n=[];for(const s of e){for(;n.length>0&&n[n.length-1].level>=s.level;)n.pop();n.length===0?t.push(s):n[n.length-1].subsections.push(s),n.push(s)}return t}generateTableOfContents(e){const t=n=>({id:n.id,title:n.title,level:n.level,position:n.startPosition,children:n.subsections.map(t)});return{entries:e.map(t)}}async createContentBlocks(e,t){const n=[],s=e.split(`
`);for(const i of t.sections){const r=s.slice(i.startPosition,i.endPosition).join(`
`);if(r.trim()&&n.push({id:this.generateId(),type:"text",content:{text:r,format:"markdown"},metadata:{created:new Date,modified:new Date,version:1}}),this.config.detectCodeBlocks){const o=this.extractCodeBlocks(r);n.push(...o)}}return n}extractCodeBlocks(e){const t=[],n=/```(\w+)?\n([\s\S]*?)```/g;let s;for(;(s=n.exec(e))!==null;){const i=s[1]||"text",a=s[2];t.push({id:this.generateId(),type:"code",content:{code:a,language:i,executable:this.isExecutableLanguage(i)},metadata:{created:new Date,modified:new Date,version:1}})}return t}isExecutableLanguage(e){return["javascript","python","typescript","sql"].includes(e.toLowerCase())}async parseMarkdownStructure(e){const t=this.detectMarkdownSections(e),n=this.generateTableOfContents(t),s={maxDepth:this.getMaxDepth(t),sectionCount:this.countAllSections(t),hasImages:/!\[.*?\]\(.*?\)/.test(e),hasCodeBlocks:/```[\s\S]*?```/.test(e),hasTables:/\|.*\|/.test(e)};return{sections:t,toc:n,metadata:s}}detectMarkdownSections(e){const t=[],n=e.split(`
`);let s=0;for(let i=0;i<n.length;i++){const a=n[i],r=a.match(/^(#{1,6})\s+(.+)$/);if(r){t.push({id:`section-${++s}`,title:r[2],level:r[1].length,content:[],subsections:[],startPosition:i,endPosition:i});continue}if(i<n.length-1){const o=n[i+1];if(/^=+$/.test(o)&&a.trim()){t.push({id:`section-${++s}`,title:a.trim(),level:1,content:[],subsections:[],startPosition:i,endPosition:i}),i++;continue}if(/^-+$/.test(o)&&a.trim()){t.push({id:`section-${++s}`,title:a.trim(),level:2,content:[],subsections:[],startPosition:i,endPosition:i}),i++;continue}}}for(let i=0;i<t.length;i++)i<t.length-1?t[i].endPosition=t[i+1].startPosition:t[i].endPosition=n.length;return this.buildSectionHierarchy(t)}extractFrontmatter(e){const t=/^---\n([\s\S]*?)\n---\n([\s\S]*)$/,n=e.match(t);if(!n)return{content:e,frontmatter:null};try{const s=n[1],i={},a=s.split(`
`);for(const r of a){const o=r.indexOf(":");if(o>0){const c=r.substring(0,o).trim(),l=r.substring(o+1).trim();l.startsWith("[")&&l.endsWith("]")?i[c]=l.slice(1,-1).split(",").map(d=>d.trim().replace(/['"]/g,"")):i[c]=l.replace(/['"]/g,"")}}return{content:n[2],frontmatter:i}}catch{return{content:e,frontmatter:null}}}async createMarkdownContentBlocks(e,t){const n=[];for(const s of t.sections){const i=this.extractSectionContent(e,s);if(i.trim()&&n.push({id:this.generateId(),type:"text",content:{text:i,format:"markdown",section:s.title},metadata:{created:new Date,modified:new Date,version:1}}),this.config.detectCodeBlocks){const a=this.extractCodeBlocks(i);n.push(...a)}}if(this.config.detectCodeBlocks){const s=this.extractCodeBlocks(e);for(const i of s)n.some(r=>r.type==="code"&&r.content.code===i.content.code)||n.push(i)}return n}extractSectionContent(e,t){return e.split(`
`).slice(t.startPosition,t.endPosition).join(`
`)}async extractMarkdownAssets(e){const t=[];if(this.config.extractImages){const n=/!\[([^\]]*)\]\(([^)]+)\)/g;let s;for(;(s=n.exec(e))!==null;){const i=s[1],a=s[2];t.push({id:this.generateId(),type:"image",url:a,filename:a.split("/").pop()||"image",size:0,mimeType:this.getMimeTypeFromUrl(a),extractedFrom:"markdown",metadata:{alt:i}})}}return t}buildHtmlStructure(e){const t=/<h([1-6])[^>]*>(.*?)<\/h[1-6]>/gi,n=[];let s,i=0;for(;(s=t.exec(e))!==null;){const c=parseInt(s[1]),l=this.stripHtml(s[2]);n.push({id:`section-${++i}`,title:l,level:c,content:[],subsections:[],startPosition:s.index,endPosition:s.index+s[0].length})}const a=this.buildSectionHierarchy(n),r=this.generateTableOfContents(a),o={maxDepth:this.getMaxDepth(a),sectionCount:this.countAllSections(a),hasImages:/<img[^>]*>/i.test(e),hasCodeBlocks:/<code[^>]*>|<pre[^>]*>/i.test(e),hasTables:/<table[^>]*>/i.test(e)};return Promise.resolve({sections:a,toc:r,metadata:o})}async createHtmlContentBlocks(e,t){const n=[],s=this.stripHtml(e);s.trim()&&n.push({id:this.generateId(),type:"text",content:{text:s,format:"html",originalHtml:e},metadata:{created:new Date,modified:new Date,version:1}});const i=/<pre[^>]*><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi;let a;for(;(a=i.exec(e))!==null;){const r=this.decodeHtml(a[1]);n.push({id:this.generateId(),type:"code",content:{code:r,language:"text",executable:!1},metadata:{created:new Date,modified:new Date,version:1}})}return n}async extractHtmlAssets(e,t){const n=[],s=/<img[^>]+src="([^"]+)"[^>]*>/gi;let i;for(;(i=s.exec(e))!==null;){let a=i[1];t&&!a.startsWith("http")&&(a=new URL(a,t).href),n.push({id:this.generateId(),type:"image",url:a,filename:a.split("/").pop()||"image",size:0,mimeType:this.getMimeTypeFromUrl(a),extractedFrom:"html"})}return n}extractMainContent(e){const t=e.match(/<body[^>]*>([\s\S]*)<\/body>/i);return t?t[1]:e}extractHtmlTitle(e){const t=e.match(/<title[^>]*>(.*?)<\/title>/i);return t?this.stripHtml(t[1]):""}extractHtmlTags(e){const t=/<meta[^>]+name="keywords"[^>]+content="([^"]+)"/i,n=e.match(t);return n?n[1].split(",").map(s=>s.trim()):[]}async processPlainText(e){const t=await this.buildDocumentStructure(e),n=await this.createContentBlocks(e,t),s={originalFormat:"text",title:"Plain Text Document",created:new Date,modified:new Date,wordCount:this.countWords(e),tags:[],extractionMethod:"plain-text",confidence:.5};return{id:this.generateId(),title:s.title,content:n,metadata:s,structure:t,assets:[]}}detectFileType(e){switch(e.name.split(".").pop()?.toLowerCase()){case"pdf":return"pdf";case"md":case"markdown":return"markdown";case"html":case"htm":return"html";default:return"text"}}detectContentType(e){return e.includes("<!DOCTYPE")||e.includes("<html")?"html":e.includes("#")||e.includes("```")||e.includes("*")?"markdown":"text"}countWords(e){return e.trim().split(/\s+/).length}stripHtml(e){return e.replace(/<[^>]*>/g,"").trim()}decodeHtml(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&[^;]+;/g,n=>t[n]||n)}getMimeTypeFromUrl(e){const t=e.split(".").pop()?.toLowerCase();return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp"}[t||""]||"application/octet-stream"}generateId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getMaxDepth(e){let t=0;const n=(s,i)=>{for(const a of s)t=Math.max(t,i),n(a.subsections,i+1)};return n(e,1),t}countAllSections(e){let t=e.length;for(const n of e)t+=this.countAllSections(n.subsections);return t}countAllSections(e){let t=e.length;for(const n of e)t+=this.countAllSections(n.subsections);return t}getMaxDepth(e){if(e.length===0)return 0;let t=0;for(const n of e){t=Math.max(t,n.level);const s=this.getMaxDepth(n.subsections);t=Math.max(t,s)}return t}}new oe;export{x as a,F as i,ge as p,he as s};
