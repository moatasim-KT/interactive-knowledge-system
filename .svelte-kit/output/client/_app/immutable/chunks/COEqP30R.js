const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./hAlw3l8v.js","./D9dWO0Sc.js","./DvEoYHKW.js"])))=>i.map(i=>d[i]);
import{s as g,a as f,b}from"./BdGMWZf_.js";import{o as G}from"./Dob3nYDb.js";import{d as A,s as F}from"./DvEoYHKW.js";const X="modulepreload",Y=function(p,e){return new URL(p,e).href},J={},j=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){const i=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),o=r?.nonce||r?.getAttribute("nonce");s=Promise.allSettled(t.map(c=>{if(c=Y(c,n),c in J)return;J[c]=!0;const l=c.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(!!n)for(let y=i.length-1;y>=0;y--){const w=i[y];if(w.href===c&&(!l||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":X,l||(u.as="script"),u.crossOrigin="",u.href=c,o&&u.setAttribute("nonce",o),document.head.appendChild(u),l)return new Promise((y,w)=>{u.addEventListener("load",y),u.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return s.then(i=>{for(const r of i||[])r.status==="rejected"&&a(r.reason);return e().catch(a)})},Z="InteractiveKnowledgeMedia",ee=1,C="media",S="metadata";class te{db=null;async init(){return new Promise((e,t)=>{const n=indexedDB.open(Z,ee);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=s=>{const a=s.target.result;if(!a.objectStoreNames.contains(C)){const i=a.createObjectStore(C,{keyPath:"id"});i.createIndex("type","type",{unique:!1}),i.createIndex("created","metadata.created",{unique:!1})}if(!a.objectStoreNames.contains(S)){const i=a.createObjectStore(S,{keyPath:"id"});i.createIndex("name","name",{unique:!1}),i.createIndex("type","type",{unique:!1}),i.createIndex("size","size",{unique:!1})}}})}async storeMedia(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((n,s)=>{const a=this.db.transaction([C,S],"readwrite"),i=a.objectStore(C),r=a.objectStore(S);i.put({id:e.id,data:t}),r.put(e),a.oncomplete=()=>n(),a.onerror=()=>s(a.error)})}async getMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const s=this.db.transaction([C,S],"readonly"),a=s.objectStore(C),i=s.objectStore(S);let r=null,o=null;const c=a.get(e),l=i.get(e);c.onsuccess=()=>{r=c.result?.data||null,d()},l.onsuccess=()=>{o=l.result||null,d()};function d(){r!==null&&o!==null&&t(r&&o?{file:o,data:r}:null)}s.onerror=()=>n(s.error)})}async listMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const a=this.db.transaction([S],"readonly").objectStore(S);let i;e?i=a.index("type").getAll(e):i=a.getAll(),i.onsuccess=()=>t(i.result||[]),i.onerror=()=>n(i.error)})}async deleteMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const s=this.db.transaction([C,S],"readwrite"),a=s.objectStore(C),i=s.objectStore(S);a.delete(e),i.delete(e),s.oncomplete=()=>t(),s.onerror=()=>n(s.error)})}async getStorageQuota(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return{used:e.usage||0,total:e.quota||0,available:(e.quota||0)-(e.usage||0)}}return{used:0,total:0,available:0}}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=new Date;return t.setDate(t.getDate()-e),new Promise((n,s)=>{const a=this.db.transaction([C,S],"readwrite"),i=a.objectStore(S),r=a.objectStore(C),o=i.index("created"),c=IDBKeyRange.upperBound(t),l=o.openCursor(c);let d=0;l.onsuccess=h=>{const u=h.target.result;if(u){const y=u.value;r.delete(y.id),i.delete(y.id),d++,u.continue()}},a.oncomplete=()=>n(d),a.onerror=()=>s(a.error)})}close(){this.db&&(this.db.close(),this.db=null)}}const Te=new te;class ne{graphCache=new Map;dependencyCache=new Map;analyticsCache=null;lastCacheUpdate=new Date(0);cacheTimeout=5*60*1e3;async createLink(e,t,n,s=1,a,i=!1,r=!1){r||await this.validateLinkCreation(e,t,n);const o={id:`${e}-${t}-${n}-${Date.now()}`,sourceId:e,targetId:t,type:n,strength:Math.max(0,Math.min(1,s)),metadata:{created:new Date,createdBy:"current-user",description:a,automatic:i}};if(await g.add("links",o,`Created ${n} link`),this.isBidirectionalType(n)){const c=await this.createReverseLink(o);await g.add("links",c,`Created reverse ${n} link`)}return(n==="prerequisite"||n==="dependent")&&await this.updateDependencyChains(e,t,n),this.invalidateCache(),o}async createLinksBatch(e){const t=[];for(const n of e)if(n.operation==="create"){for(const s of n.links)if(s.sourceId&&s.targetId&&s.type)try{const a=await this.createLink(s.sourceId,s.targetId,s.type,s.strength,s.metadata?.description,s.metadata?.automatic||!1,!0);t.push(a)}catch(a){console.warn(`Failed to create link in batch: ${a}`)}}return await this.validateBatchForCircularDependencies(t),t}async updateLink(e,t){const n=await g.get("links",e);if(!n)return null;const s={...n,...t,metadata:{...n.metadata,...t.metadata}};if(await g.update("links",e,s,"Updated link"),this.isBidirectionalType(n.type)){const a=this.getReverseId(n),i=await g.get("links",a);i&&t.strength!==void 0&&await g.update("links",a,{...i,strength:t.strength},"Updated reverse link")}return this.invalidateCache(),s}async deleteLink(e){const t=await g.get("links",e);if(!t)return!1;if(this.isBidirectionalType(t.type)){const n=this.getReverseId(t);await g.delete("links",n,"Deleted reverse link")}return await g.delete("links",e,"Deleted link"),(t.type==="prerequisite"||t.type==="dependent")&&await this.recalculateDependencyChains(),this.invalidateCache(),!0}async findLinks(e={}){return(await g.getAll("links")).filter(n=>{if(e.sourceIds&&!e.sourceIds.includes(n.sourceId)||e.targetIds&&!e.targetIds.includes(n.targetId)||e.types&&!e.types.includes(n.type))return!1;if(e.strengthRange){const[s,a]=e.strengthRange;if(n.strength<s||n.strength>a)return!1}return!(e.automatic!==void 0&&n.metadata.automatic!==e.automatic||e.createdAfter&&n.metadata.created<e.createdAfter||e.createdBefore&&n.metadata.created>e.createdBefore)})}async getLinksForContent(e){const t=await g.getAll("links"),n=t.filter(i=>i.targetId===e),s=t.filter(i=>i.sourceId===e),a=[...n,...s];return{incoming:n,outgoing:s,all:a}}async buildContentGraph(e){const t=e.map(r=>r.id).sort().join("-");if(this.graphCache.has(t)&&!this.isCacheExpired())return this.graphCache.get(t);const n=new Map,s=new Map;for(const r of e){const o=await this.getLinksForContent(r.id);n.set(r.id,{id:r.id,title:r.title,type:this.inferNodeType(r),tags:r.metadata.tags,difficulty:r.metadata.difficulty,incomingLinks:o.incoming.map(c=>c.id),outgoingLinks:o.outgoing.map(c=>c.id)})}const a=await this.findLinks({sourceIds:e.map(r=>r.id),targetIds:e.map(r=>r.id)});for(const r of a)s.set(r.id,r);const i={nodes:n,edges:s};return this.graphCache.set(t,i),this.lastCacheUpdate=new Date,i}async analyzeDependencyChain(e){if(this.dependencyCache.has(e)&&!this.isCacheExpired())return this.dependencyCache.get(e);const t=new Set,n=await this.getPrerequisiteChain(e,t);t.clear();const s=await this.getDependentChain(e,t),a=await this.calculateDepth(e),i=await this.checkAccessibility(e),r={nodeId:e,prerequisites:Array.from(n),dependents:Array.from(s),depth:a,canAccess:i};return this.dependencyCache.set(e,r),r}async detectCircularDependencies(){const e=await this.findLinks({types:["prerequisite","dependent"]}),t=new Map;for(const r of e)r.type==="prerequisite"&&(t.has(r.targetId)||t.set(r.targetId,[]),t.get(r.targetId).push(r.sourceId));const n=[],s=new Set,a=new Set,i=(r,o)=>{if(a.has(r)){const l=o.indexOf(r);l!==-1&&n.push([...o.slice(l),r]);return}if(s.has(r))return;s.add(r),a.add(r),o.push(r);const c=t.get(r)||[];for(const l of c)i(l,[...o]);a.delete(r)};for(const r of t.keys())s.has(r)||i(r,[]);return n}async generateAutomaticLinks(e,t=.7,n=5){const s=[];for(let a=0;a<e.length;a++){const i=e[a],r=[];for(let o=a+1;o<e.length;o++){const c=e[o];if((await this.findLinks({sourceIds:[i.id],targetIds:[c.id]})).length>0)continue;const d=await this.calculateModuleSimilarity(i,c);if(d.score>=t){const h=this.suggestRelationshipType(i,c,d);r.push({module:c,score:d.score,type:h})}}r.sort((o,c)=>c.score-o.score).slice(0,n).forEach(o=>{s.push({id:`auto-${i.id}-${o.module.id}-${o.type}`,sourceId:i.id,targetId:o.module.id,type:o.type,strength:o.score,metadata:{created:new Date,createdBy:"system",description:`Automatically suggested based on ${Math.round(o.score*100)}% similarity`,automatic:!0}})})}return s}async getAnalytics(){if(this.analyticsCache&&!this.isCacheExpired())return this.analyticsCache;const e=await g.getAll("links"),t=e.length,n={prerequisite:0,dependent:0,related:0,similar:0,sequence:0,reference:0,example:0,practice:0};let s=0,a=0,i=0;const r=new Map;for(const u of e)n[u.type]++,s+=u.strength,u.metadata.automatic?a++:i++,r.set(u.sourceId,(r.get(u.sourceId)||0)+1),r.set(u.targetId,(r.get(u.targetId)||0)+1);const o=t>0?s/t:0,c=Array.from(r.entries()).map(([u,y])=>({id:u,connectionCount:y})).sort((u,y)=>y.connectionCount-u.connectionCount).slice(0,10),l=e.sort((u,y)=>u.strength-y.strength),d=l.slice(0,5),h=l.slice(-5).reverse();return this.analyticsCache={totalLinks:t,linksByType:n,averageStrength:o,automaticVsManual:{automatic:a,manual:i},mostConnectedNodes:c,weakestLinks:d,strongestLinks:h},this.analyticsCache}async validateLinkCreation(e,t,n){if(e===t)throw new Error("Cannot create self-referential link");if((await this.findLinks({sourceIds:[e],targetIds:[t],types:[n]})).length>0)throw new Error("Link already exists");if(n==="prerequisite"&&await this.wouldCreateCircularDependency(e,t))throw new Error("Creating this prerequisite link would create a circular dependency")}async wouldCreateCircularDependency(e,t){const n=new Set;return await this.hasPath(t,e,n,["prerequisite"])}async hasPath(e,t,n,s){if(e===t)return!0;if(n.has(e))return!1;n.add(e);const a=await this.findLinks({sourceIds:[e],types:s});for(const i of a)if(await this.hasPath(i.targetId,t,n,s))return!0;return!1}async createReverseLink(e){return{...e,id:this.getReverseId(e),sourceId:e.targetId,targetId:e.sourceId,type:this.getReverseType(e.type)}}getReverseId(e){return`${e.targetId}-${e.sourceId}-${e.type}-reverse`}getReverseType(e){switch(e){case"prerequisite":return"dependent";case"dependent":return"prerequisite";case"related":return"related";case"similar":return"similar";default:return e}}isBidirectionalType(e){return["related","similar","prerequisite"].includes(e)}inferNodeType(e){const t=e.blocks.length,n=e.blocks.some(s=>s.type==="quiz");return t>10||n?"module":t>3?"lesson":"concept"}async calculateModuleSimilarity(e,t){let n=0,s=0;const a=e.metadata.tags.filter(l=>t.metadata.tags.includes(l)),i=a.length/Math.max(e.metadata.tags.length,t.metadata.tags.length,1);n+=i*.4,s+=.4;const r=Math.abs(e.metadata.difficulty-t.metadata.difficulty),o=Math.max(0,1-r/10);n+=o*.3,s+=.3;const c=this.calculateContentTypeSimilarity(e,t);return n+=c*.3,s+=.3,{contentId:t.id,score:s>0?n/s:0,reasons:[{type:"tags",score:i,details:`Common tags: ${a.join(", ")}`},{type:"difficulty",score:o,details:`Difficulty difference: ${r}`},{type:"content",score:c,details:"Content type similarity"}]}}calculateContentTypeSimilarity(e,t){const n=new Set(e.blocks.map(r=>r.type)),s=new Set(t.blocks.map(r=>r.type)),a=new Set([...n].filter(r=>s.has(r))),i=new Set([...n,...s]);return i.size>0?a.size/i.size:0}suggestRelationshipType(e,t,n){const s=t.metadata.difficulty-e.metadata.difficulty;return s>=2?"prerequisite":Math.abs(s)<=1&&n.score>=.8?"related":this.calculateContentTypeSimilarity(e,t)>=.6?"similar":"related"}async getPrerequisiteChain(e,t){if(t.has(e))return new Set;t.add(e);const n=new Set,s=await this.findLinks({targetIds:[e],types:["prerequisite"]});for(const a of s)n.add(a.sourceId),(await this.getPrerequisiteChain(a.sourceId,t)).forEach(r=>n.add(r));return n}async getDependentChain(e,t){if(t.has(e))return new Set;t.add(e);const n=new Set,s=await this.findLinks({sourceIds:[e],types:["prerequisite"]});for(const a of s)n.add(a.targetId),(await this.getDependentChain(a.targetId,t)).forEach(r=>n.add(r));return n}async calculateDepth(e){const t=await this.findLinks({targetIds:[e],types:["prerequisite"]});if(t.length===0)return 0;let n=0;for(const s of t){const a=await this.calculateDepth(s.sourceId);n=Math.max(n,a)}return n+1}async checkAccessibility(e){return!0}async updateDependencyChains(e,t,n){this.dependencyCache.delete(e),this.dependencyCache.delete(t)}async recalculateDependencyChains(){this.dependencyCache.clear()}async validateBatchForCircularDependencies(e){const t=e.filter(s=>s.type==="prerequisite");if(t.length===0)return;const n=new Map;t.forEach(s=>{n.has(s.targetId)||n.set(s.targetId,new Set),n.get(s.targetId).add(s.sourceId)});for(const[s,a]of n.entries())if(this.hasCycleInBatch(s,a,n,new Set))throw new Error(`Batch operation would create circular dependency involving ${s}`)}hasCycleInBatch(e,t,n,s){if(s.has(e))return!0;s.add(e);for(const a of t){const i=n.get(a);if(i&&this.hasCycleInBatch(a,i,n,new Set(s)))return!0}return!1}isCacheExpired(){return Date.now()-this.lastCacheUpdate.getTime()>this.cacheTimeout}invalidateCache(){this.graphCache.clear(),this.dependencyCache.clear(),this.analyticsCache=null}clearCaches(){this.invalidateCache()}}const z=new ne;class se{async createModule(e){const t=new Date,n={...e,metadata:{author:"current-user",created:t,modified:t,version:1,difficulty:e.metadata?.difficulty||1,estimatedTime:e.metadata?.estimatedTime||0,prerequisites:e.metadata?.prerequisites||[],tags:e.metadata?.tags||[],language:e.metadata?.language||"en"}};return await g.add("modules",n,"Initial creation"),n}async getModule(e){return await g.get("modules",e)}async getAllModules(){return await g.getAll("modules")}async updateModule(e,t){const n={...e,metadata:{...e.metadata,modified:new Date,version:e.metadata.version+1}};await g.put("modules",n,t||"Module updated")}async deleteModule(e){await g.delete("modules",e)}async searchModulesByTitle(e){return(await g.getAll("modules")).filter(n=>n.title.toLowerCase().includes(e.toLowerCase()))}async searchModulesByTag(e){return await g.searchByIndex("modules","tags",e)}async searchModulesByAuthor(e){return await g.searchByIndex("modules","author",e)}async searchModulesByDifficulty(e){return await g.searchByIndex("modules","difficulty",e)}async getModulesByDateRange(e,t){const n=IDBKeyRange.bound(e,t);return await g.searchByIndex("modules","created",n)}async getModuleHistory(e){return await g.getVersionHistory(e,"module")}async getModuleVersion(e,t){return await g.getVersion(e,t)}async restoreModuleVersion(e,t){const n=await g.getVersion(e,t);if(!n)throw new Error(`Version ${t} not found for module ${e}`);const s={...n.data,metadata:{...n.data.metadata,modified:new Date,version:n.data.metadata.version+1}};await g.put("modules",s,`Restored to version ${t}`)}}const Ie=new se;class R{static instance;networkStatus={isOnline:typeof navigator<"u"?navigator.onLine:!0};listeners=new Set;connectionMonitor=null;constructor(){this.initializeNetworkMonitoring()}static getInstance(){return R.instance||(R.instance=new R),R.instance}initializeNetworkMonitoring(){if(!(typeof window>"u")){if(window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),"connection"in navigator){const e=navigator.connection;e&&(this.updateConnectionInfo(e),e.addEventListener("change",()=>{this.updateConnectionInfo(e)}))}this.startPeriodicCheck()}}handleOnline(){this.networkStatus.isOnline=!0,f.setOnlineStatus(!0),this.notifyListeners()}handleOffline(){this.networkStatus.isOnline=!1,f.setOnlineStatus(!1),this.notifyListeners()}updateConnectionInfo(e){this.networkStatus={...this.networkStatus,connectionType:e.type||"unknown",effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt},this.notifyListeners()}startPeriodicCheck(){this.connectionMonitor=window.setInterval(async()=>{const e=this.networkStatus.isOnline,t=await this.checkConnectivity();e!==t&&(this.networkStatus.isOnline=t,f.setOnlineStatus(t),this.notifyListeners())},3e4)}async checkConnectivity(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("/favicon.ico",{method:"HEAD",cache:"no-cache",signal:e.signal});return clearTimeout(t),n.ok}catch{return!1}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.networkStatus)}catch{}})}getNetworkStatus(){return{...this.networkStatus}}isOnline(){return this.networkStatus.isOnline}isSlowConnection(){const{effectiveType:e,downlink:t}=this.networkStatus;return e==="slow-2g"||e==="2g"||t!==void 0&&t<1}addListener(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}destroy(){typeof window>"u"||(window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.connectionMonitor&&(clearInterval(this.connectionMonitor),this.connectionMonitor=null),this.listeners.clear())}}const x=R.getInstance();class M{static instance;queue=new Map;processing=!1;QUEUE_STORE="offline_queue";constructor(){this.loadQueue()}static getInstance(){return M.instance||(M.instance=new M),M.instance}async enqueue(e,t="medium",n=[]){const s={operation:e,priority:t,dependencies:n};this.queue.set(e.id,s),await this.persistQueue()}async dequeue(e){this.queue.delete(e),await this.persistQueue()}getNextOperations(e=10){const t=[],n=new Set,s=Array.from(this.queue.values()).sort((a,i)=>{const r={high:3,medium:2,low:1},o=r[i.priority]-r[a.priority];return o!==0?o:a.operation.timestamp.getTime()-i.operation.timestamp.getTime()});for(const a of s){if(t.length>=e)break;a.dependencies.every(r=>n.has(r)||!this.queue.has(r))&&(t.push(a.operation),n.add(a.operation.id))}return t}getAllOperations(){return Array.from(this.queue.values()).map(e=>e.operation)}size(){return this.queue.size}isEmpty(){return this.queue.size===0}async clear(){this.queue.clear(),await this.persistQueue()}getOperationsByEntity(e){return Array.from(this.queue.values()).filter(t=>t.operation.entity===e).map(t=>t.operation)}getOperationsByEntityId(e){return Array.from(this.queue.values()).filter(t=>t.operation.entityId===e).map(t=>t.operation)}async incrementRetryCount(e){const t=this.queue.get(e);return t?(t.operation.retryCount++,t.operation.retryCount>=t.operation.maxRetries?(await this.dequeue(e),!1):(await this.persistQueue(),!0)):!1}async optimizeQueue(){const e=new Map;for(const t of this.queue.values()){const n=`${t.operation.entity}:${t.operation.entityId}`;e.has(n)||e.set(n,[]),e.get(n).push(t)}for(const[t,n]of e){if(n.length<=1)continue;n.sort((i,r)=>r.operation.timestamp.getTime()-i.operation.timestamp.getTime());const s=new Set,a=new Set;for(const i of n){const r=i.operation.type;if(r==="delete"){a.clear(),a.add(i.operation.id);break}else{if(r==="create"&&s.has("update"))continue;(r==="update"&&!s.has(r)||r==="create"&&!s.has("update"))&&a.add(i.operation.id)}s.add(r)}for(const i of n)a.has(i.operation.id)||this.queue.delete(i.operation.id)}await this.persistQueue()}async loadQueue(){try{await g.init();const e=await g.get("offline_queue","queue");e&&Array.isArray(e.items)&&(this.queue=new Map(e.items.map(t=>[t.operation.id,{...t,operation:{...t.operation,timestamp:new Date(t.operation.timestamp)}}])))}catch(e){console.error("Failed to load offline queue:",e),this.queue=new Map}}async persistQueue(){try{await g.init();const t={id:"queue",items:Array.from(this.queue.values()),lastUpdated:new Date};await g.put("offline_queue",t)}catch(e){console.error("Failed to persist offline queue:",e)}}}const v=M.getInstance();class ae{strategies=new Map;constructor(){this.registerDefaultStrategies()}registerStrategy(e,t){this.strategies.set(e,t)}async resolveConflict(e){const t=this.strategies.get(e.conflictType);if(!t)throw new Error(`No resolution strategy found for conflict type: ${e.conflictType}`);const n=await t.resolve(e);return e.resolved=!0,n}detectConflicts(e,t){const n=[];return t?(this.hasVersionConflict(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"version",timestamp:new Date,resolved:!1}),this.hasConcurrentEdit(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"concurrent_edit",timestamp:new Date,resolved:!1}),n):((e.type==="update"||e.type==="delete")&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:null,conflictType:"deleted_remotely",timestamp:new Date,resolved:!1}),n)}hasVersionConflict(e,t){return e.metadata?.version!==void 0&&t.metadata?.version!==void 0&&e.metadata.version!==t.metadata.version}hasConcurrentEdit(e,t){const n=new Date(e.metadata?.modified||0),s=new Date(t.metadata?.modified||0);return Math.abs(n.getTime()-s.getTime())<5*60*1e3}registerDefaultStrategies(){this.registerStrategy("version",new ie),this.registerStrategy("concurrent_edit",new re),this.registerStrategy("deleted_remotely",new oe),this.registerStrategy("deleted_locally",new ce)}}class ie{async resolve(e){const t=new Date(e.localData.metadata?.modified||0),n=new Date(e.remoteData.metadata?.modified||0);return t>n?e.localData:e.remoteData}}class re{async resolve(e){const{localData:t,remoteData:n}=e;if(this.isContentModule(t))return this.mergeContentModule(t,n);if(this.isUserProgress(t))return this.mergeUserProgress(t,n);if(this.isUserSettings(t))return this.mergeUserSettings(t,n);const s=new Date(t.metadata?.modified||0),a=new Date(n.metadata?.modified||0);return s>a?t:n}isContentModule(e){return e&&typeof e.title=="string"&&Array.isArray(e.blocks)}isUserProgress(e){return e&&typeof e.moduleId=="string"&&typeof e.userId=="string"}isUserSettings(e){return e&&typeof e.userId=="string"&&e.preferences}mergeContentModule(e,t){const n=Math.max(...(e.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),s=Math.max(...(t.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),a=n>s?e:t,i={views:(e.analytics?.views??0)+(t.analytics?.views??0),completions:(e.analytics?.completions??0)+(t.analytics?.completions??0),averageScore:((e.analytics?.averageScore??0)+(t.analytics?.averageScore??0))/2||0,averageTime:((e.analytics?.averageTime??0)+(t.analytics?.averageTime??0))/2||0},r=Array.from(new Set([...e.metadata?.tags??[],...t.metadata?.tags??[]]));return{...a,metadata:{...a.metadata,tags:r,modified:new Date,version:Math.max(e.metadata?.version??0,t.metadata?.version??0)+1},analytics:{...a.analytics,...i}}}mergeUserProgress(e,t){return{...e,score:Math.max(e.score??0,t.score??0),timeSpent:(e.timeSpent??0)+(t.timeSpent??0),lastAccessed:new Date(Math.max(e.lastAccessed.getTime(),t.lastAccessed.getTime())),attempts:e.attempts+t.attempts,notes:e.notes&&t.notes?`${e.notes}
---
${t.notes}`:e.notes||t.notes,status:this.getMostAdvancedStatus(e.status,t.status)}}mergeUserSettings(e,t){return{...e,preferences:{...t.preferences,...e.preferences}}}getMostAdvancedStatus(e,t){const n={"not-started":0,"in-progress":1,completed:2},s=n[e]||0,a=n[t]||0,i=Math.max(s,a);return Object.keys(n)[i]}}class oe{async resolve(e){return console.warn("User prompt strategy not implemented, using local data"),e.localData}}class ce{async resolve(e){return e.remoteData}}const Q=new ae;class ${static instance;updates=new Map;rollbackCallbacks=new Map;constructor(){}static getInstance(){return $.instance||($.instance=new $),$.instance}applyOptimisticUpdate(e){const t=crypto.randomUUID(),n=this.captureCurrentState(e.entity,e.entityId);this.applyUpdateToState(e);const s={id:t,operationId:e.id,entity:e.entity,entityId:e.entityId,previousState:n,newState:e.data,timestamp:new Date,applied:!0};return this.updates.set(t,s),this.rollbackCallbacks.set(t,()=>{this.rollbackUpdate(t)}),t}confirmUpdate(e){this.updates.get(e)&&(this.updates.delete(e),this.rollbackCallbacks.delete(e))}rollbackUpdate(e){const t=this.updates.get(e);!t||!t.applied||(this.restoreState(t.entity,t.entityId,t.previousState),t.applied=!1,f.addNotification({type:"warning",message:`Update to ${t.entity} failed and was rolled back`}))}rollbackOperation(e){for(const[t,n]of this.updates)n.operationId===e&&this.rollbackUpdate(t)}getPendingUpdates(){return Array.from(this.updates.values()).filter(e=>e.applied)}clearAll(){this.updates.clear(),this.rollbackCallbacks.clear()}captureCurrentState(e,t){switch(e){case"content":return b.content.nodes.get(t);case"progress":return b.progress.userProgress.get(t);case"settings":return b.user.settings;default:return null}}applyUpdateToState(e){switch(e.entity){case"content":this.applyContentUpdate(e);break;case"progress":this.applyProgressUpdate(e);break;case"settings":this.applySettingsUpdate(e);break;case"relationships":this.applyRelationshipUpdate(e);break}}applyContentUpdate(e){switch(e.type){case"create":f.addKnowledgeNode(e.data);break;case"update":f.updateKnowledgeNode(e.entityId,e.data);break;case"delete":f.removeKnowledgeNode(e.entityId);break}}applyProgressUpdate(e){switch(e.type){case"create":case"update":f.updateUserProgress(e.entityId,e.data);break;case"delete":b.progress.userProgress.delete(e.entityId);break}}applySettingsUpdate(e){e.type==="update"&&(b.user.settings={...b.user.settings,...e.data})}applyRelationshipUpdate(e){console.log("Relationship update applied optimistically:",e)}restoreState(e,t,n){if(n)switch(e){case"content":n?f.updateKnowledgeNode(t,n):f.removeKnowledgeNode(t);break;case"progress":n?f.updateUserProgress(t,n):b.progress.userProgress.delete(t);break;case"settings":b.user.settings=n;break}}}const B=$.getInstance();class q{static instance;config=null;syncInterval=null;isSyncing=!1;lastSyncAttempt=null;constructor(){this.setupNetworkListener()}static getInstance(){return q.instance||(q.instance=new q),q.instance}initialize(e){this.config=e,this.startPeriodicSync()}startPeriodicSync(){!this.config||this.syncInterval||typeof window>"u"||(this.syncInterval=window.setInterval(()=>{x.isOnline()&&!this.isSyncing&&this.sync()},this.config.syncInterval))}stopPeriodicSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async sync(){if(!this.config||this.isSyncing||!x.isOnline())return{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:"Sync not available",retryable:!1,timestamp:new Date}]};this.isSyncing=!0,f.setSyncStatus(!0),this.lastSyncAttempt=new Date;try{const e=v.getNextOperations(this.config.batchSize);if(e.length===0)return await this.pullRemoteChanges(),{success:!0,operationsProcessed:0,conflicts:[],errors:[]};const t=await this.processSyncBatch(e);for(const n of e)t.errors.some(a=>a.operationId===n.id)||(await v.dequeue(n.id),B.confirmUpdate(n.id));return t}catch(e){return console.error("Sync failed:",e),{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:e instanceof Error?e.message:"Unknown sync error",retryable:!0,timestamp:new Date}]}}finally{this.isSyncing=!1,f.setSyncStatus(!1)}}async processSyncBatch(e){const t={success:!0,operationsProcessed:0,conflicts:[],errors:[]};for(const n of e)try{const s=await this.processSyncOperation(n);if(t.operationsProcessed++,t.conflicts.push(...s.conflicts),s.conflicts.length>0)for(const a of s.conflicts)try{const i=await Q.resolveConflict(a);await this.applyResolvedData(n,i)}catch(i){t.errors.push({operationId:n.id,error:`Conflict resolution failed: ${i}`,retryable:!1,timestamp:new Date})}}catch(s){t.success=!1,t.errors.push({operationId:n.id,error:s instanceof Error?s.message:"Unknown operation error",retryable:this.isRetryableError(s),timestamp:new Date}),await v.incrementRetryCount(n.id)||B.rollbackOperation(n.id)}return t}async processSyncOperation(e){const t=this.getEndpointForOperation(e),n=this.getHttpMethodForOperation(e);let s=null;(e.type==="update"||e.type==="delete")&&(s=await this.fetchRemoteData(e.entity,e.entityId));const a=Q.detectConflicts(e,s);if(a.length>0)return{conflicts:a};const i=await this.makeRequest(t,{method:n,headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:n!=="DELETE"?JSON.stringify(e.data):void 0});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return{conflicts:[]}}async pullRemoteChanges(){if(!this.config)return;const e=b.sync.lastSync?.toISOString()||new Date(0).toISOString(),t=`${this.config.endpoint}/changes?since=${e}&userId=${this.config.userId}`;try{const n=await this.makeRequest(t,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});if(n.ok){const s=await n.json();await this.applyRemoteChanges(s)}}catch(n){console.error("Failed to pull remote changes:",n)}}async applyRemoteChanges(e){for(const t of e)try{switch(t.entity){case"content":t.type==="delete"?f.removeKnowledgeNode(t.entityId):f.updateKnowledgeNode(t.entityId,t.data);break;case"progress":t.type==="delete"?b.progress.userProgress.delete(t.entityId):f.updateUserProgress(t.entityId,t.data);break;case"settings":t.type!=="delete"&&(b.user.settings={...b.user.settings,...t.data});break}}catch(n){console.error("Failed to apply remote change:",n)}}async applyResolvedData(e,t){switch(e.entity){case"content":f.updateKnowledgeNode(e.entityId,t);break;case"progress":f.updateUserProgress(e.entityId,t);break;case"settings":b.user.settings={...b.user.settings,...t};break}const n=this.getEndpointForOperation(e);await this.makeRequest(n,{method:"PUT",headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:JSON.stringify({...e,data:t,resolved:!0})})}async fetchRemoteData(e,t){if(!this.config)return null;const n=`${this.config.endpoint}/${e}/${t}?userId=${this.config.userId}`;try{const s=await this.makeRequest(n,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});return s.ok?await s.json():null}catch{return null}}async makeRequest(e,t,n=3){for(let s=0;s<n;s++)try{return await fetch(e,{...t,signal:AbortSignal.timeout(1e4)})}catch(a){if(s===n-1)throw a;const i=Math.min(1e3*Math.pow(2,s),1e4);await new Promise(r=>setTimeout(r,i))}throw new Error("Max retries exceeded")}getEndpointForOperation(e){if(!this.config)throw new Error("Sync not configured");return e.type==="create"?`${this.config.endpoint}/${e.entity}?userId=${this.config.userId}`:`${this.config.endpoint}/${e.entity}/${e.entityId}?userId=${this.config.userId}`}getHttpMethodForOperation(e){switch(e.type){case"create":return"POST";case"update":return"PUT";case"delete":return"DELETE";default:return"PUT"}}isRetryableError(e){return e instanceof TypeError||e.name==="AbortError"||e&&typeof e.status=="number"&&e.status>=500&&e.status<600}setupNetworkListener(){x.addListener(e=>{e.isOnline&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),1e3)})}async queueOperation(e,t,n,s,a="medium"){const i={id:crypto.randomUUID(),type:e,entity:t,entityId:t==="settings"?b.user?.id||"default-user":n,data:s,timestamp:new Date,retryCount:0,maxRetries:3};return B.applyOptimisticUpdate(i),await v.enqueue(i,a),f.addPendingChange(i.id),x.isOnline()&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),100),i.id}getSyncStatus(){return{isOnline:x.isOnline(),isSyncing:this.isSyncing,lastSync:b.sync.lastSync,pendingOperations:v.size(),lastSyncAttempt:this.lastSyncAttempt}}}const T=q.getInstance();class P{static instance;initialized=!1;constructor(){}static getInstance(){return P.instance||(P.instance=new P),P.instance}async initialize(e){this.initialized||(x.getNetworkStatus(),this.setupNetworkEffects(),e&&T.initialize(e),await v.optimizeQueue(),this.initialized=!0,f.addNotification({type:"info",message:"Sync service initialized"}))}async createContent(e){return await T.queueOperation("create","content",e.id,e,"high")}async updateContent(e,t){return await T.queueOperation("update","content",e,t,"medium")}async deleteContent(e){return await T.queueOperation("delete","content",e,null,"high")}async updateProgress(e,t){return await T.queueOperation("update","progress",e,t,"medium")}async updateSettings(e){return await T.queueOperation("update","settings",b.user.id,e,"low")}async syncNow(){if(!x.isOnline()){f.addNotification({type:"warning",message:"Cannot sync while offline"});return}try{const e=await T.sync();e.success?f.addNotification({type:"success",message:`Synced ${e.operationsProcessed} operations`}):f.addNotification({type:"error",message:`Sync failed: ${e.errors.length} errors`}),e.conflicts.length>0&&f.addNotification({type:"warning",message:`${e.conflicts.length} conflicts resolved automatically`})}catch(e){f.addNotification({type:"error",message:"Sync failed: "+(e instanceof Error?e.message:"Unknown error")})}}getSyncStatus(){const e=T.getSyncStatus(),t=x.getNetworkStatus(),n=B.getPendingUpdates();return{...e,networkStatus:t,pendingOptimisticUpdates:n.length,queueSize:v.size(),canSync:t.isOnline&&!e.isSyncing}}async clearOfflineData(){await v.clear(),B.clearAll(),f.addNotification({type:"info",message:"Offline data cleared"})}getOfflineStats(){const e=v.getAllOperations(),t={total:e.length,byType:{},byEntity:{},oldestOperation:null,newestOperation:null};for(const n of e)t.byType[n.type]=(t.byType[n.type]||0)+1,t.byEntity[n.entity]=(t.byEntity[n.entity]||0)+1,(!t.oldestOperation||n.timestamp<t.oldestOperation)&&(t.oldestOperation=n.timestamp),(!t.newestOperation||n.timestamp>t.newestOperation)&&(t.newestOperation=n.timestamp);return t}setupNetworkEffects(){x.addListener(e=>{if(f.setOnlineStatus(e.isOnline),e.isOnline){const t=v.size();t>0&&f.addNotification({type:"info",message:`Back online! ${t} operations queued for sync`})}else f.addNotification({type:"warning",message:"You are now offline. Changes will be synced when connection is restored."})}),setInterval(async()=>{v.size()>10&&await v.optimizeQueue()},5*60*1e3)}destroy(){T.stopPeriodicSync(),x.destroy(),B.clearAll(),this.initialized=!1}}const _e=P.getInstance();class le{db=null;dbName="web-content-sourcing";version=1;async initialize(){this.db=await G(this.dbName,this.version,{upgrade(e){const t=e.createObjectStore("sources",{keyPath:"id"});t.createIndex("by-domain","domain"),t.createIndex("by-category","metadata.category"),t.createIndex("by-status","status");const n=e.createObjectStore("content",{keyPath:"id"});n.createIndex("by-url","url"),n.createIndex("by-domain","metadata.domain");const s=e.createObjectStore("jobs",{keyPath:"id"});s.createIndex("by-status","status"),s.createIndex("by-created","createdAt");const a=e.createObjectStore("templates",{keyPath:"id"});a.createIndex("by-type","type"),a.createIndex("by-category","category"),e.createObjectStore("settings",{keyPath:"key"})}})}ensureDB(){if(!this.db)throw new Error("Database not initialized. Call initialize() first.");return this.db}async addSource(e){await this.ensureDB().add("sources",e)}async updateSource(e){await this.ensureDB().put("sources",e)}async getSource(e){return await this.ensureDB().get("sources",e)}async getAllSources(){return await this.ensureDB().getAll("sources")}async getSourcesByDomain(e){return await this.ensureDB().getAllFromIndex("sources","by-domain",e)}async getSourcesByCategory(e){return await this.ensureDB().getAllFromIndex("sources","by-category",e)}async getSourcesByStatus(e){return await this.ensureDB().getAllFromIndex("sources","by-status",e)}async deleteSource(e){await this.ensureDB().delete("sources",e)}async addContent(e){await this.ensureDB().add("content",e)}async updateContent(e){await this.ensureDB().put("content",e)}async getContent(e){return await this.ensureDB().get("content",e)}async getContentByUrl(e){return await this.ensureDB().getFromIndex("content","by-url",e)}async getAllContent(){return await this.ensureDB().getAll("content")}async deleteContent(e){await this.ensureDB().delete("content",e)}async addJob(e){await this.ensureDB().add("jobs",e)}async updateJob(e){await this.ensureDB().put("jobs",e)}async getJob(e){return await this.ensureDB().get("jobs",e)}async getJobsByStatus(e){return await this.ensureDB().getAllFromIndex("jobs","by-status",e)}async getAllJobs(){return await this.ensureDB().getAll("jobs")}async deleteJob(e){await this.ensureDB().delete("jobs",e)}async addTemplate(e){await this.ensureDB().add("templates",e)}async updateTemplate(e){await this.ensureDB().put("templates",e)}async getTemplate(e){return await this.ensureDB().get("templates",e)}async getTemplatesByType(e){return await this.ensureDB().getAllFromIndex("templates","by-type",e)}async getAllTemplates(){return await this.ensureDB().getAll("templates")}async deleteTemplate(e){await this.ensureDB().delete("templates",e)}async setSetting(e,t){await this.ensureDB().put("settings",{key:e,value:t})}async getSetting(e){return(await this.ensureDB().get("settings",e))?.value}async deleteSetting(e){await this.ensureDB().delete("settings",e)}async clear(){const t=this.ensureDB().transaction(["sources","content","jobs","templates","settings"],"readwrite");await Promise.all([t.objectStore("sources").clear(),t.objectStore("content").clear(),t.objectStore("jobs").clear(),t.objectStore("templates").clear(),t.objectStore("settings").clear()]),await t.done}async getStats(){const e=this.ensureDB(),[t,n,s,a]=await Promise.all([e.count("sources"),e.count("content"),e.count("jobs"),e.count("templates")]);return{sources:t,content:n,jobs:s,templates:a}}}const m=new le;let E;const de=typeof window>"u";de?E=(await j(async()=>{const{svelteActions:p}=await import("./BEo638Mz.js");return{svelteActions:p}},[],import.meta.url)).svelteActions:E=(await j(()=>import("./hAlw3l8v.js"),__vite__mapDeps([0,1,2]),import.meta.url)).webContentActions;const k=A("web-content-error-handler");class L{static instance;errorHistory=[];maxHistorySize=100;static getInstance(){return L.instance||(L.instance=new L),L.instance}handleError(e,t,n){const s=this.categorizeError(e,t,n);return k.error(`${n} failed in ${t}:`,{code:s.code,message:s.message,details:s.details}),this.addToHistory(s),this.showUserNotification(s),s.recoverable&&this.attemptRecovery(s,t,n),s}categorizeError(e,t,n){const a={details:{context:t,operation:n,originalError:e},timestamp:new Date};if(e instanceof TypeError&&e.message.includes("fetch"))return{...a,code:"NETWORK_ERROR",message:"Network connection failed",recoverable:!0,retryable:!0,userMessage:"Unable to connect to the website. Please check your internet connection and try again."};if(e.name==="AbortError"||e.message.includes("timeout"))return{...a,code:"TIMEOUT_ERROR",message:"Request timed out",recoverable:!0,retryable:!0,userMessage:"The request took too long to complete. The website might be slow or unavailable."};if(e.status){const i=e.status;if(i===404)return{...a,code:"NOT_FOUND",message:"Content not found",recoverable:!1,retryable:!1,userMessage:"The requested page could not be found. Please check the URL and try again."};if(i===403)return{...a,code:"ACCESS_DENIED",message:"Access denied",recoverable:!1,retryable:!1,userMessage:"Access to this content is restricted. You may need special permissions to view it."};if(i===429)return{...a,code:"RATE_LIMITED",message:"Rate limit exceeded",recoverable:!0,retryable:!0,userMessage:"Too many requests have been made. Please wait a moment before trying again."};if(i>=500)return{...a,code:"SERVER_ERROR",message:"Server error",recoverable:!0,retryable:!0,userMessage:"The website is experiencing technical difficulties. Please try again later."}}return t.includes("extraction")||t.includes("parsing")?{...a,code:"EXTRACTION_ERROR",message:"Failed to extract content",recoverable:!0,retryable:!1,userMessage:"Unable to extract readable content from this page. The page format may not be supported."}:t.includes("storage")||e.name==="QuotaExceededError"?{...a,code:"STORAGE_ERROR",message:"Storage operation failed",recoverable:!0,retryable:!1,userMessage:"Unable to save content. Your storage may be full or unavailable."}:t.includes("transformation")||t.includes("analysis")?{...a,code:"TRANSFORMATION_ERROR",message:"Content transformation failed",recoverable:!0,retryable:!0,userMessage:"Unable to transform this content into interactive format. The content structure may not be suitable."}:e.message?.includes("Invalid URL")||t.includes("validation")?{...a,code:"INVALID_URL",message:"Invalid URL provided",recoverable:!1,retryable:!1,userMessage:"The provided URL is not valid. Please check the URL format and try again."}:{...a,code:"UNKNOWN_ERROR",message:e.message||"An unknown error occurred",recoverable:!1,retryable:!1,userMessage:"An unexpected error occurred. Please try again or contact support if the problem persists."}}addToHistory(e){this.errorHistory.unshift(e),this.errorHistory.length>this.maxHistorySize&&(this.errorHistory=this.errorHistory.slice(0,this.maxHistorySize))}showUserNotification(e){const t=this.getNotificationType(e.code);E.addNotification({type:t,message:e.userMessage})}getNotificationType(e){switch(e){case"RATE_LIMITED":case"TIMEOUT_ERROR":return"warning";case"NOT_FOUND":case"ACCESS_DENIED":case"INVALID_URL":return"error";case"EXTRACTION_ERROR":case"TRANSFORMATION_ERROR":return"warning";default:return"error"}}attemptRecovery(e,t,n){switch(k.info(`Attempting recovery for ${e.code} in ${t}`),e.code){case"NETWORK_ERROR":case"TIMEOUT_ERROR":this.scheduleRetry(e,t,n);break;case"RATE_LIMITED":this.scheduleDelayedRetry(e,t,n,6e4);break;case"STORAGE_ERROR":this.attemptStorageCleanup();break;case"EXTRACTION_ERROR":this.tryAlternativeExtraction(e,t);break;default:k.info(`No recovery strategy available for ${e.code}`)}}scheduleRetry(e,t,n){const s=this.getRetryCount(e.code),a=Math.min(1e3*Math.pow(2,s),3e4);k.info(`Scheduling retry ${s+1} for ${e.code} in ${a}ms`),setTimeout(()=>{E.addNotification({type:"info",message:`Retrying ${n}... (attempt ${s+1})`})},a)}scheduleDelayedRetry(e,t,n,s){k.info(`Scheduling delayed retry for ${e.code} in ${s}ms`),setTimeout(()=>{E.addNotification({type:"info",message:`Rate limit should be cleared. You can try ${n} again.`})},s)}attemptStorageCleanup(){try{k.info("Attempting storage cleanup..."),E.addNotification({type:"info",message:"Attempting to free up storage space..."}),k.info("Storage cleanup completed")}catch(e){k.error("Storage cleanup failed:",e)}}tryAlternativeExtraction(e,t){k.info("Trying alternative extraction methods..."),E.addNotification({type:"info",message:"Trying alternative content extraction methods..."})}getRetryCount(e){return this.errorHistory.filter(t=>t.code===e).length}getErrorStats(){const e={};let t=0,n=0;for(const s of this.errorHistory)e[s.code]=(e[s.code]||0)+1,s.recoverable&&t++,s.retryable&&n++;return{total:this.errorHistory.length,byCode:e,recent:this.errorHistory.slice(0,10),recoverable:t,retryable:n}}clearHistory(){this.errorHistory=[],k.info("Error history cleared")}shouldRetry(e,t=3){return this.errorHistory.filter(s=>s.code===e).filter(s=>Date.now()-s.timestamp.getTime()<3e5).length<t}getErrorGuidance(e){switch(e){case"NETWORK_ERROR":return{message:"Network connection failed",suggestions:["Check your internet connection","Try again in a few moments","Verify the website is accessible"],canRetry:!0};case"NOT_FOUND":return{message:"Content not found",suggestions:["Verify the URL is correct","Check if the page has moved","Try accessing the page directly in your browser"],canRetry:!1};case"ACCESS_DENIED":return{message:"Access denied",suggestions:["The content may require login","Check if you have permission to access this content","Try accessing the page directly in your browser"],canRetry:!1};case"EXTRACTION_ERROR":return{message:"Content extraction failed",suggestions:["The page format may not be supported","Try a different URL from the same site","Check if the page loads correctly in your browser"],canRetry:!0};default:return{message:"An error occurred",suggestions:["Try again in a few moments","Check your internet connection","Contact support if the problem persists"],canRetry:!0}}}}const ue=L.getInstance();class he{logger=A("web-content-fetcher");defaultOptions={timeout:3e4,userAgent:"Mozilla/5.0 (compatible; WebContentFetcher/2.0; +https://example.com/bot)",followRedirects:!0,maxRedirects:5,extractAssets:!0,cleanContent:!0,preserveInteractivity:!1,useHeadlessBrowser:!1,retryAttempts:3,retryDelay:1e3,acceptedContentTypes:["text/html","application/xhtml+xml","application/xml","text/xml","application/json","application/rss+xml","application/atom+xml"],extractionMethod:"auto"};retryConfig={maxAttempts:3,baseDelay:1e3,maxDelay:3e4,backoffMultiplier:2,retryableErrors:["NETWORK_ERROR","TIMEOUT_ERROR","SERVER_ERROR","RATE_LIMITED"]};contentTypeHandlers=[];constructor(){this.initializeContentTypeHandlers()}initializeContentTypeHandlers(){this.contentTypeHandlers.push({canHandle:e=>e.includes("text/html")||e.includes("application/xhtml+xml"),extract:this.extractHtmlContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("application/json"),extract:this.extractJsonContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("application/xml")||e.includes("text/xml")||e.includes("application/rss+xml")||e.includes("application/atom+xml"),extract:this.extractXmlContent.bind(this)}),this.contentTypeHandlers.push({canHandle:e=>e.includes("text/plain"),extract:this.extractPlainTextContent.bind(this)})}async fetch(e,t={}){const n={...this.defaultOptions,...t},s=Date.now();try{this.logger.info(`Fetching content from: ${e}`);const a=new URL(e);return await this.fetchWithRetry(e,n,s)}catch(a){const i=Date.now()-s,r=ue.handleError(a,"fetch","URL content fetching");return{id:`error_${Date.now()}`,url:e,title:"Failed to fetch content",content:{html:"",text:"",images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(e),contentType:"error",language:"en",readingTime:0,wordCount:0,keywords:[],description:r.userMessage,attribution:e,tags:["error",r.code.toLowerCase()],category:"error"},extraction:{method:"error",confidence:0,qualityScore:0,issues:[r.message],processingTime:i},fetchedAt:new Date().toISOString(),success:!1}}}async fetchWithRetry(e,t,n){let s=null;const a=t.retryAttempts||this.retryConfig.maxAttempts;for(let i=1;i<=a;i++)try{this.logger.info(`Fetch attempt ${i}/${a} for: ${e}`);const r=await this.performSingleFetch(e,t),o=Date.now()-n;return r.extraction.processingTime=o,this.logger.info(`Content fetched successfully in ${o}ms on attempt ${i}`),r}catch(r){if(s=r instanceof Error?r:new Error(String(r)),this.shouldRetryError(s)&&i<a){const c=this.calculateRetryDelay(i);this.logger.warn(`Attempt ${i} failed, retrying in ${c}ms:`,s.message),await this.sleep(c)}else throw this.logger.error(`All ${i} attempts failed for ${e}:`,s),s}throw s||new Error("All retry attempts failed")}async performSingleFetch(e,t){const n=new AbortController,s=setTimeout(()=>n.abort(),t.timeout);try{if(t.useHeadlessBrowser||await this.shouldUseHeadlessBrowser(e))return await this.fetchWithHeadlessBrowser(e,t);const i=await fetch(e,{signal:n.signal,headers:this.buildHeaders(t),redirect:t.followRedirects?"follow":"manual"});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const r=i.headers.get("content-type")||"text/html",o=await i.text(),c=i.url,l=this.contentTypeHandlers.find(d=>d.canHandle(r));return l?await l.extract(o,c,t):await this.extractHtmlContent(o,c,t)}finally{clearTimeout(s)}}buildHeaders(e){const t=e.acceptedContentTypes?.join(",")||"text/html,application/xhtml+xml,application/xml;q=0.9,application/json;q=0.8,*/*;q=0.7";return{"User-Agent":e.userAgent,Accept:t,"Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",DNT:"1","Upgrade-Insecure-Requests":"1"}}shouldRetryError(e){const t=e.message.toLowerCase();return e.name.toLowerCase()==="aborterror"||t.includes("timeout")||t.includes("network")||t.includes("fetch")||t.includes("503")||t.includes("502")||t.includes("500")||t.includes("429")||t.includes("connection")}calculateRetryDelay(e){const t=this.retryConfig.baseDelay,n=this.retryConfig.backoffMultiplier,s=this.retryConfig.maxDelay,a=Math.random()*.1*t,i=Math.min(t*Math.pow(n,e-1)+a,s);return Math.floor(i)}sleep(e){return new Promise(t=>setTimeout(t,e))}async shouldUseHeadlessBrowser(e){const t=this.safeParseDomain(e).toLowerCase();return["twitter.com","x.com","facebook.com","instagram.com","linkedin.com","reddit.com","youtube.com","tiktok.com","discord.com","slack.com","notion.so","airtable.com"].some(s=>t.includes(s))}async fetchWithHeadlessBrowser(e,t){this.logger.info(`Headless browser requested for ${e}, falling back to regular fetch`);const n={...t,timeout:(t.timeout||3e4)*2};return await this.performSingleFetch(e,n)}async extractHtmlContent(e,t,n){const a=new DOMParser().parseFromString(e,"text/html"),i=this.extractMetadata(a,t,t),r=await this.extractMainContentAdvanced(a,n),o=this.extractImages(a,t),c=this.extractCodeBlocks(a),l=this.extractTables(a),d=this.detectCharts(a);return{id:`content_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,url:t,finalUrl:t,title:i.description||"Untitled",content:{html:r.html,text:r.text,images:o,codeBlocks:c,tables:l,charts:d,blocks:[]},metadata:i,extraction:{method:n.extractionMethod||"auto",confidence:this.calculateExtractionConfidence(a,r),qualityScore:this.calculateQualityScore(r,i),issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractJsonContent(e,t,n){try{const s=JSON.parse(e),a=`json_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,i=this.extractTextFromJson(s),r=this.extractTitleFromJson(s)||"JSON Content";return{id:a,url:t,finalUrl:t,title:r,content:{html:`<pre><code class="language-json">${JSON.stringify(s,null,2)}</code></pre>`,text:i,images:[],codeBlocks:[{id:"json_data",code:JSON.stringify(s,null,2),language:"json",interactive:!1,executable:!1}],tables:this.extractTablesFromJson(s),charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"json",language:"en",readingTime:Math.ceil(i.split(" ").length/200),wordCount:i.split(" ").length,keywords:this.extractKeywordsFromJson(s),description:r,attribution:t,tags:["json","data"],category:"data"},extraction:{method:"json",confidence:.9,qualityScore:.8,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}catch(s){throw new Error(`Failed to parse JSON content: ${s instanceof Error?s.message:String(s)}`)}}async extractXmlContent(e,t,n){try{const s=new DOMParser;let a;try{if(a=s.parseFromString(e,"application/xml"),a.querySelector("parsererror")||a.documentElement.nodeName==="parsererror"||!a.documentElement)throw new Error("XML parsing failed")}catch{if(a=s.parseFromString(e,"text/html"),!a.documentElement)throw new Error("Invalid XML content")}const i=`xml_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;if(a.querySelector("rss, feed"))return await this.extractRssFeedContent(a,t,n);const o=a.documentElement.textContent||"",c=this.extractTitleFromXml(a)||"XML Content";return{id:i,url:t,finalUrl:t,title:c,content:{html:`<pre><code class="language-xml">${this.escapeHtml(e)}</code></pre>`,text:o,images:[],codeBlocks:[{id:"xml_data",code:e,language:"xml",interactive:!1,executable:!1}],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"xml",language:"en",readingTime:Math.ceil(o.split(" ").length/200),wordCount:o.split(" ").length,keywords:[],description:c,attribution:t,tags:["xml","data"],category:"data"},extraction:{method:"xml",confidence:.8,qualityScore:.7,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}catch(s){throw new Error(`Failed to parse XML content: ${s instanceof Error?s.message:String(s)}`)}}async extractRssFeedContent(e,t,n){const s=`rss_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,a=e.querySelector("title")?.textContent||"RSS Feed",i=e.querySelector("description")?.textContent||"",r=Array.from(e.querySelectorAll("item, entry")).map((l,d)=>{const h=l.querySelector("title")?.textContent||`Item ${d+1}`,u=l.querySelector("description, summary")?.textContent||"",y=l.querySelector("link")?.textContent||l.querySelector("link")?.getAttribute("href")||"",w=l.querySelector("pubDate, published")?.textContent||"";return{title:h,description:u,link:y,date:w}}),o=`
            <h1>${this.escapeHtml(a)}</h1>
            <p>${this.escapeHtml(i)}</p>
            <div class="rss-items">
                ${r.map(l=>`
                    <article class="rss-item">
                        <h2><a href="${this.escapeHtml(l.link)}">${this.escapeHtml(l.title)}</a></h2>
                        <p>${this.escapeHtml(l.description)}</p>
                        ${l.date?`<time>${this.escapeHtml(l.date)}</time>`:""}
                    </article>
                `).join("")}
            </div>
        `,c=`${a}
${i}

${r.map(l=>`${l.title}
${l.description}
${l.link}`).join(`

`)}`;return{id:s,url:t,finalUrl:t,title:a,content:{html:o,text:c,images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"rss",language:"en",readingTime:Math.ceil(c.split(" ").length/200),wordCount:c.split(" ").length,keywords:[],description:i,attribution:t,tags:["rss","feed","news"],category:"news"},extraction:{method:"rss",confidence:.9,qualityScore:.8,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractPlainTextContent(e,t,n){const s=`text_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,i=e.split(`
`)[0]?.trim()||"Plain Text Content";return{id:s,url:t,finalUrl:t,title:i,content:{html:`<pre>${this.escapeHtml(e)}</pre>`,text:e,images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(t),contentType:"text",language:"en",readingTime:Math.ceil(e.split(" ").length/200),wordCount:e.split(" ").length,keywords:[],description:i,attribution:t,tags:["text"],category:"document"},extraction:{method:"text",confidence:.7,qualityScore:.6,issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}async extractMainContentAdvanced(e,t){switch(t.extractionMethod||"auto"){case"readability":return this.extractWithReadabilityAlgorithm(e,t);case"semantic":return this.extractWithSemanticAnalysis(e,t);case"heuristic":return this.extractMainContent(e,t);case"auto":default:try{return this.extractWithSemanticAnalysis(e,t)}catch{try{return this.extractWithReadabilityAlgorithm(e,t)}catch{return this.extractMainContent(e,t)}}}}extractWithReadabilityAlgorithm(e,t){const n=[];e.querySelectorAll("div, article, section, main, p").forEach(i=>{let r=0;const c=(i.textContent||"").length;c>25&&(r+=1),c>100&&(r+=1),c>500&&(r+=2);const l=i.querySelectorAll("p");r+=l.length;const d=i.querySelectorAll("a"),h=Array.from(d).reduce((N,D)=>N+(D.textContent?.length||0),0);(c>0?h/c:0)>.3&&(r-=2);const y=i.className.toLowerCase(),w=i.id.toLowerCase();(y.includes("content")||y.includes("article")||y.includes("main"))&&(r+=2),(y.includes("sidebar")||y.includes("nav")||y.includes("ad"))&&(r-=2),(w.includes("content")||w.includes("article")||w.includes("main"))&&(r+=2),(w.includes("sidebar")||w.includes("nav")||w.includes("ad"))&&(r-=2),n.push({element:i,score:r})}),n.sort((i,r)=>r.score-i.score);const a=n[0];if(a&&a.score>0){const i=a.element.cloneNode(!0);return t.cleanContent&&this.cleanContent(i),{html:i.innerHTML,text:i.textContent||""}}return this.extractMainContent(e,t)}extractWithSemanticAnalysis(e,t){const n=["main",'[role="main"]',"article",'[role="article"]',".content","#content",".post-content",".entry-content",".article-content",".main-content"];for(const s of n){const a=e.querySelector(s);if(a){const i=a.cloneNode(!0);t.cleanContent&&this.cleanContent(i);const r=i.textContent||"";if(r.length>100)return{html:i.innerHTML,text:r}}}return this.extractWithReadabilityAlgorithm(e,t)}extractTextFromJson(e){return typeof e=="string"?e:typeof e=="number"||typeof e=="boolean"?String(e):Array.isArray(e)?e.map(t=>this.extractTextFromJson(t)).join(" "):typeof e=="object"&&e!==null?Object.values(e).map(t=>this.extractTextFromJson(t)).join(" "):""}extractTitleFromJson(e){if(typeof e=="object"&&e!==null){const t=["title","name","label","heading","subject"];for(const n of t)if(e[n]&&typeof e[n]=="string")return e[n]}return null}extractKeywordsFromJson(e){const t=[];if(typeof e=="object"&&e!==null){const n=["keywords","tags","categories","labels"];for(const s of n)e[s]&&(Array.isArray(e[s])?t.push(...e[s].filter(a=>typeof a=="string")):typeof e[s]=="string"&&t.push(...e[s].split(",").map(a=>a.trim())))}return[...new Set(t)]}extractTablesFromJson(e){const t=[];if(typeof e=="object"&&e!==null){for(const[n,s]of Object.entries(e))if(Array.isArray(s)&&s.length>0){const a=s[0];if(typeof a=="object"&&a!==null){const i=Object.keys(a),r=s.map(o=>i.map(c=>String(o[c]||"")));t.push({id:`json_table_${t.length}`,headers:i,rows:r})}}}if(Array.isArray(e)&&e.length>0){const n=e[0];if(typeof n=="object"&&n!==null){const s=Object.keys(n),a=e.map(i=>s.map(r=>String(i[r]||"")));t.push({id:`json_table_${t.length}`,headers:s,rows:a})}}return t}extractTitleFromXml(e){const t=["title","name","label","heading"];for(const n of t){const s=e.querySelector(n);if(s?.textContent)return s.textContent.trim()}return null}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}extractMetadata(e,t,n){const s=new URL(n).hostname,a=e.querySelector("title")?.textContent?.trim()||e.querySelector('meta[property="og:title"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:title"]')?.getAttribute("content")||e.querySelector("h1")?.textContent?.trim()||"Untitled",i=e.querySelector('meta[name="description"]')?.getAttribute("content")||e.querySelector('meta[property="og:description"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:description"]')?.getAttribute("content")||"",r=e.querySelector('meta[name="author"]')?.getAttribute("content")||e.querySelector('meta[property="article:author"]')?.getAttribute("content")||e.querySelector('[rel="author"]')?.textContent?.trim(),o=this.extractDate(e,['meta[property="article:published_time"]','meta[name="date"]','meta[name="publish-date"]',"time[datetime]"]),c=this.extractDate(e,['meta[property="article:modified_time"]','meta[name="last-modified"]','meta[http-equiv="last-modified"]']),l=e.documentElement.lang||e.querySelector('meta[http-equiv="content-language"]')?.getAttribute("content")||"en",h=(e.querySelector('meta[name="keywords"]')?.getAttribute("content")||"").split(",").map(D=>D.trim()).filter(D=>D.length>0),u=this.determineContentType(e,a,i),w=(e.body?.textContent||"").split(/\s+/).filter(D=>D.length>0).length,N=Math.ceil(w/200);return{description:a,author:r,publishDate:o,lastModified:c,domain:s,contentType:u,language:l,readingTime:N,wordCount:w,keywords:h,attribution:t,tags:[],category:this.categorizeContent(u,s,a,i)}}extractMainContent(e,t){let n=e.querySelector("main")||e.querySelector("article")||e.querySelector('[role="main"]')||e.querySelector(".content")||e.querySelector("#content")||e.querySelector(".post-content")||e.querySelector(".entry-content");if(n||(n=e.body),!n)return{html:"",text:""};const s=n.cloneNode(!0);t.cleanContent&&this.cleanContent(s);const a=s.innerHTML,i=s.textContent||"";return{html:a,text:i}}cleanContent(e){["script","style","noscript",".advertisement",".ads",".ad",".social-share",".share-buttons",".comments",".comment-section",".sidebar",".navigation",".nav",".header",".footer",".popup",".modal",".overlay"].forEach(n=>{e.querySelectorAll(n).forEach(s=>s.remove())}),e.querySelectorAll("*").forEach(n=>{["onclick","onload","onerror","data-track","data-analytics"].forEach(a=>{n.hasAttribute(a)&&n.removeAttribute(a)})})}extractImages(e,t){const n=[];return e.querySelectorAll("img").forEach((a,i)=>{const r=a.getAttribute("src");if(r)try{const o=new URL(r,t).href;n.push({id:`img_${i}`,src:o,alt:a.getAttribute("alt")||"",caption:a.getAttribute("title")||"",width:a.naturalWidth||void 0,height:a.naturalHeight||void 0})}catch{}}),n}extractCodeBlocks(e){const t=[];return e.querySelectorAll("pre code, code, .highlight, .code-block").forEach((s,a)=>{const i=s.textContent||"";if(i.trim().length>10){const r=this.detectCodeLanguage(s,i);t.push({id:`code_${a}`,code:i.trim(),language:r,filename:s.getAttribute("data-filename")||void 0,interactive:!1,executable:!1})}}),t}extractTables(e){const t=[];return e.querySelectorAll("table").forEach((s,a)=>{const i=[],r=[];s.querySelectorAll("thead th, tr:first-child th").forEach(l=>{i.push(l.textContent?.trim()||"")}),s.querySelectorAll("tbody tr, tr").forEach(l=>{const d=l.querySelectorAll("td, th");if(d.length>0){const h=[];d.forEach(u=>{h.push(u.textContent?.trim()||"")}),r.push(h)}}),r.length>0&&t.push({id:`table_${a}`,headers:i.length>0?i:void 0,rows:r})}),t}detectCharts(e){const t=[];return['canvas[id*="chart"]',".chart",".graph",".visualization","[data-chart]","[data-graph]","svg.chart","svg.graph"].forEach(s=>{e.querySelectorAll(s).forEach((a,i)=>{t.push({id:`chart_${t.length}`,type:this.detectChartType(a),selector:s,detected:!0,data:null})})}),t}detectChartType(e){const t=e.className.toLowerCase(),n=e.id.toLowerCase();return t.includes("line")||n.includes("line")?"line":t.includes("bar")||n.includes("bar")?"bar":t.includes("pie")||n.includes("pie")?"pie":t.includes("scatter")||n.includes("scatter")?"scatter":t.includes("area")||n.includes("area")?"area":"unknown"}detectCodeLanguage(e,t){const n=e.className.toLowerCase(),s={javascript:/\b(javascript|js)\b/,typescript:/\b(typescript|ts)\b/,python:/\b(python|py)\b/,java:/\bjava\b/,cpp:/\b(cpp|c\+\+)\b/,csharp:/\b(csharp|c#)\b/,html:/\bhtml\b/,css:/\bcss\b/,sql:/\bsql\b/,json:/\bjson\b/,xml:/\bxml\b/,bash:/\b(bash|shell|sh)\b/};for(const[a,i]of Object.entries(s))if(i.test(n))return a;return t.includes("function")&&t.includes("{")?"javascript":t.includes("def ")&&t.includes(":")?"python":t.includes("public class")||t.includes("import java")?"java":t.includes("<html")||t.includes("<!DOCTYPE")?"html":t.includes("SELECT")&&t.includes("FROM")?"sql":t.startsWith("{")&&t.endsWith("}")?"json":"text"}extractDate(e,t){for(const n of t){const s=e.querySelector(n);if(s){const a=s.getAttribute("content")||s.getAttribute("datetime")||s.textContent;if(a){const i=new Date(a);if(!isNaN(i.getTime()))return i}}}}determineContentType(e,t,n){const s=(t+" "+n).toLowerCase();return s.includes("tutorial")||s.includes("how to")||s.includes("guide")?"tutorial":s.includes("news")||s.includes("breaking")?"news":s.includes("blog")||s.includes("post")?"blog":s.includes("research")||s.includes("paper")||s.includes("study")?"research":s.includes("documentation")||s.includes("docs")||s.includes("api")?"documentation":e.querySelector("article")||e.querySelector('[itemtype*="Article"]')?"article":"webpage"}categorizeContent(e,t,n,s){const a=(n+" "+s+" "+t).toLowerCase();return a.includes("tech")||a.includes("programming")||a.includes("code")?"technology":a.includes("science")||a.includes("research")?"science":a.includes("business")||a.includes("finance")||a.includes("market")?"business":a.includes("health")||a.includes("medical")?"health":a.includes("education")||a.includes("learning")?"education":"general"}calculateExtractionConfidence(e,t){let n=.5;return e.querySelector('main, article, [role="main"]')&&(n+=.2),t.text.length>500&&(n+=.1),t.text.length>2e3&&(n+=.1),e.querySelector("h1, h2, h3")&&(n+=.1),Math.min(n,1)}calculateQualityScore(e,t){let n=.5;e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),t.description&&t.description.length>10&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.author&&(n+=.05),t.publishDate&&(n+=.05),t.keywords.length>0&&(n+=.05);const s=e.html.toLowerCase();return(s.includes("<h1")||s.includes("<h2"))&&(n+=.05),s.includes("<p>")&&(n+=.05),(s.includes("<ul>")||s.includes("<ol>"))&&(n+=.05),Math.min(n,1)}safeParseDomain(e){try{return new URL(e).hostname}catch{return"unknown"}}addContentTypeHandler(e){this.contentTypeHandlers.push(e)}removeContentTypeHandler(e){const t=this.contentTypeHandlers.indexOf(e);t>-1&&this.contentTypeHandlers.splice(t,1)}getSupportedContentTypes(){return this.defaultOptions.acceptedContentTypes||[]}async checkIfNeedsJavaScript(e){return this.shouldUseHeadlessBrowser(e)}isRetryableError(e){const t=e.message.toLowerCase();return e.name==="AbortError"||t.includes("timeout")||t.includes("network")||t.includes("fetch")||t.includes("503")||t.includes("502")||t.includes("500")}}const V=new he;class ge{config={similarityThreshold:.3,tagMatchWeight:.4,contentMatchWeight:.3,titleMatchWeight:.3,enableAutomaticPrerequisites:!0,enableAutomaticRelated:!0,maxAutoRelationships:5};updateConfig(e){this.config={...this.config,...e}}async integrateContent(e,t){const n=Date.now();try{await this.createKnowledgeNode(e,t);const s=await this.detectRelationships(t);return this.addToSearchIndex(t),await this.updateRecommendations(t),await this.generateLearningPathSuggestions(t),await this.recordIntegrationMetrics(n),s}catch(s){throw new Error(`Integration failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async createKnowledgeNode(e,t){const n=await this.findAppropriateParent(t),s=Math.min(5,Math.max(1,t.metadata.difficulty));return{id:t.id,title:t.title,type:"module",parent:n,metadata:{difficulty:s,estimatedTime:t.metadata.estimatedTime,prerequisites:t.relationships.prerequisites,tags:[...t.metadata.tags,"imported",`source:${e.domain}`,`type:${e.metadata.category}`]},progress:{completed:!1,lastAccessed:new Date}}}async findAppropriateParent(e){}async detectRelationships(e){const t=await g.getAll("modules"),n=[],s=[];for(const r of t){if(r.id===e.id)continue;const o=this.calculateContentSimilarity(e,r);if(o.score>=this.config.similarityThreshold){const c=this.determineRelationshipType(e,r,o);n.push({targetContentId:r.id,relationshipType:c,confidence:o.score,reasoning:o.reasons.join(", "),automatic:!0}),s.push(`Found ${c} relationship with "${r.title}" (confidence: ${(o.score*100).toFixed(1)}%)`)}}n.sort((r,o)=>o.confidence-r.confidence);const a=n.slice(0,this.config.maxAutoRelationships);(this.config.enableAutomaticRelated||this.config.enableAutomaticPrerequisites)&&await this.createAutomaticRelationships(e.id,a);const i=a.length>0?a.reduce((r,o)=>r+o.confidence,0)/a.length:0;return{sourceContentId:e.id,suggestedRelationships:a,confidence:i,reasoning:s}}calculateContentSimilarity(e,t){let n=0;const s=[],a=e.metadata.tags.filter(w=>t.metadata.tags.includes(w)),i=a.length/Math.max(e.metadata.tags.length,t.metadata.tags.length);n+=i*this.config.tagMatchWeight,a.length>0&&s.push(`Common tags: ${a.join(", ")}`);const r=e.title.toLowerCase().split(/\s+/),o=t.title.toLowerCase().split(/\s+/),c=r.filter(w=>o.includes(w)),l=c.length/Math.max(r.length,o.length);n+=l*this.config.titleMatchWeight,c.length>0&&s.push(`Common title words: ${c.join(", ")}`);const d=this.extractContentText(e),h=this.extractContentText(t),u=this.calculateTextSimilarity(d,h);return n+=u*this.config.contentMatchWeight,u>.1&&s.push(`Content similarity: ${(u*100).toFixed(1)}%`),Math.abs(e.metadata.difficulty-t.metadata.difficulty)<=1&&(n+=.1,s.push("Similar difficulty levels")),{score:Math.min(1,n),reasons:s}}extractContentText(e){return e.blocks.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(n=>n.question).join(" ")||"";default:return""}}).join(" ").toLowerCase()}calculateTextSimilarity(e,t){const n=new Set(e.split(/\s+/).filter(r=>r.length>3)),s=new Set(t.split(/\s+/).filter(r=>r.length>3)),a=new Set(Array.from(n).filter(r=>s.has(r))),i=new Set(Array.from(n).concat(Array.from(s)));return i.size>0?a.size/i.size:0}determineRelationshipType(e,t,n){return t.metadata.difficulty<e.metadata.difficulty&&n.reasons.some(r=>r.includes("basic")||r.includes("intro")||r.includes("fundamental"))?"prerequisite":n.reasons.some(i=>i.includes("part")||i.includes("chapter")||i.includes("lesson"))?"sequence":n.reasons.some(i=>i.includes("example")||i.includes("demo")||i.includes("tutorial"))?"example":"related"}async createAutomaticRelationships(e,t){for(const n of t)try{(n.relationshipType==="related"&&this.config.enableAutomaticRelated||n.relationshipType==="prerequisite"&&this.config.enableAutomaticPrerequisites||n.relationshipType==="sequence"||n.relationshipType==="example")&&await z.createLink(e,n.targetContentId,n.relationshipType,n.confidence,n.reasoning,!0)}catch{}}addToSearchIndex(e){F.indexModule(e)}async updateRecommendations(e){const t=F.getRelatedContent(e.id,new Map([[e.id,e]]),new Map);await g.add("content_recommendations",{contentId:e.id,relatedContent:t.map(n=>n.id),lastUpdated:new Date},"Updated recommendations for imported content")}async generateLearningPathSuggestions(e){const t=[],n=await g.getAll("paths"),s=await g.getAll("modules");for(const i of n){const r=s.filter(c=>i.modules.includes(c.id)),o=await this.calculatePathSimilarity(e,r);o.score>.4&&t.push({pathId:i.id,name:`Enhanced ${i.name}`,description:`${i.description} - Enhanced with imported content from ${e.metadata.tags.join(", ")}`,suggestedModules:[...i.modules,e.id],estimatedDuration:i.estimatedDuration+e.metadata.estimatedTime,difficulty:Math.max(i.difficulty,e.metadata.difficulty),confidence:o.score,reasoning:o.reasons})}const a=await z.getLinksForContent(e.id);if(a.length>0){const i=a.map(r=>r.sourceId===e.id?r.targetId:r.sourceId);t.push({pathId:`generated-${e.id}`,name:`Learning Path: ${e.title}`,description:"Auto-generated learning path based on imported content and related materials",suggestedModules:[e.id,...i.slice(0,3)],estimatedDuration:e.metadata.estimatedTime*2,difficulty:e.metadata.difficulty,confidence:.7,reasoning:["Based on automatic relationship detection","Includes related existing content"]})}return t.sort((i,r)=>r.confidence-i.confidence)}async calculatePathSimilarity(e,t){let n=0;const s=[],a=new Set(t.flatMap(h=>h.metadata.tags)),i=e.metadata.tags.filter(h=>a.has(h)),r=i.length/Math.max(e.metadata.tags.length,a.size);n+=r*.5,i.length>0&&s.push(`Common tags with path: ${i.join(", ")}`);const o=t.map(h=>h.metadata.difficulty).sort((h,u)=>h-u);e.metadata.difficulty>=o[0]&&e.metadata.difficulty<=o[o.length-1]&&(n+=.3,s.push("Difficulty fits path progression"));const d=(await z.getLinksForContent(e.id)).filter(h=>t.some(u=>u.id===h.targetId||u.id===h.sourceId));return d.length>0&&(n+=.2,s.push(`Has relationships with ${d.length} path modules`)),{score:Math.min(1,n),reasons:s}}async recordIntegrationMetrics(e){const t=Date.now()-e;try{const n=await g.get("integration_metrics","current")||{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0},s={...n,totalImportedContent:n.totalImportedContent+1,averageIntegrationTime:(n.averageIntegrationTime+t)/2};await g.put("integration_metrics",s,"Updated integration metrics")}catch{}}async getIntegrationMetrics(){try{return await g.get("integration_metrics","current")}catch{return{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0}}}async createManualRelationship(e,t,n,s){const a=await z.createLink(e,t,n,1,s,!1);try{const i=await this.getIntegrationMetrics();i.manualRelationshipsCreated+=1,await g.put("integration_metrics",i,"Updated manual relationship count")}catch{}return a}async getContentRecommendations(e,t,n=10){const s=[],i=(await g.getAll("modules")).filter(r=>r.metadata.tags.includes("imported")&&!t.has(r.id));for(const r of i){const o=await z.getLinksForContent(r.id);if(o.filter(d=>d.type==="prerequisite"&&d.targetId===r.id).map(d=>d.sourceId).every(d=>t.has(d))){const d=[];let h=.5;const u=o.filter(y=>t.has(y.sourceId)||t.has(y.targetId));h+=u.length*.1,u.length>0&&d.push({type:"prerequisite-completed",weight:.3,description:`Related to ${u.length} completed modules`}),s.push({contentId:r.id,score:Math.min(1,h),reasons:d,type:"related-topic"})}}return s.sort((r,o)=>o.score-r.score).slice(0,n)}}const W=new ge;class me{logger=A("source-manager");initialized=!1;async initialize(){this.initialized||(await m.initialize(),this.initialized=!0,this.logger.info("Source Manager initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async addSource(e){await this.ensureInitialized();const{url:t,title:n,category:s="web-content",tags:a=[],metadata:i={}}=e;this.logger.info("Adding new content source",{url:t,category:s,tags:a});try{const o=new URL(t).hostname,c=await this.findDuplicateSource(t);if(c)return this.logger.warn("Duplicate source detected",{url:t,existingSourceId:c.id}),{sourceId:c.id,source:c,isDuplicate:!0,duplicateOf:c.id};const l=`source_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,d=new Date,h={id:l,url:t,title:n||`Content from ${o}`,domain:o,importDate:d,lastChecked:d,status:"active",metadata:{author:i.author,publishDate:i.publishDate?new Date(i.publishDate):void 0,lastModified:i.lastModified?new Date(i.lastModified):void 0,domain:o,contentType:i.contentType||"article",language:i.language||"en",readingTime:i.readingTime||0,wordCount:i.wordCount||0,keywords:i.keywords||[],description:i.description||"",license:i.license,attribution:t,tags:a,category:s,contentHash:i.contentHash},usage:{timesReferenced:0,lastAccessed:d,generatedModules:[]}};return await m.addSource(h),this.logger.info("Content source added successfully",{sourceId:l,url:t,domain:o,category:s}),{sourceId:l,source:h,isDuplicate:!1}}catch(r){throw this.logger.error("Failed to add content source:",r),new Error(`Failed to add source: ${r instanceof Error?r.message:"Unknown error"}`)}}async listSources(e){await this.ensureInitialized(),this.logger.info("Listing content sources",{filters:e});try{let t;e?.domain?t=await m.getSourcesByDomain(e.domain):e?.category?t=await m.getSourcesByCategory(e.category):e?.status?t=await m.getSourcesByStatus(e.status):t=await m.getAllSources();const n=(await m.getAllSources()).length;e?.tags&&e.tags.length>0&&(t=t.filter(a=>e.tags.some(i=>a.metadata.tags.includes(i))));const s=t.length;if(e?.offset||e?.limit){const a=e.offset||0,i=e.limit||50;t=t.slice(a,a+i)}return t.sort((a,i)=>i.lastChecked.getTime()-a.lastChecked.getTime()),this.logger.info("Sources listed successfully",{total:n,filtered:s,returned:t.length}),{sources:t,total:n,filtered:s}}catch(t){throw this.logger.error("Failed to list sources:",t),new Error(`Failed to list sources: ${t instanceof Error?t.message:"Unknown error"}`)}}async updateSource(e,t){await this.ensureInitialized(),this.logger.info("Updating content source",{sourceId:e,updates:t});try{const n=await m.getSource(e);if(!n)throw new Error(`Source not found: ${e}`);const s={...n};let a=!1;t&&(t.title&&t.title!==n.title&&(n.title=t.title,a=!0),t.category&&t.category!==n.metadata.category&&(n.metadata.category=t.category,a=!0),t.tags&&JSON.stringify(t.tags)!==JSON.stringify(n.metadata.tags)&&(n.metadata.tags=t.tags,a=!0),t.status&&t.status!==n.status&&(n.status=t.status,a=!0)),n.lastChecked=new Date;try{const r=await V.fetch(n.url);if(r.success){const o=this.generateContentHash(r.content.text);n.metadata.contentHash&&n.metadata.contentHash!==o?(n.status="updated",n.metadata.contentHash=o,a=!0):n.metadata.contentHash||(n.metadata.contentHash=o,a=!0)}}catch(r){this.logger.warn("Failed to check for content updates:",r),n.status="error",a=!0}a&&await m.updateSource(n);const i={sourceId:e,success:!0,hasChanges:a,changes:a?{title:t?.title!==s.title,content:n.metadata.contentHash!==s.metadata.contentHash,metadata:t?.category!==s.metadata.category||JSON.stringify(t?.tags)!==JSON.stringify(s.metadata.tags)}:void 0,updatedAt:new Date};return this.logger.info("Source updated successfully",{sourceId:e,hasChanges:a}),i}catch(n){return this.logger.error("Failed to update source:",n),{sourceId:e,success:!1,hasChanges:!1,error:n instanceof Error?n.message:"Unknown error",updatedAt:new Date}}}async removeSource(e){await this.ensureInitialized(),this.logger.info("Removing content source",{sourceId:e});try{const t=await m.getSource(e);if(!t)return{sourceId:e,removed:!1};await m.deleteSource(e);const n=await m.getContentByUrl(t.url);return n&&await m.deleteContent(n.id),this.logger.info("Source removed successfully",{sourceId:e}),{sourceId:e,removed:!0,source:t}}catch(t){return this.logger.error("Failed to remove source:",t),{sourceId:e,removed:!1}}}async validateSources(e){await this.ensureInitialized();const t=e?(await Promise.all(e.map(n=>m.getSource(n)))).filter(Boolean):await m.getAllSources();this.logger.info("Validating content sources",{sourceCount:t.length,specific:!!e});try{const n=[];for(const a of t){if(!a)continue;const i=[],r=[];try{new URL(a.url)}catch{i.push("Invalid URL format"),r.push("Update URL to valid format")}(Date.now()-a.lastChecked.getTime())/(1e3*60*60*24)>30&&(i.push("Source not checked in over 30 days"),r.push("Update source to refresh content")),a.metadata.description||(i.push("Missing description"),r.push("Add description for better categorization")),a.metadata.keywords.length===0&&(i.push("No keywords defined"),r.push("Add keywords for better searchability"));try{const c=await fetch(a.url,{method:"HEAD"});c.ok||(i.push(`URL returns ${c.status} status`),r.push("Check if URL is still accessible"))}catch{i.push("URL is not accessible"),r.push("Verify URL is correct and accessible")}n.push({sourceId:a.id,valid:i.length===0,issues:i,suggestions:r})}const s={total:n.length,valid:n.filter(a=>a.valid).length,invalid:n.filter(a=>!a.valid).length};return this.logger.info("Source validation completed",s),{validationResults:n,summary:s}}catch(n){throw this.logger.error("Source validation failed:",n),new Error(`Source validation failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async performHealthCheck(e){await this.ensureInitialized(),this.logger.info("Performing source health check",{filters:e});try{let t=await m.getAllSources();if(e&&(e.domain&&(t=t.filter(a=>a.domain===e.domain)),e.category&&(t=t.filter(a=>a.metadata.category===e.category)),e.lastCheckedBefore)){const a=new Date(e.lastCheckedBefore);t=t.filter(i=>i.lastChecked<a)}const n=[];for(const a of t){const i=Date.now();let r;const o=[],c=[];try{const l=new AbortController,d=setTimeout(()=>l.abort(),1e4),h=await fetch(a.url,{method:"HEAD",signal:l.signal});clearTimeout(d);const u=Date.now()-i;h.ok?u>5e3?(r="warning",o.push("Slow response time"),c.push("Monitor performance","Consider caching")):r="healthy":(r="error",o.push(`HTTP ${h.status}: ${h.statusText}`),c.push("Check URL validity","Verify content is still available")),n.push({sourceId:a.id,url:a.url,status:r,lastChecked:new Date,responseTime:u,issues:o,suggestions:c})}catch{const d=Date.now()-i;r="error",o.push("Connection failed"),c.push("Check URL validity","Verify network connectivity"),n.push({sourceId:a.id,url:a.url,status:r,lastChecked:new Date,responseTime:d,issues:o,suggestions:c})}r==="error"&&(a.status="error",await m.updateSource(a))}const s={total:n.length,healthy:n.filter(a=>a.status==="healthy").length,warning:n.filter(a=>a.status==="warning").length,error:n.filter(a=>a.status==="error").length};return this.logger.info("Health check completed",s),{healthChecks:n,summary:s}}catch(t){throw this.logger.error("Health check failed:",t),new Error(`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async detectDuplicates(){await this.ensureInitialized(),this.logger.info("Detecting duplicate sources");try{const e=await m.getAllSources(),t=[],n=new Set;for(const a of e){if(n.has(a.id))continue;const i=e.filter(r=>r.id!==a.id&&!n.has(r.id)&&this.calculateSimilarity(a,r)>.8);if(i.length>0){const r={sourceId:a.id,duplicates:i.map(o=>({id:o.id,similarity:this.calculateSimilarity(a,o),reason:this.getDuplicateReason(a,o)})),suggestions:[{action:"merge",confidence:.8,reasoning:"High similarity detected, consider merging sources"}]};t.push(r),n.add(a.id),i.forEach(o=>n.add(o.id))}}const s={totalSources:e.length,duplicateGroups:t.length,duplicateSources:t.reduce((a,i)=>a+i.duplicates.length+1,0)};return this.logger.info("Duplicate detection completed",s),{duplicates:t,summary:s}}catch(e){throw this.logger.error("Duplicate detection failed:",e),new Error(`Duplicate detection failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getSourceStatistics(){await this.ensureInitialized();const e=await m.getAllSources(),t=new Date,n=new Date(t.getTime()-24*60*60*1e3),s=new Date(t.getTime()-7*24*60*60*1e3),a={total:e.length,byDomain:{},byCategory:{},byStatus:{},recentlyAdded:e.filter(i=>i.importDate>s).length,recentlyUpdated:e.filter(i=>i.lastChecked>n).length};return e.forEach(i=>{a.byDomain[i.domain]=(a.byDomain[i.domain]||0)+1}),e.forEach(i=>{a.byCategory[i.metadata.category]=(a.byCategory[i.metadata.category]||0)+1}),e.forEach(i=>{a.byStatus[i.status]=(a.byStatus[i.status]||0)+1}),a}async integrateWithKnowledgeSystem(e,t){await this.ensureInitialized(),this.logger.info("Integrating content with knowledge system",{sourceId:e.id,moduleId:t.id});try{const n=await W.integrateContent(e,t);return e.usage.timesReferenced+=1,e.usage.lastAccessed=new Date,e.usage.generatedModules.push(t.id),await m.updateSource(e),this.logger.info("Knowledge system integration completed",{sourceId:e.id,relationshipsDetected:n.suggestedRelationships.length,confidence:n.confidence}),{success:!0,relationshipsCreated:n.suggestedRelationships.length,searchIndexed:!0,learningPathSuggestions:0,error:void 0}}catch(n){return this.logger.error("Knowledge system integration failed:",n),{success:!1,relationshipsCreated:0,searchIndexed:!1,learningPathSuggestions:0,error:n instanceof Error?n.message:"Unknown error"}}}async getSource(e){return await this.ensureInitialized(),await m.getSource(e)}async getAllSources(){return await this.ensureInitialized(),await m.getAllSources()}async deleteSource(e){await this.ensureInitialized(),await m.deleteSource(e)}async getContentRecommendations(e,t,n=10){await this.ensureInitialized();try{const s=await W.getContentRecommendations(e,t,n),a=await m.getAllSources(),i=[];for(const r of s){const o=a.find(c=>c.usage.generatedModules.includes(r.contentId));o&&i.push({contentId:r.contentId,title:o.title,sourceUrl:o.url,score:r.score,reasons:r.reasons.map(c=>c.description||"Related content")})}return i}catch(s){return this.logger.error("Failed to get content recommendations:",s),[]}}async findDuplicateSource(e){return await m.getContentByUrl(e)&&(await m.getAllSources()).find(s=>s.url===e)||null}calculateSimilarity(e,t){let n=0;return e.url===t.url?n+=.5:e.domain===t.domain&&(n+=.2),e.title===t.title?n+=.3:(e.title.toLowerCase().includes(t.title.toLowerCase())||t.title.toLowerCase().includes(e.title.toLowerCase()))&&(n+=.15),e.metadata.contentHash&&t.metadata.contentHash&&e.metadata.contentHash===t.metadata.contentHash&&(n+=.2),Math.min(n,1)}getDuplicateReason(e,t){return e.url===t.url?"Identical URL":e.title===t.title?"Identical title":e.metadata.contentHash===t.metadata.contentHash?"Identical content":e.domain===t.domain?"Same domain with similar content":"Similar content detected"}generateContentHash(e){let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return t.toString(36)}}const I=new me;class U{static instance;config;constructor(){this.config={similarityThreshold:.8,methods:["url","title","content","metadata"],weights:{url:.4,title:.3,content:.2,metadata:.1},ignoreParameters:!0,caseSensitive:!1}}static getInstance(){return U.instance||(U.instance=new U),U.instance}updateConfig(e){this.config={...this.config,...e}}async detectDuplicatesForSource(e){const t=await I.getSource(e);if(!t)throw new Error(`Source ${e} not found`);const s=(await I.getAllSources()).filter(r=>r.id!==e),a=[];for(const r of s){const o=this.calculateSimilarity(t,r);if(o>=this.config.similarityThreshold){const c=this.generateSimilarityReason(t,r,o);a.push({id:r.id,similarity:o,reason:c})}}a.sort((r,o)=>o.similarity-r.similarity);const i=this.generateMergeSuggestions(t,a);return{sourceId:e,duplicates:a,suggestions:i}}async detectAllDuplicates(){const e=await I.getAllSources(),t=[],n=new Set;for(const s of e){const a=await this.detectDuplicatesForSource(s.id),i=a.duplicates.filter(r=>{const o=[s.id,r.id].sort().join("-");return n.has(o)?!1:(n.add(o),!0)});i.length>0&&t.push({...a,duplicates:i})}return t}calculateSimilarity(e,t){let n=0,s=0;for(const a of this.config.methods){const i=this.config.weights[a],r=this.calculateMethodSimilarity(e,t,a);n+=r*i,s+=i}return s>0?n/s:0}calculateMethodSimilarity(e,t,n){switch(n){case"url":return this.calculateUrlSimilarity(e.url,t.url);case"title":return this.calculateTextSimilarity(e.title,t.title);case"content":return this.calculateContentSimilarity(e,t);case"metadata":return this.calculateMetadataSimilarity(e.metadata,t.metadata);case"combined":return this.calculateUrlSimilarity(e.url,t.url)*.4+this.calculateTextSimilarity(e.title,t.title)*.6;default:return 0}}calculateUrlSimilarity(e,t){try{const n=new URL(e),s=new URL(t);if(e===t)return 1;if(n.hostname===s.hostname&&n.pathname===s.pathname){if(this.config.ignoreParameters)return 1;const a=new Set(n.searchParams.keys()),i=new Set(s.searchParams.keys()),r=new Set(Array.from(a).filter(c=>i.has(c))),o=new Set([...Array.from(a),...Array.from(i)]);return o.size>0?r.size/o.size:1}return n.hostname===s.hostname?.7:n.pathname===s.pathname&&n.pathname!=="/"?.5:0}catch{return this.calculateTextSimilarity(e,t)}}calculateTextSimilarity(e,t){if(!e||!t)return 0;const n=l=>this.config.caseSensitive?l:l.toLowerCase(),s=n(e),a=n(t);if(s===a)return 1;const i=new Set(s.split(/\s+/).filter(l=>l.length>0)),r=new Set(a.split(/\s+/).filter(l=>l.length>0)),o=new Set(Array.from(i).filter(l=>r.has(l))),c=new Set([...Array.from(i),...Array.from(r)]);return c.size>0?o.size/c.size:0}calculateContentSimilarity(e,t){const n=[this.calculateNumericSimilarity(e.metadata?.wordCount??0,t.metadata?.wordCount??0),this.calculateNumericSimilarity(e.metadata?.readingTime??0,t.metadata?.readingTime??0),this.calculateArraySimilarity(e.metadata?.keywords??[],t.metadata?.keywords??[])];return n.reduce((s,a)=>s+a,0)/n.length}calculateMetadataSimilarity(e,t){const n=[];return e?.author&&t?.author&&n.push(this.calculateTextSimilarity(e.author,t.author)),e?.category&&t?.category&&n.push(e.category===t.category?1:0),n.push(this.calculateArraySimilarity(e?.tags||[],t?.tags||[])),e?.language&&t?.language&&n.push(e.language===t.language?1:0),n.length>0?n.reduce((s,a)=>s+a,0)/n.length:0}calculateNumericSimilarity(e,t){return e===t?1:e===0||t===0?0:Math.min(e,t)/Math.max(e,t)}calculateArraySimilarity(e,t){if(e.length===0&&t.length===0)return 1;if(e.length===0||t.length===0)return 0;const n=new Set(e.map(r=>this.config.caseSensitive?r:r.toLowerCase())),s=new Set(t.map(r=>this.config.caseSensitive?r:r.toLowerCase())),a=new Set(Array.from(n).filter(r=>s.has(r))),i=new Set([...Array.from(n),...Array.from(s)]);return i.size>0?a.size/i.size:0}generateSimilarityReason(e,t,n){const s=[],a=this.calculateUrlSimilarity(e.url,t.url);a>.8?s.push("Very similar URLs"):a>.5&&s.push("Similar domains or paths");const i=this.calculateTextSimilarity(e.title,t.title);return i>.8?s.push("Nearly identical titles"):i>.5&&s.push("Similar titles"),e.metadata?.author&&t.metadata?.author&&e.metadata.author===t.metadata.author&&s.push("Same author"),e.metadata?.category&&t.metadata?.category&&e.metadata.category===t.metadata.category&&s.push("Same category"),s.length>0?s.join(", "):`${Math.round(n*100)}% similarity`}generateMergeSuggestions(e,t){return t.map(n=>n.similarity>.95?{action:"merge",confidence:.9,reasoning:"Very high similarity suggests these are the same content"}:n.similarity>.85?{action:"merge",confidence:.7,reasoning:"High similarity suggests likely duplicates"}:n.similarity>.7?{action:"keep_both",confidence:.6,reasoning:"Moderate similarity - may be related but distinct content"}:{action:"keep_both",confidence:.8,reasoning:"Low similarity - likely different content"})}async mergeSources(e,t,n={preferNewer:!0,preserveUsageStats:!0,combineMetadata:!0,keepBothIfUncertain:!1}){const s=await I.getSource(e);if(!s)throw new Error(`Primary source ${e} not found`);const i=(await Promise.all(t.map(o=>I.getSource(o)))).filter(o=>o!==void 0),r=[];if(n.preserveUsageStats){for(const o of i)if(s.usage&&o.usage){s.usage.timesReferenced+=o.usage.timesReferenced;const c=o.usage.generatedModules.filter(l=>!s.usage.generatedModules.includes(l));s.usage.generatedModules.push(...c),o.usage.lastAccessed>s.usage.lastAccessed&&(s.usage.lastAccessed=o.usage.lastAccessed)}}if(n.combineMetadata){for(const o of i)if(s.metadata&&o.metadata){const c=o.metadata.tags.filter(d=>!s.metadata.tags.includes(d));s.metadata.tags.push(...c);const l=o.metadata.keywords.filter(d=>!s.metadata.keywords.includes(d));s.metadata.keywords.push(...l),o.metadata.author&&s.metadata.author&&o.metadata.author!==s.metadata.author&&r.push(`Author conflict: ${s.metadata.author} vs ${o.metadata.author}`)}}await I.updateSource(s.id,s);for(const o of t)await I.deleteSource(o);return{success:!0,mergedSourceId:e,removedSourceIds:t,conflicts:r,preservedData:{usage:n.preserveUsageStats,metadata:n.combineMetadata,relationships:!0}}}}const pe=U.getInstance();class fe{logger=A("interactive-analyzer");initialized=!1;async initialize(){this.initialized||(await m.initialize(),this.initialized=!0,this.logger.info("Interactive Analyzer initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async analyzeContent(e){await this.ensureInitialized(),this.logger.info("Analyzing content for interactivity",{contentId:e});try{const t=await m.getContent(e);if(!t)throw new Error(`Content not found: ${e}`);const n={interactiveElements:[],javascriptFrameworks:[],dependencies:[],dataRequirements:{},preservationFeasibility:{},opportunities:[]};return n.interactiveElements=this.detectInteractiveElements(t.content.html),n.javascriptFrameworks=this.detectJavaScriptFrameworks(t.content.html),n.dependencies=this.analyzeDependencies(t.content.html),n.preservationFeasibility=this.assessPreservationFeasibility(n.interactiveElements),n.opportunities=this.generateInteractiveOpportunities(t),this.logger.info("Content analysis completed",{contentId:e,interactiveElements:n.interactiveElements.length,frameworks:n.javascriptFrameworks.length,opportunities:n.opportunities.length}),n}catch(t){throw this.logger.error("Failed to analyze content:",t),new Error(`Content analysis failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async transform(e,t){await this.ensureInitialized();const{type:n,domain:s,parameters:a={}}=t;this.logger.info("Transforming content to interactive",{contentId:e,transformationType:n,domain:s});try{const i=await m.getContent(e);if(!i)throw new Error(`Content not found: ${e}`);const r={transformedContent:null,interactiveBlocks:[],preservationResults:{},metadata:{transformationType:n,domain:s,parameters:a,transformedAt:new Date().toISOString()}},o=await this.analyzeContent(e);switch(n){case"auto":r.interactiveBlocks=this.autoTransform(i,o);break;case"visualization":r.interactiveBlocks=this.createVisualizationBlocks(i,s);break;case"simulation":r.interactiveBlocks=this.createSimulationBlocks(i,s);break;case"chart":r.interactiveBlocks=this.createInteractiveCharts(i);break;case"quiz":r.interactiveBlocks=this.generateQuizBlocks(i);break;default:throw new Error(`Unknown transformation type: ${n}`)}return r.transformedContent={...i,blocks:[...i.content.blocks||[],...r.interactiveBlocks],metadata:{...i.metadata,transformed:!0,transformationType:n,transformedAt:new Date().toISOString()}},this.logger.info("Content transformation completed",{contentId:e,blocksCreated:r.interactiveBlocks.length}),r}catch(i){throw this.logger.error("Failed to transform content:",i),new Error(`Content transformation failed: ${i instanceof Error?i.message:"Unknown error"}`)}}async generateVisualization(e,t){await this.ensureInitialized();const{type:n,config:s={}}=t;this.logger.info("Generating visualization",{contentId:e,visualizationType:n});try{const a=await m.getContent(e);if(!a)throw new Error(`Content not found: ${e}`);const i={id:`viz_${Date.now()}`,type:n,contentId:e,data:null,config:null,interactionHandlers:[]};switch(n){case"chart":i.data=this.extractChartData(a),i.config=this.createChartConfig(s),i.interactionHandlers=this.createChartInteractions();break;case"network":i.data=this.extractNetworkData(a),i.config=this.createNetworkConfig(s),i.interactionHandlers=this.createNetworkInteractions();break;case"timeline":i.data=this.extractTimelineData(a),i.config=this.createTimelineConfig(s),i.interactionHandlers=this.createTimelineInteractions();break;case"neural-network":i.data=this.extractNeuralNetworkData(a),i.config=this.createNeuralNetworkConfig(s),i.interactionHandlers=this.createNeuralNetworkInteractions();break;default:throw new Error(`Unknown visualization type: ${n}`)}return{visualization:i,config:i.config,interactionHandlers:i.interactionHandlers}}catch(a){throw this.logger.error("Failed to generate visualization:",a),new Error(`Visualization generation failed: ${a instanceof Error?a.message:"Unknown error"}`)}}detectInteractiveElements(e){const t=[],n=[{selector:"button",type:"button"},{selector:"input",type:"input"},{selector:"select",type:"select"},{selector:"textarea",type:"textarea"},{selector:"form",type:"form"},{selector:"canvas",type:"canvas"},{selector:"svg",type:"svg"},{selector:"[onclick]",type:"clickable"},{selector:"[data-*]",type:"data-element"}],a=new DOMParser().parseFromString(e,"text/html");return n.forEach(({selector:i,type:r})=>{a.querySelectorAll(i).forEach((c,l)=>{t.push({id:`element_${t.length}`,type:r,selector:i,html:c.outerHTML.substring(0,200),detected:"static_analysis",confidence:.8})})}),t}detectJavaScriptFrameworks(e){return[]}analyzeDependencies(e){return[]}assessPreservationFeasibility(e){return{feasible:!0,confidence:.8}}generateInteractiveOpportunities(e){const t=[];e.content.codeBlocks.forEach((s,a)=>{this.isInteractiveCodeCandidate(s)&&t.push({id:`code_${a}`,type:"interactive-code",title:`Interactive Code: ${s.language}`,description:`Make this ${s.language} code block interactive`,confidence:.8,reasoning:`Code block contains ${s.language} code that could be made executable`,sourceElement:`code_block_${a}`,parameters:{language:{type:"text",value:s.language},executable:{type:"boolean",value:!0}}})}),e.content.tables.forEach((s,a)=>{s.rows.length>5&&t.push({id:`table_${a}`,type:"interactive-table",title:"Interactive Data Table",description:"Add filtering and sorting to this data table",confidence:.7,reasoning:`Table has ${s.rows.length} rows and could benefit from interactive features`,sourceElement:`table_${a}`,parameters:{sortable:{type:"boolean",value:!0},filterable:{type:"boolean",value:!0}}})}),e.content.charts.forEach((s,a)=>{t.push({id:`chart_${a}`,type:"interactive-chart",title:`Interactive ${s.type} Chart`,description:`Make this ${s.type} chart interactive with hover and zoom`,confidence:.9,reasoning:"Chart detected and can be enhanced with interactivity",sourceElement:`chart_${a}`,parameters:{chartType:{type:"text",value:s.type},interactive:{type:"boolean",value:!0}}})});const n=e.content.text.toLowerCase();return(n.includes("algorithm")||n.includes("process")||n.includes("step"))&&t.push({id:"simulation_content",type:"simulation",title:"Process Simulation",description:"Create an interactive simulation of the described process",confidence:.6,reasoning:"Content describes processes or algorithms that could be simulated",sourceElement:"main_content",parameters:{simulationType:{type:"text",value:"process"},interactive:{type:"boolean",value:!0}}}),t}isInteractiveCodeCandidate(e){return["javascript","python","html","css","sql"].includes(e.language.toLowerCase())&&e.code.length>50}autoTransform(e,t){return[]}createVisualizationBlocks(e,t){return[]}createSimulationBlocks(e,t){return[]}createInteractiveCharts(e){return[]}generateQuizBlocks(e){return[]}extractChartData(e){return null}createChartConfig(e){return{title:"Chart",description:"Interactive chart",parameters:[],layout:{width:800,height:600,margin:{top:20,right:20,bottom:20,left:20},responsive:!0},styling:{theme:"light",colors:["#1f77b4"],fonts:{family:"Arial",size:12}},animations:{enabled:!0,duration:300,easing:"ease",transitions:[]}}}createChartInteractions(){return[]}extractNetworkData(e){return null}createNetworkConfig(e){return this.createChartConfig(e)}createNetworkInteractions(){return[]}extractTimelineData(e){return null}createTimelineConfig(e){return this.createChartConfig(e)}createTimelineInteractions(){return[]}extractNeuralNetworkData(e){return null}createNeuralNetworkConfig(e){return this.createChartConfig(e)}createNeuralNetworkInteractions(){return[]}}const K=new fe;class O{static instance;config;activeJobs=new Map;jobQueue=[];completedJobs=new Map;isProcessing=!1;logger=A("processing-pipeline");progressReportingTimer;eventListeners=new Map;constructor(){this.config={maxConcurrentJobs:3,retryAttempts:3,retryDelay:1e3,retryBackoffMultiplier:2,maxRetryDelay:3e4,timeoutMs:3e5,enableDuplicateDetection:!0,enableQualityAssessment:!0,enableInteractiveTransformation:!0,enableParallelProcessing:!0,progressReportingInterval:5e3,enableDetailedLogging:!0},this.startProgressReporting()}static getInstance(){return O.instance||(O.instance=new O),O.instance}updateConfig(e){this.config={...this.config,...e},this.logger.info("Pipeline configuration updated",e),e.progressReportingInterval!==void 0&&(this.stopProgressReporting(),this.startProgressReporting())}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const n=this.eventListeners.get(e);if(n){const s=n.indexOf(t);s>-1&&n.splice(s,1)}}emitEvent(e,t){const n=this.eventListeners.get(e);n&&n.forEach(s=>{try{s(t)}catch(a){this.logger.error("Error in event listener:",a)}})}createSingleProcessingJob(e,t="normal",n={}){const s=this.generateJobId(),a=this.createProcessingStages("single"),i={id:s,type:"single",status:"pending",progress:{currentStage:0,totalStages:a.length,stageProgress:0,overallProgress:0},stages:a,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrl:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(i),this.sortJobQueue(),this.logger.info("Single processing job created",{jobId:s,url:e,priority:t}),this.emitEvent("job-created",{job:this.sanitizeJobForEvent(i)}),this.isProcessing||this.processJobQueue(),s}createBatchProcessingJob(e,t="normal",n={}){const s=this.generateJobId();if(this.config.enableParallelProcessing&&n.enableParallel!==!1){const a=e.map(i=>this.createSingleProcessingJob(i,t,{...n,tags:[...n.tags||[],"batch"],batchId:s}));return this.logger.info("Batch processing job created (parallel)",{batchId:s,urlCount:e.length,jobIds:a}),this.emitEvent("batch-created",{batchId:s,urlCount:e.length,jobIds:a,parallel:!0}),s}else{const a=this.createProcessingStages("batch"),i={id:s,type:"batch",status:"pending",progress:{currentStage:0,totalStages:a.length,stageProgress:0,overallProgress:0},stages:a,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrls:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(i),this.sortJobQueue(),this.logger.info("Batch processing job created (sequential)",{batchId:s,urlCount:e.length}),this.emitEvent("batch-created",{batchId:s,urlCount:e.length,parallel:!1}),this.isProcessing||this.processJobQueue(),s}}getJobStatus(e){return this.activeJobs.get(e)||this.jobQueue.find(t=>t.id===e)||this.completedJobs.get(e)}cancelJob(e){const t=this.getJobStatus(e);if(!t)return!1;if(t.status==="pending"){const n=this.jobQueue.findIndex(s=>s.id===e);n>=0&&this.jobQueue.splice(n,1)}return t.status="cancelled",t.completedAt=new Date,!0}getActiveJobs(){return Array.from(this.activeJobs.values())}getJobQueue(){return[...this.jobQueue]}getCompletedJobs(){return Array.from(this.completedJobs.values())}getBatchStatus(e){const t=[...this.jobQueue,...this.activeJobs.values(),...this.completedJobs.values()].filter(r=>r.metadata.batchId===e);if(t.length===0)return null;const n=t.filter(r=>r.status==="completed").length,s=t.filter(r=>r.status==="failed").length,a=t.filter(r=>r.status==="processing").length;let i;return n===t.length?i="completed":s===t.length?i="failed":a>0||n>0?i="processing":i="pending",{batchId:e,totalJobs:t.length,completedJobs:n,failedJobs:s,overallProgress:n/t.length*100,status:i}}getStatistics(){const e=Array.from(this.completedJobs.values()),t=e.filter(a=>a.status==="completed"),n=e.filter(a=>a.startedAt&&a.completedAt).map(a=>a.completedAt.getTime()-a.startedAt.getTime()),s=n.length>0?n.reduce((a,i)=>a+i,0)/n.length:0;return{activeJobs:this.activeJobs.size,queuedJobs:this.jobQueue.length,completedJobs:e.length,totalProcessed:e.length,averageProcessingTime:s,successRate:e.length>0?t.length/e.length*100:0}}async processJobQueue(){if(!this.isProcessing){this.isProcessing=!0;try{for(;this.jobQueue.length>0&&this.activeJobs.size<this.config.maxConcurrentJobs;){const e=this.jobQueue.shift();!e||e.status==="cancelled"||(await new Promise(t=>setTimeout(t,0)),this.activeJobs.set(e.id,e),this.processJob(e).catch(t=>{e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date}).finally(()=>{this.activeJobs.delete(e.id),this.jobQueue.length>0&&setTimeout(()=>void this.processJobQueue(),100)}))}}finally{this.activeJobs.size===0&&this.jobQueue.length===0&&(this.isProcessing=!1)}}}async processJob(e){e.status="processing",e.startedAt=new Date,this.logger.info("Starting job processing",{jobId:e.id,type:e.type}),this.emitEvent("job-started",{job:this.sanitizeJobForEvent(e)});try{for(let t=0;t<e.stages.length;t++){if(this.activeJobs.get(e.id)?.status==="cancelled"){this.logger.info("Job cancelled during processing",{jobId:e.id});return}const n=e.stages[t];e.progress.currentStage=t,e.progress.stageProgress=0,e.stageTimings.set(n.name,{startTime:Date.now()}),this.logger.debug("Processing stage",{jobId:e.id,stage:n.name}),this.emitEvent("stage-started",{jobId:e.id,stage:n.name,stageIndex:t});let s,a=0;for(;a<=this.config.retryAttempts;)try{s=await this.processStageWithTimeout(e,n);break}catch(r){if(a++,a>this.config.retryAttempts)throw r;const o=this.calculateRetryDelay(a);this.logger.warn("Stage failed, retrying",{jobId:e.id,stage:n.name,attempt:a,delay:o,error:r instanceof Error?r.message:"Unknown error"}),this.emitEvent("stage-retry",{jobId:e.id,stage:n.name,attempt:a,delay:o}),await this.delay(o)}const i=e.stageTimings.get(n.name);if(i.endTime=Date.now(),i.duration=i.endTime-i.startTime,e.results.push(s),!s.success)throw new Error(`Stage ${n.name} failed: ${s.metadata.issues.join(", ")}`);e.progress.stageProgress=100,e.progress.overallProgress=(t+1)/e.stages.length*100,e.progressHistory.push({timestamp:new Date,stage:n.name,progress:e.progress.overallProgress}),this.updateTimeEstimate(e),this.logger.debug("Stage completed",{jobId:e.id,stage:n.name,duration:i.duration}),this.emitEvent("stage-completed",{jobId:e.id,stage:n.name,duration:i.duration,progress:e.progress.overallProgress})}e.status="completed",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.info("Job completed successfully",{jobId:e.id,duration:e.completedAt.getTime()-e.startedAt.getTime()}),this.emitEvent("job-completed",{job:this.sanitizeJobForEvent(e)})}catch(t){throw e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.error("Job failed",{jobId:e.id,error:e.error,retryCount:e.retryCount}),this.emitEvent("job-failed",{job:this.sanitizeJobForEvent(e),error:e.error}),t}}async processStage(e,t){const n=Date.now(),s=[];try{let a={};switch(t.name){case"fetch":a=await this.processFetchStage(e,t);break;case"extract":a=await this.processExtractStage(e,t);break;case"store":a=await this.processStoreStage(e,t);break;case"duplicate_check":this.config.enableDuplicateDetection&&(a=await this.processDuplicateCheckStage(e,t));break;case"quality_assessment":this.config.enableQualityAssessment&&(a=await this.processQualityAssessmentStage(e,t));break;case"interactive_transformation":this.config.enableInteractiveTransformation&&(a=await this.processInteractiveTransformationStage(e,t));break;default:s.push(`Unknown stage: ${t.name}`)}const i=this.calculateStageConfidence(t.name,a);return{stage:t.name,success:s.length===0,data:a,metadata:{processingTime:Date.now()-n,confidence:i,issues:s}}}catch(a){return s.push(a instanceof Error?a.message:"Unknown error"),{stage:t.name,success:!1,data:null,metadata:{processingTime:Date.now()-n,confidence:0,issues:s}}}}async processFetchStage(e,t){const n=e.metadata.sourceUrl||e.metadata.sourceUrls?.[0];if(!n)throw new Error("No URL provided for fetch stage");this.logger.debug("Fetching content",{jobId:e.id,url:n});try{const s=await V.fetch(n,{timeout:this.config.timeoutMs,cleanContent:!0,preserveInteractivity:!0});if(!s.success)throw new Error(`Failed to fetch content: ${s.extraction.issues.join(", ")}`);return{webContent:s,url:n,fetchedAt:new Date,success:!0,confidence:s.extraction.confidence}}catch(s){throw this.logger.error("Fetch stage failed",{jobId:e.id,url:n,error:s}),s}}async processExtractStage(e,t){const n=e.results.find(a=>a.stage==="fetch");if(!n?.data?.webContent)throw new Error("No web content available for extraction");const s=n.data.webContent;this.logger.debug("Analyzing content for interactivity",{jobId:e.id,contentId:s.id});try{const a=await I.addSource({url:s.url,title:s.title,metadata:s.metadata}),i=await K.analyzeContent(s.id);return{contentId:a.sourceId,analysis:i,extractionMethod:s.extraction.method,confidence:s.extraction.confidence,interactiveOpportunities:i.opportunities.length}}catch(a){throw this.logger.error("Extract stage failed",{jobId:e.id,error:a}),a}}async processStoreStage(e,t){const n=e.results.find(a=>a.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for storage");const s=n.data.contentId;this.logger.debug("Storing content permanently",{jobId:e.id,contentId:s});try{const a=await m.getSource(s);if(!a)throw new Error("Content not found in source manager");return await I.updateSource(s,{status:"updated"}),{sourceId:s,stored:!0,url:a.url,title:a.title}}catch(a){throw this.logger.error("Store stage failed",{jobId:e.id,error:a}),a}}async processDuplicateCheckStage(e,t){const n=e.results.find(a=>a.stage==="store");if(!n?.data?.sourceId)return{duplicatesFound:!1};const s=await pe.detectDuplicatesForSource(n.data.sourceId);return{duplicatesFound:s.duplicates.length>0,duplicateCount:s.duplicates.length,suggestions:s.suggestions}}async processQualityAssessmentStage(e,t){const n=e.results.find(i=>i.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for quality assessment");const s=n.data.contentId,a=n.data.analysis;this.logger.debug("Assessing content quality",{jobId:e.id,contentId:s});try{const i=await m.getSource(s);if(!i)throw new Error("Source not found for quality assessment");const r=this.assessContentQuality(i,a);return{contentId:s,qualityScore:r.overallScore,readabilityScore:r.readabilityScore,interactivityPotential:r.interactivityScore,accessibilityScore:r.accessibilityScore,suggestions:this.generateQualityImprovements(r),metrics:r}}catch(i){throw this.logger.error("Quality assessment stage failed",{jobId:e.id,error:i}),i}}async processInteractiveTransformationStage(e,t){const n=e.results.find(i=>i.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for transformation");const s=n.data.contentId,a=n.data.analysis;this.logger.debug("Transforming content to interactive",{jobId:e.id,contentId:s,opportunities:a.opportunities.length});try{const i=await K.transform(s,{type:"auto",domain:this.detectDomain(a),parameters:t.config});return{contentId:s,transformationsApplied:i.interactiveBlocks.length,interactiveElementsCreated:i.interactiveBlocks.map(r=>r.type),confidence:this.calculateTransformationConfidence(i),transformedContent:i.transformedContent}}catch(i){throw this.logger.error("Interactive transformation stage failed",{jobId:e.id,error:i}),i}}createProcessingStages(e){const t=[{name:"fetch",processor:"WebContentFetcher",config:{},dependencies:[],outputs:["webContent"]},{name:"extract",processor:"ContentExtractor",config:{},dependencies:["fetch"],outputs:["extractedContent"]},{name:"store",processor:"SourceManager",config:{},dependencies:["extract"],outputs:["sourceId"]}];return this.config.enableDuplicateDetection&&t.push({name:"duplicate_check",processor:"DuplicateDetector",config:{},dependencies:["store"],outputs:["duplicateReport"]}),this.config.enableQualityAssessment&&t.push({name:"quality_assessment",processor:"QualityAssessor",config:{},dependencies:["store"],outputs:["qualityReport"]}),this.config.enableInteractiveTransformation&&t.push({name:"interactive_transformation",processor:"InteractiveTransformer",config:{},dependencies:["quality_assessment"],outputs:["interactiveContent"]}),t}sortJobQueue(){const e={high:3,normal:2,low:1};this.jobQueue.sort((t,n)=>{const s=e[t.metadata.priority],a=e[n.metadata.priority];return s!==a?a-s:t.createdAt.getTime()-n.createdAt.getTime()})}generateJobId(){return`job_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async processStageWithTimeout(e,t){return new Promise((n,s)=>{const a=setTimeout(()=>{s(new Error(`Stage ${t.name} timed out after ${this.config.timeoutMs}ms`))},this.config.timeoutMs);this.processStage(e,t).then(i=>{clearTimeout(a),n(i)}).catch(i=>{clearTimeout(a),s(i)})})}calculateRetryDelay(e){const t=this.config.retryDelay*Math.pow(this.config.retryBackoffMultiplier,e-1);return Math.min(t,this.config.maxRetryDelay)}delay(e){return new Promise(t=>setTimeout(t,e))}updateTimeEstimate(e){if(e.progressHistory.length<2)return;const t=e.progressHistory.slice(-3),n=t.reduce((a,i,r)=>{if(r===0)return a;const o=t[r-1],c=i.timestamp.getTime()-o.timestamp.getTime(),l=i.progress-o.progress;return a+(l>0?c/l:0)},0)/(t.length-1),s=100-e.progress.overallProgress;if(e.progress.estimatedTimeRemaining=s*n,e.startedAt){const a=Date.now()-e.startedAt.getTime();e.progress.throughput=e.progress.overallProgress/a*1e3}}sanitizeJobForEvent(e){return{id:e.id,type:e.type,status:e.status,progress:e.progress,retryCount:e.retryCount,createdAt:e.createdAt,startedAt:e.startedAt,completedAt:e.completedAt,metadata:{priority:e.metadata.priority,tags:e.metadata.tags,batchId:e.metadata.batchId}}}startProgressReporting(){this.progressReportingTimer&&clearInterval(this.progressReportingTimer),this.progressReportingTimer=setInterval(()=>{if(this.activeJobs.size>0){const e=Array.from(this.activeJobs.values()),t=this.getStatistics();this.emitEvent("progress-report",{activeJobs:e.map(n=>this.sanitizeJobForEvent(n)),statistics:t,timestamp:new Date}),this.config.enableDetailedLogging&&this.logger.debug("Progress report",{statistics:t,activeJobCount:e.length})}},this.config.progressReportingInterval)}stopProgressReporting(){this.progressReportingTimer&&(clearInterval(this.progressReportingTimer),this.progressReportingTimer=void 0)}cleanupCompletedJobs(e=24*60*60*1e3){const t=Date.now()-e,n=[];this.completedJobs.forEach((s,a)=>{s.completedAt&&s.completedAt.getTime()<t&&n.push(a)}),n.forEach(s=>this.completedJobs.delete(s)),n.length>0&&this.logger.info("Cleaned up completed jobs",{removedCount:n.length})}detectDomain(e){return e.javascriptFrameworks.some(t=>t.name.includes("React"))?"web-development":e.interactiveElements.some(t=>t.type==="canvas")?"data-visualization":"general"}calculateTransformationConfidence(e){const t=e.interactiveBlocks.length;return t===0?.1:t>=3?.9:.5+t*.2}calculateStageConfidence(e,t){switch(e){case"fetch":return t.confidence||.8;case"extract":return t.confidence||.7;case"store":return t.stored?.9:.1;case"duplicate_check":return .8;case"quality_assessment":return t.qualityScore||.6;case"interactive_transformation":return t.confidence||.7;default:return .5}}assessContentQuality(e,t){const n=e.content,s=e.metadata,a=this.calculateReadabilityScore(n.text),i=t.opportunities.length>0?Math.min(t.opportunities.length*.2,1):.1,r=this.calculateAccessibilityScore(n.html),o=this.calculateEngagementScore(n,s),c=(a+i+r+o)/4;return{readabilityScore:a,interactivityScore:i,accessibilityScore:r,engagementScore:o,overallScore:c}}calculateReadabilityScore(e){const t=e.split(/\s+/).length,n=e.split(/[.!?]+/).length,s=t/n;return s<15?.9:s<20?.7:s<25?.5:.3}calculateAccessibilityScore(e){let t=.5;const n=e.match(/<img[^>]*>/g)||[],s=e.match(/<img[^>]*alt\s*=\s*["'][^"']*["'][^>]*>/g)||[];return n.length>0&&(t+=s.length/n.length*.2),(e.includes("<h1")||e.includes("<h2"))&&(t+=.1),(e.includes("<nav")||e.includes("<main"))&&(t+=.1),e.includes("aria-")&&(t+=.1),Math.min(t,1)}calculateEngagementScore(e,t){let n=.3;return e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),e.images.length>0&&(n+=.1),e.codeBlocks.length>0&&(n+=.1),e.tables.length>0&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.keywords.length>0&&(n+=.1),Math.min(n,1)}generateQualityImprovements(e){const t=[];return e.readabilityScore<.6&&t.push("Consider breaking up long sentences for better readability"),e.interactivityScore<.4&&t.push("Add interactive elements like charts, quizzes, or simulations"),e.accessibilityScore<.7&&t.push("Improve accessibility by adding alt text to images and using semantic HTML"),e.engagementScore<.5&&t.push("Add more visual elements and structured content to increase engagement"),t}}const _=O.getInstance(),De={startProcessing:async(p,e)=>({success:!0,id:_.createSingleProcessingJob(p[0]??"")}),startBatchProcessing:async(p,e)=>({id:_.createBatchProcessingJob(p)}),onProgressUpdate:p=>{const e=t=>p(t);return _.addEventListener("progress-report",e),()=>_.removeEventListener("progress-report",e)},onJobComplete:p=>{const e=({job:t})=>p(t);return _.addEventListener("job-completed",e),()=>_.removeEventListener("job-completed",e)},onJobError:p=>{const e=({job:t,error:n})=>p(t.id,new Error(n));return _.addEventListener("job-failed",e),()=>_.removeEventListener("job-failed",e)}},ye=A("interactive-document-generator");class we{generatePreviewHtml(e){ye.info("Generating HTML preview for interactive document",{numBlocks:e.length});let t="";return e.forEach(n=>{switch(n.type){case"text":t+=`<div class="preview-text">${n.content.html||"<p>No text content</p>"}</div>`;break;case"code":t+=`<div class="preview-code"><pre><code>${n.content.code||"// No code content"}</code></pre></div>`;break;case"quiz":t+=`<div class="preview-quiz"><h4>${n.content.question||"No question"}</h4><ul>`,(n.content.options||[]).forEach((s,a)=>{t+=`<li>${a+1}. ${s}</li>`}),t+="</ul></div>";break;case"interactive-visualization":t+=`<div class="preview-visualization">Interactive Visualization: ${n.content.type||"Unknown"}</div>`;break;case"interactive-chart":t+=`<div class="preview-chart">Interactive Chart: ${n.content.type||"Unknown"}</div>`;break;case"image":t+=`<div class="preview-image"><img src="${n.content.src}" alt="${n.content.alt||"Image"}" /></div>`;break;case"video":t+=`<div class="preview-video"><video controls src="${n.content.src}"></video></div>`;break;case"flashcard":t+=`<div class="preview-flashcard"><div class="front">${n.content.front}</div><div class="back">${n.content.back}</div></div>`;break;case"diagram":t+=`<div class="preview-diagram">Diagram: ${n.content.type||"Unknown"}</div>`;break;case"simulation":t+=`<div class="preview-simulation">Simulation: ${n.content.type||"Unknown"}</div>`;break;default:t+=`<div class="preview-unknown">Unsupported Block Type: ${n.type}</div>`}}),t}}const Ee=new we,H=A("enhanced-url-fetcher");class be{async fetchAndProcess(e){H.info(`Simulating fetch and process for URL: ${e}`),await new Promise(t=>setTimeout(t,1e3));try{const n=new URL(e).hostname,s=`Content from ${n}`,a={id:`content_${Date.now()}`,url:e,title:s,domain:n,importDate:new Date,lastChecked:new Date,status:"active",metadata:{author:"Simulated Author",publishDate:new Date,domain:n,contentType:"article",language:"en",readingTime:Math.floor(Math.random()*30)+5,wordCount:Math.floor(Math.random()*5e3)+1e3,keywords:["simulated","web",n.split(".")[0]].filter(Boolean),description:`Simulated content fetched from ${e}`,tags:[],category:"web-content",contentHash:`hash_${Date.now()}`},usage:{timesReferenced:0,lastAccessed:new Date,generatedModules:[]}};return H.info(`Successfully simulated fetch for URL: ${e}`),a}catch(t){throw H.error(`Failed to simulate fetch for URL: ${e}`,t),new Error(`Failed to fetch and process URL: ${e} - ${t instanceof Error?t.message:"Unknown error"}`)}}}const Ae=new be,Se={enableOcr:!0,ocrLanguage:"eng",extractImages:!0,detectCodeBlocks:!0,generateToc:!0,minSectionLength:100,maxSectionDepth:6};class ve{config;constructor(e={}){this.config={...Se,...e}}async processPdf(e){try{const t=await e.arrayBuffer(),n=new Uint8Array(t);let s="",a="direct",i=.9;try{s=await this.extractPdfText(n),s.trim().length<100&&this.config.enableOcr&&(s=await this.performOcr(n),a="ocr",i=.7)}catch{if(this.config.enableOcr)s=await this.performOcr(n),a="ocr-fallback",i=.6;else throw new Error("PDF text extraction failed and OCR is disabled")}const r=[];if(this.config.extractImages){const d=await this.extractPdfImages(n);r.push(...d)}const o={originalFormat:"pdf",title:e.name.replace(".pdf",""),created:new Date,modified:new Date,wordCount:this.countWords(s),tags:[],extractionMethod:a,confidence:i},c=await this.buildDocumentStructure(s),l=await this.createContentBlocks(s,c);return{id:this.generateId(),title:o.title,content:l,metadata:o,structure:c,assets:r}}catch(t){throw new Error(`PDF processing failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async processMarkdown(e,t){try{const n=await this.parseMarkdownStructure(e),{content:s,frontmatter:a}=this.extractFrontmatter(e),i=await this.createMarkdownContentBlocks(s,n),r=await this.extractMarkdownAssets(s),o={originalFormat:"markdown",title:a?.title||t?.replace(".md","")||"Untitled",author:a?.author,created:a?.date?new Date(a.date):new Date,modified:new Date,language:a?.language||"en",wordCount:this.countWords(s),tags:a?.tags||[],extractionMethod:"markdown-parser",confidence:.95};return{id:this.generateId(),title:o.title,content:i,metadata:o,structure:n,assets:r}}catch(n){throw new Error(`Markdown processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processWebContent(e,t){try{const n=this.extractMainContent(e),s=await this.buildHtmlStructure(n),a=await this.createHtmlContentBlocks(n,s),i=await this.extractHtmlAssets(n,t),r={originalFormat:"html",title:this.extractHtmlTitle(e)||"Web Content",created:new Date,modified:new Date,wordCount:this.countWords(this.stripHtml(n)),tags:this.extractHtmlTags(e),extractionMethod:"html-parser",confidence:.8};return{id:this.generateId(),title:r.title,content:a,metadata:r,structure:s,assets:i}}catch(n){throw new Error(`Web content processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processDocument(e,t){if(e instanceof File){const n=t||this.detectFileType(e);switch(n){case"pdf":return this.processPdf(e);case"markdown":const s=await e.text();return this.processMarkdown(s,e.name);default:throw new Error(`Unsupported file type: ${n}`)}}else switch(t||this.detectContentType(e)){case"markdown":return this.processMarkdown(e);case"html":return this.processWebContent(e);default:return this.processPlainText(e)}}async extractPdfText(e){throw new Error("PDF text extraction not implemented - requires pdf-parse library")}async performOcr(e){throw new Error("OCR not implemented - requires Tesseract.js library")}async extractPdfImages(e){return[]}async buildDocumentStructure(e){const t=this.detectSections(e),n=this.generateTableOfContents(t),s={maxDepth:this.getMaxDepth(t),sectionCount:this.countAllSections(t),hasImages:e.includes("![")||e.includes("<img"),hasCodeBlocks:e.includes("```")||e.includes("<code"),hasTables:e.includes("|")||e.includes("<table")};return{sections:t,toc:n,metadata:s}}detectSections(e){const t=[],n=e.split(`
`);let s=null,a=0;for(let i=0;i<n.length;i++){const o=n[i].trim().match(/^(#{1,6})\s+(.+)$/);if(o){const c=o[1].length,l=o[2];s&&(s.endPosition=i),s={id:`section-${++a}`,title:l,level:c,content:[],subsections:[],startPosition:i,endPosition:i},t.push(s)}}return s&&(s.endPosition=n.length),this.buildSectionHierarchy(t)}buildSectionHierarchy(e){const t=[],n=[];for(const s of e){for(;n.length>0&&n[n.length-1].level>=s.level;)n.pop();n.length===0?t.push(s):n[n.length-1].subsections.push(s),n.push(s)}return t}generateTableOfContents(e){const t=n=>({id:n.id,title:n.title,level:n.level,position:n.startPosition,children:n.subsections.map(t)});return{entries:e.map(t)}}async createContentBlocks(e,t){const n=[],s=e.split(`
`);for(const a of t.sections){const r=s.slice(a.startPosition,a.endPosition).join(`
`);if(r.trim()&&n.push({id:this.generateId(),type:"text",content:{text:r,format:"markdown"},metadata:{created:new Date,modified:new Date,version:1}}),this.config.detectCodeBlocks){const o=this.extractCodeBlocks(r);n.push(...o)}}return n}extractCodeBlocks(e){const t=[],n=/```(\w+)?\n([\s\S]*?)```/g;let s;for(;(s=n.exec(e))!==null;){const a=s[1]||"text",i=s[2];t.push({id:this.generateId(),type:"code",content:{code:i,language:a,executable:this.isExecutableLanguage(a)},metadata:{created:new Date,modified:new Date,version:1}})}return t}isExecutableLanguage(e){return["javascript","python","typescript","sql"].includes(e.toLowerCase())}async parseMarkdownStructure(e){const t=this.detectMarkdownSections(e),n=this.generateTableOfContents(t),s={maxDepth:this.getMaxDepth(t),sectionCount:this.countAllSections(t),hasImages:/!\[.*?\]\(.*?\)/.test(e),hasCodeBlocks:/```[\s\S]*?```/.test(e),hasTables:/\|.*\|/.test(e)};return{sections:t,toc:n,metadata:s}}detectMarkdownSections(e){const t=[],n=e.split(`
`);let s=0;for(let a=0;a<n.length;a++){const i=n[a],r=i.match(/^(#{1,6})\s+(.+)$/);if(r){t.push({id:`section-${++s}`,title:r[2],level:r[1].length,content:[],subsections:[],startPosition:a,endPosition:a});continue}if(a<n.length-1){const o=n[a+1];if(/^=+$/.test(o)&&i.trim()){t.push({id:`section-${++s}`,title:i.trim(),level:1,content:[],subsections:[],startPosition:a,endPosition:a}),a++;continue}if(/^-+$/.test(o)&&i.trim()){t.push({id:`section-${++s}`,title:i.trim(),level:2,content:[],subsections:[],startPosition:a,endPosition:a}),a++;continue}}}for(let a=0;a<t.length;a++)a<t.length-1?t[a].endPosition=t[a+1].startPosition:t[a].endPosition=n.length;return this.buildSectionHierarchy(t)}extractFrontmatter(e){const t=/^---\n([\s\S]*?)\n---\n([\s\S]*)$/,n=e.match(t);if(!n)return{content:e,frontmatter:null};try{const s=n[1],a={},i=s.split(`
`);for(const r of i){const o=r.indexOf(":");if(o>0){const c=r.substring(0,o).trim(),l=r.substring(o+1).trim();l.startsWith("[")&&l.endsWith("]")?a[c]=l.slice(1,-1).split(",").map(d=>d.trim().replace(/['"]/g,"")):a[c]=l.replace(/['"]/g,"")}}return{content:n[2],frontmatter:a}}catch{return{content:e,frontmatter:null}}}async createMarkdownContentBlocks(e,t){const n=[];for(const s of t.sections){const a=this.extractSectionContent(e,s);if(a.trim()&&n.push({id:this.generateId(),type:"text",content:{text:a,format:"markdown",section:s.title},metadata:{created:new Date,modified:new Date,version:1}}),this.config.detectCodeBlocks){const i=this.extractCodeBlocks(a);n.push(...i)}}if(this.config.detectCodeBlocks){const s=this.extractCodeBlocks(e);for(const a of s)n.some(r=>r.type==="code"&&r.content.code===a.content.code)||n.push(a)}return n}extractSectionContent(e,t){return e.split(`
`).slice(t.startPosition,t.endPosition).join(`
`)}async extractMarkdownAssets(e){const t=[];if(this.config.extractImages){const n=/!\[([^\]]*)\]\(([^)]+)\)/g;let s;for(;(s=n.exec(e))!==null;){const a=s[1],i=s[2];t.push({id:this.generateId(),type:"image",url:i,filename:i.split("/").pop()||"image",size:0,mimeType:this.getMimeTypeFromUrl(i),extractedFrom:"markdown",metadata:{alt:a}})}}return t}buildHtmlStructure(e){const t=/<h([1-6])[^>]*>(.*?)<\/h[1-6]>/gi,n=[];let s,a=0;for(;(s=t.exec(e))!==null;){const c=parseInt(s[1]),l=this.stripHtml(s[2]);n.push({id:`section-${++a}`,title:l,level:c,content:[],subsections:[],startPosition:s.index,endPosition:s.index+s[0].length})}const i=this.buildSectionHierarchy(n),r=this.generateTableOfContents(i),o={maxDepth:this.getMaxDepth(i),sectionCount:this.countAllSections(i),hasImages:/<img[^>]*>/i.test(e),hasCodeBlocks:/<code[^>]*>|<pre[^>]*>/i.test(e),hasTables:/<table[^>]*>/i.test(e)};return Promise.resolve({sections:i,toc:r,metadata:o})}async createHtmlContentBlocks(e,t){const n=[],s=this.stripHtml(e);s.trim()&&n.push({id:this.generateId(),type:"text",content:{text:s,format:"html",originalHtml:e},metadata:{created:new Date,modified:new Date,version:1}});const a=/<pre[^>]*><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi;let i;for(;(i=a.exec(e))!==null;){const r=this.decodeHtml(i[1]);n.push({id:this.generateId(),type:"code",content:{code:r,language:"text",executable:!1},metadata:{created:new Date,modified:new Date,version:1}})}return n}async extractHtmlAssets(e,t){const n=[],s=/<img[^>]+src="([^"]+)"[^>]*>/gi;let a;for(;(a=s.exec(e))!==null;){let i=a[1];t&&!i.startsWith("http")&&(i=new URL(i,t).href),n.push({id:this.generateId(),type:"image",url:i,filename:i.split("/").pop()||"image",size:0,mimeType:this.getMimeTypeFromUrl(i),extractedFrom:"html"})}return n}extractMainContent(e){const t=e.match(/<body[^>]*>([\s\S]*)<\/body>/i);return t?t[1]:e}extractHtmlTitle(e){const t=e.match(/<title[^>]*>(.*?)<\/title>/i);return t?this.stripHtml(t[1]):""}extractHtmlTags(e){const t=/<meta[^>]+name="keywords"[^>]+content="([^"]+)"/i,n=e.match(t);return n?n[1].split(",").map(s=>s.trim()):[]}async processPlainText(e){const t=await this.buildDocumentStructure(e),n=await this.createContentBlocks(e,t),s={originalFormat:"text",title:"Plain Text Document",created:new Date,modified:new Date,wordCount:this.countWords(e),tags:[],extractionMethod:"plain-text",confidence:.5};return{id:this.generateId(),title:s.title,content:n,metadata:s,structure:t,assets:[]}}detectFileType(e){switch(e.name.split(".").pop()?.toLowerCase()){case"pdf":return"pdf";case"md":case"markdown":return"markdown";case"html":case"htm":return"html";default:return"text"}}detectContentType(e){return e.includes("<!DOCTYPE")||e.includes("<html")?"html":e.includes("#")||e.includes("```")||e.includes("*")?"markdown":"text"}countWords(e){return e.trim().split(/\s+/).length}stripHtml(e){return e.replace(/<[^>]*>/g,"").trim()}decodeHtml(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&[^;]+;/g,n=>t[n]||n)}getMimeTypeFromUrl(e){const t=e.split(".").pop()?.toLowerCase();return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp"}[t||""]||"application/octet-stream"}generateId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getMaxDepth(e){let t=0;const n=(s,a)=>{for(const i of s)t=Math.max(t,a),n(i.subsections,a+1)};return n(e,1),t}countAllSections(e){let t=e.length;for(const n of e)t+=this.countAllSections(n.subsections);return t}countAllSections(e){let t=e.length;for(const n of e)t+=this.countAllSections(n.subsections);return t}getMaxDepth(e){if(e.length===0)return 0;let t=0;for(const n of e){t=Math.max(t,n.level);const s=this.getMaxDepth(n.subsections);t=Math.max(t,s)}return t}}new ve;export{j as _,K as a,I as b,Ie as c,Ae as e,Ee as i,Te as m,De as p,_e as s};
