const KEYBOARD_KEYS={ENTER:"Enter",SPACE:" ",ESCAPE:"Escape",TAB:"Tab",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",HOME:"Home",END:"End"};let idCounter=0;function generateId(o="a11y"){return`${o}-${++idCounter}`}function trapFocus(o){const e=o.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),t=e[0],n=e[e.length-1];function s(r){r.key===KEYBOARD_KEYS.TAB&&(r.shiftKey?document.activeElement===t&&(r.preventDefault(),n.focus()):document.activeElement===n&&(r.preventDefault(),t.focus()))}return o.addEventListener("keydown",s),t?.focus(),()=>{o.removeEventListener("keydown",s)}}function announceToScreenReader(o,e="polite"){const t=document.createElement("div");t.setAttribute("aria-live",e),t.setAttribute("aria-atomic","true"),t.className="sr-only",t.textContent=o,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},1e3)}function createKeyboardNavigationHandler(o,e={}){const{orientation:t="vertical",wrap:n=!0,activateOnFocus:s=!1}=e;let r=0;return function(l){const{key:u}=l;let c=r;switch(u){case KEYBOARD_KEYS.ARROW_DOWN:(t==="vertical"||t==="both")&&(l.preventDefault(),c=n?(r+1)%o.length:Math.min(r+1,o.length-1));break;case KEYBOARD_KEYS.ARROW_UP:(t==="vertical"||t==="both")&&(l.preventDefault(),c=n?(r-1+o.length)%o.length:Math.max(r-1,0));break;case KEYBOARD_KEYS.ARROW_RIGHT:(t==="horizontal"||t==="both")&&(l.preventDefault(),c=n?(r+1)%o.length:Math.min(r+1,o.length-1));break;case KEYBOARD_KEYS.ARROW_LEFT:(t==="horizontal"||t==="both")&&(l.preventDefault(),c=n?(r-1+o.length)%o.length:Math.max(r-1,0));break;case KEYBOARD_KEYS.HOME:l.preventDefault(),c=0;break;case KEYBOARD_KEYS.END:l.preventDefault(),c=o.length-1;break;case KEYBOARD_KEYS.ENTER:case KEYBOARD_KEYS.SPACE:s&&(l.preventDefault(),o[r].click());break}c!==r&&(r=c,o[r].focus())}}class LiveRegionManager{regions=new Map;createRegion(e,t="polite"){if(this.regions.has(e))return this.regions.get(e);const n=document.createElement("div");return n.id=e,n.setAttribute("aria-live",t),n.setAttribute("aria-atomic","true"),n.className="sr-only",document.body.appendChild(n),this.regions.set(e,n),n}announce(e,t){const n=this.regions.get(e);n&&(n.textContent=t)}clear(e){const t=this.regions.get(e);t&&(t.textContent="")}destroy(e){const t=this.regions.get(e);t&&(document.body.removeChild(t),this.regions.delete(e))}}const liveRegionManager=new LiveRegionManager;class AccessibilityPreferences{preferences=new Map;listeners=new Map;constructor(){this.loadPreferences(),this.setupMediaQueryListeners()}loadPreferences(){if(!(typeof window>"u"||typeof localStorage>"u"))try{const e=localStorage.getItem("accessibility-preferences");if(e){const t=JSON.parse(e);Object.entries(t).forEach(([n,s])=>{this.preferences.set(n,s)})}}catch(e){console.warn("Failed to load accessibility preferences:",e)}}savePreferences(){if(!(typeof window>"u"||typeof localStorage>"u"))try{const e=Object.fromEntries(this.preferences);localStorage.setItem("accessibility-preferences",JSON.stringify(e))}catch(e){console.warn("Failed to save accessibility preferences:",e)}}setupMediaQueryListeners(){if(typeof window>"u"||typeof window.matchMedia!="function")return;const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=window.matchMedia("(prefers-contrast: high)"),n=window.matchMedia("(prefers-color-scheme: dark)"),s=(r,i)=>{typeof r.addEventListener=="function"?r.addEventListener("change",i):typeof r.addListener=="function"&&r.addListener(i)};s(e,r=>{this.set("reducedMotion",r.matches)}),s(t,r=>{this.set("highContrast",r.matches)}),s(n,r=>{this.set("darkMode",r.matches)}),this.set("reducedMotion",e.matches),this.set("highContrast",t.matches),this.set("darkMode",n.matches)}get(e,t){return this.preferences.get(e)??t}set(e,t){this.preferences.set(e,t),this.savePreferences(),this.notifyListeners(e,t)}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),t(this.get(e)),()=>{this.listeners.get(e)?.delete(t)}}notifyListeners(e,t){this.listeners.get(e)?.forEach(n=>n(t))}}const accessibilityPreferences=new AccessibilityPreferences;function optimizeImage(o,e={}){const{quality:t=.8,maxWidth:n=1920,maxHeight:s=1080,generateThumbnail:r=!0,generateWebP:i=!0}=e;return new Promise((l,u)=>{const c=new Image,h=document.createElement("canvas"),a=h.getContext("2d");if(!a){u(new Error("Canvas context not available"));return}c.onload=()=>{try{const{width:d,height:m}=calculate_dimensions(c.width,c.height,n,s);h.width=d,h.height=m,a.drawImage(c,0,0,d,m);const f={original:h.toDataURL("image/jpeg",t)};if(i&&h.toDataURL("image/webp").indexOf("data:image/webp")===0&&(f.webp=h.toDataURL("image/webp",t)),r){const p=document.createElement("canvas"),y=p.getContext("2d");if(y){const w=calculate_dimensions(d,m,200,200);p.width=w.width,p.height=w.height,y.drawImage(h,0,0,w.width,w.height),f.thumbnail=p.toDataURL("image/jpeg",.7)}}l(f)}catch(d){u(d)}},c.onerror=()=>u(new Error("Failed to load image")),c.src=URL.createObjectURL(o)})}async function optimizeVideo(o,e={}){return new Promise((t,n)=>{const s=new FileReader;s.onload=async()=>{try{const i={original:s.result};if(e.generateThumbnail){const l=await generateVideoThumbnail(o);l&&(i.thumbnail=l)}t(i)}catch(r){n(r)}},s.onerror=()=>n(new Error("Failed to read video file")),s.readAsDataURL(o)})}async function generateVideoThumbnail(o){return new Promise(e=>{const t=document.createElement("video"),n=document.createElement("canvas"),s=n.getContext("2d");if(!s){e(null);return}t.onloadedmetadata=()=>{t.currentTime=Math.min(1,t.duration*.1)},t.onseeked=()=>{try{n.width=t.videoWidth,n.height=t.videoHeight,s.drawImage(t,0,0);const r=n.toDataURL("image/jpeg",.8);e(r)}catch{e(null)}},t.onerror=()=>e(null),t.src=URL.createObjectURL(o),t.load()})}function calculate_dimensions(o,e,t,n){let{width:s,height:r}={width:o,height:e};return s>t&&(r=r*t/s,s=t),r>n&&(s=s*n/r,r=n),{width:Math.round(s),height:Math.round(r)}}function formatFileSize(o){if(o===0)return"0 Bytes";const e=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(o)/Math.log(e));return parseFloat((o/Math.pow(e,n)).toFixed(2))+" "+t[n]}function validateMediaFile(o,e={}){const{maxSize:t=10*1024*1024,allowedTypes:n=["image/*","video/*"]}=e;return o.size>t?{valid:!1,error:`File size (${formatFileSize(o.size)}) exceeds maximum allowed size (${formatFileSize(t)})`}:n.some(r=>r.endsWith("/*")?o.type.startsWith(r.slice(0,-1)):o.type===r)?{valid:!0}:{valid:!1,error:`File type ${o.type} is not allowed. Allowed types: ${n.join(", ")}`}}class SearchEngine{searchIndex={content:new Map,tags:new Map,links:new Map};stopWords=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","will","with","the","this","but","they","have","had","what","said","each","which","she","do","how","their","if","up","out","many","then","them","these","so","some","her","would","make","like","into","him","time","two","more","go","no","way","could","my","than","first","been","call","who","oil","sit","now","find","down","day","did","get","come","made","may","part"]);tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!this.stopWords.has(t)).map(t=>t.trim()).filter(t=>t.length>0)}extractContentText(e){return e.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(n=>n.question).join(" ")||"";case"flashcard":return`${t.content?.front||""} ${t.content?.back||""}`;default:return""}}).join(" ")}indexModule(e){const t=[e.title,e.description,this.extractContentText(e.blocks)].join(" "),n=this.tokenize(t);this.searchIndex.content.set(e.id,n);for(const r of e.metadata.tags)this.searchIndex.tags.has(r)||this.searchIndex.tags.set(r,[]),this.searchIndex.tags.get(r).push(e.id);const s=[...e.relationships.prerequisites,...e.relationships.dependents,...e.relationships.related];this.searchIndex.links.set(e.id,s)}indexNode(e){const t=[e.title].join(" "),n=this.tokenize(t);this.searchIndex.content.set(e.id,n);for(const s of e.metadata.tags)this.searchIndex.tags.has(s)||this.searchIndex.tags.set(s,[]),this.searchIndex.tags.get(s).push(e.id)}removeFromIndex(e){this.searchIndex.content.delete(e),this.searchIndex.links.delete(e);for(const[t,n]of this.searchIndex.tags.entries()){const s=n.indexOf(e);s>-1&&(n.splice(s,1),n.length===0&&this.searchIndex.tags.delete(t))}}calculateRelevance(e,t,n,s,r){let i=0,l=!1;for(const a of t){const d=n.filter(m=>a.length>=3&&m.length>a.length&&m.includes(a)).length;d>0&&(i+=d*5,l=!0),n.includes(a)&&(i+=20,l=!0)}const u=s?.title||r?.title||"",c=this.tokenize(u);for(const a of t)c.includes(a)?(i+=50,l=!0):a.length>=3&&c.some(d=>d.length>a.length&&d.includes(a))&&(i+=25,l=!0);const h=s?.metadata.tags||r?.metadata.tags||[];for(const a of h){const d=this.tokenize(a);for(const m of t)d.includes(m)?(i+=30,l=!0):m.length>=3&&d.some(g=>g.length>m.length&&g.includes(m))&&(i+=15,l=!0)}return l&&s&&(i+=Math.log(s.analytics.views+1)*2,i+=Math.log(s.analytics.completions+1)*3,i+=s.analytics.averageScore*.5),i}applyFilters(e,t,n,s){return e.filter(r=>{const i=n.get(r.id),l=s.get(r.id);if(t.contentTypes&&t.contentTypes.length>0&&!t.contentTypes.includes(r.type))return!1;if(t.tags&&t.tags.length>0){const u=i?.metadata.tags||l?.metadata.tags||[];if(!t.tags.some(c=>u.includes(c)))return!1}if(t.difficulty&&t.difficulty.length>0){const u=i?.metadata.difficulty||l?.metadata.difficulty;if(u&&!t.difficulty.includes(u))return!1}if(t.dateRange&&i){const u=i.metadata.created;if(u<t.dateRange.start||u>t.dateRange.end)return!1}return!(t.author&&i&&i.metadata.author!==t.author||t.minRelevance&&r.relevance<t.minRelevance)})}generateSnippet(e,t,n=150){const s=t.split(/[.!?]+/).filter(l=>l.trim().length>0);let r="",i=0;for(const l of s){const u=this.tokenize(l),c=e.filter(h=>u.some(a=>a.includes(h))).length;c>i&&(i=c,r=l.trim())}return r.length>n&&(r=r.substring(0,n-3)+"..."),r||t.substring(0,n-3)+"..."}search(e,t,n,s={},r=50){if(!e.trim())return[];const i=this.tokenize(e),l=[];for(const[c,h]of this.searchIndex.content.entries()){const a=t.get(c),d=n.get(c);if(!a&&!d)continue;const m=this.calculateRelevance(c,i,h,a,d);if(m>10){const g=a?.title||d?.title||"",f=a?`${a.description} ${this.extractContentText(a.blocks)}`:g,p=this.generateSnippet(i,f),y=a?.metadata.tags||d?.metadata.tags||[],E=a?"module":d?.type||"unknown";l.push({id:c,title:g,snippet:p,relevance:m,type:E,tags:y})}}return l.sort((c,h)=>h.relevance-c.relevance),this.applyFilters(l,s,t,n).slice(0,r)}searchByTags(e,t,n){const s=[],r=new Set;for(const i of e){const l=this.searchIndex.tags.get(i)||[];for(const u of l){if(r.has(u))continue;r.add(u);const c=t.get(u),h=n.get(u);if(c||h){const a=c?.title||h?.title||"",d=c?`${c.description} ${this.extractContentText(c.blocks)}`:a,m=this.generateSnippet([i],d),g=c?.metadata.tags||h?.metadata.tags||[],f=c?"module":h?.type||"unknown";s.push({id:u,title:a,snippet:m,relevance:100,type:f,tags:g})}}}return s.sort((i,l)=>l.relevance-i.relevance)}getRelatedContent(e,t,n,s=10){const r=[],i=t.get(e),l=n.get(e);if(!i&&!l)return r;const u=this.searchIndex.links.get(e)||[];for(const h of u){const a=t.get(h),d=n.get(h);if(a||d){const m=a?.title||d?.title||"",g=a?`${a.description} ${this.extractContentText(a.blocks)}`:m,f=this.generateSnippet([],g),p=a?.metadata.tags||d?.metadata.tags||[],y=a?"module":d?.type||"unknown";r.push({id:h,title:m,snippet:f,relevance:90,type:y,tags:p})}}const c=i?.metadata.tags||l?.metadata.tags||[];for(const h of c){const a=this.searchIndex.tags.get(h)||[];for(const d of a){if(d===e||r.some(f=>f.id===d))continue;const m=t.get(d),g=n.get(d);if(m||g){const f=m?.title||g?.title||"",p=m?`${m.description} ${this.extractContentText(m.blocks)}`:f,y=this.generateSnippet([],p),E=m?.metadata.tags||g?.metadata.tags||[],w=m?"module":g?.type||"unknown";r.push({id:d,title:f,snippet:y,relevance:70,type:w,tags:E})}}}return r.sort((h,a)=>a.relevance-h.relevance).slice(0,s)}getSuggestions(e,t=5){if(e.length<2)return[];const n=new Set,s=e.toLowerCase();for(const r of this.searchIndex.content.values()){for(const i of r)if(i.startsWith(s)&&i.length>s.length&&(n.add(i),n.size>=t))break;if(n.size>=t)break}for(const r of this.searchIndex.tags.keys())if(r.toLowerCase().includes(s)&&(n.add(r),n.size>=t))break;return Array.from(n).slice(0,t)}clearIndex(){this.searchIndex.content.clear(),this.searchIndex.tags.clear(),this.searchIndex.links.clear()}getIndexStats(){return{totalContent:this.searchIndex.content.size,totalTags:this.searchIndex.tags.size,totalLinks:this.searchIndex.links.size,averageTokensPerContent:this.searchIndex.content.size>0?Array.from(this.searchIndex.content.values()).reduce((e,t)=>e+t.length,0)/this.searchIndex.content.size:0}}}const searchEngine=new SearchEngine;class CodeExecutionService{static instance;executionEnvironments=new Map;constructor(){this.initializeEnvironments()}static getInstance(){return CodeExecutionService.instance||(CodeExecutionService.instance=new CodeExecutionService),CodeExecutionService.instance}initializeEnvironments(){this.executionEnvironments.set("javascript",{language:"javascript",timeout:5e3,memoryLimit:50*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("python",{language:"python",timeout:1e4,memoryLimit:100*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("html",{language:"html",timeout:3e3,memoryLimit:25*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1})}async executeCode(o,e,t){const n=performance.now(),s=this.executionEnvironments.get(e);if(!s)return{success:!1,error:`Execution not supported for language: ${e}`,executionTime:0,timestamp:new Date};const r={...s,...t};try{let i;switch(e){case"javascript":i=await this.executeJavaScript(o,r);break;case"python":i=await this.executePython(o,r);break;case"html":i=await this.executeHTML(o,r);break;default:i={success:!1,error:`Execution not implemented for language: ${e}`,executionTime:0,timestamp:new Date}}return i.executionTime=performance.now()-n,i}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown execution error",executionTime:performance.now()-n,timestamp:new Date}}}async executeJavaScript(o,e){return new Promise(t=>{const n=setTimeout(()=>{t({success:!1,error:"Execution timeout exceeded",executionTime:e.timeout,timestamp:new Date})},e.timeout);try{const s=console,r=[],l={console:{log:(...h)=>r.push(h.map(a=>String(a)).join(" ")),error:(...h)=>r.push("ERROR: "+h.map(a=>String(a)).join(" ")),warn:(...h)=>r.push("WARN: "+h.map(a=>String(a)).join(" ")),info:(...h)=>r.push("INFO: "+h.map(a=>String(a)).join(" "))},Math,Date,JSON,Array,Object,String,Number,Boolean,RegExp,setTimeout:(h,a)=>(a>1e3&&(a=1e3),setTimeout(h,a)),clearTimeout},c=new Function(...Object.keys(l),`
					"use strict";
					try {
						${o}
					} catch (error) {
						console.error(error.message);
						throw error;
					}
					`)(...Object.values(l));clearTimeout(n),t({success:!0,output:r.length>0?r.join(`
`):c!==void 0?String(c):"",executionTime:0,timestamp:new Date})}catch(s){clearTimeout(n),t({success:!1,error:s instanceof Error?s.message:"JavaScript execution error",executionTime:0,timestamp:new Date})}})}async executePython(code,environment){return new Promise(resolve=>{setTimeout(()=>{if(code.includes("print(")){const print_matches=code.match(/print\((.*?)\)/g),output=print_matches?.map(match=>{const content=match.replace(/print\((.*?)\)/,"$1");try{return eval(content.replace(/'/g,'"'))}catch{return content.replace(/['"]/g,"")}}).join(`
`)||"";resolve({success:!0,output,executionTime:0,timestamp:new Date})}else resolve({success:!0,output:"Python code executed (simulation)",executionTime:0,timestamp:new Date})},100)})}async executeHTML(o,e){try{const t=document.createElement("iframe");return t.style.display="none",t.setAttribute("sandbox","allow-scripts"),document.body.appendChild(t),new Promise(n=>{const s=setTimeout(()=>{document.body.removeChild(t),n({success:!1,error:"HTML execution timeout",executionTime:e.timeout,timestamp:new Date})},e.timeout);t.onload=()=>{try{t.contentDocument&&(t.contentDocument.open(),t.contentDocument.write(o),t.contentDocument.close()),clearTimeout(s),setTimeout(()=>{document.body.removeChild(t),n({success:!0,output:"HTML rendered successfully",executionTime:0,timestamp:new Date})},500)}catch(r){clearTimeout(s),document.body.removeChild(t),n({success:!1,error:r instanceof Error?r.message:"HTML execution error",executionTime:0,timestamp:new Date})}},t.src="about:blank"})}catch(t){return{success:!1,error:t instanceof Error?t.message:"HTML execution setup error",executionTime:0,timestamp:new Date}}}isLanguageExecutable(o){return this.executionEnvironments.get(o)!==void 0}getSupportedLanguages(){return Array.from(this.executionEnvironments.keys())}}CodeExecutionService.getInstance();function exportSimulationToJSON(o,e,t,n){const s={simulationType:o,parameters:e,results:t,metadata:{exportedAt:new Date().toISOString(),duration:t.length>0?t[t.length-1].time:0,steps:t.length,version:"1.0.0",...n}};return JSON.stringify(s,null,2)}function exportSimulationToCSV(o,e){if(o.length===0)return"";const t=Object.keys(o[0].state),n=["step","time",...t].join(","),s=o.map(r=>[r.step,r.time.toFixed(6),...t.map(l=>{const u=r.state[l];return typeof u=="number"?u.toFixed(6):String(u)})].join(","));return[n,...s].join(`
`)}function downloadFile(o,e,t="text/plain"){const n=new Blob([o],{type:t}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=e,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}function exportSimulationResults(o,e,t,n="json"){const s=new Date().toISOString().replace(/[:.]/g,"-"),r=`${o.toLowerCase().replace(/\s+/g,"-")}-${s}`;if(n==="json"){const i=exportSimulationToJSON(o,e,t);downloadFile(i,`${r}.json`,"application/json")}else if(n==="csv"){const i=exportSimulationToCSV(t);downloadFile(i,`${r}.csv`,"text/csv")}}function generateSimulationReport(o,e,t){if(t.length===0)return"No simulation data available for report generation.";const n=t[0],s=t[t.length-1],r=Object.keys(n.state);let i=`# Simulation Report: ${o}

`;return i+=`## Parameters

`,Object.entries(e).forEach(([l,u])=>{i+=`- **${l}**: ${u}
`}),i+=`
## Summary

`,i+=`- **Duration**: ${s.time.toFixed(3)} seconds
`,i+=`- **Steps**: ${t.length}
`,i+=`- **Average step time**: ${(s.time/t.length).toFixed(6)} seconds
`,i+=`
## State Analysis

`,r.forEach(l=>{const u=t.map(c=>c.state[l]).filter(c=>typeof c=="number");if(u.length>0){const c=Math.min(...u),h=Math.max(...u),a=u.reduce((m,g)=>m+g,0)/u.length,d=u[u.length-1];i+=`### ${l}
`,i+=`- **Initial**: ${u[0].toFixed(6)}
`,i+=`- **Final**: ${d.toFixed(6)}
`,i+=`- **Minimum**: ${c.toFixed(6)}
`,i+=`- **Maximum**: ${h.toFixed(6)}
`,i+=`- **Average**: ${a.toFixed(6)}

`}}),i+=`
## Export Information

`,i+=`- **Generated**: ${new Date().toISOString()}
`,i+=`- **Version**: 1.0.0
`,i}function exportSimulationReport(o,e,t){const n=generateSimulationReport(o,e,t),s=new Date().toISOString().replace(/[:.]/g,"-"),r=`${o.toLowerCase().replace(/\s+/g,"-")}-report-${s}.md`;downloadFile(n,r,"text/markdown")}function createLogger(o){const e=`[${o}]`;return{debug:(...t)=>{},info:(...t)=>{console.info(e,...t)},warn:(...t)=>{console.warn(e,...t)},error:(...t)=>{console.error(e,...t)}}}class ErrorHandler{static instance;logger=createLogger("error-handler");toastQueue=[];errorListeners=[];constructor(){}static getInstance(){return ErrorHandler.instance||(ErrorHandler.instance=new ErrorHandler),ErrorHandler.instance}async handleAsync(e,t,n={}){const{showToast:s=!0,logError:r=!0,retryable:i=!1,maxRetries:l=3,retryDelay:u=1e3,onError:c,onRetry:h}=n;let a,d=0;for(;d<=(i?l:0);)try{return{success:!0,data:await e(),retryCount:d}}catch(m){if(a=m instanceof Error?m:new Error(String(m)),r&&this.logger.error(`Operation failed: ${t.operation}`,{error:a,context:t,attempt:d+1}),c&&c(a,t),this.notifyErrorListeners(a,t),i&&d<l&&this.isRetryableError(a)){d++,h&&h(d,a),await this.delay(u*d);continue}break}return s&&this.showErrorToast(a,t),{success:!1,error:a,retryCount:d}}handleSync(e,t,n={}){const{showToast:s=!0,logError:r=!0,fallbackValue:i,onError:l}=n;try{return{success:!0,data:e()}}catch(u){const c=u instanceof Error?u:new Error(String(u));return r&&this.logger.error(`Sync operation failed: ${t.operation}`,{error:c,context:t}),l&&l(c,t),this.notifyErrorListeners(c,t),s&&this.showErrorToast(c,t),{success:!1,error:c,data:i}}}createAsyncWrapper(e,t,n={}){return async(...s)=>(await this.handleAsync(()=>e(...s),t,n)).data}createSyncWrapper(e,t,n={}){return(...s)=>this.handleSync(()=>e(...s),t,n).data}addErrorListener(e){this.errorListeners.push(e)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}getUserFriendlyMessage(e,t){if(this.isNetworkError(e))return"Unable to connect to the server. Please check your internet connection and try again.";if(this.isValidationError(e))return e.message||"Please check your input and try again.";if(this.isPermissionError(e))return"You do not have permission to perform this action.";if(this.isTimeoutError(e))return"The operation took too long to complete. Please try again.";if(this.isStorageError(e))return"Unable to save data. Please check your storage space and try again.";switch(t.operation){case"save":case"create":return"Failed to save. Please try again.";case"load":case"fetch":return"Failed to load data. Please refresh and try again.";case"delete":return"Failed to delete. Please try again.";case"update":return"Failed to update. Please try again.";default:return"An unexpected error occurred. Please try again."}}isRetryableError(e){return this.isNetworkError(e)||this.isTimeoutError(e)||e.message.toLowerCase().includes("rate limit")||e.message.toLowerCase().includes("server error")||e.message.includes("503")||e.message.includes("502")||e.message.toLowerCase().includes("network error")}isNetworkError(e){return e.message.includes("fetch")||e.message.includes("network")||e.message.includes("connection")||e.message.includes("offline")||e.name==="NetworkError"}isValidationError(e){return e.message.includes("validation")||e.message.includes("invalid")||e.message.includes("required")||e.name==="ValidationError"}isPermissionError(e){return e.message.includes("permission")||e.message.includes("unauthorized")||e.message.includes("forbidden")||e.message.includes("401")||e.message.includes("403")}isTimeoutError(e){return e.message.includes("timeout")||e.message.includes("aborted")||e.name==="TimeoutError"||e.name==="AbortError"}isStorageError(e){return e.message.includes("storage")||e.message.includes("quota")||e.message.includes("IndexedDB")||e.name==="QuotaExceededError"}showErrorToast(e,t){const n=this.getUserFriendlyMessage(e,t),s={id:`error_${Date.now()}`,type:"error",title:"Error",message:n,duration:5e3,timestamp:new Date,actions:this.getErrorActions(e,t)};this.toastQueue.push(s),typeof window<"u"&&window.dispatchEvent(new CustomEvent("show-toast",{detail:s}))}getErrorActions(e,t){const n=[];return this.isRetryableError(e)&&n.push({label:"Retry",action:()=>{typeof window<"u"&&window.dispatchEvent(new CustomEvent("error-retry",{detail:{error:e,context:t}}))}}),this.isNetworkError(e)&&n.push({label:"Refresh",action:()=>window.location.reload()}),n}notifyErrorListeners(e,t){this.errorListeners.forEach(n=>{try{n(e,t)}catch(s){this.logger.error("Error listener failed:",s)}})}delay(e){return new Promise(t=>setTimeout(t,e))}getToastQueue(){return[...this.toastQueue]}clearToastQueue(){this.toastQueue.length=0}}const errorHandler=ErrorHandler.getInstance();errorHandler.handleAsync.bind(errorHandler);errorHandler.handleSync.bind(errorHandler);errorHandler.createAsyncWrapper.bind(errorHandler);errorHandler.createSyncWrapper.bind(errorHandler);class PerformanceMonitor{entries=[];observers=[];startTime=Date.now();constructor(){this.initializeObservers()}initializeObservers(){if(!(typeof window>"u")&&"PerformanceObserver"in window){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(s=>{s.entryType==="navigation"&&this.recordNavigationMetrics(s)})});e.observe({entryTypes:["navigation"]}),this.observers.push(e)}catch(e){console.warn("Navigation timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(s=>{s.entryType==="paint"&&this.recordPaintMetrics(s)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Paint timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{const n=t.getEntries(),s=n[n.length-1];s&&this.recordLCPMetrics(s)});e.observe({entryTypes:["largest-contentful-paint"]}),this.observers.push(e)}catch(e){console.warn("LCP observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(s=>{this.recordLayoutShiftMetrics(s)})});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Layout shift observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(s=>{this.recordFirstInputDelay(s)})});e.observe({entryTypes:["first-input"]}),this.observers.push(e)}catch(e){console.warn("First input delay observer not supported:",e)}}}recordNavigationMetrics(e){const t={pageLoad:{domContentLoaded:e.domContentLoadedEventEnd-e.fetchStart,loadComplete:e.loadEventEnd-e.fetchStart}};this.updateCurrentMetrics(t)}recordPaintMetrics(e){const t={};e.name==="first-contentful-paint"&&(t.pageLoad={...this.getCurrentMetrics()?.pageLoad,firstContentfulPaint:e.startTime}),this.updateCurrentMetrics(t)}recordLCPMetrics(e){const t={pageLoad:{...this.getCurrentMetrics()?.pageLoad,largestContentfulPaint:e.startTime}};this.updateCurrentMetrics(t)}recordLayoutShiftMetrics(e){if(!e.hadRecentInput){const t=this.getCurrentMetrics(),n=t?.userExperience?.cumulativeLayoutShift||0,s={userExperience:{...t?.userExperience,cumulativeLayoutShift:n+e.value}};this.updateCurrentMetrics(s)}}recordFirstInputDelay(e){const t={userExperience:{...this.getCurrentMetrics()?.userExperience,firstInputDelay:e.processingStart-e.startTime}};this.updateCurrentMetrics(t)}measureRenderTime(e,t){const n=performance.now();t();const r=performance.now()-n;return console.debug(`Component ${e} render time: ${r.toFixed(2)}ms`),r}async measureAsyncOperation(e,t){const n=performance.now(),s=await t(),i=performance.now()-n;return console.debug(`Operation ${e} completed in: ${i.toFixed(2)}ms`),{result:s,duration:i}}getMemoryUsage(){if(typeof window<"u"&&"memory"in performance)return performance.memory.usedJSHeapSize}getConnectionInfo(){if(typeof navigator<"u"&&"connection"in navigator){const e=navigator.connection;return e.effectiveType||e.type}}recordEntry(e,t){const n=this.getCurrentMetrics(),s=this.getMemoryUsage(),r=this.getConnectionInfo(),i={timestamp:Date.now(),page:e,metrics:{pageLoad:n?.pageLoad||{domContentLoaded:0,loadComplete:0},bundle:n?.bundle||{totalSize:0,chunkCount:0,loadTime:0},runtime:{memoryUsage:s,renderTime:n?.runtime?.renderTime||0,interactionTime:n?.runtime?.interactionTime||0},userExperience:n?.userExperience||{},...t},userAgent:navigator.userAgent,connectionType:r};this.entries.push(i),this.logPerformanceEntry(i)}getCurrentMetrics(){return this.entries[this.entries.length-1]?.metrics}updateCurrentMetrics(e){this.entries.length===0&&this.recordEntry(window.location.pathname);const t=this.entries[this.entries.length-1];t.metrics={...t.metrics,...e,pageLoad:{...t.metrics.pageLoad,...e.pageLoad},runtime:{...t.metrics.runtime,...e.runtime},userExperience:{...t.metrics.userExperience,...e.userExperience}}}logPerformanceEntry(e){console.group(`Performance Metrics - ${e.page}`),console.log("Timestamp:",new Date(e.timestamp).toISOString()),console.log("Page Load:",e.metrics.pageLoad),console.log("Runtime:",e.metrics.runtime),console.log("User Experience:",e.metrics.userExperience),e.connectionType&&console.log("Connection:",e.connectionType),console.groupEnd()}getEntries(){return[...this.entries]}getSummary(){if(this.entries.length===0)return{totalEntries:0,averageLoadTime:0,averageRenderTime:0,averageMemoryUsage:0};const e=this.entries.reduce((s,r)=>s+r.metrics.pageLoad.loadComplete,0),t=this.entries.reduce((s,r)=>s+r.metrics.runtime.renderTime,0),n=this.entries.reduce((s,r)=>s+(r.metrics.runtime.memoryUsage||0),0);return{totalEntries:this.entries.length,averageLoadTime:e/this.entries.length,averageRenderTime:t/this.entries.length,averageMemoryUsage:n/this.entries.length}}clearEntries(){this.entries=[]}cleanup(){this.observers.forEach(e=>{e.disconnect()}),this.observers=[]}}new PerformanceMonitor;export{KEYBOARD_KEYS as K,exportSimulationReport as a,accessibilityPreferences as b,createKeyboardNavigationHandler as c,createLogger as d,exportSimulationResults as e,announceToScreenReader as f,generateId as g,optimizeVideo as h,formatFileSize as i,errorHandler as j,liveRegionManager as l,optimizeImage as o,searchEngine as s,trapFocus as t,validateMediaFile as v};
