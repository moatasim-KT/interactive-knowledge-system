import{r as relationshipStorage}from"./BoPf8oN2.js";const KEYBOARD_KEYS={ENTER:"Enter",SPACE:" ",ESCAPE:"Escape",TAB:"Tab",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",HOME:"Home",END:"End"};let idCounter=0;function generateId(c="a11y"){return`${c}-${++idCounter}`}function trapFocus(c){const e=c.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),t=e[0],n=e[e.length-1];function r(i){i.key===KEYBOARD_KEYS.TAB&&(i.shiftKey?document.activeElement===t&&(i.preventDefault(),n.focus()):document.activeElement===n&&(i.preventDefault(),t.focus()))}return c.addEventListener("keydown",r),t?.focus(),()=>{c.removeEventListener("keydown",r)}}function announceToScreenReader(c,e="polite"){const t=document.createElement("div");t.setAttribute("aria-live",e),t.setAttribute("aria-atomic","true"),t.className="sr-only",t.textContent=c,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},1e3)}function createKeyboardNavigationHandler(c,e={}){const{orientation:t="vertical",wrap:n=!0,activateOnFocus:r=!1}=e;let i=0;return function(a){const{key:l}=a;let o=i;switch(l){case KEYBOARD_KEYS.ARROW_DOWN:(t==="vertical"||t==="both")&&(a.preventDefault(),o=n?(i+1)%c.length:Math.min(i+1,c.length-1));break;case KEYBOARD_KEYS.ARROW_UP:(t==="vertical"||t==="both")&&(a.preventDefault(),o=n?(i-1+c.length)%c.length:Math.max(i-1,0));break;case KEYBOARD_KEYS.ARROW_RIGHT:(t==="horizontal"||t==="both")&&(a.preventDefault(),o=n?(i+1)%c.length:Math.min(i+1,c.length-1));break;case KEYBOARD_KEYS.ARROW_LEFT:(t==="horizontal"||t==="both")&&(a.preventDefault(),o=n?(i-1+c.length)%c.length:Math.max(i-1,0));break;case KEYBOARD_KEYS.HOME:a.preventDefault(),o=0;break;case KEYBOARD_KEYS.END:a.preventDefault(),o=c.length-1;break;case KEYBOARD_KEYS.ENTER:case KEYBOARD_KEYS.SPACE:r&&(a.preventDefault(),c[i].click());break}o!==i&&(i=o,c[i].focus())}}class LiveRegionManager{regions=new Map;createRegion(e,t="polite"){if(this.regions.has(e))return this.regions.get(e);const n=document.createElement("div");return n.id=e,n.setAttribute("aria-live",t),n.setAttribute("aria-atomic","true"),n.className="sr-only",document.body.appendChild(n),this.regions.set(e,n),n}announce(e,t){const n=this.regions.get(e);n&&(n.textContent=t)}clear(e){const t=this.regions.get(e);t&&(t.textContent="")}destroy(e){const t=this.regions.get(e);t&&(document.body.removeChild(t),this.regions.delete(e))}}const liveRegionManager=new LiveRegionManager;class AccessibilityPreferences{preferences=new Map;listeners=new Map;constructor(){this.loadPreferences(),this.setupMediaQueryListeners()}loadPreferences(){try{const e=localStorage.getItem("accessibility-preferences");if(e){const t=JSON.parse(e);Object.entries(t).forEach(([n,r])=>{this.preferences.set(n,r)})}}catch(e){console.warn("Failed to load accessibility preferences:",e)}}savePreferences(){try{const e=Object.fromEntries(this.preferences);localStorage.setItem("accessibility-preferences",JSON.stringify(e))}catch(e){console.warn("Failed to save accessibility preferences:",e)}}setupMediaQueryListeners(){const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=window.matchMedia("(prefers-contrast: high)"),n=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",r=>{this.set("reducedMotion",r.matches)}),t.addEventListener("change",r=>{this.set("highContrast",r.matches)}),n.addEventListener("change",r=>{this.set("darkMode",r.matches)}),this.set("reducedMotion",e.matches),this.set("highContrast",t.matches),this.set("darkMode",n.matches)}get(e,t){return this.preferences.get(e)??t}set(e,t){this.preferences.set(e,t),this.savePreferences(),this.notifyListeners(e,t)}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),t(this.get(e)),()=>{this.listeners.get(e)?.delete(t)}}notifyListeners(e,t){this.listeners.get(e)?.forEach(n=>n(t))}}const accessibilityPreferences=new AccessibilityPreferences;function optimizeImage(c,e={}){const{quality:t=.8,maxWidth:n=1920,maxHeight:r=1080,generateThumbnail:i=!0,generateWebP:s=!0}=e;return new Promise((a,l)=>{const o=new Image,d=document.createElement("canvas"),u=d.getContext("2d");if(!u){l(new Error("Canvas context not available"));return}o.onload=()=>{try{const{width:m,height:p}=calculate_dimensions(o.width,o.height,n,r);d.width=m,d.height=p,u.drawImage(o,0,0,m,p);const g={original:d.toDataURL("image/jpeg",t)};if(s&&d.toDataURL("image/webp").indexOf("data:image/webp")===0&&(g.webp=d.toDataURL("image/webp",t)),i){const f=document.createElement("canvas"),y=f.getContext("2d");if(y){const w=calculate_dimensions(m,p,200,200);f.width=w.width,f.height=w.height,y.drawImage(d,0,0,w.width,w.height),g.thumbnail=f.toDataURL("image/jpeg",.7)}}a(g)}catch(m){l(m)}},o.onerror=()=>l(new Error("Failed to load image")),o.src=URL.createObjectURL(c)})}async function optimizeVideo(c,e={}){return new Promise((t,n)=>{const r=new FileReader;r.onload=async()=>{try{const s={original:r.result};if(e.generateThumbnail){const a=await generateVideoThumbnail(c);a&&(s.thumbnail=a)}t(s)}catch(i){n(i)}},r.onerror=()=>n(new Error("Failed to read video file")),r.readAsDataURL(c)})}async function generateVideoThumbnail(c){return new Promise(e=>{const t=document.createElement("video"),n=document.createElement("canvas"),r=n.getContext("2d");if(!r){e(null);return}t.onloadedmetadata=()=>{t.currentTime=Math.min(1,t.duration*.1)},t.onseeked=()=>{try{n.width=t.videoWidth,n.height=t.videoHeight,r.drawImage(t,0,0);const i=n.toDataURL("image/jpeg",.8);e(i)}catch{e(null)}},t.onerror=()=>e(null),t.src=URL.createObjectURL(c),t.load()})}function calculate_dimensions(c,e,t,n){let{width:r,height:i}={width:c,height:e};return r>t&&(i=i*t/r,r=t),i>n&&(r=r*n/i,i=n),{width:Math.round(r),height:Math.round(i)}}function formatFileSize(c){if(c===0)return"0 Bytes";const e=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(c)/Math.log(e));return parseFloat((c/Math.pow(e,n)).toFixed(2))+" "+t[n]}function validateMediaFile(c,e={}){const{maxSize:t=10*1024*1024,allowedTypes:n=["image/*","video/*"]}=e;return c.size>t?{valid:!1,error:`File size (${formatFileSize(c.size)}) exceeds maximum allowed size (${formatFileSize(t)})`}:n.some(i=>i.endsWith("/*")?c.type.startsWith(i.slice(0,-1)):c.type===i)?{valid:!0}:{valid:!1,error:`File type ${c.type} is not allowed. Allowed types: ${n.join(", ")}`}}class SimilarityEngine{async calculateSimilarity(e,t){const n=[];let r=0,i=0;const s=this.calculateTagSimilarity(e.metadata.tags,t.metadata.tags);n.push({type:"tags",score:s,details:`Shared tags: ${this.getSharedTags(e.metadata.tags,t.metadata.tags).join(", ")}`}),r+=s*.3,i+=.3;const a=this.calculateDifficultySimilarity(e.metadata.difficulty,t.metadata.difficulty);n.push({type:"difficulty",score:a,details:`Difficulty levels: ${e.metadata.difficulty} vs ${t.metadata.difficulty}`}),r+=a*.2,i+=.2;const l=this.calculateContentSimilarity(e,t);n.push({type:"content",score:l,details:"Content structure and text similarity"}),r+=l*.3,i+=.3;const o=this.calculateStructureSimilarity(e,t);n.push({type:"structure",score:o,details:"Similar content block types and organization"}),r+=o*.2,i+=.2;const d=i>0?r/i:0;return{contentId:t.id,score:d,reasons:n}}async findSimilarContent(e,t,n=10,r=.3){const i=[];for(const s of t){if(s.id===e.id)continue;const a=await this.calculateSimilarity(e,s);a.score>=r&&i.push(a)}return i.sort((s,a)=>a.score-s.score).slice(0,n)}async generateRecommendations(e,t,n,r,i=5){const s=[],a=n?r.find(d=>d.id===n):null;if(a){const d=await this.getSequenceRecommendations(a,r,t);s.push(...d)}if(a){const d=await this.getRelatedTopicRecommendations(a,r,t);s.push(...d)}const l=await this.getPracticeRecommendations(t,r);if(s.push(...l),a){const d=await this.getSimilarDifficultyRecommendations(a,r,t);s.push(...d)}const o=await this.getReviewRecommendations(t,r);return s.push(...o),s.sort((d,u)=>u.score-d.score).slice(0,i)}calculateTagSimilarity(e,t){if(e.length===0&&t.length===0)return 1;if(e.length===0||t.length===0)return 0;const n=new Set(e.map(a=>a.toLowerCase())),r=new Set(t.map(a=>a.toLowerCase())),i=new Set([...n].filter(a=>r.has(a))),s=new Set([...n,...r]);return i.size/s.size}getSharedTags(e,t){const n=new Set(e.map(i=>i.toLowerCase())),r=new Set(t.map(i=>i.toLowerCase()));return[...n].filter(i=>r.has(i))}calculateDifficultySimilarity(e,t){return 1-Math.abs(e-t)/4}calculateContentSimilarity(e,t){const n=`${e.title} ${e.description}`.toLowerCase(),r=`${t.title} ${t.description}`.toLowerCase(),i=new Set(n.split(/\s+/).filter(o=>o.length>2)),s=new Set(r.split(/\s+/).filter(o=>o.length>2));if(i.size===0&&s.size===0)return 1;if(i.size===0||s.size===0)return 0;const a=new Set([...i].filter(o=>s.has(o))),l=new Set([...i,...s]);return a.size/l.size}calculateStructureSimilarity(e,t){const n=e.blocks.map(o=>o.type),r=t.blocks.map(o=>o.type),i=this.countTypes(n),s=this.countTypes(r),a=new Set([...Object.keys(i),...Object.keys(s)]);let l=0;for(const o of a){const d=i[o]||0,u=s[o]||0,m=Math.max(d,u),p=Math.min(d,u);m>0&&(l+=p/m)}return a.size>0?l/a.size:0}countTypes(e){const t={};for(const n of e)t[n]=(t[n]||0)+1;return t}async getSequenceRecommendations(e,t,n){const r=[],s=(await relationshipStorage.getOutgoingLinks(e.id)).filter(a=>a.type==="sequence"||a.type==="prerequisite");for(const a of s){const l=t.find(d=>d.id===a.targetId);if(!l||n.has(l.id))continue;(await relationshipStorage.analyzeDependencyChain(l.id,n)).canAccess&&r.push({contentId:l.id,score:.9*a.strength,type:"next-in-sequence",reasons:[{type:"prerequisite-completed",weight:1,description:`Next step after completing ${e.title}`}]})}return r}async getRelatedTopicRecommendations(e,t,n){const r=[],i=await this.findSimilarContent(e,t,5,.4);for(const s of i)n.has(s.contentId)||r.push({contentId:s.contentId,score:.7*s.score,type:"related-topic",reasons:[{type:"similar-content",weight:s.score,description:`Similar to ${e.title} (${Math.round(s.score*100)}% match)`}]});return r}async getPracticeRecommendations(e,t){const n=[];for(const r of e){const s=(await relationshipStorage.getOutgoingLinks(r)).filter(a=>a.type==="practice").map(a=>t.find(l=>l.id===a.targetId)).filter(a=>a&&!e.has(a.id));for(const a of s)a&&n.push({contentId:a.id,score:.6,type:"practice",reasons:[{type:"difficulty-match",weight:.8,description:"Practice exercises for completed content"}]})}return n}async getSimilarDifficultyRecommendations(e,t,n){const r=[],i=e.metadata.difficulty,s=t.filter(a=>!n.has(a.id)&&a.id!==e.id&&Math.abs(a.metadata.difficulty-i)<=1);for(const a of s.slice(0,3)){const l=this.calculateDifficultySimilarity(i,a.metadata.difficulty);r.push({contentId:a.id,score:.5*l,type:"similar-difficulty",reasons:[{type:"difficulty-match",weight:l,description:`Similar difficulty level (${a.metadata.difficulty})`}]})}return r}async getReviewRecommendations(e,t){const n=[],i=t.filter(s=>e.has(s.id)).slice(0,2);for(const s of i)n.push({contentId:s.id,score:.4,type:"review",reasons:[{type:"topic-continuation",weight:.6,description:"Review previously completed content"}]});return n}}const similarityEngine=new SimilarityEngine;class SearchEngine{searchIndex={content:new Map,tags:new Map,links:new Map};stopWords=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","will","with","the","this","but","they","have","had","what","said","each","which","she","do","how","their","if","up","out","many","then","them","these","so","some","her","would","make","like","into","him","time","two","more","go","no","way","could","my","than","first","been","call","who","oil","sit","now","find","down","day","did","get","come","made","may","part"]);tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!this.stopWords.has(t)).map(t=>t.trim()).filter(t=>t.length>0)}extractContentText(e){return e.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(n=>n.question).join(" ")||"";case"flashcard":return`${t.content?.front||""} ${t.content?.back||""}`;default:return""}}).join(" ")}indexModule(e){const t=[e.title,e.description,this.extractContentText(e.blocks)].join(" "),n=this.tokenize(t);this.searchIndex.content.set(e.id,n);for(const i of e.metadata.tags)this.searchIndex.tags.has(i)||this.searchIndex.tags.set(i,[]),this.searchIndex.tags.get(i).push(e.id);const r=[...e.relationships.prerequisites,...e.relationships.dependents,...e.relationships.related];this.searchIndex.links.set(e.id,r)}indexNode(e){const t=[e.title].join(" "),n=this.tokenize(t);this.searchIndex.content.set(e.id,n);for(const r of e.metadata.tags)this.searchIndex.tags.has(r)||this.searchIndex.tags.set(r,[]),this.searchIndex.tags.get(r).push(e.id)}removeFromIndex(e){this.searchIndex.content.delete(e),this.searchIndex.links.delete(e);for(const[t,n]of this.searchIndex.tags.entries()){const r=n.indexOf(e);r>-1&&(n.splice(r,1),n.length===0&&this.searchIndex.tags.delete(t))}}calculateRelevance(e,t,n,r,i){let s=0,a=!1;for(const u of t){const m=n.filter(p=>u.length>=3&&p.length>u.length&&p.includes(u)).length;m>0&&(s+=m*5,a=!0),n.includes(u)&&(s+=20,a=!0)}const l=r?.title||i?.title||"",o=this.tokenize(l);for(const u of t)o.includes(u)?(s+=50,a=!0):u.length>=3&&o.some(m=>m.length>u.length&&m.includes(u))&&(s+=25,a=!0);const d=r?.metadata.tags||i?.metadata.tags||[];for(const u of d){const m=this.tokenize(u);for(const p of t)m.includes(p)?(s+=30,a=!0):p.length>=3&&m.some(h=>h.length>p.length&&h.includes(p))&&(s+=15,a=!0)}return a&&r&&(s+=Math.log(r.analytics.views+1)*2,s+=Math.log(r.analytics.completions+1)*3,s+=r.analytics.averageScore*.5),s}applyFilters(e,t,n,r){return e.filter(i=>{const s=n.get(i.id),a=r.get(i.id);if(t.contentTypes&&t.contentTypes.length>0&&!t.contentTypes.includes(i.type))return!1;if(t.tags&&t.tags.length>0){const l=s?.metadata.tags||a?.metadata.tags||[];if(!t.tags.some(o=>l.includes(o)))return!1}if(t.difficulty&&t.difficulty.length>0){const l=s?.metadata.difficulty||a?.metadata.difficulty;if(l&&!t.difficulty.includes(l))return!1}if(t.dateRange&&s){const l=s.metadata.created;if(l<t.dateRange.start||l>t.dateRange.end)return!1}return!(t.author&&s&&s.metadata.author!==t.author||t.minRelevance&&i.relevance<t.minRelevance)})}generateSnippet(e,t,n=150){const r=t.split(/[.!?]+/).filter(a=>a.trim().length>0);let i="",s=0;for(const a of r){const l=this.tokenize(a),o=e.filter(d=>l.some(u=>u.includes(d))).length;o>s&&(s=o,i=a.trim())}return i.length>n&&(i=i.substring(0,n-3)+"..."),i||t.substring(0,n-3)+"..."}search(e,t,n,r={},i=50){if(!e.trim())return[];const s=this.tokenize(e),a=[];for(const[o,d]of this.searchIndex.content.entries()){const u=t.get(o),m=n.get(o);if(!u&&!m)continue;const p=this.calculateRelevance(o,s,d,u,m);if(p>10){const h=u?.title||m?.title||"",g=u?`${u.description} ${this.extractContentText(u.blocks)}`:h,f=this.generateSnippet(s,g),y=u?.metadata.tags||m?.metadata.tags||[],v=u?"module":m?.type||"unknown";a.push({id:o,title:h,snippet:f,relevance:p,type:v,tags:y})}}return a.sort((o,d)=>d.relevance-o.relevance),this.applyFilters(a,r,t,n).slice(0,i)}searchByTags(e,t,n){const r=[],i=new Set;for(const s of e){const a=this.searchIndex.tags.get(s)||[];for(const l of a){if(i.has(l))continue;i.add(l);const o=t.get(l),d=n.get(l);if(o||d){const u=o?.title||d?.title||"",m=o?`${o.description} ${this.extractContentText(o.blocks)}`:u,p=this.generateSnippet([s],m),h=o?.metadata.tags||d?.metadata.tags||[],g=o?"module":d?.type||"unknown";r.push({id:l,title:u,snippet:p,relevance:100,type:g,tags:h})}}}return r.sort((s,a)=>a.relevance-s.relevance)}getRelatedContent(e,t,n,r=10){const i=[],s=t.get(e),a=n.get(e);if(!s&&!a)return i;const l=this.searchIndex.links.get(e)||[];for(const d of l){const u=t.get(d),m=n.get(d);if(u||m){const p=u?.title||m?.title||"",h=u?`${u.description} ${this.extractContentText(u.blocks)}`:p,g=this.generateSnippet([],h),f=u?.metadata.tags||m?.metadata.tags||[],y=u?"module":m?.type||"unknown";i.push({id:d,title:p,snippet:g,relevance:90,type:y,tags:f})}}const o=s?.metadata.tags||a?.metadata.tags||[];for(const d of o){const u=this.searchIndex.tags.get(d)||[];for(const m of u){if(m===e||i.some(g=>g.id===m))continue;const p=t.get(m),h=n.get(m);if(p||h){const g=p?.title||h?.title||"",f=p?`${p.description} ${this.extractContentText(p.blocks)}`:g,y=this.generateSnippet([],f),v=p?.metadata.tags||h?.metadata.tags||[],w=p?"module":h?.type||"unknown";i.push({id:m,title:g,snippet:y,relevance:70,type:w,tags:v})}}}return i.sort((d,u)=>u.relevance-d.relevance).slice(0,r)}getSuggestions(e,t=5){if(e.length<2)return[];const n=new Set,r=e.toLowerCase();for(const i of this.searchIndex.content.values()){for(const s of i)if(s.startsWith(r)&&s.length>r.length&&(n.add(s),n.size>=t))break;if(n.size>=t)break}for(const i of this.searchIndex.tags.keys())if(i.toLowerCase().includes(r)&&(n.add(i),n.size>=t))break;return Array.from(n).slice(0,t)}clearIndex(){this.searchIndex.content.clear(),this.searchIndex.tags.clear(),this.searchIndex.links.clear()}getIndexStats(){return{totalContent:this.searchIndex.content.size,totalTags:this.searchIndex.tags.size,totalLinks:this.searchIndex.links.size,averageTokensPerContent:this.searchIndex.content.size>0?Array.from(this.searchIndex.content.values()).reduce((e,t)=>e+t.length,0)/this.searchIndex.content.size:0}}}const searchEngine=new SearchEngine;class CodeExecutionService{static instance;executionEnvironments=new Map;constructor(){this.initializeEnvironments()}static getInstance(){return CodeExecutionService.instance||(CodeExecutionService.instance=new CodeExecutionService),CodeExecutionService.instance}initializeEnvironments(){this.executionEnvironments.set("javascript",{language:"javascript",timeout:5e3,memoryLimit:50*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("python",{language:"python",timeout:1e4,memoryLimit:100*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1}),this.executionEnvironments.set("html",{language:"html",timeout:3e3,memoryLimit:25*1024*1024,allowNetworkAccess:!1,allowFileSystem:!1})}async executeCode(c,e,t){const n=performance.now(),r=this.executionEnvironments.get(e);if(!r)return{success:!1,error:`Execution not supported for language: ${e}`,executionTime:0,timestamp:new Date};const i={...r,...t};try{let s;switch(e){case"javascript":s=await this.executeJavaScript(c,i);break;case"python":s=await this.executePython(c,i);break;case"html":s=await this.executeHTML(c,i);break;default:s={success:!1,error:`Execution not implemented for language: ${e}`,executionTime:0,timestamp:new Date}}return s.executionTime=performance.now()-n,s}catch(s){return{success:!1,error:s instanceof Error?s.message:"Unknown execution error",executionTime:performance.now()-n,timestamp:new Date}}}async executeJavaScript(c,e){return new Promise(t=>{const n=setTimeout(()=>{t({success:!1,error:"Execution timeout exceeded",executionTime:e.timeout,timestamp:new Date})},e.timeout);try{const r=console,i=[],a={console:{log:(...d)=>i.push(d.map(u=>String(u)).join(" ")),error:(...d)=>i.push("ERROR: "+d.map(u=>String(u)).join(" ")),warn:(...d)=>i.push("WARN: "+d.map(u=>String(u)).join(" ")),info:(...d)=>i.push("INFO: "+d.map(u=>String(u)).join(" "))},Math,Date,JSON,Array,Object,String,Number,Boolean,RegExp,setTimeout:(d,u)=>(u>1e3&&(u=1e3),setTimeout(d,u)),clearTimeout},o=new Function(...Object.keys(a),`
					"use strict";
					try {
						${c}
					} catch (error) {
						console.error(error.message);
						throw error;
					}
					`)(...Object.values(a));clearTimeout(n),t({success:!0,output:i.length>0?i.join(`
`):o!==void 0?String(o):"",executionTime:0,timestamp:new Date})}catch(r){clearTimeout(n),t({success:!1,error:r instanceof Error?r.message:"JavaScript execution error",executionTime:0,timestamp:new Date})}})}async executePython(code,environment){return new Promise(resolve=>{setTimeout(()=>{if(code.includes("print(")){const print_matches=code.match(/print\((.*?)\)/g),output=print_matches?.map(match=>{const content=match.replace(/print\((.*?)\)/,"$1");try{return eval(content.replace(/'/g,'"'))}catch{return content.replace(/['"]/g,"")}}).join(`
`)||"";resolve({success:!0,output,executionTime:0,timestamp:new Date})}else resolve({success:!0,output:"Python code executed (simulation)",executionTime:0,timestamp:new Date})},100)})}async executeHTML(c,e){try{const t=document.createElement("iframe");return t.style.display="none",t.setAttribute("sandbox","allow-scripts"),document.body.appendChild(t),new Promise(n=>{const r=setTimeout(()=>{document.body.removeChild(t),n({success:!1,error:"HTML execution timeout",executionTime:e.timeout,timestamp:new Date})},e.timeout);t.onload=()=>{try{t.contentDocument&&(t.contentDocument.open(),t.contentDocument.write(c),t.contentDocument.close()),clearTimeout(r),setTimeout(()=>{document.body.removeChild(t),n({success:!0,output:"HTML rendered successfully",executionTime:0,timestamp:new Date})},500)}catch(i){clearTimeout(r),document.body.removeChild(t),n({success:!1,error:i instanceof Error?i.message:"HTML execution error",executionTime:0,timestamp:new Date})}},t.src="about:blank"})}catch(t){return{success:!1,error:t instanceof Error?t.message:"HTML execution setup error",executionTime:0,timestamp:new Date}}}isLanguageExecutable(c){return this.executionEnvironments.get(c)!==void 0}getSupportedLanguages(){return Array.from(this.executionEnvironments.keys())}}const codeExecutionService=CodeExecutionService.getInstance();class CodeVersioningService{static instance;constructor(){}static getInstance(){return CodeVersioningService.instance||(CodeVersioningService.instance=new CodeVersioningService),CodeVersioningService.instance}createVersion(e,t,n,r){const i={id:crypto.randomUUID(),code:e.code,timestamp:new Date,description:n||`Version ${e.version}`,author:r||"Anonymous"};return{...e,code:t,version:e.version+1,history:[...e.history,i]}}restoreToVersion(e,t){const n=e.history.find(i=>i.id===t);if(!n)return null;const r={id:crypto.randomUUID(),code:e.code,timestamp:new Date,description:`Backup before restore to version ${n.description}`,author:"System"};return{...e,code:n.code,version:e.version+1,history:[...e.history,r]}}getVersionHistory(e){const t=[...e.history],n={id:"current",code:e.code,timestamp:new Date,description:`Current version (${e.version})`,author:"Current"},r=[...t,n];return r.map((i,s)=>{if(s===0)return i;const a=r[s-1],l=this.calculateDiffStats(a.code,i.code);return{...i,diffStats:l}})}calculateDiffStats(e,t){const n=e.split(`
`),r=t.split(`
`);let i=0,s=0,a=0;const l=Math.max(n.length,r.length);for(let o=0;o<l;o++){const d=n[o],u=r[o];d===void 0?i++:u===void 0?s++:d!==u&&a++}return{added:i,removed:s,modified:a}}generateDiff(e,t){const n=e.split(`
`),r=t.split(`
`),i=[],s=Math.max(n.length,r.length);for(let a=0;a<s;a++){const l=n[a],o=r[a];l===void 0?i.push({type:"added",content:o,lineNumber:a+1}):o===void 0?i.push({type:"removed",content:l,lineNumber:a+1}):l!==o?(i.push({type:"removed",content:l,lineNumber:a+1}),i.push({type:"added",content:o,lineNumber:a+1})):i.push({type:"unchanged",content:l,lineNumber:a+1})}return i}cleanupVersions(e,t=10){if(e.history.length<=t)return e;const n=[...e.history].sort((r,i)=>i.timestamp.getTime()-r.timestamp.getTime());return{...e,history:n.slice(0,t)}}exportVersionHistory(e){const t={currentVersion:{code:e.code,version:e.version,language:e.language,title:e.title,description:e.description},history:e.history,exportedAt:new Date().toISOString()};return JSON.stringify(t,null,2)}importVersionHistory(e){try{const t=JSON.parse(e);if(!t.currentVersion||!Array.isArray(t.history))throw new Error("Invalid version history format");return{code:t.currentVersion.code,language:t.currentVersion.language,title:t.currentVersion.title,description:t.currentVersion.description,version:t.currentVersion.version,history:t.history.map(n=>({...n,timestamp:new Date(n.timestamp)})),executable:!0}}catch{return null}}}const codeVersioningService=CodeVersioningService.getInstance();function exportSimulationToJSON(c,e,t,n){const r={simulationType:c,parameters:e,results:t,metadata:{exportedAt:new Date().toISOString(),duration:t.length>0?t[t.length-1].time:0,steps:t.length,version:"1.0.0",...n}};return JSON.stringify(r,null,2)}function exportSimulationToCSV(c,e){if(c.length===0)return"";const t=Object.keys(c[0].state),n=["step","time",...t].join(","),r=c.map(i=>[i.step,i.time.toFixed(6),...t.map(a=>{const l=i.state[a];return typeof l=="number"?l.toFixed(6):String(l)})].join(","));return[n,...r].join(`
`)}function downloadFile(c,e,t="text/plain"){const n=new Blob([c],{type:t}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=e,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}function exportSimulationResults(c,e,t,n="json"){const r=new Date().toISOString().replace(/[:.]/g,"-"),i=`${c.toLowerCase().replace(/\s+/g,"-")}-${r}`;if(n==="json"){const s=exportSimulationToJSON(c,e,t);downloadFile(s,`${i}.json`,"application/json")}else if(n==="csv"){const s=exportSimulationToCSV(t);downloadFile(s,`${i}.csv`,"text/csv")}}function generateSimulationReport(c,e,t){if(t.length===0)return"No simulation data available for report generation.";const n=t[0],r=t[t.length-1],i=Object.keys(n.state);let s=`# Simulation Report: ${c}

`;return s+=`## Parameters

`,Object.entries(e).forEach(([a,l])=>{s+=`- **${a}**: ${l}
`}),s+=`
## Summary

`,s+=`- **Duration**: ${r.time.toFixed(3)} seconds
`,s+=`- **Steps**: ${t.length}
`,s+=`- **Average step time**: ${(r.time/t.length).toFixed(6)} seconds
`,s+=`
## State Analysis

`,i.forEach(a=>{const l=t.map(o=>o.state[a]).filter(o=>typeof o=="number");if(l.length>0){const o=Math.min(...l),d=Math.max(...l),u=l.reduce((p,h)=>p+h,0)/l.length,m=l[l.length-1];s+=`### ${a}
`,s+=`- **Initial**: ${l[0].toFixed(6)}
`,s+=`- **Final**: ${m.toFixed(6)}
`,s+=`- **Minimum**: ${o.toFixed(6)}
`,s+=`- **Maximum**: ${d.toFixed(6)}
`,s+=`- **Average**: ${u.toFixed(6)}

`}}),s+=`
## Export Information

`,s+=`- **Generated**: ${new Date().toISOString()}
`,s+=`- **Version**: 1.0.0
`,s}function exportSimulationReport(c,e,t){const n=generateSimulationReport(c,e,t),r=new Date().toISOString().replace(/[:.]/g,"-"),i=`${c.toLowerCase().replace(/\s+/g,"-")}-report-${r}.md`;downloadFile(n,i,"text/markdown")}const physicsSimulations=[{id:"pendulum",name:"Simple Pendulum",domain:"physics",description:"Simulate the motion of a simple pendulum with adjustable parameters",parameters:[{name:"length",type:"number",min:.5,max:5,step:.1,default:2,description:"Length of the pendulum (m)"},{name:"gravity",type:"number",min:1,max:20,step:.1,default:9.81,description:"Gravitational acceleration (m/s²)"},{name:"damping",type:"number",min:0,max:1,step:.01,default:.05,description:"Damping coefficient"},{name:"initialAngle",type:"number",min:-90,max:90,step:1,default:30,description:"Initial angle (degrees)"}],initialState:{angle:30*Math.PI/180,angularVelocity:0,time:0},stepFunction:`
            const dt = 0.016; // 60 FPS
            const g = parameters.gravity;
            const L = parameters.length;
            const b = parameters.damping;
            
            const angularAcceleration = -(g / L) * Math.sin(state.angle) - b * state.angularVelocity;
            
            return {
                angle: state.angle + state.angularVelocity * dt,
                angularVelocity: state.angularVelocity + angularAcceleration * dt,
                time: state.time + dt
            };
        `,visualization:{type:"canvas",width:400,height:400,interactive:!0,config:{showTrail:!0,showForces:!1}}},{id:"spring-mass",name:"Spring-Mass System",domain:"physics",description:"Simulate a mass attached to a spring with damping",parameters:[{name:"mass",type:"number",min:.1,max:10,step:.1,default:1,description:"Mass (kg)"},{name:"springConstant",type:"number",min:1,max:100,step:1,default:20,description:"Spring constant (N/m)"},{name:"damping",type:"number",min:0,max:10,step:.1,default:1,description:"Damping coefficient"},{name:"initialPosition",type:"number",min:-2,max:2,step:.1,default:1,description:"Initial displacement (m)"}],initialState:{position:1,velocity:0,time:0},stepFunction:`
            const dt = 0.016;
            const m = parameters.mass;
            const k = parameters.springConstant;
            const c = parameters.damping;
            
            const force = -k * state.position - c * state.velocity;
            const acceleration = force / m;
            
            return {
                position: state.position + state.velocity * dt,
                velocity: state.velocity + acceleration * dt,
                time: state.time + dt
            };
        `,visualization:{type:"canvas",width:400,height:300,interactive:!0,config:{showGraph:!0,showForces:!0}}}],chemistrySimulations=[{id:"reaction-kinetics",name:"Chemical Reaction Kinetics",domain:"chemistry",description:"Simulate the kinetics of a simple A → B reaction",parameters:[{name:"rateConstant",type:"number",min:.001,max:1,step:.001,default:.1,description:"Rate constant (s⁻¹)"},{name:"initialConcentrationA",type:"number",min:.1,max:10,step:.1,default:2,description:"Initial concentration of A (mol/L)"},{name:"temperature",type:"number",min:273,max:373,step:1,default:298,description:"Temperature (K)"}],initialState:{concentrationA:2,concentrationB:0,time:0},stepFunction:`
            const dt = 0.1;
            const k = parameters.rateConstant;
            const rate = k * state.concentrationA;
            
            return {
                concentrationA: Math.max(0, state.concentrationA - rate * dt),
                concentrationB: state.concentrationB + rate * dt,
                time: state.time + dt
            };
        `,visualization:{type:"chart",width:500,height:300,interactive:!0,config:{chartType:"line",showBoth:!0}}},{id:"gas-laws",name:"Ideal Gas Law",domain:"chemistry",description:"Explore the relationship between pressure, volume, and temperature",parameters:[{name:"volume",type:"number",min:1,max:50,step:.5,default:22.4,description:"Volume (L)"},{name:"temperature",type:"number",min:200,max:500,step:5,default:273,description:"Temperature (K)"},{name:"moles",type:"number",min:.1,max:10,step:.1,default:1,description:"Amount of gas (mol)"}],initialState:{pressure:1,volume:22.4,temperature:273,moles:1},stepFunction:`
            const R = 0.08314; // Gas constant (L·bar/mol·K)
            const pressure = (parameters.moles * R * parameters.temperature) / parameters.volume;
            
            return {
                pressure: pressure,
                volume: parameters.volume,
                temperature: parameters.temperature,
                moles: parameters.moles
            };
        `,visualization:{type:"canvas",width:400,height:400,interactive:!0,config:{show3D:!1,showMolecules:!0}}}],engineeringSimulations=[{id:"pid-controller",name:"PID Controller",domain:"engineering",description:"Simulate a PID controller response to a step input",parameters:[{name:"kp",type:"number",min:0,max:10,step:.1,default:1,description:"Proportional gain (Kp)"},{name:"ki",type:"number",min:0,max:5,step:.1,default:.5,description:"Integral gain (Ki)"},{name:"kd",type:"number",min:0,max:2,step:.01,default:.1,description:"Derivative gain (Kd)"},{name:"setpoint",type:"number",min:0,max:10,step:.1,default:5,description:"Setpoint value"}],initialState:{output:0,error:0,integral:0,previousError:0,time:0},stepFunction:`
            const dt = 0.05;
            const setpoint = parameters.setpoint;
            const error = setpoint - state.output;
            const integral = state.integral + error * dt;
            const derivative = (error - state.previousError) / dt;
            
            const controlSignal = parameters.kp * error + parameters.ki * integral + parameters.kd * derivative;
            const newOutput = state.output + controlSignal * dt;
            
            return {
                output: newOutput,
                error: error,
                integral: integral,
                previousError: error,
                time: state.time + dt
            };
        `,visualization:{type:"chart",width:500,height:300,interactive:!0,config:{chartType:"line",showSetpoint:!0,showError:!0}}},{id:"beam-deflection",name:"Beam Deflection",domain:"engineering",description:"Calculate deflection of a simply supported beam under load",parameters:[{name:"load",type:"number",min:100,max:1e4,step:100,default:1e3,description:"Applied load (N)"},{name:"length",type:"number",min:1,max:10,step:.1,default:4,description:"Beam length (m)"},{name:"elasticModulus",type:"number",min:1e5,max:3e5,step:1e4,default:2e5,description:"Elastic modulus (MPa)"},{name:"momentOfInertia",type:"number",min:1e-4,max:.01,step:1e-4,default:.001,description:"Moment of inertia (m⁴)"}],initialState:{maxDeflection:0,stress:0,safetyFactor:0},stepFunction:`
            const P = parameters.load;
            const L = parameters.length;
            const E = parameters.elasticModulus * 1e6; // Convert MPa to Pa
            const I = parameters.momentOfInertia;
            
            // Maximum deflection at center for simply supported beam with center load
            const maxDeflection = (P * Math.pow(L, 3)) / (48 * E * I);
            
            // Maximum stress
            const maxStress = (P * L) / (4 * Math.sqrt(I)) / 1e6; // Convert to MPa
            
            // Safety factor (assuming yield strength of 250 MPa)
            const yieldStrength = 250;
            const safetyFactor = yieldStrength / maxStress;
            
            return {
                maxDeflection: maxDeflection * 1000, // Convert to mm
                stress: maxStress,
                safetyFactor: safetyFactor
            };
        `,visualization:{type:"canvas",width:500,height:300,interactive:!0,config:{showDeformation:!0,showStress:!0}}}],systemDiagramTemplates=[{id:"control-system",name:"Control System Block Diagram",domain:"engineering",description:"Interactive control system with feedback loop",elements:[{id:"input",type:"circle",position:{x:50,y:150},size:{width:60,height:60},label:"Input",description:"System input signal",style:{fill:"#e3f2fd",stroke:"#1976d2",strokeWidth:2},interactive:!0,clickable:!0},{id:"controller",type:"rectangle",position:{x:150,y:125},size:{width:100,height:50},label:"Controller",description:"PID Controller",style:{fill:"#f3e5f5",stroke:"#7b1fa2",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"plant",type:"rectangle",position:{x:300,y:125},size:{width:100,height:50},label:"Plant",description:"System to be controlled",style:{fill:"#e8f5e8",stroke:"#388e3c",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"output",type:"circle",position:{x:450,y:150},size:{width:60,height:60},label:"Output",description:"System output signal",style:{fill:"#fff3e0",stroke:"#f57c00",strokeWidth:2},interactive:!0,clickable:!0},{id:"sensor",type:"rectangle",position:{x:300,y:225},size:{width:100,height:40},label:"Sensor",description:"Feedback sensor",style:{fill:"#fce4ec",stroke:"#c2185b",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0}],connections:[{id:"input-controller",from:"input",to:"controller",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"controller-plant",from:"controller",to:"plant",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"plant-output",from:"plant",to:"output",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2}},{id:"output-sensor",from:"output",to:"sensor",type:"line",arrow:!1,style:{stroke:"#666666",strokeWidth:2}},{id:"sensor-controller",from:"sensor",to:"controller",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:2,strokeDasharray:"5,5"}}],parameters:[{name:"gain",type:"number",min:.1,max:10,step:.1,default:1,description:"Controller gain"},{name:"delay",type:"number",min:0,max:2,step:.1,default:.5,description:"System delay (s)"}],initialState:{input:{opacity:1,scale:1},controller:{opacity:1,scale:1},plant:{opacity:1,scale:1},output:{opacity:1,scale:1},sensor:{opacity:1,scale:1}},updateFunction:`
            const gain = parameters.gain;
            const delay = parameters.delay;
            
            // Highlight active components based on parameters
            const controllerScale = 1.0 + (gain - 1.0) * 0.1;
            const plantOpacity = Math.max(0.3, 1.0 - delay * 0.3);
            
            return {
                ...state,
                controller: { ...state.controller, scale: controllerScale },
                plant: { ...state.plant, opacity: plantOpacity }
            };
        `},{id:"chemical-process",name:"Chemical Process Flow",domain:"chemistry",description:"Interactive chemical process diagram",elements:[{id:"reactor",type:"circle",position:{x:200,y:100},size:{width:80,height:80},label:"Reactor",description:"Chemical reactor vessel",style:{fill:"#e8f5e8",stroke:"#388e3c",strokeWidth:3},interactive:!0,clickable:!0},{id:"heater",type:"rectangle",position:{x:150,y:200},size:{width:60,height:40},label:"Heater",description:"Process heater",style:{fill:"#ffebee",stroke:"#d32f2f",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0},{id:"separator",type:"rectangle",position:{x:350,y:125},size:{width:80,height:60},label:"Separator",description:"Product separator",style:{fill:"#e3f2fd",stroke:"#1976d2",strokeWidth:2,borderRadius:5},interactive:!0,clickable:!0}],connections:[{id:"reactor-separator",from:"reactor",to:"separator",type:"arrow",arrow:!0,style:{stroke:"#666666",strokeWidth:3}},{id:"heater-reactor",from:"heater",to:"reactor",type:"arrow",arrow:!0,style:{stroke:"#d32f2f",strokeWidth:2}}],parameters:[{name:"temperature",type:"number",min:20,max:200,step:5,default:80,description:"Reactor temperature (°C)"},{name:"pressure",type:"number",min:1,max:10,step:.5,default:2,description:"System pressure (bar)"}],initialState:{reactor:{opacity:1,scale:1},heater:{opacity:1,scale:1},separator:{opacity:1,scale:1}},updateFunction:`
            const temp = parameters.temperature;
            const pressure = parameters.pressure;
            
            // Visual feedback based on parameters
            const heaterIntensity = Math.min(1.0, temp / 100);
            const reactorScale = 1.0 + (pressure - 1.0) * 0.05;
            
            return {
                reactor: { opacity: 1.0, scale: reactorScale },
                heater: { opacity: 0.5 + heaterIntensity * 0.5, scale: 1.0 },
                separator: { opacity: 1.0, scale: 1.0 }
            };
        `}];function getSimulationTemplate(c){return[...physicsSimulations,...chemistrySimulations,...engineeringSimulations].find(t=>t.id===c)}function getDiagramTemplate(c){return systemDiagramTemplates.find(e=>e.id===c)}function createSimulationFromTemplate(c,e){const t=getSimulationTemplate(c);return t?{id:e,type:"simulation",content:{simulationType:t.name,parameters:t.parameters,initialState:t.initialState,stepFunction:t.stepFunction,visualization:t.visualization,sourceReference:{originalUrl:"",originalContent:`Template: ${t.name}`,transformationReasoning:`Created from ${t.domain} simulation template`,extractionMethod:"template",confidence:1}},metadata:{created:new Date,modified:new Date,version:1}}:null}function createDiagramFromTemplate(c,e){const t=getDiagramTemplate(c);return t?{id:e,type:"system-diagram",content:{diagramType:t.name,description:t.description,elements:t.elements,connections:t.connections,parameters:t.parameters,initialState:t.initialState,updateFunction:t.updateFunction,layout:{width:600,height:400,padding:20,grid:!1},sourceReference:{originalUrl:"",originalContent:`Template: ${t.name}`,transformationReasoning:`Created from ${t.domain} diagram template`,extractionMethod:"template",confidence:1}},metadata:{created:new Date,modified:new Date,version:1}}:null}function createLogger(c){const e=`[${c}]`;return{debug:(...t)=>{},info:(...t)=>{console.info(e,...t)},warn:(...t)=>{console.warn(e,...t)},error:(...t)=>{console.error(e,...t)}}}class ErrorHandler{static instance;logger=createLogger("error-handler");toastQueue=[];errorListeners=[];constructor(){}static getInstance(){return ErrorHandler.instance||(ErrorHandler.instance=new ErrorHandler),ErrorHandler.instance}async handleAsync(e,t,n={}){const{showToast:r=!0,logError:i=!0,retryable:s=!1,maxRetries:a=3,retryDelay:l=1e3,onError:o,onRetry:d}=n;let u,m=0;for(;m<=(s?a:0);)try{return{success:!0,data:await e(),retryCount:m}}catch(p){if(u=p instanceof Error?p:new Error(String(p)),i&&this.logger.error(`Operation failed: ${t.operation}`,{error:u,context:t,attempt:m+1}),o&&o(u,t),this.notifyErrorListeners(u,t),s&&m<a&&this.isRetryableError(u)){m++,d&&d(m,u),await this.delay(l*m);continue}break}return r&&this.showErrorToast(u,t),{success:!1,error:u,retryCount:m}}handleSync(e,t,n={}){const{showToast:r=!0,logError:i=!0,fallbackValue:s,onError:a}=n;try{return{success:!0,data:e()}}catch(l){const o=l instanceof Error?l:new Error(String(l));return i&&this.logger.error(`Sync operation failed: ${t.operation}`,{error:o,context:t}),a&&a(o,t),this.notifyErrorListeners(o,t),r&&this.showErrorToast(o,t),{success:!1,error:o,data:s}}}createAsyncWrapper(e,t,n={}){return async(...r)=>(await this.handleAsync(()=>e(...r),t,n)).data}createSyncWrapper(e,t,n={}){return(...r)=>this.handleSync(()=>e(...r),t,n).data}addErrorListener(e){this.errorListeners.push(e)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}getUserFriendlyMessage(e,t){if(this.isNetworkError(e))return"Unable to connect to the server. Please check your internet connection and try again.";if(this.isValidationError(e))return e.message||"Please check your input and try again.";if(this.isPermissionError(e))return"You do not have permission to perform this action.";if(this.isTimeoutError(e))return"The operation took too long to complete. Please try again.";if(this.isStorageError(e))return"Unable to save data. Please check your storage space and try again.";switch(t.operation){case"save":case"create":return"Failed to save. Please try again.";case"load":case"fetch":return"Failed to load data. Please refresh and try again.";case"delete":return"Failed to delete. Please try again.";case"update":return"Failed to update. Please try again.";default:return"An unexpected error occurred. Please try again."}}isRetryableError(e){return this.isNetworkError(e)||this.isTimeoutError(e)||e.message.toLowerCase().includes("rate limit")||e.message.toLowerCase().includes("server error")||e.message.includes("503")||e.message.includes("502")||e.message.toLowerCase().includes("network error")}isNetworkError(e){return e.message.includes("fetch")||e.message.includes("network")||e.message.includes("connection")||e.message.includes("offline")||e.name==="NetworkError"}isValidationError(e){return e.message.includes("validation")||e.message.includes("invalid")||e.message.includes("required")||e.name==="ValidationError"}isPermissionError(e){return e.message.includes("permission")||e.message.includes("unauthorized")||e.message.includes("forbidden")||e.message.includes("401")||e.message.includes("403")}isTimeoutError(e){return e.message.includes("timeout")||e.message.includes("aborted")||e.name==="TimeoutError"||e.name==="AbortError"}isStorageError(e){return e.message.includes("storage")||e.message.includes("quota")||e.message.includes("IndexedDB")||e.name==="QuotaExceededError"}showErrorToast(e,t){const n=this.getUserFriendlyMessage(e,t),r={id:`error_${Date.now()}`,type:"error",title:"Error",message:n,duration:5e3,actions:this.getErrorActions(e,t)};this.toastQueue.push(r),typeof window<"u"&&window.dispatchEvent(new CustomEvent("show-toast",{detail:r}))}getErrorActions(e,t){const n=[];return this.isRetryableError(e)&&n.push({label:"Retry",action:()=>{typeof window<"u"&&window.dispatchEvent(new CustomEvent("error-retry",{detail:{error:e,context:t}}))}}),this.isNetworkError(e)&&n.push({label:"Refresh",action:()=>window.location.reload()}),n}notifyErrorListeners(e,t){this.errorListeners.forEach(n=>{try{n(e,t)}catch(r){this.logger.error("Error listener failed:",r)}})}delay(e){return new Promise(t=>setTimeout(t,e))}getToastQueue(){return[...this.toastQueue]}clearToastQueue(){this.toastQueue.length=0}}const errorHandler=ErrorHandler.getInstance();errorHandler.handleAsync.bind(errorHandler);errorHandler.handleSync.bind(errorHandler);errorHandler.createAsyncWrapper.bind(errorHandler);errorHandler.createSyncWrapper.bind(errorHandler);class PerformanceMonitor{entries=[];observers=[];startTime=Date.now();constructor(){this.initializeObservers()}initializeObservers(){if(!(typeof window>"u")&&"PerformanceObserver"in window){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(r=>{r.entryType==="navigation"&&this.recordNavigationMetrics(r)})});e.observe({entryTypes:["navigation"]}),this.observers.push(e)}catch(e){console.warn("Navigation timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(r=>{r.entryType==="paint"&&this.recordPaintMetrics(r)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Paint timing observer not supported:",e)}try{const e=new PerformanceObserver(t=>{const n=t.getEntries(),r=n[n.length-1];r&&this.recordLCPMetrics(r)});e.observe({entryTypes:["largest-contentful-paint"]}),this.observers.push(e)}catch(e){console.warn("LCP observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(r=>{this.recordLayoutShiftMetrics(r)})});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Layout shift observer not supported:",e)}try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(r=>{this.recordFirstInputDelay(r)})});e.observe({entryTypes:["first-input"]}),this.observers.push(e)}catch(e){console.warn("First input delay observer not supported:",e)}}}recordNavigationMetrics(e){const t={pageLoad:{domContentLoaded:e.domContentLoadedEventEnd-e.navigationStart,loadComplete:e.loadEventEnd-e.navigationStart}};this.updateCurrentMetrics(t)}recordPaintMetrics(e){const t={};e.name==="first-contentful-paint"&&(t.pageLoad={...this.getCurrentMetrics()?.pageLoad,firstContentfulPaint:e.startTime}),this.updateCurrentMetrics(t)}recordLCPMetrics(e){const t={pageLoad:{...this.getCurrentMetrics()?.pageLoad,largestContentfulPaint:e.startTime}};this.updateCurrentMetrics(t)}recordLayoutShiftMetrics(e){if(!e.hadRecentInput){const t=this.getCurrentMetrics(),n=t?.userExperience?.cumulativeLayoutShift||0,r={userExperience:{...t?.userExperience,cumulativeLayoutShift:n+e.value}};this.updateCurrentMetrics(r)}}recordFirstInputDelay(e){const t={userExperience:{...this.getCurrentMetrics()?.userExperience,firstInputDelay:e.processingStart-e.startTime}};this.updateCurrentMetrics(t)}measureRenderTime(e,t){const n=performance.now();t();const i=performance.now()-n;return console.debug(`Component ${e} render time: ${i.toFixed(2)}ms`),i}async measureAsyncOperation(e,t){const n=performance.now(),r=await t(),s=performance.now()-n;return console.debug(`Operation ${e} completed in: ${s.toFixed(2)}ms`),{result:r,duration:s}}getMemoryUsage(){if(typeof window<"u"&&"memory"in performance)return performance.memory.usedJSHeapSize}getConnectionInfo(){if(typeof navigator<"u"&&"connection"in navigator){const e=navigator.connection;return e.effectiveType||e.type}}recordEntry(e,t){const n=this.getCurrentMetrics(),r=this.getMemoryUsage(),i=this.getConnectionInfo(),s={timestamp:Date.now(),page:e,metrics:{pageLoad:n?.pageLoad||{domContentLoaded:0,loadComplete:0},bundle:n?.bundle||{totalSize:0,chunkCount:0,loadTime:0},runtime:{memoryUsage:r,renderTime:n?.runtime?.renderTime||0,interactionTime:n?.runtime?.interactionTime||0},userExperience:n?.userExperience||{},...t},userAgent:navigator.userAgent,connectionType:i};this.entries.push(s),this.logPerformanceEntry(s)}getCurrentMetrics(){return this.entries[this.entries.length-1]?.metrics}updateCurrentMetrics(e){this.entries.length===0&&this.recordEntry(window.location.pathname);const t=this.entries[this.entries.length-1];t.metrics={...t.metrics,...e,pageLoad:{...t.metrics.pageLoad,...e.pageLoad},runtime:{...t.metrics.runtime,...e.runtime},userExperience:{...t.metrics.userExperience,...e.userExperience}}}logPerformanceEntry(e){console.group(`Performance Metrics - ${e.page}`),console.log("Timestamp:",new Date(e.timestamp).toISOString()),console.log("Page Load:",e.metrics.pageLoad),console.log("Runtime:",e.metrics.runtime),console.log("User Experience:",e.metrics.userExperience),e.connectionType&&console.log("Connection:",e.connectionType),console.groupEnd()}getEntries(){return[...this.entries]}getSummary(){if(this.entries.length===0)return{totalEntries:0,averageLoadTime:0,averageRenderTime:0,averageMemoryUsage:0};const e=this.entries.reduce((r,i)=>r+i.metrics.pageLoad.loadComplete,0),t=this.entries.reduce((r,i)=>r+i.metrics.runtime.renderTime,0),n=this.entries.reduce((r,i)=>r+(i.metrics.runtime.memoryUsage||0),0);return{totalEntries:this.entries.length,averageLoadTime:e/this.entries.length,averageRenderTime:t/this.entries.length,averageMemoryUsage:n/this.entries.length}}clearEntries(){this.entries=[]}cleanup(){this.observers.forEach(e=>{e.disconnect()}),this.observers=[]}}new PerformanceMonitor;export{KEYBOARD_KEYS as K,exportSimulationReport as a,createDiagramFromTemplate as b,createSimulationFromTemplate as c,chemistrySimulations as d,exportSimulationResults as e,engineeringSimulations as f,generateId as g,createKeyboardNavigationHandler as h,accessibilityPreferences as i,createLogger as j,searchEngine as k,liveRegionManager as l,announceToScreenReader as m,similarityEngine as n,codeVersioningService as o,physicsSimulations as p,codeExecutionService as q,errorHandler as r,systemDiagramTemplates as s,trapFocus as t,optimizeImage as u,validateMediaFile as v,optimizeVideo as w,formatFileSize as x};
