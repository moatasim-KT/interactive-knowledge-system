import{s as u,a as g,b as m}from"./DG3UZo5P.js";import{o as Q}from"./Dob3nYDb.js";import{j as B,k as L}from"./DsZ6whlC.js";const j="InteractiveKnowledgeMedia",K=1,D="media",v="metadata";class V{db=null;async init(){return new Promise((e,t)=>{const n=indexedDB.open(j,K);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=i=>{const s=i.target.result;if(!s.objectStoreNames.contains(D)){const a=s.createObjectStore(D,{keyPath:"id"});a.createIndex("type","type",{unique:!1}),a.createIndex("created","metadata.created",{unique:!1})}if(!s.objectStoreNames.contains(v)){const a=s.createObjectStore(v,{keyPath:"id"});a.createIndex("name","name",{unique:!1}),a.createIndex("type","type",{unique:!1}),a.createIndex("size","size",{unique:!1})}}})}async storeMedia(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((n,i)=>{const s=this.db.transaction([D,v],"readwrite"),a=s.objectStore(D),r=s.objectStore(v);a.put({id:e.id,data:t}),r.put(e),s.oncomplete=()=>n(),s.onerror=()=>i(s.error)})}async getMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([D,v],"readonly"),s=i.objectStore(D),a=i.objectStore(v);let r=null,o=null;const c=s.get(e),l=a.get(e);c.onsuccess=()=>{r=c.result?.data||null,d()},l.onsuccess=()=>{o=l.result||null,d()};function d(){r!==null&&o!==null&&t(r&&o?{file:o,data:r}:null)}i.onerror=()=>n(i.error)})}async listMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const s=this.db.transaction([v],"readonly").objectStore(v);let a;e?a=s.index("type").getAll(e):a=s.getAll(),a.onsuccess=()=>t(a.result||[]),a.onerror=()=>n(a.error)})}async deleteMedia(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([D,v],"readwrite"),s=i.objectStore(D),a=i.objectStore(v);s.delete(e),a.delete(e),i.oncomplete=()=>t(),i.onerror=()=>n(i.error)})}async getStorageQuota(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return{used:e.usage||0,total:e.quota||0,available:(e.quota||0)-(e.usage||0)}}return{used:0,total:0,available:0}}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=new Date;return t.setDate(t.getDate()-e),new Promise((n,i)=>{const s=this.db.transaction([D,v],"readwrite"),a=s.objectStore(v),r=s.objectStore(D),o=a.index("created"),c=IDBKeyRange.upperBound(t),l=o.openCursor(c);let d=0;l.onsuccess=h=>{const p=h.target.result;if(p){const _=p.value;r.delete(_.id),a.delete(_.id),d++,p.continue()}},s.oncomplete=()=>n(d),s.onerror=()=>i(s.error)})}close(){this.db&&(this.db.close(),this.db=null)}}const ue=new V;class W{async createLink(e,t,n,i=1,s,a=!1){const r={id:`${e}-${t}-${n}`,sourceId:e,targetId:t,type:n,strength:Math.max(0,Math.min(1,i)),metadata:{created:new Date,createdBy:"current-user",description:s,automatic:a}};if(await u.add("links",r,`Created ${n} link`),n==="related"||n==="similar"){const o={...r,id:`${t}-${e}-${n}`,sourceId:t,targetId:e};await u.add("links",o,`Created reverse ${n} link`)}return r}async getLinksForContent(e){return(await u.getAll("links")).filter(n=>n.sourceId===e||n.targetId===e)}async getLinksByType(e){return await u.searchByIndex("links","type",e)}async getOutgoingLinks(e){return await u.searchByIndex("links","sourceId",e)}async getIncomingLinks(e){return await u.searchByIndex("links","targetId",e)}async deleteLink(e){await u.delete("links",e)}async updateLink(e){await u.put("links",e,"Link updated")}async buildContentGraph(e){const t=new Map,n=new Map;for(const s of e){const a=await this.getOutgoingLinks(s.id),r=await this.getIncomingLinks(s.id);t.set(s.id,{id:s.id,title:s.title,type:"module",tags:s.metadata.tags,difficulty:s.metadata.difficulty,incomingLinks:r.map(o=>o.id),outgoingLinks:a.map(o=>o.id)})}const i=await u.getAll("links");for(const s of i)n.set(s.id,s);return{nodes:t,edges:n}}async analyzeDependencyChain(e,t=new Set){const n=await this.getPrerequisiteChain(e),i=await this.getDependentChain(e),s=n.every(r=>t.has(r)),a=await this.calculateDependencyDepth(e);return{nodeId:e,prerequisites:n,dependents:i,depth:a,canAccess:s}}async getPrerequisiteChain(e,t=new Set){if(t.has(e))return[];t.add(e);const i=(await this.getIncomingLinks(e)).filter(a=>a.type==="prerequisite").map(a=>a.sourceId),s=[...i];for(const a of i){const r=await this.getPrerequisiteChain(a,t);s.push(...r)}return[...new Set(s)]}async getDependentChain(e,t=new Set){if(t.has(e))return[];t.add(e);const i=(await this.getOutgoingLinks(e)).filter(a=>a.type==="prerequisite").map(a=>a.targetId),s=[...i];for(const a of i){const r=await this.getDependentChain(a,t);s.push(...r)}return[...new Set(s)]}async calculateDependencyDepth(e){const t=await this.getPrerequisiteChain(e);if(t.length===0)return 0;let n=0;for(const i of t){const s=await this.calculateDependencyDepth(i);n=Math.max(n,s)}return n+1}async findCircularDependencies(){const e=await this.buildContentGraph(await u.getAll("modules")),t=[],n=[],i=(c,l,d,h,p)=>{d.set(c,l),h.set(c,l),p.add(c),t.push(c);const _=e.nodes.get(c);if(!_)return l+1;if(Array.from(_.outgoingLinks).forEach(S=>{const I=e.edges.get(S);if(!I||I.type!=="prerequisite")return;const k=I.targetId;d.has(k)?p.has(k)&&h.set(c,Math.min(h.get(c),d.get(k))):(l=i(k,l+1,d,h,p),h.set(c,Math.min(h.get(c),h.get(k))))}),h.get(c)===d.get(c)){const S=[];let I;do I=t.pop(),p.delete(I),S.push(I);while(I!==c);S.length>1&&n.push(S)}return l+1},s=new Map,a=new Map,r=new Set;let o=0;return Array.from(e.nodes.keys()).forEach(c=>{s.has(c)||(o=i(c,o,s,a,r))}),n}}const $=new W;class G{async createModule(e){const t=new Date,n={...e,metadata:{author:"current-user",created:t,modified:t,version:1,difficulty:e.metadata?.difficulty||1,estimatedTime:e.metadata?.estimatedTime||0,prerequisites:e.metadata?.prerequisites||[],tags:e.metadata?.tags||[],language:e.metadata?.language||"en"}};return await u.add("modules",n,"Initial creation"),n}async getModule(e){return await u.get("modules",e)}async getAllModules(){return await u.getAll("modules")}async updateModule(e,t){const n={...e,metadata:{...e.metadata,modified:new Date,version:e.metadata.version+1}};await u.put("modules",n,t||"Module updated")}async deleteModule(e){await u.delete("modules",e)}async searchModulesByTitle(e){return(await u.getAll("modules")).filter(n=>n.title.toLowerCase().includes(e.toLowerCase()))}async searchModulesByTag(e){return await u.searchByIndex("modules","tags",e)}async searchModulesByAuthor(e){return await u.searchByIndex("modules","author",e)}async searchModulesByDifficulty(e){return await u.searchByIndex("modules","difficulty",e)}async getModulesByDateRange(e,t){const n=IDBKeyRange.bound(e,t);return await u.searchByIndex("modules","created",n)}async getModuleHistory(e){return await u.getVersionHistory(e,"module")}async getModuleVersion(e,t){return await u.getVersion(e,t)}async restoreModuleVersion(e,t){const n=await u.getVersion(e,t);if(!n)throw new Error(`Version ${t} not found for module ${e}`);const i={...n.data,metadata:{...n.data.metadata,modified:new Date,version:n.data.metadata.version+1}};await u.put("modules",i,`Restored to version ${t}`)}}const he=new G;class E{static instance;networkStatus={isOnline:typeof navigator<"u"?navigator.onLine:!0};listeners=new Set;connectionMonitor=null;constructor(){this.initializeNetworkMonitoring()}static getInstance(){return E.instance||(E.instance=new E),E.instance}initializeNetworkMonitoring(){if(!(typeof window>"u")){if(window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),"connection"in navigator){const e=navigator.connection;e&&(this.updateConnectionInfo(e),e.addEventListener("change",()=>{this.updateConnectionInfo(e)}))}this.startPeriodicCheck()}}handleOnline(){this.networkStatus.isOnline=!0,g.setOnlineStatus(!0),this.notifyListeners()}handleOffline(){this.networkStatus.isOnline=!1,g.setOnlineStatus(!1),this.notifyListeners()}updateConnectionInfo(e){this.networkStatus={...this.networkStatus,connectionType:e.type||"unknown",effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt},this.notifyListeners()}startPeriodicCheck(){this.connectionMonitor=window.setInterval(async()=>{const e=this.networkStatus.isOnline,t=await this.checkConnectivity();e!==t&&(this.networkStatus.isOnline=t,g.setOnlineStatus(t),this.notifyListeners())},3e4)}async checkConnectivity(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("/favicon.ico",{method:"HEAD",cache:"no-cache",signal:e.signal});return clearTimeout(t),n.ok}catch{return!1}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.networkStatus)}catch{}})}getNetworkStatus(){return{...this.networkStatus}}isOnline(){return this.networkStatus.isOnline}isSlowConnection(){const{effectiveType:e,downlink:t}=this.networkStatus;return e==="slow-2g"||e==="2g"||t!==void 0&&t<1}addListener(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}destroy(){typeof window>"u"||(window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.connectionMonitor&&(clearInterval(this.connectionMonitor),this.connectionMonitor=null),this.listeners.clear())}}const w=E.getInstance();class z{static instance;queue=new Map;processing=!1;QUEUE_STORE="offline_queue";constructor(){this.loadQueue()}static getInstance(){return z.instance||(z.instance=new z),z.instance}async enqueue(e,t="medium",n=[]){const i={operation:e,priority:t,dependencies:n};this.queue.set(e.id,i),await this.persistQueue()}async dequeue(e){this.queue.delete(e),await this.persistQueue()}getNextOperations(e=10){const t=[],n=new Set,i=Array.from(this.queue.values()).sort((s,a)=>{const r={high:3,medium:2,low:1},o=r[a.priority]-r[s.priority];return o!==0?o:s.operation.timestamp.getTime()-a.operation.timestamp.getTime()});for(const s of i){if(t.length>=e)break;s.dependencies.every(r=>n.has(r)||!this.queue.has(r))&&(t.push(s.operation),n.add(s.operation.id))}return t}getAllOperations(){return Array.from(this.queue.values()).map(e=>e.operation)}size(){return this.queue.size}isEmpty(){return this.queue.size===0}async clear(){this.queue.clear(),await this.persistQueue()}getOperationsByEntity(e){return Array.from(this.queue.values()).filter(t=>t.operation.entity===e).map(t=>t.operation)}getOperationsByEntityId(e){return Array.from(this.queue.values()).filter(t=>t.operation.entityId===e).map(t=>t.operation)}async incrementRetryCount(e){const t=this.queue.get(e);return t?(t.operation.retryCount++,t.operation.retryCount>=t.operation.maxRetries?(await this.dequeue(e),!1):(await this.persistQueue(),!0)):!1}async optimizeQueue(){const e=new Map;for(const t of this.queue.values()){const n=`${t.operation.entity}:${t.operation.entityId}`;e.has(n)||e.set(n,[]),e.get(n).push(t)}for(const[t,n]of e){if(n.length<=1)continue;n.sort((a,r)=>r.operation.timestamp.getTime()-a.operation.timestamp.getTime());const i=new Set,s=new Set;for(const a of n){const r=a.operation.type;if(r==="delete"){s.clear(),s.add(a.operation.id);break}else{if(r==="create"&&i.has("update"))continue;(r==="update"&&!i.has(r)||r==="create"&&!i.has("update"))&&s.add(a.operation.id)}i.add(r)}for(const a of n)s.has(a.operation.id)||this.queue.delete(a.operation.id)}await this.persistQueue()}async loadQueue(){try{await u.init();const e=await u.get("offline_queue","queue");e&&Array.isArray(e.items)&&(this.queue=new Map(e.items.map(t=>[t.operation.id,{...t,operation:{...t.operation,timestamp:new Date(t.operation.timestamp)}}])))}catch(e){console.error("Failed to load offline queue:",e),this.queue=new Map}}async persistQueue(){try{await u.init();const t={id:"queue",items:Array.from(this.queue.values()),lastUpdated:new Date};await u.put("offline_queue",t)}catch(e){console.error("Failed to persist offline queue:",e)}}}const y=z.getInstance();class Y{strategies=new Map;constructor(){this.registerDefaultStrategies()}registerStrategy(e,t){this.strategies.set(e,t)}async resolveConflict(e){const t=this.strategies.get(e.conflictType);if(!t)throw new Error(`No resolution strategy found for conflict type: ${e.conflictType}`);const n=await t.resolve(e);return e.resolved=!0,n}detectConflicts(e,t){const n=[];return t?(this.hasVersionConflict(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"version",timestamp:new Date,resolved:!1}),this.hasConcurrentEdit(e.data,t)&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:t,conflictType:"concurrent_edit",timestamp:new Date,resolved:!1}),n):((e.type==="update"||e.type==="delete")&&n.push({id:crypto.randomUUID(),operationId:e.id,localData:e.data,remoteData:null,conflictType:"deleted_remotely",timestamp:new Date,resolved:!1}),n)}hasVersionConflict(e,t){return e.metadata?.version!==void 0&&t.metadata?.version!==void 0&&e.metadata.version!==t.metadata.version}hasConcurrentEdit(e,t){const n=new Date(e.metadata?.modified||0),i=new Date(t.metadata?.modified||0);return Math.abs(n.getTime()-i.getTime())<5*60*1e3}registerDefaultStrategies(){this.registerStrategy("version",new X),this.registerStrategy("concurrent_edit",new Z),this.registerStrategy("deleted_remotely",new ee),this.registerStrategy("deleted_locally",new te)}}class X{async resolve(e){const t=new Date(e.localData.metadata?.modified||0),n=new Date(e.remoteData.metadata?.modified||0);return t>n?e.localData:e.remoteData}}class Z{async resolve(e){const{localData:t,remoteData:n}=e;if(this.isContentModule(t))return this.mergeContentModule(t,n);if(this.isUserProgress(t))return this.mergeUserProgress(t,n);if(this.isUserSettings(t))return this.mergeUserSettings(t,n);const i=new Date(t.metadata?.modified||0),s=new Date(n.metadata?.modified||0);return i>s?t:n}isContentModule(e){return e&&typeof e.title=="string"&&Array.isArray(e.blocks)}isUserProgress(e){return e&&typeof e.moduleId=="string"&&typeof e.userId=="string"}isUserSettings(e){return e&&typeof e.userId=="string"&&e.preferences}mergeContentModule(e,t){const n=Math.max(...(e.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),i=Math.max(...(t.blocks||[]).map(o=>new Date(o.metadata?.modified||0).getTime())),s=n>i?e:t,a={views:(e.analytics?.views??0)+(t.analytics?.views??0),completions:(e.analytics?.completions??0)+(t.analytics?.completions??0),averageScore:((e.analytics?.averageScore??0)+(t.analytics?.averageScore??0))/2||0,averageTime:((e.analytics?.averageTime??0)+(t.analytics?.averageTime??0))/2||0},r=Array.from(new Set([...e.metadata?.tags??[],...t.metadata?.tags??[]]));return{...s,metadata:{...s.metadata,tags:r,modified:new Date,version:Math.max(e.metadata?.version??0,t.metadata?.version??0)+1},analytics:{...s.analytics,...a}}}mergeUserProgress(e,t){return{...e,score:Math.max(e.score??0,t.score??0),timeSpent:(e.timeSpent??0)+(t.timeSpent??0),lastAccessed:new Date(Math.max(e.lastAccessed.getTime(),t.lastAccessed.getTime())),attempts:e.attempts+t.attempts,notes:e.notes&&t.notes?`${e.notes}
---
${t.notes}`:e.notes||t.notes,status:this.getMostAdvancedStatus(e.status,t.status)}}mergeUserSettings(e,t){return{...e,preferences:{...t.preferences,...e.preferences}}}getMostAdvancedStatus(e,t){const n={"not-started":0,"in-progress":1,completed:2},i=n[e]||0,s=n[t]||0,a=Math.max(i,s);return Object.keys(n)[a]}}class ee{async resolve(e){return console.warn("User prompt strategy not implemented, using local data"),e.localData}}class te{async resolve(e){return e.remoteData}}const N=new Y;class q{static instance;updates=new Map;rollbackCallbacks=new Map;constructor(){}static getInstance(){return q.instance||(q.instance=new q),q.instance}applyOptimisticUpdate(e){const t=crypto.randomUUID(),n=this.captureCurrentState(e.entity,e.entityId);this.applyUpdateToState(e);const i={id:t,operationId:e.id,entity:e.entity,entityId:e.entityId,previousState:n,newState:e.data,timestamp:new Date,applied:!0};return this.updates.set(t,i),this.rollbackCallbacks.set(t,()=>{this.rollbackUpdate(t)}),t}confirmUpdate(e){this.updates.get(e)&&(this.updates.delete(e),this.rollbackCallbacks.delete(e))}rollbackUpdate(e){const t=this.updates.get(e);!t||!t.applied||(this.restoreState(t.entity,t.entityId,t.previousState),t.applied=!1,g.addNotification({type:"warning",message:`Update to ${t.entity} failed and was rolled back`}))}rollbackOperation(e){for(const[t,n]of this.updates)n.operationId===e&&this.rollbackUpdate(t)}getPendingUpdates(){return Array.from(this.updates.values()).filter(e=>e.applied)}clearAll(){this.updates.clear(),this.rollbackCallbacks.clear()}captureCurrentState(e,t){switch(e){case"content":return m.content.nodes.get(t);case"progress":return m.progress.userProgress.get(t);case"settings":return m.user.settings;default:return null}}applyUpdateToState(e){switch(e.entity){case"content":this.applyContentUpdate(e);break;case"progress":this.applyProgressUpdate(e);break;case"settings":this.applySettingsUpdate(e);break;case"relationships":this.applyRelationshipUpdate(e);break}}applyContentUpdate(e){switch(e.type){case"create":g.addKnowledgeNode(e.data);break;case"update":g.updateKnowledgeNode(e.entityId,e.data);break;case"delete":g.removeKnowledgeNode(e.entityId);break}}applyProgressUpdate(e){switch(e.type){case"create":case"update":g.updateUserProgress(e.entityId,e.data);break;case"delete":m.progress.userProgress.delete(e.entityId);break}}applySettingsUpdate(e){e.type==="update"&&(m.user.settings={...m.user.settings,...e.data})}applyRelationshipUpdate(e){console.log("Relationship update applied optimistically:",e)}restoreState(e,t,n){if(n)switch(e){case"content":n?g.updateKnowledgeNode(t,n):g.removeKnowledgeNode(t);break;case"progress":n?g.updateUserProgress(t,n):m.progress.userProgress.delete(t);break;case"settings":m.user.settings=n;break}}}const C=q.getInstance();class M{static instance;config=null;syncInterval=null;isSyncing=!1;lastSyncAttempt=null;constructor(){this.setupNetworkListener()}static getInstance(){return M.instance||(M.instance=new M),M.instance}initialize(e){this.config=e,this.startPeriodicSync()}startPeriodicSync(){!this.config||this.syncInterval||typeof window>"u"||(this.syncInterval=window.setInterval(()=>{w.isOnline()&&!this.isSyncing&&this.sync()},this.config.syncInterval))}stopPeriodicSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async sync(){if(!this.config||this.isSyncing||!w.isOnline())return{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:"Sync not available",retryable:!1,timestamp:new Date}]};this.isSyncing=!0,g.setSyncStatus(!0),this.lastSyncAttempt=new Date;try{const e=y.getNextOperations(this.config.batchSize);if(e.length===0)return await this.pullRemoteChanges(),{success:!0,operationsProcessed:0,conflicts:[],errors:[]};const t=await this.processSyncBatch(e);for(const n of e)t.errors.some(s=>s.operationId===n.id)||(await y.dequeue(n.id),C.confirmUpdate(n.id));return t}catch(e){return console.error("Sync failed:",e),{success:!1,operationsProcessed:0,conflicts:[],errors:[{operationId:"",error:e instanceof Error?e.message:"Unknown sync error",retryable:!0,timestamp:new Date}]}}finally{this.isSyncing=!1,g.setSyncStatus(!1)}}async processSyncBatch(e){const t={success:!0,operationsProcessed:0,conflicts:[],errors:[]};for(const n of e)try{const i=await this.processSyncOperation(n);if(t.operationsProcessed++,t.conflicts.push(...i.conflicts),i.conflicts.length>0)for(const s of i.conflicts)try{const a=await N.resolveConflict(s);await this.applyResolvedData(n,a)}catch(a){t.errors.push({operationId:n.id,error:`Conflict resolution failed: ${a}`,retryable:!1,timestamp:new Date})}}catch(i){t.success=!1,t.errors.push({operationId:n.id,error:i instanceof Error?i.message:"Unknown operation error",retryable:this.isRetryableError(i),timestamp:new Date}),await y.incrementRetryCount(n.id)||C.rollbackOperation(n.id)}return t}async processSyncOperation(e){const t=this.getEndpointForOperation(e),n=this.getHttpMethodForOperation(e);let i=null;(e.type==="update"||e.type==="delete")&&(i=await this.fetchRemoteData(e.entity,e.entityId));const s=N.detectConflicts(e,i);if(s.length>0)return{conflicts:s};const a=await this.makeRequest(t,{method:n,headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:n!=="DELETE"?JSON.stringify(e.data):void 0});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return{conflicts:[]}}async pullRemoteChanges(){if(!this.config)return;const e=m.sync.lastSync?.toISOString()||new Date(0).toISOString(),t=`${this.config.endpoint}/changes?since=${e}&userId=${this.config.userId}`;try{const n=await this.makeRequest(t,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});if(n.ok){const i=await n.json();await this.applyRemoteChanges(i)}}catch(n){console.error("Failed to pull remote changes:",n)}}async applyRemoteChanges(e){for(const t of e)try{switch(t.entity){case"content":t.type==="delete"?g.removeKnowledgeNode(t.entityId):g.updateKnowledgeNode(t.entityId,t.data);break;case"progress":t.type==="delete"?m.progress.userProgress.delete(t.entityId):g.updateUserProgress(t.entityId,t.data);break;case"settings":t.type!=="delete"&&(m.user.settings={...m.user.settings,...t.data});break}}catch(n){console.error("Failed to apply remote change:",n)}}async applyResolvedData(e,t){switch(e.entity){case"content":g.updateKnowledgeNode(e.entityId,t);break;case"progress":g.updateUserProgress(e.entityId,t);break;case"settings":m.user.settings={...m.user.settings,...t};break}const n=this.getEndpointForOperation(e);await this.makeRequest(n,{method:"PUT",headers:{"Content-Type":"application/json",...this.config?.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:JSON.stringify({...e,data:t,resolved:!0})})}async fetchRemoteData(e,t){if(!this.config)return null;const n=`${this.config.endpoint}/${e}/${t}?userId=${this.config.userId}`;try{const i=await this.makeRequest(n,{method:"GET",headers:{...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}}});return i.ok?await i.json():null}catch{return null}}async makeRequest(e,t,n=3){for(let i=0;i<n;i++)try{return await fetch(e,{...t,signal:AbortSignal.timeout(1e4)})}catch(s){if(i===n-1)throw s;const a=Math.min(1e3*Math.pow(2,i),1e4);await new Promise(r=>setTimeout(r,a))}throw new Error("Max retries exceeded")}getEndpointForOperation(e){if(!this.config)throw new Error("Sync not configured");return e.type==="create"?`${this.config.endpoint}/${e.entity}?userId=${this.config.userId}`:`${this.config.endpoint}/${e.entity}/${e.entityId}?userId=${this.config.userId}`}getHttpMethodForOperation(e){switch(e.type){case"create":return"POST";case"update":return"PUT";case"delete":return"DELETE";default:return"PUT"}}isRetryableError(e){return e instanceof TypeError||e.name==="AbortError"||e&&typeof e.status=="number"&&e.status>=500&&e.status<600}setupNetworkListener(){w.addListener(e=>{e.isOnline&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),1e3)})}async queueOperation(e,t,n,i,s="medium"){const a={id:crypto.randomUUID(),type:e,entity:t,entityId:t==="settings"?m.user?.id||"default-user":n,data:i,timestamp:new Date,retryCount:0,maxRetries:3};return C.applyOptimisticUpdate(a),await y.enqueue(a,s),g.addPendingChange(a.id),w.isOnline()&&!this.isSyncing&&typeof window<"u"&&setTimeout(()=>this.sync(),100),a.id}getSyncStatus(){return{isOnline:w.isOnline(),isSyncing:this.isSyncing,lastSync:m.sync.lastSync,pendingOperations:y.size(),lastSyncAttempt:this.lastSyncAttempt}}}const T=M.getInstance();class P{static instance;initialized=!1;constructor(){}static getInstance(){return P.instance||(P.instance=new P),P.instance}async initialize(e){this.initialized||(w.getNetworkStatus(),this.setupNetworkEffects(),e&&T.initialize(e),await y.optimizeQueue(),this.initialized=!0,g.addNotification({type:"info",message:"Sync service initialized"}))}async createContent(e){return await T.queueOperation("create","content",e.id,e,"high")}async updateContent(e,t){return await T.queueOperation("update","content",e,t,"medium")}async deleteContent(e){return await T.queueOperation("delete","content",e,null,"high")}async updateProgress(e,t){return await T.queueOperation("update","progress",e,t,"medium")}async updateSettings(e){return await T.queueOperation("update","settings",m.user.id,e,"low")}async syncNow(){if(!w.isOnline()){g.addNotification({type:"warning",message:"Cannot sync while offline"});return}try{const e=await T.sync();e.success?g.addNotification({type:"success",message:`Synced ${e.operationsProcessed} operations`}):g.addNotification({type:"error",message:`Sync failed: ${e.errors.length} errors`}),e.conflicts.length>0&&g.addNotification({type:"warning",message:`${e.conflicts.length} conflicts resolved automatically`})}catch(e){g.addNotification({type:"error",message:"Sync failed: "+(e instanceof Error?e.message:"Unknown error")})}}getSyncStatus(){const e=T.getSyncStatus(),t=w.getNetworkStatus(),n=C.getPendingUpdates();return{...e,networkStatus:t,pendingOptimisticUpdates:n.length,queueSize:y.size(),canSync:t.isOnline&&!e.isSyncing}}async clearOfflineData(){await y.clear(),C.clearAll(),g.addNotification({type:"info",message:"Offline data cleared"})}getOfflineStats(){const e=y.getAllOperations(),t={total:e.length,byType:{},byEntity:{},oldestOperation:null,newestOperation:null};for(const n of e)t.byType[n.type]=(t.byType[n.type]||0)+1,t.byEntity[n.entity]=(t.byEntity[n.entity]||0)+1,(!t.oldestOperation||n.timestamp<t.oldestOperation)&&(t.oldestOperation=n.timestamp),(!t.newestOperation||n.timestamp>t.newestOperation)&&(t.newestOperation=n.timestamp);return t}setupNetworkEffects(){w.addListener(e=>{if(g.setOnlineStatus(e.isOnline),e.isOnline){const t=y.size();t>0&&g.addNotification({type:"info",message:`Back online! ${t} operations queued for sync`})}else g.addNotification({type:"warning",message:"You are now offline. Changes will be synced when connection is restored."})}),setInterval(async()=>{y.size()>10&&await y.optimizeQueue()},5*60*1e3)}destroy(){T.stopPeriodicSync(),w.destroy(),C.clearAll(),this.initialized=!1}}const A=P.getInstance();class R{static instance;initialized=!1;config={enableAutoSync:!0,syncInterval:3e4,maxRetries:3,enableOptimisticUpdates:!0,enableOfflineQueue:!0,enableNetworkDetection:!0};constructor(){}static getInstance(){return R.instance||(R.instance=new R),R.instance}async initialize(e){if(!this.initialized){e&&(this.config={...this.config,...e});try{await u.init(),this.config.enableNetworkDetection&&this.setupNetworkMonitoring(),this.config.enableAutoSync&&await this.initializeSyncService(),this.setupPeriodicMaintenance(),this.initialized=!0,g.addNotification({type:"info",message:"Offline functionality initialized"})}catch(t){console.error("Failed to initialize offline functionality:",t),this.initialized=!0,g.addNotification({type:"warning",message:"Offline functionality initialized with limited features"})}}}isAvailable(){return this.initialized&&typeof window<"u"}getStatus(){return{isOnline:w.isOnline(),isInitialized:this.initialized,queueSize:y.size(),pendingUpdates:C.getPendingUpdates().length,lastSync:m.sync.lastSync,storageAvailable:typeof window<"u"&&"indexedDB"in window,networkStatus:w.getNetworkStatus()}}async createContent(e){if(!this.initialized)throw new Error("Offline manager not initialized");try{await u.put("modules",e)}catch(t){console.warn("Failed to store content locally:",t)}return await A.createContent(e)}async updateContent(e,t){if(!this.initialized)throw new Error("Offline manager not initialized");try{const n=await u.get("modules",e);if(n){const i={...n,...t};await u.put("modules",i)}}catch(n){console.warn("Failed to update content locally:",n)}return await A.updateContent(e,t)}async deleteContent(e){if(!this.initialized)throw new Error("Offline manager not initialized");try{await u.delete("modules",e)}catch(t){console.warn("Failed to delete content locally:",t)}return await A.deleteContent(e)}async updateProgress(e,t){if(!this.initialized)throw new Error("Offline manager not initialized");try{const n=[t.userId,e];await u.put("progress",{...t,moduleId:e})}catch(n){console.warn("Failed to store progress locally:",n)}return await A.updateProgress(e,t)}async updateSettings(e){if(!this.initialized)throw new Error("Offline manager not initialized");try{const t={id:m.user.id||"default-user",userId:m.user.id||"default-user",...e};await u.put("settings",t)}catch(t){console.warn("Failed to store settings locally:",t)}return await A.updateSettings(e)}async forceSync(){if(!this.initialized)throw new Error("Offline manager not initialized");if(!w.isOnline()){g.addNotification({type:"warning",message:"Cannot sync while offline"});return}await A.syncNow()}async clearOfflineData(){if(!this.initialized)throw new Error("Offline manager not initialized");await y.clear(),C.clearAll(),m.sync.pendingChanges.length=0,g.addNotification({type:"info",message:"Offline data cleared"})}getStatistics(){const e=A.getOfflineStats(),t=this.getStatus();return{...e,...t,config:this.config}}updateConfig(e){this.config={...this.config,...e},!e.enableNetworkDetection&&this.config.enableNetworkDetection?w.destroy():e.enableNetworkDetection&&!this.config.enableNetworkDetection&&this.setupNetworkMonitoring()}setupNetworkMonitoring(){w.addListener(e=>{g.setOnlineStatus(e.isOnline),e.isOnline?this.handleOnline():this.handleOffline()})}handleOnline(){const e=y.size();e>0&&(g.addNotification({type:"info",message:`Back online! ${e} operations queued for sync`}),this.config.enableAutoSync&&setTimeout(()=>{A.syncNow().catch(t=>{console.error("Auto-sync failed:",t)})},1e3))}handleOffline(){g.addNotification({type:"warning",message:"You are now offline. Changes will be synced when connection is restored."})}async initializeSyncService(){try{await A.initialize()}catch(e){console.warn("Sync service initialization failed, continuing with offline-only mode:",e)}}setupPeriodicMaintenance(){typeof window>"u"||(setInterval(async()=>{try{y.size()>10&&await y.optimizeQueue()}catch(e){console.error("Queue optimization failed:",e)}},5*60*1e3),setInterval(()=>{try{C.getPendingUpdates().filter(n=>Date.now()-n.timestamp.getTime()>10*60*1e3).forEach(n=>{C.rollbackUpdate(n.id)})}catch(e){console.error("Optimistic update cleanup failed:",e)}},10*60*1e3))}destroy(){this.initialized&&(A.destroy(),w.destroy(),C.clearAll(),u.close(),this.initialized=!1)}}const ge=R.getInstance();class ne{db=null;dbName="web-content-sourcing";version=1;async initialize(){this.db=await Q(this.dbName,this.version,{upgrade(e){const t=e.createObjectStore("sources",{keyPath:"id"});t.createIndex("by-domain","domain"),t.createIndex("by-category","metadata.category"),t.createIndex("by-status","status");const n=e.createObjectStore("content",{keyPath:"id"});n.createIndex("by-url","url"),n.createIndex("by-domain","metadata.domain");const i=e.createObjectStore("jobs",{keyPath:"id"});i.createIndex("by-status","status"),i.createIndex("by-created","createdAt");const s=e.createObjectStore("templates",{keyPath:"id"});s.createIndex("by-type","type"),s.createIndex("by-category","category"),e.createObjectStore("settings",{keyPath:"key"})}})}ensureDB(){if(!this.db)throw new Error("Database not initialized. Call initialize() first.");return this.db}async addSource(e){await this.ensureDB().add("sources",e)}async updateSource(e){await this.ensureDB().put("sources",e)}async getSource(e){return await this.ensureDB().get("sources",e)}async getAllSources(){return await this.ensureDB().getAll("sources")}async getSourcesByDomain(e){return await this.ensureDB().getAllFromIndex("sources","by-domain",e)}async getSourcesByCategory(e){return await this.ensureDB().getAllFromIndex("sources","by-category",e)}async getSourcesByStatus(e){return await this.ensureDB().getAllFromIndex("sources","by-status",e)}async deleteSource(e){await this.ensureDB().delete("sources",e)}async addContent(e){await this.ensureDB().add("content",e)}async updateContent(e){await this.ensureDB().put("content",e)}async getContent(e){return await this.ensureDB().get("content",e)}async getContentByUrl(e){return await this.ensureDB().getFromIndex("content","by-url",e)}async getAllContent(){return await this.ensureDB().getAll("content")}async deleteContent(e){await this.ensureDB().delete("content",e)}async addJob(e){await this.ensureDB().add("jobs",e)}async updateJob(e){await this.ensureDB().put("jobs",e)}async getJob(e){return await this.ensureDB().get("jobs",e)}async getJobsByStatus(e){return await this.ensureDB().getAllFromIndex("jobs","by-status",e)}async getAllJobs(){return await this.ensureDB().getAll("jobs")}async deleteJob(e){await this.ensureDB().delete("jobs",e)}async addTemplate(e){await this.ensureDB().add("templates",e)}async updateTemplate(e){await this.ensureDB().put("templates",e)}async getTemplate(e){return await this.ensureDB().get("templates",e)}async getTemplatesByType(e){return await this.ensureDB().getAllFromIndex("templates","by-type",e)}async getAllTemplates(){return await this.ensureDB().getAll("templates")}async deleteTemplate(e){await this.ensureDB().delete("templates",e)}async setSetting(e,t){await this.ensureDB().put("settings",{key:e,value:t})}async getSetting(e){return(await this.ensureDB().get("settings",e))?.value}async deleteSetting(e){await this.ensureDB().delete("settings",e)}async clear(){const t=this.ensureDB().transaction(["sources","content","jobs","templates","settings"],"readwrite");await Promise.all([t.objectStore("sources").clear(),t.objectStore("content").clear(),t.objectStore("jobs").clear(),t.objectStore("templates").clear(),t.objectStore("settings").clear()]),await t.done}async getStats(){const e=this.ensureDB(),[t,n,i,s]=await Promise.all([e.count("sources"),e.count("content"),e.count("jobs"),e.count("templates")]);return{sources:t,content:n,jobs:i,templates:s}}}const f=new ne;class ie{logger=B("web-content-fetcher");defaultOptions={timeout:3e4,userAgent:"Mozilla/5.0 (compatible; WebContentFetcher/1.0)",followRedirects:!0,maxRedirects:5,extractAssets:!0,cleanContent:!0,preserveInteractivity:!1};async fetch(e,t={}){const n={...this.defaultOptions,...t},i=Date.now();try{this.logger.info(`Fetching content from: ${e}`);const s=new URL(e),a=new AbortController,r=setTimeout(()=>a.abort(),n.timeout);try{const o=await fetch(e,{signal:a.signal,headers:{"User-Agent":n.userAgent,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate","Cache-Control":"no-cache"},redirect:n.followRedirects?"follow":"manual"});if(clearTimeout(r),!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const c=await o.text(),l=o.url,d=this.extractContent(c,e,l,n),h=Date.now()-i;return this.logger.info(`Content fetched successfully in ${h}ms`),d}finally{clearTimeout(r)}}catch(s){const a=Date.now()-i;this.logger.error(`Failed to fetch content from ${e}:`,s);const r=s instanceof Error?s:new Error(String(s));let o="unknown",c="Failed to fetch content";return r.name==="AbortError"||r.message.includes("aborted")?(o="timeout",c="Request timed out"):r.message.includes("fetch")||r.message.includes("network")?(o="network",c="Network connection failed"):r.message.includes("HTTP")?(o="http",c=r.message):r.message.includes("CORS")&&(o="cors",c="Cross-origin request blocked"),{id:`error_${Date.now()}`,url:e,title:"Failed to fetch content",content:{html:"",text:"",images:[],codeBlocks:[],tables:[],charts:[],blocks:[]},metadata:{domain:this.safeParseDomain(e),contentType:"error",language:"en",readingTime:0,wordCount:0,keywords:[],description:`${c}: ${r.message}`,attribution:e,tags:["error",o],category:"error"},extraction:{method:"heuristic",confidence:0,qualityScore:0,issues:[r.message],processingTime:a,errorCategory:o,retryable:this.isRetryableError(r)},fetchedAt:new Date().toISOString(),success:!1}}}extractContent(e,t,n,i){const a=new DOMParser().parseFromString(e,"text/html"),r=this.extractMetadata(a,t,n),o=this.extractMainContent(a,i),c=this.extractImages(a,n),l=this.extractCodeBlocks(a),d=this.extractTables(a),h=this.detectCharts(a);return{id:`content_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,url:t,finalUrl:n,title:r.description||"Untitled",content:{html:o.html,text:o.text,images:c,codeBlocks:l,tables:d,charts:h,blocks:[]},metadata:r,extraction:{method:"heuristic",confidence:this.calculateExtractionConfidence(a,o),qualityScore:this.calculateQualityScore(o,r),issues:[],processingTime:0},fetchedAt:new Date().toISOString(),success:!0}}extractMetadata(e,t,n){const i=new URL(n).hostname,s=e.querySelector("title")?.textContent?.trim()||e.querySelector('meta[property="og:title"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:title"]')?.getAttribute("content")||"Untitled",a=e.querySelector('meta[name="description"]')?.getAttribute("content")||e.querySelector('meta[property="og:description"]')?.getAttribute("content")||e.querySelector('meta[name="twitter:description"]')?.getAttribute("content")||"",r=e.querySelector('meta[name="author"]')?.getAttribute("content")||e.querySelector('meta[property="article:author"]')?.getAttribute("content")||e.querySelector('[rel="author"]')?.textContent?.trim(),o=this.extractDate(e,['meta[property="article:published_time"]','meta[name="date"]','meta[name="publish-date"]',"time[datetime]"]),c=this.extractDate(e,['meta[property="article:modified_time"]','meta[name="last-modified"]','meta[http-equiv="last-modified"]']),l=e.documentElement.lang||e.querySelector('meta[http-equiv="content-language"]')?.getAttribute("content")||"en",h=(e.querySelector('meta[name="keywords"]')?.getAttribute("content")||"").split(",").map(k=>k.trim()).filter(k=>k.length>0),p=this.determineContentType(e,s,a),S=(e.body?.textContent||"").split(/\s+/).filter(k=>k.length>0).length,I=Math.ceil(S/200);return{description:a,author:r,publishDate:o,lastModified:c,domain:i,contentType:p,language:l,readingTime:I,wordCount:S,keywords:h,attribution:t,tags:[],category:this.categorizeContent(p,i,s,a)}}extractMainContent(e,t){let n=e.querySelector("main")||e.querySelector("article")||e.querySelector('[role="main"]')||e.querySelector(".content")||e.querySelector("#content")||e.querySelector(".post-content")||e.querySelector(".entry-content");if(n||(n=e.body),!n)return{html:"",text:""};const i=n.cloneNode(!0);t.cleanContent&&this.cleanContent(i);const s=i.innerHTML,a=i.textContent||"";return{html:s,text:a}}cleanContent(e){["script","style","noscript",".advertisement",".ads",".ad",".social-share",".share-buttons",".comments",".comment-section",".sidebar",".navigation",".nav",".header",".footer",".popup",".modal",".overlay"].forEach(n=>{e.querySelectorAll(n).forEach(i=>i.remove())}),e.querySelectorAll("*").forEach(n=>{["onclick","onload","onerror","data-track","data-analytics"].forEach(s=>{n.hasAttribute(s)&&n.removeAttribute(s)})})}extractImages(e,t){const n=[];return e.querySelectorAll("img").forEach((s,a)=>{const r=s.getAttribute("src");if(r)try{const o=new URL(r,t).href;n.push({id:`img_${a}`,src:o,alt:s.getAttribute("alt")||"",caption:s.getAttribute("title")||"",width:s.naturalWidth||void 0,height:s.naturalHeight||void 0})}catch{}}),n}extractCodeBlocks(e){const t=[];return e.querySelectorAll("pre code, code, .highlight, .code-block").forEach((i,s)=>{const a=i.textContent||"";if(a.trim().length>10){const r=this.detectCodeLanguage(i,a);t.push({id:`code_${s}`,code:a.trim(),language:r,filename:i.getAttribute("data-filename")||void 0,interactive:!1,executable:!1})}}),t}extractTables(e){const t=[];return e.querySelectorAll("table").forEach((i,s)=>{const a=[],r=[];i.querySelectorAll("thead th, tr:first-child th").forEach(l=>{a.push(l.textContent?.trim()||"")}),i.querySelectorAll("tbody tr, tr").forEach(l=>{const d=l.querySelectorAll("td, th");if(d.length>0){const h=[];d.forEach(p=>{h.push(p.textContent?.trim()||"")}),r.push(h)}}),r.length>0&&t.push({id:`table_${s}`,headers:a.length>0?a:void 0,rows:r})}),t}detectCharts(e){const t=[];return['canvas[id*="chart"]',".chart",".graph",".visualization","[data-chart]","[data-graph]","svg.chart","svg.graph"].forEach(i=>{e.querySelectorAll(i).forEach((s,a)=>{t.push({id:`chart_${t.length}`,type:this.detectChartType(s),selector:i,detected:!0,data:null})})}),t}detectChartType(e){const t=e.className.toLowerCase(),n=e.id.toLowerCase();return t.includes("line")||n.includes("line")?"line":t.includes("bar")||n.includes("bar")?"bar":t.includes("pie")||n.includes("pie")?"pie":t.includes("scatter")||n.includes("scatter")?"scatter":t.includes("area")||n.includes("area")?"area":"unknown"}detectCodeLanguage(e,t){const n=e.className.toLowerCase(),i={javascript:/\b(javascript|js)\b/,typescript:/\b(typescript|ts)\b/,python:/\b(python|py)\b/,java:/\bjava\b/,cpp:/\b(cpp|c\+\+)\b/,csharp:/\b(csharp|c#)\b/,html:/\bhtml\b/,css:/\bcss\b/,sql:/\bsql\b/,json:/\bjson\b/,xml:/\bxml\b/,bash:/\b(bash|shell|sh)\b/};for(const[s,a]of Object.entries(i))if(a.test(n))return s;return t.includes("function")&&t.includes("{")?"javascript":t.includes("def ")&&t.includes(":")?"python":t.includes("public class")||t.includes("import java")?"java":t.includes("<html")||t.includes("<!DOCTYPE")?"html":t.includes("SELECT")&&t.includes("FROM")?"sql":t.startsWith("{")&&t.endsWith("}")?"json":"text"}extractDate(e,t){for(const n of t){const i=e.querySelector(n);if(i){const s=i.getAttribute("content")||i.getAttribute("datetime")||i.textContent;if(s){const a=new Date(s);if(!isNaN(a.getTime()))return a}}}}determineContentType(e,t,n){const i=(t+" "+n).toLowerCase();return i.includes("tutorial")||i.includes("how to")||i.includes("guide")?"tutorial":i.includes("news")||i.includes("breaking")?"news":i.includes("blog")||i.includes("post")?"blog":i.includes("research")||i.includes("paper")||i.includes("study")?"research":i.includes("documentation")||i.includes("docs")||i.includes("api")?"documentation":e.querySelector("article")||e.querySelector('[itemtype*="Article"]')?"article":"webpage"}categorizeContent(e,t,n,i){const s=(n+" "+i+" "+t).toLowerCase();return s.includes("tech")||s.includes("programming")||s.includes("code")?"technology":s.includes("science")||s.includes("research")?"science":s.includes("business")||s.includes("finance")||s.includes("market")?"business":s.includes("health")||s.includes("medical")?"health":s.includes("education")||s.includes("learning")?"education":"general"}calculateExtractionConfidence(e,t){let n=.5;return e.querySelector('main, article, [role="main"]')&&(n+=.2),t.text.length>500&&(n+=.1),t.text.length>2e3&&(n+=.1),e.querySelector("h1, h2, h3")&&(n+=.1),Math.min(n,1)}calculateQualityScore(e,t){let n=.5;e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),t.description&&t.description.length>10&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.author&&(n+=.05),t.publishDate&&(n+=.05),t.keywords.length>0&&(n+=.05);const i=e.html.toLowerCase();return(i.includes("<h1")||i.includes("<h2"))&&(n+=.05),i.includes("<p>")&&(n+=.05),(i.includes("<ul>")||i.includes("<ol>"))&&(n+=.05),Math.min(n,1)}safeParseDomain(e){try{return new URL(e).hostname}catch{return"unknown"}}isRetryableError(e){const t=e.message.toLowerCase();return e.name==="AbortError"||t.includes("timeout")||t.includes("network")||t.includes("fetch")||t.includes("503")||t.includes("502")||t.includes("500")}}const H=new ie;class se{config={similarityThreshold:.3,tagMatchWeight:.4,contentMatchWeight:.3,titleMatchWeight:.3,enableAutomaticPrerequisites:!0,enableAutomaticRelated:!0,maxAutoRelationships:5};updateConfig(e){this.config={...this.config,...e}}async integrateContent(e,t){const n=Date.now();try{await this.createKnowledgeNode(e,t);const i=await this.detectRelationships(t);return this.addToSearchIndex(t),await this.updateRecommendations(t),await this.generateLearningPathSuggestions(t),await this.recordIntegrationMetrics(n),i}catch(i){throw new Error(`Integration failed: ${i instanceof Error?i.message:"Unknown error"}`)}}async createKnowledgeNode(e,t){const n=await this.findAppropriateParent(t),i=Math.min(5,Math.max(1,t.metadata.difficulty));return{id:t.id,title:t.title,type:"module",parent:n,metadata:{difficulty:i,estimatedTime:t.metadata.estimatedTime,prerequisites:t.relationships.prerequisites,tags:[...t.metadata.tags,"imported",`source:${e.domain}`,`type:${e.metadata.category}`]},progress:{completed:!1,lastAccessed:new Date}}}async findAppropriateParent(e){}async detectRelationships(e){const t=await u.getAll("modules"),n=[],i=[];for(const r of t){if(r.id===e.id)continue;const o=this.calculateContentSimilarity(e,r);if(o.score>=this.config.similarityThreshold){const c=this.determineRelationshipType(e,r,o);n.push({targetContentId:r.id,relationshipType:c,confidence:o.score,reasoning:o.reasons.join(", "),automatic:!0}),i.push(`Found ${c} relationship with "${r.title}" (confidence: ${(o.score*100).toFixed(1)}%)`)}}n.sort((r,o)=>o.confidence-r.confidence);const s=n.slice(0,this.config.maxAutoRelationships);(this.config.enableAutomaticRelated||this.config.enableAutomaticPrerequisites)&&await this.createAutomaticRelationships(e.id,s);const a=s.length>0?s.reduce((r,o)=>r+o.confidence,0)/s.length:0;return{sourceContentId:e.id,suggestedRelationships:s,confidence:a,reasoning:i}}calculateContentSimilarity(e,t){let n=0;const i=[],s=e.metadata.tags.filter(S=>t.metadata.tags.includes(S)),a=s.length/Math.max(e.metadata.tags.length,t.metadata.tags.length);n+=a*this.config.tagMatchWeight,s.length>0&&i.push(`Common tags: ${s.join(", ")}`);const r=e.title.toLowerCase().split(/\s+/),o=t.title.toLowerCase().split(/\s+/),c=r.filter(S=>o.includes(S)),l=c.length/Math.max(r.length,o.length);n+=l*this.config.titleMatchWeight,c.length>0&&i.push(`Common title words: ${c.join(", ")}`);const d=this.extractContentText(e),h=this.extractContentText(t),p=this.calculateTextSimilarity(d,h);return n+=p*this.config.contentMatchWeight,p>.1&&i.push(`Content similarity: ${(p*100).toFixed(1)}%`),Math.abs(e.metadata.difficulty-t.metadata.difficulty)<=1&&(n+=.1,i.push("Similar difficulty levels")),{score:Math.min(1,n),reasons:i}}extractContentText(e){return e.blocks.map(t=>{switch(t.type){case"text":return typeof t.content=="string"?t.content:"";case"code":return t.content?.code||"";case"quiz":return t.content?.questions?.map(n=>n.question).join(" ")||"";default:return""}}).join(" ").toLowerCase()}calculateTextSimilarity(e,t){const n=new Set(e.split(/\s+/).filter(r=>r.length>3)),i=new Set(t.split(/\s+/).filter(r=>r.length>3)),s=new Set(Array.from(n).filter(r=>i.has(r))),a=new Set(Array.from(n).concat(Array.from(i)));return a.size>0?s.size/a.size:0}determineRelationshipType(e,t,n){return t.metadata.difficulty<e.metadata.difficulty&&n.reasons.some(r=>r.includes("basic")||r.includes("intro")||r.includes("fundamental"))?"prerequisite":n.reasons.some(a=>a.includes("part")||a.includes("chapter")||a.includes("lesson"))?"sequence":n.reasons.some(a=>a.includes("example")||a.includes("demo")||a.includes("tutorial"))?"example":"related"}async createAutomaticRelationships(e,t){for(const n of t)try{(n.relationshipType==="related"&&this.config.enableAutomaticRelated||n.relationshipType==="prerequisite"&&this.config.enableAutomaticPrerequisites||n.relationshipType==="sequence"||n.relationshipType==="example")&&await $.createLink(e,n.targetContentId,n.relationshipType,n.confidence,n.reasoning,!0)}catch{}}addToSearchIndex(e){L.indexModule(e)}async updateRecommendations(e){const t=L.getRelatedContent(e.id,new Map([[e.id,e]]),new Map);await u.add("content_recommendations",{contentId:e.id,relatedContent:t.map(n=>n.id),lastUpdated:new Date},"Updated recommendations for imported content")}async generateLearningPathSuggestions(e){const t=[],n=await u.getAll("paths"),i=await u.getAll("modules");for(const a of n){const r=i.filter(c=>a.modules.includes(c.id)),o=await this.calculatePathSimilarity(e,r);o.score>.4&&t.push({pathId:a.id,name:`Enhanced ${a.name}`,description:`${a.description} - Enhanced with imported content from ${e.metadata.tags.join(", ")}`,suggestedModules:[...a.modules,e.id],estimatedDuration:a.estimatedDuration+e.metadata.estimatedTime,difficulty:Math.max(a.difficulty,e.metadata.difficulty),confidence:o.score,reasoning:o.reasons})}const s=await $.getLinksForContent(e.id);if(s.length>0){const a=s.map(r=>r.sourceId===e.id?r.targetId:r.sourceId);t.push({pathId:`generated-${e.id}`,name:`Learning Path: ${e.title}`,description:"Auto-generated learning path based on imported content and related materials",suggestedModules:[e.id,...a.slice(0,3)],estimatedDuration:e.metadata.estimatedTime*2,difficulty:e.metadata.difficulty,confidence:.7,reasoning:["Based on automatic relationship detection","Includes related existing content"]})}return t.sort((a,r)=>r.confidence-a.confidence)}async calculatePathSimilarity(e,t){let n=0;const i=[],s=new Set(t.flatMap(h=>h.metadata.tags)),a=e.metadata.tags.filter(h=>s.has(h)),r=a.length/Math.max(e.metadata.tags.length,s.size);n+=r*.5,a.length>0&&i.push(`Common tags with path: ${a.join(", ")}`);const o=t.map(h=>h.metadata.difficulty).sort((h,p)=>h-p);e.metadata.difficulty>=o[0]&&e.metadata.difficulty<=o[o.length-1]&&(n+=.3,i.push("Difficulty fits path progression"));const d=(await $.getLinksForContent(e.id)).filter(h=>t.some(p=>p.id===h.targetId||p.id===h.sourceId));return d.length>0&&(n+=.2,i.push(`Has relationships with ${d.length} path modules`)),{score:Math.min(1,n),reasons:i}}async recordIntegrationMetrics(e){const t=Date.now()-e;try{const n=await u.get("integration_metrics","current")||{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0},i={...n,totalImportedContent:n.totalImportedContent+1,averageIntegrationTime:(n.averageIntegrationTime+t)/2};await u.put("integration_metrics",i,"Updated integration metrics")}catch{}}async getIntegrationMetrics(){try{return await u.get("integration_metrics","current")}catch{return{totalImportedContent:0,automaticRelationshipsCreated:0,manualRelationshipsCreated:0,searchIndexEntries:0,learningPathsGenerated:0,averageIntegrationTime:0}}}async createManualRelationship(e,t,n,i){const s=await $.createLink(e,t,n,1,i,!1);try{const a=await this.getIntegrationMetrics();a.manualRelationshipsCreated+=1,await u.put("integration_metrics",a,"Updated manual relationship count")}catch{}return s}async getContentRecommendations(e,t,n=10){const i=[],a=(await u.getAll("modules")).filter(r=>r.metadata.tags.includes("imported")&&!t.has(r.id));for(const r of a){const o=await $.getLinksForContent(r.id);if(o.filter(d=>d.type==="prerequisite"&&d.targetId===r.id).map(d=>d.sourceId).every(d=>t.has(d))){const d=[];let h=.5;const p=o.filter(_=>t.has(_.sourceId)||t.has(_.targetId));h+=p.length*.1,p.length>0&&d.push({type:"prerequisite-completed",weight:.3,description:`Related to ${p.length} completed modules`}),i.push({contentId:r.id,score:Math.min(1,h),reasons:d,type:"related-topic"})}}return i.sort((r,o)=>o.score-r.score).slice(0,n)}}const J=new se;class ae{logger=B("source-manager");initialized=!1;async initialize(){this.initialized||(await f.initialize(),this.initialized=!0,this.logger.info("Source Manager initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async addSource(e){await this.ensureInitialized();const{url:t,title:n,category:i="web-content",tags:s=[],metadata:a={}}=e;this.logger.info("Adding new content source",{url:t,category:i,tags:s});try{const o=new URL(t).hostname,c=await this.findDuplicateSource(t);if(c)return this.logger.warn("Duplicate source detected",{url:t,existingSourceId:c.id}),{sourceId:c.id,source:c,isDuplicate:!0,duplicateOf:c.id};const l=`source_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,d=new Date,h={id:l,url:t,title:n||`Content from ${o}`,domain:o,importDate:d,lastChecked:d,status:"active",metadata:{author:a.author,publishDate:a.publishDate?new Date(a.publishDate):void 0,lastModified:a.lastModified?new Date(a.lastModified):void 0,domain:o,contentType:a.contentType||"article",language:a.language||"en",readingTime:a.readingTime||0,wordCount:a.wordCount||0,keywords:a.keywords||[],description:a.description||"",license:a.license,attribution:t,tags:s,category:i,contentHash:a.contentHash},usage:{timesReferenced:0,lastAccessed:d,generatedModules:[]}};return await f.addSource(h),this.logger.info("Content source added successfully",{sourceId:l,url:t,domain:o,category:i}),{sourceId:l,source:h,isDuplicate:!1}}catch(r){throw this.logger.error("Failed to add content source:",r),new Error(`Failed to add source: ${r instanceof Error?r.message:"Unknown error"}`)}}async listSources(e){await this.ensureInitialized(),this.logger.info("Listing content sources",{filters:e});try{let t;e?.domain?t=await f.getSourcesByDomain(e.domain):e?.category?t=await f.getSourcesByCategory(e.category):e?.status?t=await f.getSourcesByStatus(e.status):t=await f.getAllSources();const n=(await f.getAllSources()).length;e?.tags&&e.tags.length>0&&(t=t.filter(s=>e.tags.some(a=>s.metadata.tags.includes(a))));const i=t.length;if(e?.offset||e?.limit){const s=e.offset||0,a=e.limit||50;t=t.slice(s,s+a)}return t.sort((s,a)=>a.lastChecked.getTime()-s.lastChecked.getTime()),this.logger.info("Sources listed successfully",{total:n,filtered:i,returned:t.length}),{sources:t,total:n,filtered:i}}catch(t){throw this.logger.error("Failed to list sources:",t),new Error(`Failed to list sources: ${t instanceof Error?t.message:"Unknown error"}`)}}async updateSource(e,t){await this.ensureInitialized(),this.logger.info("Updating content source",{sourceId:e,updates:t});try{const n=await f.getSource(e);if(!n)throw new Error(`Source not found: ${e}`);const i={...n};let s=!1;t&&(t.title&&t.title!==n.title&&(n.title=t.title,s=!0),t.category&&t.category!==n.metadata.category&&(n.metadata.category=t.category,s=!0),t.tags&&JSON.stringify(t.tags)!==JSON.stringify(n.metadata.tags)&&(n.metadata.tags=t.tags,s=!0),t.status&&t.status!==n.status&&(n.status=t.status,s=!0)),n.lastChecked=new Date;try{const r=await H.fetch(n.url);if(r.success){const o=this.generateContentHash(r.content.text);n.metadata.contentHash&&n.metadata.contentHash!==o?(n.status="updated",n.metadata.contentHash=o,s=!0):n.metadata.contentHash||(n.metadata.contentHash=o,s=!0)}}catch(r){this.logger.warn("Failed to check for content updates:",r),n.status="error",s=!0}s&&await f.updateSource(n);const a={sourceId:e,success:!0,hasChanges:s,changes:s?{title:t?.title!==i.title,content:n.metadata.contentHash!==i.metadata.contentHash,metadata:t?.category!==i.metadata.category||JSON.stringify(t?.tags)!==JSON.stringify(i.metadata.tags)}:void 0,updatedAt:new Date};return this.logger.info("Source updated successfully",{sourceId:e,hasChanges:s}),a}catch(n){return this.logger.error("Failed to update source:",n),{sourceId:e,success:!1,hasChanges:!1,error:n instanceof Error?n.message:"Unknown error",updatedAt:new Date}}}async removeSource(e){await this.ensureInitialized(),this.logger.info("Removing content source",{sourceId:e});try{const t=await f.getSource(e);if(!t)return{sourceId:e,removed:!1};await f.deleteSource(e);const n=await f.getContentByUrl(t.url);return n&&await f.deleteContent(n.id),this.logger.info("Source removed successfully",{sourceId:e}),{sourceId:e,removed:!0,source:t}}catch(t){return this.logger.error("Failed to remove source:",t),{sourceId:e,removed:!1}}}async validateSources(e){await this.ensureInitialized();const t=e?(await Promise.all(e.map(n=>f.getSource(n)))).filter(Boolean):await f.getAllSources();this.logger.info("Validating content sources",{sourceCount:t.length,specific:!!e});try{const n=[];for(const s of t){if(!s)continue;const a=[],r=[];try{new URL(s.url)}catch{a.push("Invalid URL format"),r.push("Update URL to valid format")}(Date.now()-s.lastChecked.getTime())/(1e3*60*60*24)>30&&(a.push("Source not checked in over 30 days"),r.push("Update source to refresh content")),s.metadata.description||(a.push("Missing description"),r.push("Add description for better categorization")),s.metadata.keywords.length===0&&(a.push("No keywords defined"),r.push("Add keywords for better searchability"));try{const c=await fetch(s.url,{method:"HEAD"});c.ok||(a.push(`URL returns ${c.status} status`),r.push("Check if URL is still accessible"))}catch{a.push("URL is not accessible"),r.push("Verify URL is correct and accessible")}n.push({sourceId:s.id,valid:a.length===0,issues:a,suggestions:r})}const i={total:n.length,valid:n.filter(s=>s.valid).length,invalid:n.filter(s=>!s.valid).length};return this.logger.info("Source validation completed",i),{validationResults:n,summary:i}}catch(n){throw this.logger.error("Source validation failed:",n),new Error(`Source validation failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async performHealthCheck(e){await this.ensureInitialized(),this.logger.info("Performing source health check",{filters:e});try{let t=await f.getAllSources();if(e&&(e.domain&&(t=t.filter(s=>s.domain===e.domain)),e.category&&(t=t.filter(s=>s.metadata.category===e.category)),e.lastCheckedBefore)){const s=new Date(e.lastCheckedBefore);t=t.filter(a=>a.lastChecked<s)}const n=[];for(const s of t){const a=Date.now();let r;const o=[],c=[];try{const l=new AbortController,d=setTimeout(()=>l.abort(),1e4),h=await fetch(s.url,{method:"HEAD",signal:l.signal});clearTimeout(d);const p=Date.now()-a;h.ok?p>5e3?(r="warning",o.push("Slow response time"),c.push("Monitor performance","Consider caching")):r="healthy":(r="error",o.push(`HTTP ${h.status}: ${h.statusText}`),c.push("Check URL validity","Verify content is still available")),n.push({sourceId:s.id,url:s.url,status:r,lastChecked:new Date,responseTime:p,issues:o,suggestions:c})}catch{const d=Date.now()-a;r="error",o.push("Connection failed"),c.push("Check URL validity","Verify network connectivity"),n.push({sourceId:s.id,url:s.url,status:r,lastChecked:new Date,responseTime:d,issues:o,suggestions:c})}r==="error"&&(s.status="error",await f.updateSource(s))}const i={total:n.length,healthy:n.filter(s=>s.status==="healthy").length,warning:n.filter(s=>s.status==="warning").length,error:n.filter(s=>s.status==="error").length};return this.logger.info("Health check completed",i),{healthChecks:n,summary:i}}catch(t){throw this.logger.error("Health check failed:",t),new Error(`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async detectDuplicates(){await this.ensureInitialized(),this.logger.info("Detecting duplicate sources");try{const e=await f.getAllSources(),t=[],n=new Set;for(const s of e){if(n.has(s.id))continue;const a=e.filter(r=>r.id!==s.id&&!n.has(r.id)&&this.calculateSimilarity(s,r)>.8);if(a.length>0){const r={sourceId:s.id,duplicates:a.map(o=>({id:o.id,similarity:this.calculateSimilarity(s,o),reason:this.getDuplicateReason(s,o)})),suggestions:[{action:"merge",confidence:.8,reasoning:"High similarity detected, consider merging sources"}]};t.push(r),n.add(s.id),a.forEach(o=>n.add(o.id))}}const i={totalSources:e.length,duplicateGroups:t.length,duplicateSources:t.reduce((s,a)=>s+a.duplicates.length+1,0)};return this.logger.info("Duplicate detection completed",i),{duplicates:t,summary:i}}catch(e){throw this.logger.error("Duplicate detection failed:",e),new Error(`Duplicate detection failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getSourceStatistics(){await this.ensureInitialized();const e=await f.getAllSources(),t=new Date,n=new Date(t.getTime()-24*60*60*1e3),i=new Date(t.getTime()-7*24*60*60*1e3),s={total:e.length,byDomain:{},byCategory:{},byStatus:{},recentlyAdded:e.filter(a=>a.importDate>i).length,recentlyUpdated:e.filter(a=>a.lastChecked>n).length};return e.forEach(a=>{s.byDomain[a.domain]=(s.byDomain[a.domain]||0)+1}),e.forEach(a=>{s.byCategory[a.metadata.category]=(s.byCategory[a.metadata.category]||0)+1}),e.forEach(a=>{s.byStatus[a.status]=(s.byStatus[a.status]||0)+1}),s}async integrateWithKnowledgeSystem(e,t){await this.ensureInitialized(),this.logger.info("Integrating content with knowledge system",{sourceId:e.id,moduleId:t.id});try{const n=await J.integrateContent(e,t);return e.usage.timesReferenced+=1,e.usage.lastAccessed=new Date,e.usage.generatedModules.push(t.id),await f.updateSource(e),this.logger.info("Knowledge system integration completed",{sourceId:e.id,relationshipsDetected:n.suggestedRelationships.length,confidence:n.confidence}),{success:!0,relationshipsCreated:n.suggestedRelationships.length,searchIndexed:!0,learningPathSuggestions:0,error:void 0}}catch(n){return this.logger.error("Knowledge system integration failed:",n),{success:!1,relationshipsCreated:0,searchIndexed:!1,learningPathSuggestions:0,error:n instanceof Error?n.message:"Unknown error"}}}async getSource(e){return await this.ensureInitialized(),await f.getSource(e)}async getAllSources(){return await this.ensureInitialized(),await f.getAllSources()}async deleteSource(e){await this.ensureInitialized(),await f.deleteSource(e)}async getContentRecommendations(e,t,n=10){await this.ensureInitialized();try{const i=await J.getContentRecommendations(e,t,n),s=await f.getAllSources(),a=[];for(const r of i){const o=s.find(c=>c.usage.generatedModules.includes(r.contentId));o&&a.push({contentId:r.contentId,title:o.title,sourceUrl:o.url,score:r.score,reasons:r.reasons.map(c=>c.description||"Related content")})}return a}catch(i){return this.logger.error("Failed to get content recommendations:",i),[]}}async findDuplicateSource(e){return await f.getContentByUrl(e)&&(await f.getAllSources()).find(i=>i.url===e)||null}calculateSimilarity(e,t){let n=0;return e.url===t.url?n+=.5:e.domain===t.domain&&(n+=.2),e.title===t.title?n+=.3:(e.title.toLowerCase().includes(t.title.toLowerCase())||t.title.toLowerCase().includes(e.title.toLowerCase()))&&(n+=.15),e.metadata.contentHash&&t.metadata.contentHash&&e.metadata.contentHash===t.metadata.contentHash&&(n+=.2),Math.min(n,1)}getDuplicateReason(e,t){return e.url===t.url?"Identical URL":e.title===t.title?"Identical title":e.metadata.contentHash===t.metadata.contentHash?"Identical content":e.domain===t.domain?"Same domain with similar content":"Similar content detected"}generateContentHash(e){let t=0;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return t.toString(36)}}const x=new ae;class U{static instance;config;constructor(){this.config={similarityThreshold:.8,methods:["url","title","content","metadata"],weights:{url:.4,title:.3,content:.2,metadata:.1},ignoreParameters:!0,caseSensitive:!1}}static getInstance(){return U.instance||(U.instance=new U),U.instance}updateConfig(e){this.config={...this.config,...e}}async detectDuplicatesForSource(e){const t=await x.getSource(e);if(!t)throw new Error(`Source ${e} not found`);const i=(await x.getAllSources()).filter(r=>r.id!==e),s=[];for(const r of i){const o=this.calculateSimilarity(t,r);if(o>=this.config.similarityThreshold){const c=this.generateSimilarityReason(t,r,o);s.push({id:r.id,similarity:o,reason:c})}}s.sort((r,o)=>o.similarity-r.similarity);const a=this.generateMergeSuggestions(t,s);return{sourceId:e,duplicates:s,suggestions:a}}async detectAllDuplicates(){const e=await x.getAllSources(),t=[],n=new Set;for(const i of e){const s=await this.detectDuplicatesForSource(i.id),a=s.duplicates.filter(r=>{const o=[i.id,r.id].sort().join("-");return n.has(o)?!1:(n.add(o),!0)});a.length>0&&t.push({...s,duplicates:a})}return t}calculateSimilarity(e,t){let n=0,i=0;for(const s of this.config.methods){const a=this.config.weights[s],r=this.calculateMethodSimilarity(e,t,s);n+=r*a,i+=a}return i>0?n/i:0}calculateMethodSimilarity(e,t,n){switch(n){case"url":return this.calculateUrlSimilarity(e.url,t.url);case"title":return this.calculateTextSimilarity(e.title,t.title);case"content":return this.calculateContentSimilarity(e,t);case"metadata":return this.calculateMetadataSimilarity(e.metadata,t.metadata);case"combined":return this.calculateUrlSimilarity(e.url,t.url)*.4+this.calculateTextSimilarity(e.title,t.title)*.6;default:return 0}}calculateUrlSimilarity(e,t){try{const n=new URL(e),i=new URL(t);if(e===t)return 1;if(n.hostname===i.hostname&&n.pathname===i.pathname){if(this.config.ignoreParameters)return 1;const s=new Set(n.searchParams.keys()),a=new Set(i.searchParams.keys()),r=new Set(Array.from(s).filter(c=>a.has(c))),o=new Set([...Array.from(s),...Array.from(a)]);return o.size>0?r.size/o.size:1}return n.hostname===i.hostname?.7:n.pathname===i.pathname&&n.pathname!=="/"?.5:0}catch{return this.calculateTextSimilarity(e,t)}}calculateTextSimilarity(e,t){if(!e||!t)return 0;const n=l=>this.config.caseSensitive?l:l.toLowerCase(),i=n(e),s=n(t);if(i===s)return 1;const a=new Set(i.split(/\s+/).filter(l=>l.length>0)),r=new Set(s.split(/\s+/).filter(l=>l.length>0)),o=new Set(Array.from(a).filter(l=>r.has(l))),c=new Set([...Array.from(a),...Array.from(r)]);return c.size>0?o.size/c.size:0}calculateContentSimilarity(e,t){const n=[this.calculateNumericSimilarity(e.metadata?.wordCount??0,t.metadata?.wordCount??0),this.calculateNumericSimilarity(e.metadata?.readingTime??0,t.metadata?.readingTime??0),this.calculateArraySimilarity(e.metadata?.keywords??[],t.metadata?.keywords??[])];return n.reduce((i,s)=>i+s,0)/n.length}calculateMetadataSimilarity(e,t){const n=[];return e?.author&&t?.author&&n.push(this.calculateTextSimilarity(e.author,t.author)),e?.category&&t?.category&&n.push(e.category===t.category?1:0),n.push(this.calculateArraySimilarity(e?.tags||[],t?.tags||[])),e?.language&&t?.language&&n.push(e.language===t.language?1:0),n.length>0?n.reduce((i,s)=>i+s,0)/n.length:0}calculateNumericSimilarity(e,t){return e===t?1:e===0||t===0?0:Math.min(e,t)/Math.max(e,t)}calculateArraySimilarity(e,t){if(e.length===0&&t.length===0)return 1;if(e.length===0||t.length===0)return 0;const n=new Set(e.map(r=>this.config.caseSensitive?r:r.toLowerCase())),i=new Set(t.map(r=>this.config.caseSensitive?r:r.toLowerCase())),s=new Set(Array.from(n).filter(r=>i.has(r))),a=new Set([...Array.from(n),...Array.from(i)]);return a.size>0?s.size/a.size:0}generateSimilarityReason(e,t,n){const i=[],s=this.calculateUrlSimilarity(e.url,t.url);s>.8?i.push("Very similar URLs"):s>.5&&i.push("Similar domains or paths");const a=this.calculateTextSimilarity(e.title,t.title);return a>.8?i.push("Nearly identical titles"):a>.5&&i.push("Similar titles"),e.metadata?.author&&t.metadata?.author&&e.metadata.author===t.metadata.author&&i.push("Same author"),e.metadata?.category&&t.metadata?.category&&e.metadata.category===t.metadata.category&&i.push("Same category"),i.length>0?i.join(", "):`${Math.round(n*100)}% similarity`}generateMergeSuggestions(e,t){return t.map(n=>n.similarity>.95?{action:"merge",confidence:.9,reasoning:"Very high similarity suggests these are the same content"}:n.similarity>.85?{action:"merge",confidence:.7,reasoning:"High similarity suggests likely duplicates"}:n.similarity>.7?{action:"keep_both",confidence:.6,reasoning:"Moderate similarity - may be related but distinct content"}:{action:"keep_both",confidence:.8,reasoning:"Low similarity - likely different content"})}async mergeSources(e,t,n={preferNewer:!0,preserveUsageStats:!0,combineMetadata:!0,keepBothIfUncertain:!1}){const i=await x.getSource(e);if(!i)throw new Error(`Primary source ${e} not found`);const a=(await Promise.all(t.map(o=>x.getSource(o)))).filter(o=>o!==void 0),r=[];if(n.preserveUsageStats){for(const o of a)if(i.usage&&o.usage){i.usage.timesReferenced+=o.usage.timesReferenced;const c=o.usage.generatedModules.filter(l=>!i.usage.generatedModules.includes(l));i.usage.generatedModules.push(...c),o.usage.lastAccessed>i.usage.lastAccessed&&(i.usage.lastAccessed=o.usage.lastAccessed)}}if(n.combineMetadata){for(const o of a)if(i.metadata&&o.metadata){const c=o.metadata.tags.filter(d=>!i.metadata.tags.includes(d));i.metadata.tags.push(...c);const l=o.metadata.keywords.filter(d=>!i.metadata.keywords.includes(d));i.metadata.keywords.push(...l),o.metadata.author&&i.metadata.author&&o.metadata.author!==i.metadata.author&&r.push(`Author conflict: ${i.metadata.author} vs ${o.metadata.author}`)}}await x.updateSource(i.id,i);for(const o of t)await x.deleteSource(o);return{success:!0,mergedSourceId:e,removedSourceIds:t,conflicts:r,preservedData:{usage:n.preserveUsageStats,metadata:n.combineMetadata,relationships:!0}}}}const re=U.getInstance();class oe{logger=B("interactive-analyzer");initialized=!1;async initialize(){this.initialized||(await f.initialize(),this.initialized=!0,this.logger.info("Interactive Analyzer initialized"))}async ensureInitialized(){this.initialized||await this.initialize()}async analyzeContent(e){await this.ensureInitialized(),this.logger.info("Analyzing content for interactivity",{contentId:e});try{const t=await f.getContent(e);if(!t)throw new Error(`Content not found: ${e}`);const n={interactiveElements:[],javascriptFrameworks:[],dependencies:[],dataRequirements:{},preservationFeasibility:{},opportunities:[]};return n.interactiveElements=this.detectInteractiveElements(t.content.html),n.javascriptFrameworks=this.detectJavaScriptFrameworks(t.content.html),n.dependencies=this.analyzeDependencies(t.content.html),n.preservationFeasibility=this.assessPreservationFeasibility(n.interactiveElements),n.opportunities=this.generateInteractiveOpportunities(t),this.logger.info("Content analysis completed",{contentId:e,interactiveElements:n.interactiveElements.length,frameworks:n.javascriptFrameworks.length,opportunities:n.opportunities.length}),n}catch(t){throw this.logger.error("Failed to analyze content:",t),new Error(`Content analysis failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async transform(e,t){await this.ensureInitialized();const{type:n,domain:i,parameters:s={}}=t;this.logger.info("Transforming content to interactive",{contentId:e,transformationType:n,domain:i});try{const a=await f.getContent(e);if(!a)throw new Error(`Content not found: ${e}`);const r={transformedContent:null,interactiveBlocks:[],preservationResults:{},metadata:{transformationType:n,domain:i,parameters:s,transformedAt:new Date().toISOString()}},o=await this.analyzeContent(e);switch(n){case"auto":r.interactiveBlocks=this.autoTransform(a,o);break;case"visualization":r.interactiveBlocks=this.createVisualizationBlocks(a,i);break;case"simulation":r.interactiveBlocks=this.createSimulationBlocks(a,i);break;case"chart":r.interactiveBlocks=this.createInteractiveCharts(a);break;case"quiz":r.interactiveBlocks=this.generateQuizBlocks(a);break;default:throw new Error(`Unknown transformation type: ${n}`)}return r.transformedContent={...a,blocks:[...a.content.blocks||[],...r.interactiveBlocks],metadata:{...a.metadata,transformed:!0,transformationType:n,transformedAt:new Date().toISOString()}},this.logger.info("Content transformation completed",{contentId:e,blocksCreated:r.interactiveBlocks.length}),r}catch(a){throw this.logger.error("Failed to transform content:",a),new Error(`Content transformation failed: ${a instanceof Error?a.message:"Unknown error"}`)}}async generateVisualization(e,t){await this.ensureInitialized();const{type:n,config:i={}}=t;this.logger.info("Generating visualization",{contentId:e,visualizationType:n});try{const s=await f.getContent(e);if(!s)throw new Error(`Content not found: ${e}`);const a={id:`viz_${Date.now()}`,type:n,contentId:e,data:null,config:null,interactionHandlers:[]};switch(n){case"chart":a.data=this.extractChartData(s),a.config=this.createChartConfig(i),a.interactionHandlers=this.createChartInteractions();break;case"network":a.data=this.extractNetworkData(s),a.config=this.createNetworkConfig(i),a.interactionHandlers=this.createNetworkInteractions();break;case"timeline":a.data=this.extractTimelineData(s),a.config=this.createTimelineConfig(i),a.interactionHandlers=this.createTimelineInteractions();break;case"neural-network":a.data=this.extractNeuralNetworkData(s),a.config=this.createNeuralNetworkConfig(i),a.interactionHandlers=this.createNeuralNetworkInteractions();break;default:throw new Error(`Unknown visualization type: ${n}`)}return{visualization:a,config:a.config,interactionHandlers:a.interactionHandlers}}catch(s){throw this.logger.error("Failed to generate visualization:",s),new Error(`Visualization generation failed: ${s instanceof Error?s.message:"Unknown error"}`)}}detectInteractiveElements(e){const t=[],n=[{selector:"button",type:"button"},{selector:"input",type:"input"},{selector:"select",type:"select"},{selector:"textarea",type:"textarea"},{selector:"form",type:"form"},{selector:"canvas",type:"canvas"},{selector:"svg",type:"svg"},{selector:"[onclick]",type:"clickable"},{selector:"[data-*]",type:"data-element"}],s=new DOMParser().parseFromString(e,"text/html");return n.forEach(({selector:a,type:r})=>{s.querySelectorAll(a).forEach((c,l)=>{t.push({id:`element_${t.length}`,type:r,selector:a,html:c.outerHTML.substring(0,200),detected:"static_analysis",confidence:.8})})}),t}detectJavaScriptFrameworks(e){return[]}analyzeDependencies(e){return[]}assessPreservationFeasibility(e){return{feasible:!0,confidence:.8}}generateInteractiveOpportunities(e){const t=[];e.content.codeBlocks.forEach((i,s)=>{this.isInteractiveCodeCandidate(i)&&t.push({id:`code_${s}`,type:"interactive-code",title:`Interactive Code: ${i.language}`,description:`Make this ${i.language} code block interactive`,confidence:.8,reasoning:`Code block contains ${i.language} code that could be made executable`,sourceElement:`code_block_${s}`,parameters:{language:{type:"text",value:i.language},executable:{type:"boolean",value:!0}}})}),e.content.tables.forEach((i,s)=>{i.rows.length>5&&t.push({id:`table_${s}`,type:"interactive-table",title:"Interactive Data Table",description:"Add filtering and sorting to this data table",confidence:.7,reasoning:`Table has ${i.rows.length} rows and could benefit from interactive features`,sourceElement:`table_${s}`,parameters:{sortable:{type:"boolean",value:!0},filterable:{type:"boolean",value:!0}}})}),e.content.charts.forEach((i,s)=>{t.push({id:`chart_${s}`,type:"interactive-chart",title:`Interactive ${i.type} Chart`,description:`Make this ${i.type} chart interactive with hover and zoom`,confidence:.9,reasoning:"Chart detected and can be enhanced with interactivity",sourceElement:`chart_${s}`,parameters:{chartType:{type:"text",value:i.type},interactive:{type:"boolean",value:!0}}})});const n=e.content.text.toLowerCase();return(n.includes("algorithm")||n.includes("process")||n.includes("step"))&&t.push({id:"simulation_content",type:"simulation",title:"Process Simulation",description:"Create an interactive simulation of the described process",confidence:.6,reasoning:"Content describes processes or algorithms that could be simulated",sourceElement:"main_content",parameters:{simulationType:{type:"text",value:"process"},interactive:{type:"boolean",value:!0}}}),t}isInteractiveCodeCandidate(e){return["javascript","python","html","css","sql"].includes(e.language.toLowerCase())&&e.code.length>50}autoTransform(e,t){return[]}createVisualizationBlocks(e,t){return[]}createSimulationBlocks(e,t){return[]}createInteractiveCharts(e){return[]}generateQuizBlocks(e){return[]}extractChartData(e){return null}createChartConfig(e){return{title:"Chart",description:"Interactive chart",parameters:[],layout:{width:800,height:600,margin:{top:20,right:20,bottom:20,left:20},responsive:!0},styling:{theme:"light",colors:["#1f77b4"],fonts:{family:"Arial",size:12}},animations:{enabled:!0,duration:300,easing:"ease",transitions:[]}}}createChartInteractions(){return[]}extractNetworkData(e){return null}createNetworkConfig(e){return this.createChartConfig(e)}createNetworkInteractions(){return[]}extractTimelineData(e){return null}createTimelineConfig(e){return this.createChartConfig(e)}createTimelineInteractions(){return[]}extractNeuralNetworkData(e){return null}createNeuralNetworkConfig(e){return this.createChartConfig(e)}createNeuralNetworkInteractions(){return[]}}const F=new oe;class O{static instance;config;activeJobs=new Map;jobQueue=[];completedJobs=new Map;isProcessing=!1;logger=B("processing-pipeline");progressReportingTimer;eventListeners=new Map;constructor(){this.config={maxConcurrentJobs:3,retryAttempts:3,retryDelay:1e3,retryBackoffMultiplier:2,maxRetryDelay:3e4,timeoutMs:3e5,enableDuplicateDetection:!0,enableQualityAssessment:!0,enableInteractiveTransformation:!0,enableParallelProcessing:!0,progressReportingInterval:5e3,enableDetailedLogging:!0},this.startProgressReporting()}static getInstance(){return O.instance||(O.instance=new O),O.instance}updateConfig(e){this.config={...this.config,...e},this.logger.info("Pipeline configuration updated",e),e.progressReportingInterval!==void 0&&(this.stopProgressReporting(),this.startProgressReporting())}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const n=this.eventListeners.get(e);if(n){const i=n.indexOf(t);i>-1&&n.splice(i,1)}}emitEvent(e,t){const n=this.eventListeners.get(e);n&&n.forEach(i=>{try{i(t)}catch(s){this.logger.error("Error in event listener:",s)}})}createSingleProcessingJob(e,t="normal",n={}){const i=this.generateJobId(),s=this.createProcessingStages("single"),a={id:i,type:"single",status:"pending",progress:{currentStage:0,totalStages:s.length,stageProgress:0,overallProgress:0},stages:s,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrl:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(a),this.sortJobQueue(),this.logger.info("Single processing job created",{jobId:i,url:e,priority:t}),this.emitEvent("job-created",{job:this.sanitizeJobForEvent(a)}),this.isProcessing||this.processJobQueue(),i}createBatchProcessingJob(e,t="normal",n={}){const i=this.generateJobId();if(this.config.enableParallelProcessing&&n.enableParallel!==!1){const s=e.map(a=>this.createSingleProcessingJob(a,t,{...n,tags:[...n.tags||[],"batch"],batchId:i}));return this.logger.info("Batch processing job created (parallel)",{batchId:i,urlCount:e.length,jobIds:s}),this.emitEvent("batch-created",{batchId:i,urlCount:e.length,jobIds:s,parallel:!0}),i}else{const s=this.createProcessingStages("batch"),a={id:i,type:"batch",status:"pending",progress:{currentStage:0,totalStages:s.length,stageProgress:0,overallProgress:0},stages:s,results:[],retryCount:0,createdAt:new Date,metadata:{sourceUrls:e,priority:t,...n},stageTimings:new Map,progressHistory:[]};return this.jobQueue.push(a),this.sortJobQueue(),this.logger.info("Batch processing job created (sequential)",{batchId:i,urlCount:e.length}),this.emitEvent("batch-created",{batchId:i,urlCount:e.length,parallel:!1}),this.isProcessing||this.processJobQueue(),i}}getJobStatus(e){return this.activeJobs.get(e)||this.jobQueue.find(t=>t.id===e)||this.completedJobs.get(e)}cancelJob(e){const t=this.getJobStatus(e);if(!t)return!1;if(t.status==="pending"){const n=this.jobQueue.findIndex(i=>i.id===e);n>=0&&this.jobQueue.splice(n,1)}return t.status="cancelled",t.completedAt=new Date,!0}getActiveJobs(){return Array.from(this.activeJobs.values())}getJobQueue(){return[...this.jobQueue]}getCompletedJobs(){return Array.from(this.completedJobs.values())}getBatchStatus(e){const t=[...this.jobQueue,...this.activeJobs.values(),...this.completedJobs.values()].filter(r=>r.metadata.batchId===e);if(t.length===0)return null;const n=t.filter(r=>r.status==="completed").length,i=t.filter(r=>r.status==="failed").length,s=t.filter(r=>r.status==="processing").length;let a;return n===t.length?a="completed":i===t.length?a="failed":s>0||n>0?a="processing":a="pending",{batchId:e,totalJobs:t.length,completedJobs:n,failedJobs:i,overallProgress:n/t.length*100,status:a}}getStatistics(){const e=Array.from(this.completedJobs.values()),t=e.filter(s=>s.status==="completed"),n=e.filter(s=>s.startedAt&&s.completedAt).map(s=>s.completedAt.getTime()-s.startedAt.getTime()),i=n.length>0?n.reduce((s,a)=>s+a,0)/n.length:0;return{activeJobs:this.activeJobs.size,queuedJobs:this.jobQueue.length,completedJobs:e.length,totalProcessed:e.length,averageProcessingTime:i,successRate:e.length>0?t.length/e.length*100:0}}async processJobQueue(){if(!this.isProcessing){this.isProcessing=!0;try{for(;this.jobQueue.length>0&&this.activeJobs.size<this.config.maxConcurrentJobs;){const e=this.jobQueue.shift();!e||e.status==="cancelled"||(await new Promise(t=>setTimeout(t,0)),this.activeJobs.set(e.id,e),this.processJob(e).catch(t=>{e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date}).finally(()=>{this.activeJobs.delete(e.id),this.jobQueue.length>0&&setTimeout(()=>void this.processJobQueue(),100)}))}}finally{this.activeJobs.size===0&&this.jobQueue.length===0&&(this.isProcessing=!1)}}}async processJob(e){e.status="processing",e.startedAt=new Date,this.logger.info("Starting job processing",{jobId:e.id,type:e.type}),this.emitEvent("job-started",{job:this.sanitizeJobForEvent(e)});try{for(let t=0;t<e.stages.length;t++){if(this.activeJobs.get(e.id)?.status==="cancelled"){this.logger.info("Job cancelled during processing",{jobId:e.id});return}const n=e.stages[t];e.progress.currentStage=t,e.progress.stageProgress=0,e.stageTimings.set(n.name,{startTime:Date.now()}),this.logger.debug("Processing stage",{jobId:e.id,stage:n.name}),this.emitEvent("stage-started",{jobId:e.id,stage:n.name,stageIndex:t});let i,s=0;for(;s<=this.config.retryAttempts;)try{i=await this.processStageWithTimeout(e,n);break}catch(r){if(s++,s>this.config.retryAttempts)throw r;const o=this.calculateRetryDelay(s);this.logger.warn("Stage failed, retrying",{jobId:e.id,stage:n.name,attempt:s,delay:o,error:r instanceof Error?r.message:"Unknown error"}),this.emitEvent("stage-retry",{jobId:e.id,stage:n.name,attempt:s,delay:o}),await this.delay(o)}const a=e.stageTimings.get(n.name);if(a.endTime=Date.now(),a.duration=a.endTime-a.startTime,e.results.push(i),!i.success)throw new Error(`Stage ${n.name} failed: ${i.metadata.issues.join(", ")}`);e.progress.stageProgress=100,e.progress.overallProgress=(t+1)/e.stages.length*100,e.progressHistory.push({timestamp:new Date,stage:n.name,progress:e.progress.overallProgress}),this.updateTimeEstimate(e),this.logger.debug("Stage completed",{jobId:e.id,stage:n.name,duration:a.duration}),this.emitEvent("stage-completed",{jobId:e.id,stage:n.name,duration:a.duration,progress:e.progress.overallProgress})}e.status="completed",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.info("Job completed successfully",{jobId:e.id,duration:e.completedAt.getTime()-e.startedAt.getTime()}),this.emitEvent("job-completed",{job:this.sanitizeJobForEvent(e)})}catch(t){throw e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.completedAt=new Date,this.completedJobs.set(e.id,e),this.logger.error("Job failed",{jobId:e.id,error:e.error,retryCount:e.retryCount}),this.emitEvent("job-failed",{job:this.sanitizeJobForEvent(e),error:e.error}),t}}async processStage(e,t){const n=Date.now(),i=[];try{let s={};switch(t.name){case"fetch":s=await this.processFetchStage(e,t);break;case"extract":s=await this.processExtractStage(e,t);break;case"store":s=await this.processStoreStage(e,t);break;case"duplicate_check":this.config.enableDuplicateDetection&&(s=await this.processDuplicateCheckStage(e,t));break;case"quality_assessment":this.config.enableQualityAssessment&&(s=await this.processQualityAssessmentStage(e,t));break;case"interactive_transformation":this.config.enableInteractiveTransformation&&(s=await this.processInteractiveTransformationStage(e,t));break;default:i.push(`Unknown stage: ${t.name}`)}const a=this.calculateStageConfidence(t.name,s);return{stage:t.name,success:i.length===0,data:s,metadata:{processingTime:Date.now()-n,confidence:a,issues:i}}}catch(s){return i.push(s instanceof Error?s.message:"Unknown error"),{stage:t.name,success:!1,data:null,metadata:{processingTime:Date.now()-n,confidence:0,issues:i}}}}async processFetchStage(e,t){const n=e.metadata.sourceUrl||e.metadata.sourceUrls?.[0];if(!n)throw new Error("No URL provided for fetch stage");this.logger.debug("Fetching content",{jobId:e.id,url:n});try{const i=await H.fetch(n,{timeout:this.config.timeoutMs,cleanContent:!0,preserveInteractivity:!0});if(!i.success)throw new Error(`Failed to fetch content: ${i.extraction.issues.join(", ")}`);return{webContent:i,url:n,fetchedAt:new Date,success:!0,confidence:i.extraction.confidence}}catch(i){throw this.logger.error("Fetch stage failed",{jobId:e.id,url:n,error:i}),i}}async processExtractStage(e,t){const n=e.results.find(s=>s.stage==="fetch");if(!n?.data?.webContent)throw new Error("No web content available for extraction");const i=n.data.webContent;this.logger.debug("Analyzing content for interactivity",{jobId:e.id,contentId:i.id});try{const s=await x.addSource({url:i.url,title:i.title,metadata:i.metadata}),a=await F.analyzeContent(i.id);return{contentId:s.sourceId,analysis:a,extractionMethod:i.extraction.method,confidence:i.extraction.confidence,interactiveOpportunities:a.opportunities.length}}catch(s){throw this.logger.error("Extract stage failed",{jobId:e.id,error:s}),s}}async processStoreStage(e,t){const n=e.results.find(s=>s.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for storage");const i=n.data.contentId;this.logger.debug("Storing content permanently",{jobId:e.id,contentId:i});try{const s=await f.getSource(i);if(!s)throw new Error("Content not found in source manager");return await x.updateSource(i,{status:"updated"}),{sourceId:i,stored:!0,url:s.url,title:s.title}}catch(s){throw this.logger.error("Store stage failed",{jobId:e.id,error:s}),s}}async processDuplicateCheckStage(e,t){const n=e.results.find(s=>s.stage==="store");if(!n?.data?.sourceId)return{duplicatesFound:!1};const i=await re.detectDuplicatesForSource(n.data.sourceId);return{duplicatesFound:i.duplicates.length>0,duplicateCount:i.duplicates.length,suggestions:i.suggestions}}async processQualityAssessmentStage(e,t){const n=e.results.find(a=>a.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for quality assessment");const i=n.data.contentId,s=n.data.analysis;this.logger.debug("Assessing content quality",{jobId:e.id,contentId:i});try{const a=await f.getSource(i);if(!a)throw new Error("Source not found for quality assessment");const r=this.assessContentQuality(a,s);return{contentId:i,qualityScore:r.overallScore,readabilityScore:r.readabilityScore,interactivityPotential:r.interactivityScore,accessibilityScore:r.accessibilityScore,suggestions:this.generateQualityImprovements(r),metrics:r}}catch(a){throw this.logger.error("Quality assessment stage failed",{jobId:e.id,error:a}),a}}async processInteractiveTransformationStage(e,t){const n=e.results.find(a=>a.stage==="extract");if(!n?.data?.contentId)throw new Error("No content ID available for transformation");const i=n.data.contentId,s=n.data.analysis;this.logger.debug("Transforming content to interactive",{jobId:e.id,contentId:i,opportunities:s.opportunities.length});try{const a=await F.transform(i,{type:"auto",domain:this.detectDomain(s),parameters:t.config});return{contentId:i,transformationsApplied:a.interactiveBlocks.length,interactiveElementsCreated:a.interactiveBlocks.map(r=>r.type),confidence:this.calculateTransformationConfidence(a),transformedContent:a.transformedContent}}catch(a){throw this.logger.error("Interactive transformation stage failed",{jobId:e.id,error:a}),a}}createProcessingStages(e){const t=[{name:"fetch",processor:"WebContentFetcher",config:{},dependencies:[],outputs:["webContent"]},{name:"extract",processor:"ContentExtractor",config:{},dependencies:["fetch"],outputs:["extractedContent"]},{name:"store",processor:"SourceManager",config:{},dependencies:["extract"],outputs:["sourceId"]}];return this.config.enableDuplicateDetection&&t.push({name:"duplicate_check",processor:"DuplicateDetector",config:{},dependencies:["store"],outputs:["duplicateReport"]}),this.config.enableQualityAssessment&&t.push({name:"quality_assessment",processor:"QualityAssessor",config:{},dependencies:["store"],outputs:["qualityReport"]}),this.config.enableInteractiveTransformation&&t.push({name:"interactive_transformation",processor:"InteractiveTransformer",config:{},dependencies:["quality_assessment"],outputs:["interactiveContent"]}),t}sortJobQueue(){const e={high:3,normal:2,low:1};this.jobQueue.sort((t,n)=>{const i=e[t.metadata.priority],s=e[n.metadata.priority];return i!==s?s-i:t.createdAt.getTime()-n.createdAt.getTime()})}generateJobId(){return`job_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async processStageWithTimeout(e,t){return new Promise((n,i)=>{const s=setTimeout(()=>{i(new Error(`Stage ${t.name} timed out after ${this.config.timeoutMs}ms`))},this.config.timeoutMs);this.processStage(e,t).then(a=>{clearTimeout(s),n(a)}).catch(a=>{clearTimeout(s),i(a)})})}calculateRetryDelay(e){const t=this.config.retryDelay*Math.pow(this.config.retryBackoffMultiplier,e-1);return Math.min(t,this.config.maxRetryDelay)}delay(e){return new Promise(t=>setTimeout(t,e))}updateTimeEstimate(e){if(e.progressHistory.length<2)return;const t=e.progressHistory.slice(-3),n=t.reduce((s,a,r)=>{if(r===0)return s;const o=t[r-1],c=a.timestamp.getTime()-o.timestamp.getTime(),l=a.progress-o.progress;return s+(l>0?c/l:0)},0)/(t.length-1),i=100-e.progress.overallProgress;if(e.progress.estimatedTimeRemaining=i*n,e.startedAt){const s=Date.now()-e.startedAt.getTime();e.progress.throughput=e.progress.overallProgress/s*1e3}}sanitizeJobForEvent(e){return{id:e.id,type:e.type,status:e.status,progress:e.progress,retryCount:e.retryCount,createdAt:e.createdAt,startedAt:e.startedAt,completedAt:e.completedAt,metadata:{priority:e.metadata.priority,tags:e.metadata.tags,batchId:e.metadata.batchId}}}startProgressReporting(){this.progressReportingTimer&&clearInterval(this.progressReportingTimer),this.progressReportingTimer=setInterval(()=>{if(this.activeJobs.size>0){const e=Array.from(this.activeJobs.values()),t=this.getStatistics();this.emitEvent("progress-report",{activeJobs:e.map(n=>this.sanitizeJobForEvent(n)),statistics:t,timestamp:new Date}),this.config.enableDetailedLogging&&this.logger.debug("Progress report",{statistics:t,activeJobCount:e.length})}},this.config.progressReportingInterval)}stopProgressReporting(){this.progressReportingTimer&&(clearInterval(this.progressReportingTimer),this.progressReportingTimer=void 0)}cleanupCompletedJobs(e=24*60*60*1e3){const t=Date.now()-e,n=[];this.completedJobs.forEach((i,s)=>{i.completedAt&&i.completedAt.getTime()<t&&n.push(s)}),n.forEach(i=>this.completedJobs.delete(i)),n.length>0&&this.logger.info("Cleaned up completed jobs",{removedCount:n.length})}detectDomain(e){return e.javascriptFrameworks.some(t=>t.name.includes("React"))?"web-development":e.interactiveElements.some(t=>t.type==="canvas")?"data-visualization":"general"}calculateTransformationConfidence(e){const t=e.interactiveBlocks.length;return t===0?.1:t>=3?.9:.5+t*.2}calculateStageConfidence(e,t){switch(e){case"fetch":return t.confidence||.8;case"extract":return t.confidence||.7;case"store":return t.stored?.9:.1;case"duplicate_check":return .8;case"quality_assessment":return t.qualityScore||.6;case"interactive_transformation":return t.confidence||.7;default:return .5}}assessContentQuality(e,t){const n=e.content,i=e.metadata,s=this.calculateReadabilityScore(n.text),a=t.opportunities.length>0?Math.min(t.opportunities.length*.2,1):.1,r=this.calculateAccessibilityScore(n.html),o=this.calculateEngagementScore(n,i),c=(s+a+r+o)/4;return{readabilityScore:s,interactivityScore:a,accessibilityScore:r,engagementScore:o,overallScore:c}}calculateReadabilityScore(e){const t=e.split(/\s+/).length,n=e.split(/[.!?]+/).length,i=t/n;return i<15?.9:i<20?.7:i<25?.5:.3}calculateAccessibilityScore(e){let t=.5;const n=e.match(/<img[^>]*>/g)||[],i=e.match(/<img[^>]*alt\s*=\s*["'][^"']*["'][^>]*>/g)||[];return n.length>0&&(t+=i.length/n.length*.2),(e.includes("<h1")||e.includes("<h2"))&&(t+=.1),(e.includes("<nav")||e.includes("<main"))&&(t+=.1),e.includes("aria-")&&(t+=.1),Math.min(t,1)}calculateEngagementScore(e,t){let n=.3;return e.text.length>1e3&&(n+=.1),e.text.length>3e3&&(n+=.1),e.images.length>0&&(n+=.1),e.codeBlocks.length>0&&(n+=.1),e.tables.length>0&&(n+=.1),t.description&&t.description.length>50&&(n+=.1),t.keywords.length>0&&(n+=.1),Math.min(n,1)}generateQualityImprovements(e){const t=[];return e.readabilityScore<.6&&t.push("Consider breaking up long sentences for better readability"),e.interactivityScore<.4&&t.push("Add interactive elements like charts, quizzes, or simulations"),e.accessibilityScore<.7&&t.push("Improve accessibility by adding alt text to images and using semantic HTML"),e.engagementScore<.5&&t.push("Add more visual elements and structured content to increase engagement"),t}}O.getInstance();export{he as c,ue as m,w as n,ge as o,$ as r,A as s};
